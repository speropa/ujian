<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=0.67, user-scalable=yes, maximum-scale=2.0" />
    <title>Ujian Siswa</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            /* --- VARIABEL WARNA DEFAULT (KELAS 7) --- */
            --primary-color: #0066cc;   /* Header, Judul Modal */
            --accent-color: #007bff;    /* Tombol Login, Lanjutkan */
            --warning-color: #ea4b16;   /* Judul Halaman (Orange Default) */
            --light-bg: #f4f7f9;
            --border-color: #e0e0e0;
            --danger-color: #dc3545;
            --success-color: #28a745;
        }

        body {
            font-family: 'Inter', Arial, sans-serif;
            background-color: #e0e0e0;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
            overflow: hidden;
            transition: background-color 0.5s ease;
        }

        /* Tema Kelas 8 (Orange) */
        body.theme-kelas8 {
            --primary-color: #e67e22;
            --accent-color: #f39c12;
            --warning-color: #d35400;
        }

        /* Tema Kelas 9 (Maroon) */
        body.theme-kelas9 {
            --primary-color: #800000;
            --accent-color: #a00000;
            --warning-color: #800000;
        }

        .welcome-screen {
            max-width: 400px;
            width: 90%;
            margin: 20px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            padding: 30px 20px;
            display: none;
            flex-direction: column;
            gap: 15px;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }

        .welcome-screen h2 {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .welcome-screen p {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 20px;
        }

        .welcome-button {
            padding: 15px 25px;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .welcome-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .welcome-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Warna Tombol Welcome Screen (Statis) */
        .btn-kelas7 { background-color: #007bff !important; }
        .btn-kelas7:hover { background-color: #0056b3 !important; }

        .btn-kelas8 { background-color: #ff9900 !important; }
        .btn-kelas8:hover { background-color: #cc7a00 !important; }

        .btn-kelas9 { background-color: #800000 !important; }
        .btn-kelas9:hover { background-color: #5a0000 !important; }

        .btn-susulan { background-color: #28a745 !important; }
        .btn-susulan:hover { background-color: #218838 !important; }

        .container {
            max-width: 400px;
            width: 90%;
            margin: 20px auto;
            border: 1px solid #ddd;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            flex-shrink: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            display: none;
        }
        .container.show {
            display: block;
            opacity: 1;
        }

        .header-box {
            background-color: var(--primary-color);
            padding: 20px 15px;
            color: white;
            position: relative;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        
        .back-button {
            position: absolute;
            top: 15px;
            left: 15px;
            cursor: pointer;
            color: white;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            z-index: 2;
        }

        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .header-box .logo {
            width: 80px;
            height: auto;
        }

        .header-box .title {
            font-size: 22px;
            font-weight: bold;
            margin-top: 10px;
            color: white;
        }

        .card-body {
            padding: 20px;
        }

        .judul-ujian {
            color: var(--warning-color);
            font-size: 22px;
            font-weight: bold;
            margin: 10px 0;
            transition: color 0.3s ease;
        }

        .token-input-group {
            display: flex;
            align-items: center;
            width: calc(100% - 20px);
            margin: 10px auto;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .token-input-group input {
            padding: 10px;
            font-size: 16px;
            border: none;
            margin: 0;
            box-sizing: border-box;
            text-align: center;
            height: 40px;
        }

        #inputTokenPrefix {
            flex-grow: 1;
            min-width: 0;
            border-right: 1px solid #ccc;
        }

        .token-separator {
            background-color: #f0f0f0;
            padding: 10px 5px;
            font-size: 16px;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            box-sizing: border-box;
        }

        #displayStudentId {
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            background-color: #f0f0f0;
            cursor: not-allowed;
        }

        input {
            padding: 10px;
            width: calc(100% - 20px);
            font-size: 16px;
            margin: 10px auto;
            display: block;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: center;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .custom-dropdown-container {
            position: relative;
            width: calc(100% - 20px);
            margin: 10px auto;
            display: block;
        }

        .custom-dropdown-display {
            padding: 10px;
            width: 100%;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: center;
            background-color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 40px;
            color: #555;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .custom-dropdown-display.selected {
            color: #000;
        }

        .custom-dropdown-display.disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }

        .custom-dropdown-display::after {
            content: '▼';
            position: absolute;
            right: 15px;
            font-size: 0.8em;
            color: #888;
        }

        .token-input-group.is-valid {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .token-input-group.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            width: 100%;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 10px auto;
            display: block;
        }

        button:hover {
            filter: brightness(0.9);
        }

        button:active {
            transform: scale(0.98);
        }

        #btnBatal {
            background-color: #dc3545 !important;
        }

        #btnBatal:hover {
            background-color: #c82333 !important;
        }

        .message {
            margin-bottom: 10px;
            font-size: 14px;
            min-height: 30px;
            text-align: center;
            word-wrap: break-word;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid black;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            padding-bottom: 10px;
        }

        .custom-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .custom-modal.show {
            display: flex;
            opacity: 1;
        }
        
        .custom-modal.static-backdrop {
            background: rgba(0, 0, 0, 0.85); /* Lebih gelap untuk error */
            pointer-events: all;
        }

        .custom-modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .custom-modal-content h4 {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0;
            transition: color 0.3s ease;
        }

        .custom-modal-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        .custom-modal-list li {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            text-align: left;
            font-size: 1.1em;
            transition: background-color 0.2s ease;
        }

        .custom-modal-list li:nth-child(odd) {
            background-color: white;
        }
        .custom-modal-list li:nth-child(even) {
            background-color: #e0e0e0;
        }

        .custom-modal-list li:last-child {
            border-bottom: none;
        }

        .custom-modal-list li:hover {
            background-color: #c0c0c0;
        }

        #susulanListModal .custom-modal-content {
            max-width: 450px;
        }

        #susulanListModal .custom-modal-list li {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 15px 20px;
            gap: 5px;
        }

        #susulanListModal .custom-modal-list li .item-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        #susulanListModal .custom-modal-list li .item-url {
            font-size: 0.85em;
            color: #666;
            word-break: break-all;
        }


        #confirmModal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        #confirmModal.show {
            display: flex;
            opacity: 1;
        }

        #confirmModal .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            max-width: 380px;
            text-align: left;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        #confirmModal .modal-content h4 {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
            transition: color 0.3s ease;
        }

        #confirmModal .modal-content .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        #confirmModal .modal-content .info-table tr {
            border-bottom: 1px solid #eee;
        }

        #confirmModal .modal-content .info-table tr:last-child {
            border-bottom: none;
        }

        #confirmModal .modal-content .info-table td {
            padding: 8px 0;
            font-size: 1.1em;
        }

        #confirmModal .modal-content td:first-child {
            font-weight: bold;
            color: #333;
            width: 120px;
            padding-right: 10px;
        }

        #confirmModal .modal-content td:last-child {
            text-align: left;
            color: #000;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-top: 15px;
            margin-bottom: 15px;
            font-size: 1em;
            color: #333;
            padding-left: 10px;
        }

        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0 8px 0 0;
            cursor: pointer;
            vertical-align: middle;
            box-shadow: none;
            display: inline-block;
        }

        .checkbox-container label {
            cursor: pointer;
            vertical-align: middle;
        }

        #modalMessage {
            color: red;
            font-size: 0.9em;
            text-align: center;
            margin-top: -10px;
            margin-bottom: 10px;
            min-height: 1.2em;
        }

        /* === [START] GAYA TAMPILAN UJIAN BARU === */
        #examContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            flex-direction: column;
            background-color: var(--light-bg);
            z-index: 500;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        #examBody {
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 15px;
            flex-grow: 1;
            overflow-y: auto; 
            padding-bottom: 70px; 
        }

        #examMainContent {
            order: 2;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        #examSidePanel {
            order: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #ffffff;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 15px;
            position: relative;
            border-bottom: 1px solid var(--border-color);
            background-color: #f8f9fa;
            min-height: 60px;
        }
        
        .sidebar-header #timerText {
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 2.2em;
            color: var(--danger-color);
            text-align: center;
        }
        
        /* === TOMBOL REFRESH (KIRI ATAS) === */
        #refreshSoalBtn {
            display: flex;
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #17a2b8;
            color: white;
            padding: 6px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.85em;
            border: none;
            cursor: pointer;
            align-items: center;
            gap: 5px;
            width: auto;
            transition: background-color 0.2s;
            z-index: 10;
            margin: 0;
        }
        
        #refreshSoalBtn:hover { background-color: #138496; }

        #refreshSoalBtn svg {
            width: 16px;
            height: 16px;
        }

        /* === TOMBOL UPDATE SOAL (FLOATING) === */
        #updateSoalBtn {
            display: none;
            position: fixed;
            top: 70px;
            right: 20px;
            background-color: #ff9800;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            cursor: pointer;
            border: 2px solid white;
            animation: pulseBtn 2s infinite;
            align-items: center;
            gap: 8px;
            width: auto;
            font-size: 0.9em;
        }

        #updateSoalBtn:hover {
            background-color: #f57c00;
            transform: scale(1.05);
        }

        #updateSoalBtn svg {
            width: 20px;
            height: 20px;
        }

        @keyframes pulseBtn {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
        }
        
        #mobileSidebarToggle {
            display: block; 
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            margin: 0;
            width: 30px;
            height: 30px;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
        #mobileSidebarToggle .arrow-icon {
            width: 100%;
            height: 100%;
            stroke: black;
            transition: transform 0.3s ease;
        }
        #mobileSidebarToggle.up .arrow-icon {
            transform: rotate(180deg);
        }

        .sidebar-content-wrapper {
            transition: max-height 0.4s ease-in-out;
            max-height: 500px; 
            overflow: hidden;
        }
        .sidebar-content-wrapper > * {
            transition: opacity 0.2s ease-in-out;
        }
        .sidebar-content-wrapper.collapsed {
            max-height: 0;
            border-top: none;
            padding-top: 0;
            padding-bottom: 0;
        }
        .sidebar-content-wrapper.collapsed > * {
            opacity: 0;
            pointer-events: none;
        }

        #questionGridContainer {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, 38px);
            gap: 8px;
            align-content: flex-start;
            justify-content: center;
        }

        @media (min-width: 1200px) {
            #examBody {
                display: grid;
                grid-template-columns: 1fr 2.5fr; 
                padding: 25px;
                gap: 25px;
                padding-bottom: 50px;
            }
            #examMainContent {
                order: 2;
                overflow-y: auto; 
            }
            #examSidePanel {
                order: 1;
                max-height: none;
            }
            #mobileSidebarToggle {
                display: none;
            }
            .sidebar-content-wrapper.collapsed {
                max-height: 500px;
            }
            .sidebar-content-wrapper.collapsed > * {
                opacity: 1;
                pointer-events: auto;
            }
        }
        
        #questionPanelHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        #questionPanelHeader .ragu-checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #questionPanelHeader label {
            cursor: pointer;
            font-weight: 500;
        }
        #questionPanelHeader input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        #questionHeaderNumber {
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .question-number-box {
            background-color: var(--primary-color);
            color: white;
            padding: 3px 9px;
            border-radius: 5px;
            margin-left: 8px;
            font-size: 1em;
        }


        #questionDisplayBox {
            flex-grow: 1;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 30px;
            background-color: #ffffff;
        }

        #questionContent {
            font-size: 1.1em;
            line-height: 1.7;
            margin-bottom: 30px;
            text-align: left;
        }
        
        #questionContent img, .cbt-option-label .option-text img {
            max-width: 100%;
            height: auto;
            margin: 10px 5px;
            border-radius: 5px;
            vertical-align: middle;
        }

        #cbtAnswerOptions {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .cbt-option-label {
            display: flex;
            align-items: center;
            justify-content: flex-start; 
            gap: 15px; 
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .cbt-option-label:hover {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
        }
        .cbt-option-label.selected {
            background-color: #e2f0ff;
            border-color: var(--primary-color);
        }
        .cbt-option-label input[type="radio"] {
            margin: 0; 
            flex-shrink: 0;
            width: 18px;
            height: 18px;
        }
        .cbt-option-label .option-text {
            flex-grow: 1;
            text-align: left;
        }

        #examNavigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        #examNavigation button {
            width: auto;
            padding: 10px 30px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 8px;
            margin: 0;
        }
        #prevQuestionBtn, #nextQuestionBtn {
            background-color: var(--accent-color);
        }
        #prevQuestionBtn:hover, #nextQuestionBtn:hover {
            background-color: var(--primary-color);
        }
        
        #nextQuestionBtn.submit-mode {
            background-color: var(--danger-color);
        }
        #nextQuestionBtn.submit-mode:hover {
            background-color: #c82333;
        }

        #examNavigation button:disabled {
            background-color: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .question-nav-box {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .question-nav-box:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        .question-nav-box.answered {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        .question-nav-box.current {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-color);
            transform: scale(1.05);
        }
        .question-nav-box.ragu::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 12px 12px 0;
            border-color: transparent var(--danger-color) transparent transparent;
        }

        .sidebar-footer {
            padding: 10px;
            border-top: 1px solid var(--border-color);
        }
        #submissionWarningMessage {
            color: red;
            font-weight: bold;
            text-align: center;
            font-size: 0.9em;
            min-height: 1.2em;
            margin-bottom: 0;
        }
        #submitAnswersButton {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            background-color: var(--danger-color);
            margin-bottom: 5px;
        }
        #submitAnswersButton:hover {
            background-color: #c82333;
        }
        #submitAnswersButton:disabled {
             background-color: #cccccc;
             cursor: not-allowed;
        }
        /* === [END] GAYA TAMPILAN UJIAN BARU === */

        #examFooter {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #343a40;
            color: white;
            padding: 8px 15px;
            box-sizing: border-box;
            z-index: 501; 
            text-align: center;
            font-size: 0.9em;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #studentIdentityDisplay {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
        }


        #warningOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0);
            z-index: 10;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #warningOverlay.show {
            display: flex;
            opacity: 1;
        }

        .warning-content-box {
            background: rgba(255, 255, 255, 0.03);
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: none;
            text-align: center;
            box-sizing: border-box;
            pointer-events: none;
        }

        #warningCountdown {
            font-size: 4em;
            font-weight: bold;
            color: red;
            text-shadow: 0 0 10px rgba(255,0,0,0.5);
            margin-bottom: 10px;
            pointer-events: none;
            animation: blink-smooth 1.5s infinite alternate;
        }

        @keyframes blink-smooth {
            0% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        #warningMessage {
            font-size: 1.5em;
            color: black;
            font-weight: bold;
            pointer-events: none;
        }

        #submissionConfirmationOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            pointer-events: auto;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #submissionConfirmationOverlay.show {
            display: flex;
            opacity: 1;
        }

        .submission-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            text-align: center;
            box-sizing: border-box;
        }

        #submissionConfirmationOverlay h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            font-weight: bold;
            color: #4CAF50;
        }

        #submissionConfirmationOverlay p {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 20px;
        }

        #submissionConfirmationOverlay button {
            padding: 12px 25px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #submissionConfirmationOverlay button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        #submissionConfirmationOverlay button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,128,0,0.4);
        }
        
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Gaya Spinner */
        #loadingSpinner {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
            background-color: rgba(224, 224, 224, 0.8);
            z-index: 10000;
            transition: opacity 0.3s ease-in-out;
        }

        #loadingSpinner .spinner-border {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }

        #loadingSpinner p {
            font-size: 1.2em;
            color: #555;
            font-weight: bold;
        }

        /* Gaya untuk Overlay Blokir Akses */
        #accessBlockedOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #e0e0e0;
            z-index: 9999;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }

        .blocked-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            text-align: center;
            box-sizing: border-box;
        }

        .blocked-content h1 {
            font-size: 2em;
            color: #dc3545; /* Merah */
            font-weight: bold;
            margin-bottom: 15px;
            cursor: default;
        }

        .blocked-content p {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        /* Container kontrol akses admin yang tersembunyi */
        #adminAccessControls {
            display: none;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .password-input-container {
            position: relative;
            margin-bottom: 15px;
        }

        .password-input-container input {
            padding-right: 45px;
        }
        
        .password-toggle-icon {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            cursor: pointer;
            color: #888;
            width: 24px;
            height: 24px;
        }
        
        .password-toggle-icon:hover {
            color: #333;
        }

        #unlockAccessBtn {
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 8px;
            width: 100%;
        }

        #unlockMessage {
            color: red;
            font-size: 0.9em;
            margin-top: 10px;
            min-height: 1.2em;
        }

        @media (max-width: 1200px) {
            #examBody {
                display: flex;
                flex-direction: column;
            }
            #examMainContent {
                order: 2;
                flex-grow: 1;
                overflow: visible; 
            }
            #examSidePanel {
                order: 1;
                flex-shrink: 0;
            }
            #mobileSidebarToggle {
                display: block;
            }
            #questionGridContainer {
                grid-template-columns: repeat(auto-fill, 38px);
                gap: 6px; 
                justify-content: center;
            }
            .question-nav-box {
                font-size: 0.85em; 
            }
            .sidebar-footer {
                padding: 10px;
            }
            #submitAnswersButton {
                font-size: 1em;
                padding: 10px;
            }
            #submissionWarningMessage {
                margin-bottom: 5px;
            }
        }

        @media (max-width: 580px) {
            #confirmModal .modal-content, .custom-modal-content, .submission-content, .blocked-content {
                max-width: 95%; width: 95%;
            }
            #examBody {
                padding: 15px;
                gap: 15px;
            }
            #questionDisplayBox {
                padding: 15px;
            }
            #warningCountdown { font-size: 3em; }
            #warningMessage { font-size: 1.2em; }
            /* Sesuaikan ukuran timer dan tombol di layar kecil */
            .sidebar-header #timerText {
                 font-size: 1.8em; /* Sedikit dikecilkan agar muat */
            }
            #updateSoalBtn {
                 top: 40px; /* Naikkan di mobile agar tidak tertutup navbar */
                 padding: 5px 10px;
                 font-size: 0.75em;
            }
        }

        /* Overlay Spinner khusus Update/Refresh */
        #updateSpinnerOverlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center; align-items: center; flex-direction: column;
            color: white;
        }
        #updateSpinnerOverlay .spinner-border {
            width: 40px; height: 40px; border: 4px solid #fff; border-top: 4px solid transparent; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }

        /* === TOAST NOTIFIKASI === */
        #toastNotification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 25px;
            border-radius: 50px;
            color: white;
            font-weight: bold;
            z-index: 3000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease, transform 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.95em;
        }
        .toast-show {
            opacity: 1 !important;
            transform: translateX(-50%) translateY(10px) !important;
        }
        .toast-success {
            background-color: #28a745;
        }
        .toast-error {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    
    <div id="loadingSpinner">
        <div class="spinner-border"></div>
        <p>Memuat aplikasi...</p>
    </div>

    <!-- Spinner Khusus Update Soal -->
    <div id="updateSpinnerOverlay">
        <div class="spinner-border"></div>
        <p>Mengunduh soal terbaru...</p>
    </div>

    <!-- Toast Notification -->
    <div id="toastNotification"></div>
    
    <div id="accessBlockedOverlay">
        <div class="blocked-content">
            <h1 id="blockedTitle" class="no-select">AKSES DIBLOKIR</h1>
            <p>Ujian hanya bisa diakses melalui aplikasi yang sudah disosialisasikan. Silahkan hubungi Admin jika terdapat kendala.</p>
            
            <!-- TOMBOL DOWNLOAD APLIKASI (TAB BARU) -->
            <button id="btnDownloadApp" style="display: block; width: 100%; margin-bottom: 20px; padding: 15px; border-radius: 8px; font-weight: bold; background-color: #343a40; color: white; border: none;">
                DOWNLOAD APLIKASI
            </button>
            
            <div id="adminAccessControls">
                <div class="password-input-container">
                    <input type="password" id="unlockKeyInput" placeholder="Masukkan Kunci Akses">
                    <span class="password-toggle-icon" id="togglePasswordVisibility">
                         <svg id="eye-open" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                         <svg id="eye-closed" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>
                    </span>
                </div>
                <button id="unlockAccessBtn">BUKA AKSES</button>
            </div>
            
            <p id="unlockMessage"></p>
        </div>
    </div>

    <div id="welcomeScreen" class="welcome-screen">
        <h2 id="welcomeTitle">SELAMAT DATANG</h2>
        <p id="welcomeMessage">Memuat pilihan ujian...</p>
        <div id="welcomeButtonsContainer" style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Tombol dinamis akan dimuat di sini -->
        </div>
    </div>

    <div id="loginContainer" class="container">
        <div class="header-box">
            <div id="backToWelcomeBtn" class="back-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <img src="https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/logosmpn2pjg.png" alt="Logo" class="logo" />
            <div class="title">SMPN 2 PAJANGAN</div>
        </div>
        <div class="card-body">
            <div class="judul-ujian" id="loginJudulUjian">UJIAN KELAS</div>
            
            <div id="locationBlockedDiv" style="display: none; color: red; margin-bottom: 10px; font-weight: bold; text-align: center;"></div>
             
            <div id="locationKeyContainer" style="display: none;">
                <p>Jika lokasi tetap tidak valid, silahkan hubungi pengawas untuk mendapatkan kunci akses lokasi.</p>
                <div class="password-input-container">
                    <input type="password" id="locationKeyInput" placeholder="Masukkan Kunci Akses">
                    <span class="password-toggle-icon" id="toggleLocationKeyVisibility">
                        <svg id="loc-eye-open" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        <svg id="loc-eye-closed" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>
                    </span>
                </div>
                <button id="validateLocationKeyBtn">Validasi Kunci</button>
                <p class="message" id="locationKeyMessage"></p>
            </div>
            
            <p class="message" id="message"></p>
            <p id="locationStatus" style="color: gray; font-size: 12px; text-align: center; display: none;">Memuat status lokasi...</p>

            <div id="mainLoginControls" style="display: none;">
                <div class="custom-dropdown-container">
                    <div id="customSelectKelasDisplay" class="custom-dropdown-display" data-placeholder="-- Pilih Kelas --">
                        -- Pilih Kelas --
                    </div>
                    <input type="hidden" id="selectKelas" value="" />
                </div>

                <div class="custom-dropdown-container">
                    <div id="customSelectNamaSiswaDisplay" class="custom-dropdown-display" data-placeholder="-- Pilih Nama Siswa --">
                        -- Pilih Nama Siswa --
                    </div>
                    <input type="hidden" id="selectNamaSiswa" value="" />
                </div>

                <div class="token-input-group">
                    <input type="text" id="inputTokenPrefix" placeholder="TOKEN (contoh: ABCDE)" />
                    <span class="token-separator">-</span>
                    <input type="text" id="displayStudentId" placeholder="ID Siswa" readonly />
                </div>

                <button id="loginBtn">Login</button>
            </div>
        </div>
        <div class="footer">
            © Admin SMPN 2 Pajangan<br>
            <span id="datetime"></span>
        </div>
    </div>

    
    <div id="examContainer" style="display: none;">
        <!-- Tombol Update Soal Kembali ke Body (Floating) -->
        <button id="updateSoalBtn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            UPDATE SOAL
        </button>

        <div id="examBody">
            <div id="examSidePanel">
                <div class="sidebar-header">
                    <!-- Tombol Refresh di dalam Header (Kiri) -->
                    <button id="refreshSoalBtn" title="Refresh">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Refresh
                    </button>
                    
                    <span id="timerText">00:00</span>
                    
                    <button id="mobileSidebarToggle">
                        <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </button>
                </div>
                <div class="sidebar-content-wrapper">
                    <div id="questionGridContainer"></div>
                    <div class="sidebar-footer">
                        <p id="submissionInfoMessage" style="font-size: 0.85em; color: var(--warning-color); margin-bottom: 8px; text-align: center; display: none;"></p>
                        <button id="submitAnswersButton" disabled>KIRIM JAWABAN</button>
                        <p id="submissionWarningMessage"></p>
                    </div>
                </div>
            </div>
            <div id="examMainContent">
                <div id="questionDisplayBox">
                    <div id="questionPanelHeader">
                        <span id="questionHeaderNumber">Soal No. 1</span>
                        <div class="header-controls-right">
                            <div class="ragu-checkbox-container">
                                <label for="raguRaguCheckbox">Ragu-ragu</label>
                                <input type="checkbox" id="raguRaguCheckbox" />
                            </div>
                        </div>
                    </div>
                    <div id="resizableContent">
                        <div id="questionContent"></div>
                        <div id="cbtAnswerOptions"></div>
                    </div>
                    <div id="examNavigation">
                        <button id="prevQuestionBtn" disabled>Sebelumnya</button>
                        <button id="nextQuestionBtn">Selanjutnya</button>
                    </div>
                </div>
            </div>
        </div>
        
        
        <div id="warningOverlay" style="display: none;">
            <div class="warning-content-box">
                <div id="warningCountdown"></div>
                <div id="warningMessage">SEGERA KIRIMKAN JAWABAN, JANGAN SAMPAI KEHABISAN WAKTU!</div>
            </div>
        </div>
        
        <div id="examFooter">
            <span id="studentIdentityDisplay"></span>
        </div>
    </div>
    
    <div id="confirmModal">
        <div class="modal-content">
            <h4>DATA UJIAN ONLINE</h4>
            <table class="info-table">
                <tr>
                    <td>ID Siswa</td>
                    <td>: <span id="modalIdSiswa"></span></td>
                </tr>
                <tr>
                    <td>Nama Lengkap</td>
                    <td>: <span id="modalNamaLengkap"></span></td>
                </tr>
                <tr>
                    <td>Kelas</td>
                    <td>: <span id="modalKelas"></span></td>
                </tr>
                <tr>
                    <td>Mapel</td>
                    <td>: <span id="modalMapel"></span></td>
                </tr>
                <tr>
                    <td>Waktu Ujian</td>
                    <td>: <span id="modalExamDuration"></span></td>
                </tr>
            </table>

            <div class="checkbox-container">
                <input type="checkbox" id="confirmCheckbox">
                <label for="confirmCheckbox">Data di atas sudah benar</label>
            </div>
            <p id="modalMessage" style="display: none;"></p>
            <div class="button-container">
                <button id="btnLanjut">Lanjutkan</button>
                <button id="btnBatal" onclick="window.tutupModal()">Batal</button>
            </div>
        </div>
    </div>

    <div id="submissionConfirmationOverlay">
        <div class="submission-content">
            <h1 id="submissionOverlayTitle"></h1>
            <p id="submissionOverlayMessage"></p>
            <button id="backToLoginFromSubmissionBtn">KEMBALI</button>
        </div>
    </div>

    <div id="classModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4 id="classModalTitle">Pilih Kelas</h4>
            <ul id="classModalList" class="custom-modal-list">
            </ul>
        </div>
    </div>

    <div id="studentModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4>Pilih Nama Siswa</h4>
            <ul id="studentModalList" class="custom-modal-list">
            </ul>
        </div>
    </div>
    
    <div id="susulanListModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4 id="susulanModalTitle">Pilih Ujian Susulan</h4>
            <ul id="susulanModalList" class="custom-modal-list">
            </ul>
            <button id="closeSusulanModalButton" onclick="window.closeSusulanListModal()">TUTUP</button>
        </div>
    </div>

    <div id="customMessageModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4 id="customMessageModalTitle"></h4>
            <p id="customMessageModalText"></p>
            <button id="customMessageModalButton" onclick="window.hideCustomMessageModal()">OK</button>
        </div>
    </div>

    <div id="customConfirmModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4 id="customConfirmModalTitle"></h4>
            <p id="customConfirmModalText"></p>
            <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                <button id="customConfirmModalConfirmBtn" style="background-color: #28a745; width: 45%;">Ya</button>
                <button id="customConfirmModalCancelBtn" style="background-color: #dc3545; width: 45%;">Tidak</button>
            </div>
        </div>
    </div>

    <div id="forceLogoutModal" class="custom-modal static-backdrop">
        <div class="custom-modal-content" style="text-align: center;">
            <h4 id="forceLogoutModalTitle" style="color: var(--danger-color);">Sesi Direset</h4>
            <p id="forceLogoutModalText">Sesi ujian Anda telah direset oleh administrator. Silakan login kembali.</p>
            <button id="forceLogoutModalButton" style="margin-top: 20px; background-color: var(--primary-color);">Logout</button>
        </div>
    </div>

    <!-- Modal KILL SWITCH: Server Down / Auth Limit -->
    <div id="serverDownModal" class="custom-modal static-backdrop">
        <div class="custom-modal-content" style="text-align: center;">
            <h4 style="color: var(--danger-color); font-weight: bold; margin-bottom: 15px;">ERROR</h4>
            <div style="margin-bottom: 20px; font-size: 1.1em; color: #333; line-height: 1.6;">
                <p style="margin-bottom: 15px;">Server sedang down, mohon tunggu sedang diperbaiki.</p>
                <p>Silahkan laporkan ke pengawas atau admin dan tunggu informasi berikutnya.</p>
            </div>
            <!-- TIDAK ADA TOMBOL -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getDatabase, ref, get, child, runTransaction, set, onValue, off, update, remove, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
        import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

        // --- KONFIGURASI MULTI-FIREBASE (Sama dengan Panel Admin) ---
        
        // 1. FIREBASE ATURAN
        const configAturan = {
            apiKey: "AIzaSyAoH-kHpL15GHnFa41ZdG7dWFUsUZ4QJKc",
            authDomain: "aturan-694fe.firebaseapp.com",
            databaseURL: "https://aturan-694fe-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aturan-694fe",
            storageBucket: "aturan-694fe.firebasestorage.app",
            messagingSenderId: "1008762962672",
            appId: "1:1008762962672:web:57815d4f3c49f211ebf835"
        };

        // 2. FIREBASE 7ABCDEF (Kelas 7)
        const config7 = {
            apiKey: "AIzaSyBkhBZw3oADXUAJ9FXY9-g7XBsSmQhzZVk",
            authDomain: "def-ab5ee.firebaseapp.com",
            databaseURL: "https://def-ab5ee-default-rtdb.firebaseio.com",
            projectId: "def-ab5ee",
            storageBucket: "def-ab5ee.firebasestorage.app",
            messagingSenderId: "129712840107",
            appId: "1:129712840107:web:ab10576fed95f735dd46ee"
        };

        // 3. FIREBASE 8ABCDEF (Kelas 8)
        const config8 = {
            apiKey: "AIzaSyAwilwwwEJ2MAdSf09BotxNH-z6RiXaHXY",
            authDomain: "abc-43e73.firebaseapp.com",
            databaseURL: "https://abc-43e73-default-rtdb.firebaseio.com",
            projectId: "abc-43e73",
            storageBucket: "abc-43e73.firebasestorage.app",
            messagingSenderId: "1043754727577",
            appId: "1:1043754727577:web:56c3732bf2a6ac900c2008"
        };

        // 4. FIREBASE 9ABCDEF (Kelas 9)
        const config9 = {
            apiKey: "AIzaSyBZ6JR3ggnUiZFQ-wdrewbfhzMUwFaGGzQ",
            authDomain: "abc-d272a.firebaseapp.com",
            databaseURL: "https://abc-d272a-default-rtdb.firebaseio.com",
            projectId: "abc-d272a",
            storageBucket: "abc-d272a.firebasestorage.app",
            messagingSenderId: "1036605132828",
            appId: "1:1036605132828:web:2b59f91290d50afe304fd9"
        };

        // Inisialisasi Apps
        const appAturan = initializeApp(configAturan, "appAturan");
        const app7 = initializeApp(config7, "app7");
        const app8 = initializeApp(config8, "app8");
        const app9 = initializeApp(config9, "app9");

        // Inisialisasi Auth & Database untuk setiap App
        const authAturan = getAuth(appAturan);
        const dbAturan = getDatabase(appAturan);

        const auth7 = getAuth(app7);
        const db7 = getDatabase(app7);

        const auth8 = getAuth(app8);
        const db8 = getDatabase(app8);

        const auth9 = getAuth(app9);
        const db9 = getDatabase(app9);

        // State Global untuk menyimpan DB aktif
        let currentDb = null;
        let currentAuth = null;
        let currentSelectedGrade = null;

        // Fungsi Helper untuk memilih DB berdasarkan Jenjang Kelas
        function getDbForGrade(grade) {
            const g = String(grade);
            if (g === '7') return { db: db7, auth: auth7 };
            if (g === '8') return { db: db8, auth: auth8 };
            if (g === '9') return { db: db9, auth: auth9 };
            return null;
        }

        // Fungsi Login Otomatis ke SEMUA Firebase (Anonim)
        async function performAnonymousLogin() {
            try {
                // Login ke semua instance secara paralel
                await Promise.all([
                    signInAnonymously(authAturan),
                    signInAnonymously(auth7),
                    signInAnonymously(auth8),
                    signInAnonymously(auth9)
                ]);
                console.log("Login otomatis ke semua server berhasil.");
                return true;
            } catch (error) {
                console.error("Gagal login otomatis:", error);
                window.showCustomMessageModal("Kesalahan Autentikasi", `Gagal mengautentikasi ke database. Mohon hubungi administrator.`, 'error');
                return false;
            }
        }

        function getDbRefs() {
            if (!currentDb) {
                console.error("Instance database (currentDb) tidak diinisialisasi.");
                return null;
            }
            return {
                studentsRef: ref(currentDb, 'students'),
                tokensRef: ref(currentDb, 'tokens'),
                examAccessStatusRef: ref(currentDb, 'exam_access_status'),
                submittedExamsRef: ref(currentDb, 'submitted_exams'),
                studentAnswersRef: ref(currentDb, 'student_answers'),
                ujianRef: ref(currentDb, 'ujian')
            };
        }
        
        function getSetupDbRefs() {
             // Menggunakan dbAturan untuk pengaturan global
             return {
                settingsRef: ref(dbAturan, 'setlokasi'),
                minDurationSettingsRef: ref(dbAturan, 'min_duration_settings'),
                publicSettingsRef: ref(dbAturan, 'publicSettings'),
                shuffleSettingsRef: ref(dbAturan, 'acaksoalpilgan'),
                blockKeySettingsRef: ref(dbAturan, 'block_key_settings')
            };
        }

        let isLocationEnabled = true;
        let firebaseAllowedRadiusKm = 0.075;
        let locationAccessKey = "";
        let isBlockEnabled = false;
        let blockAccessKey = "";
        let minDurationSettingsGlobal = { isMinDurationEnabled: false, minDurationSeconds: 1800 };
        let isSoalAcakEnabled = true;
        let isPilganAcakEnabled = true;
        let publicSettings = null;

        const allowedLatitude = -7.8589546;
        const allowedLongitude = 110.2655596;

        const loadingSpinner = document.getElementById('loadingSpinner');
        const accessBlockedOverlay = document.getElementById('accessBlockedOverlay');
        const unlockKeyInput = document.getElementById('unlockKeyInput');
        const unlockAccessBtn = document.getElementById('unlockAccessBtn');
        const unlockMessage = document.getElementById('unlockMessage');
        const togglePasswordVisibility = document.getElementById('togglePasswordVisibility');
        const blockedTitle = document.getElementById('blockedTitle'); 
        const adminAccessControls = document.getElementById('adminAccessControls'); 

        const welcomeScreen = document.getElementById('welcomeScreen');
        const welcomeTitle = document.getElementById('welcomeTitle');
        const welcomeMessageElement = document.getElementById('welcomeMessage');
        const welcomeButtonsContainer = document.getElementById('welcomeButtonsContainer');
        const loginContainer = document.getElementById('loginContainer');
        const examContainer = document.getElementById('examContainer');
        const timerText = document.getElementById('timerText');
        const warningOverlay = document.getElementById('warningOverlay');
        const warningCountdown = document.getElementById('warningCountdown');

        const locationBlockedDiv = document.getElementById('locationBlockedDiv');
        const locationKeyContainer = document.getElementById('locationKeyContainer');
        const mainLoginControls = document.getElementById('mainLoginControls');
        const message = document.getElementById('message');
        const loginBtn = document.getElementById('loginBtn');
        const confirmModal = document.getElementById('confirmModal');
        const locationStatus = document.getElementById('locationStatus');
        
        const inputTokenPrefix = document.getElementById('inputTokenPrefix');
        const displayStudentId = document.getElementById('displayStudentId');
        
        const customSelectKelasDisplay = document.getElementById('customSelectKelasDisplay');
        const hiddenSelectKelas = document.getElementById('selectKelas');
        const customSelectNamaSiswaDisplay = document.getElementById('customSelectNamaSiswaDisplay');
        const hiddenSelectNamaSiswa = document.getElementById('selectNamaSiswa');

        const confirmCheckbox = document.getElementById('confirmCheckbox');
        const modalMessage = document.getElementById('modalMessage');
        const modalExamDuration = document.getElementById('modalExamDuration');

        const submissionConfirmationOverlay = document.getElementById('submissionConfirmationOverlay');
        const submissionOverlayTitle = document.getElementById('submissionOverlayTitle');
        const submissionOverlayMessage = document.getElementById('submissionOverlayMessage');
        const backToLoginFromSubmissionBtn = document.getElementById('backToLoginFromSubmissionBtn');
        
        const forceLogoutModal = document.getElementById('forceLogoutModal');
        const forceLogoutModalButton = document.getElementById('forceLogoutModalButton');
        
        const updateSoalBtn = document.getElementById('updateSoalBtn');
        const refreshSoalBtn = document.getElementById('refreshSoalBtn');
        const updateSpinnerOverlay = document.getElementById('updateSpinnerOverlay');
        const toastNotification = document.getElementById('toastNotification');

        const classModal = document.getElementById('classModal');
        const classModalList = document.getElementById('classModalList');
        const studentModal = document.getElementById('studentModal');
        const studentModalList = document.getElementById('studentModalList');
        const susulanListModal = document.getElementById('susulanListModal');
        
        const questionGridContainer = document.getElementById('questionGridContainer');
        const submitAnswersButton = document.getElementById('submitAnswersButton');
        const submissionWarningMessage = document.getElementById('submissionWarningMessage');
        const questionHeaderNumber = document.getElementById('questionHeaderNumber');
        const questionContent = document.getElementById('questionContent');
        const cbtAnswerOptions = document.getElementById('cbtAnswerOptions');
        const prevQuestionBtn = document.getElementById('prevQuestionBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const raguRaguCheckbox = document.getElementById('raguRaguCheckbox');

        const loginJudulUjian = document.getElementById('loginJudulUjian');
        
        let allStudentsData = [];
        let selectedStudentData = null;
        let isLocationValid = false;
        let foundTokenGlobal = null;
        let timerInterval;
        let remainingTime;
        let accessStatusListenerRef = null;
        let accessStatusListenerPath = null;
        let examUpdateListenerRef = null;
        let examUpdateListenerPath = null;
        let localTerakhirUpdate = "";
        let isInExamMode = false;
        let isAnyModalOpen = false;
        let currentExamQuestions = [];
        let studentAnswers = [];
        let raguRaguStatus = [];
        let currentQuestionIndex = 0;
        let shuffledQuestionIndices = [];
        let shuffledOptionOrders = [];
        let sidebarCollapseTimer = null;
        let longPressTimer;

        // [TAMBAHAN] Variabel untuk listener durasi
        let minDurationListenerRef = null;

        const customMessageModal = document.getElementById('customMessageModal');
        const customMessageModalTitle = document.getElementById('customMessageModalTitle');
        const customMessageModalText = document.getElementById('customMessageModalText');

        const customConfirmModal = document.getElementById('customConfirmModal');
        const customConfirmModalTitle = document.getElementById('customConfirmModalTitle');
        const customConfirmModalText = document.getElementById('customConfirmModalText');
        const customConfirmModalConfirmBtn = document.getElementById('customConfirmModalConfirmBtn');
        const customConfirmModalCancelBtn = document.getElementById('customConfirmModalCancelBtn');

        let manualSubmissionInProgress = false;
        let submissionStatusListenerRef = null;
        let submissionStatusListenerPath = null;

        // Fungsi Notifikasi Toast
        function showToast(message, type) {
            toastNotification.textContent = message;
            toastNotification.className = ''; // Reset class
            toastNotification.classList.add(type === 'success' ? 'toast-success' : 'toast-error');
            toastNotification.classList.add('toast-show');
            setTimeout(() => {
                toastNotification.classList.remove('toast-show');
            }, 1500);
        }

        function setupPasswordToggle(toggleEl, inputEl, openIcon, closedIcon) {
            if (!toggleEl || !inputEl || !openIcon || !closedIcon) return;
            toggleEl.addEventListener('click', () => {
                const isPassword = inputEl.type === 'password';
                inputEl.type = isPassword ? 'text' : 'password';
                openIcon.style.display = isPassword ? 'none' : 'block';
                closedIcon.style.display = isPassword ? 'block' : 'none';
            });
        }

        function startSidebarCollapseTimer() {
            clearTimeout(sidebarCollapseTimer);
            if (window.innerWidth < 992 && !document.querySelector('.sidebar-content-wrapper').classList.contains('collapsed')) {
                sidebarCollapseTimer = setTimeout(() => {
                    const wrapper = document.querySelector('.sidebar-content-wrapper');
                    const toggleBtn = document.getElementById('mobileSidebarToggle');
                    wrapper.classList.add('collapsed');
                    toggleBtn.classList.remove('up');
                }, 10000);
            }
        }

        function padStudentId(id) {
            return String(id).padStart(3, '0');
        }

        function isTouchDevice() {
            return window.matchMedia('(pointer: coarse)').matches;
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c;
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('datetime').textContent = now.toLocaleDateString('id-ID', options);
        }

        function isAllowedEnvironment() {
            const ua = navigator.userAgent.toLowerCase();
            const platform = navigator.platform.toLowerCase();
            
            const isMesinAndroid = platform.includes('linux') || platform.includes('android');
            const isMesinIos = platform.includes('iphone') || platform.includes('ipad') || (platform.includes('mac') && navigator.maxTouchPoints > 1);

            const ngakuIphone = ua.includes('iphone') || ua.includes('ipad');
            const isSEB = ua.includes('seb/');

            if (isMesinAndroid && ngakuIphone && !ua.includes('safari')) {
                return true;
            }

            // KEMBALI KE LOGIKA AWAL:
            // Hanya izinkan SEB jika BUKAN iOS.
            // Ini memaksa pengguna iOS (meski pakai SEB) untuk tetap kena blokir
            // sehingga mereka bisa menekan tombol 'UJIAN KHUSUS IPHONE' untuk memuat config.
            if (isSEB && !isMesinIos) {
                return true;
            }

            return false;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        window.formatTokenPrefix = function (inputElement) {
            if (!inputElement || typeof inputElement.value === 'undefined') {
                return;
            }
            const tokenInputGroup = inputElement.closest('.token-input-group');
            if (tokenInputGroup) {
                tokenInputGroup.classList.remove('is-valid', 'is-invalid');
            }
            let value = inputElement.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            inputElement.value = value;
            if (value.length > 0) {
                if (tokenInputGroup) tokenInputGroup.classList.add('is-valid');
            } else {
                if (tokenInputGroup) tokenInputGroup.classList.remove('is-valid');
            }
            updateLoginButtonStatus();
        };

        function updateLoginButtonStatus() {
            const isLocationCheckPassed = isLocationValid;
            const isClassAndStudentSelected = hiddenSelectKelas.value !== "" && hiddenSelectNamaSiswa.value !== "";
            const isTokenPrefixFilled = inputTokenPrefix.value.trim() !== "";
            const isStudentIdDisplayed = displayStudentId.value.trim() !== "";

            if (isClassAndStudentSelected) {
                inputTokenPrefix.disabled = false;
            } else {
                inputTokenPrefix.disabled = true;
                inputTokenPrefix.value = "";
                const tokenInputGroup = inputTokenPrefix.closest('.token-input-group');
                if (tokenInputGroup) tokenInputGroup.classList.remove('is-valid', 'is-invalid');
            }

            if (hiddenSelectKelas.value === "") {
                customSelectNamaSiswaDisplay.classList.add('disabled');
            } else {
                customSelectNamaSiswaDisplay.classList.remove('disabled');
            }

            if (isLocationCheckPassed && isClassAndStudentSelected && isTokenPrefixFilled && isStudentIdDisplayed) {
                loginBtn.disabled = false;
                loginBtn.style.opacity = 1;
            } else {
                loginBtn.disabled = true;
                loginBtn.style.opacity = 0.6;
            }
        }

        window.tutupModal = async function () {
            confirmModal.classList.remove('show');
            isAnyModalOpen = false;
            message.textContent = "";
            modalMessage.textContent = "";
            confirmCheckbox.checked = false;
            updateLoginButtonStatus();
            sessionStorage.clear();
        };
        
        function showLocationFailureScreen(errorText, showKeyInput = false) {
            locationBlockedDiv.textContent = errorText;
            locationBlockedDiv.style.display = 'block';
            if (showKeyInput) {
                locationKeyContainer.style.display = 'block';
            } else {
                locationKeyContainer.style.display = 'none';
            }
            mainLoginControls.style.display = 'none';
            locationStatus.style.display = 'none';
            isLocationValid = false;
        }
        
        function showMainLoginForm() {
            locationKeyContainer.style.display = 'none';
            locationBlockedDiv.style.display = 'none';
            locationStatus.style.display = 'none';
            mainLoginControls.style.display = 'block';
            isLocationValid = true;
            updateLoginButtonStatus();
        }

        function checkLocation(latitude, longitude) {
            const distance = getDistanceFromLatLonInKm(allowedLatitude, allowedLongitude, latitude, longitude);
            if (distance <= firebaseAllowedRadiusKm) {
                showMainLoginForm();
                locationStatus.textContent = "Lokasi valid.";
                locationStatus.style.color = "green";
                locationStatus.style.display = 'block';
            } else {
                const errorText = `Lokasi Anda saat ini berada ${distance.toFixed(2)} km dari radius yg diizinkan! keluar aplikasi, hidupkan mode pesawat dan matikan lokasi. Kemudian matikan mode pesawat, hidupkan lokasi dan coba akses ujian kembali`;
                showLocationFailureScreen(errorText, true);
            }
        }

        function handleLocation(position) {
            checkLocation(position.coords.latitude, position.coords.longitude);
        }

        function handleLocationError(error) {
            let errorMessage;
            let showKey = true;
            if (error && typeof error.code === 'number') {
                switch (error.code) {
                    case 1: 
                        errorMessage = "Aktifkan lokasi di perangkat Anda! keluar aplikasi, hidupkan mode pesawat dan matikan lokasi. Kemudian matikan mode pesawat, hidupkan lokasi dan coba akses ujian kembali";
                        showKey = false;
                        break;
                    case 2: 
                        errorMessage = "Informasi lokasi tidak tersedia saat ini. Pastikan GPS aktif dan sinyal memadai.";
                        break;
                    case 3: 
                        errorMessage = "Waktu permintaan lokasi habis. Mohon coba refresh halaman.";
                        break;
                    default:
                        errorMessage = "Terjadi kesalahan lokasi yang tidak diketahui (Kode: " + error.code + ").";
                        break;
                }
            } else if (error && error.message) {
                 errorMessage = `Terjadi kesalahan lokasi: ${error.message}`;
            } else {
                errorMessage = "Gagal mengakses layanan lokasi. Pastikan GPS dan izin lokasi untuk aplikasi ini telah diaktifkan.";
                showKey = false;
            }
            showLocationFailureScreen(errorMessage, showKey);
        }

        function getLocation() {
            if (isLocationEnabled && isTouchDevice()) {
                locationStatus.style.display = 'block';
                locationStatus.textContent = 'Memvalidasi lokasi...';
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(handleLocation, handleLocationError, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                } else {
                    showLocationFailureScreen('Layanan Geolocation tidak didukung oleh perangkat ini.', true);
                }
            } else {
                showMainLoginForm();
            }
        }

        // Fungsi baru untuk mengambil list kelas langsung dari DB spesifik
        function loadClassDropdownForGrade(grade) {
            customSelectKelasDisplay.classList.add('disabled');
            customSelectNamaSiswaDisplay.classList.add('disabled');
            inputTokenPrefix.disabled = true;
            displayStudentId.value = "";
            message.innerHTML = `Memuat daftar kelas untuk kelas ${grade}... <span class="spinner"></span>`;

            // Reset dropdown
            classModalList.innerHTML = '';
            
            // Set Database Aktif
            const instances = getDbForGrade(grade);
            if (!instances) {
                message.style.color = "red";
                message.textContent = "Gagal memuat database untuk kelas ini.";
                return;
            }
            currentDb = instances.db;
            currentAuth = instances.auth;

            // Ambil semua siswa untuk mendapatkan list kelas yang unik
            const studentsRef = ref(currentDb, 'students');
            
            // Mengambil semua siswa lalu memfilter kelas unik di client-side
            // Ini karena structure DB students flat list
            get(studentsRef).then((snapshot) => {
                const classSet = new Set();
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const studentData = childSnapshot.val();
                        if (studentData.class) {
                            classSet.add(studentData.class);
                        }
                    });
                }

                // Ubah Set ke Array dan Sortir
                const classNames = Array.from(classSet).sort();

                if (classNames.length > 0) {
                    classNames.forEach(cls => {
                        const listItem = document.createElement('li');
                        listItem.textContent = cls;
                        listItem.dataset.value = cls;
                        listItem.addEventListener('click', () => selectClass(cls));
                        classModalList.appendChild(listItem);
                    });
                    customSelectKelasDisplay.classList.remove('disabled');
                    message.textContent = "";
                } else {
                    message.style.color = "orange";
                    message.textContent = `Belum ada data kelas untuk Kelas ${grade}.`;
                }
            }).catch((error) => {
                console.error("Gagal memuat list kelas:", error);
                message.style.color = "red";
                message.textContent = "Gagal memuat daftar kelas.";
            });
        }

        async function loadStudentsAndFilterByClass() {
            if (!currentDb) {
                message.style.color = "red";
                message.textContent = "Database belum diinisialisasi. Pilih jenjang kelas terlebih dahulu.";
                return;
            }
            const dbRefs = getDbRefs();
            if (!dbRefs) return;

            customSelectNamaSiswaDisplay.classList.add('disabled');
            inputTokenPrefix.disabled = true;
            displayStudentId.value = "";
            
            const selectedClass = hiddenSelectKelas.value;
            message.innerHTML = `Mengunduh data ${selectedClass}... <span class="spinner"></span>`;

            try {
                // Query Siswa berdasarkan kelas
                const studentsQuery = query(dbRefs.studentsRef, orderByChild('class'), equalTo(selectedClass));
                const snapshot = await get(studentsQuery);
                
                if (snapshot.exists()) {
                    allStudentsData = [];
                    snapshot.forEach(childSnapshot => {
                        const studentData = childSnapshot.val();
                        allStudentsData.push({ ...studentData, key: childSnapshot.key });
                    });

                    if (allStudentsData.length > 0) {
                        filterStudentsByClass();
                        message.textContent = "";
                    } else {
                          message.style.color = "orange";
                          message.textContent = "Tidak ada data siswa ditemukan untuk kelas ini.";
                          studentModalList.innerHTML = '';
                          customSelectNamaSiswaDisplay.textContent = customSelectNamaSiswaDisplay.dataset.placeholder;
                    }
                } else {
                    message.style.color = "orange";
                    message.textContent = "Tidak ada data siswa ditemukan untuk kelas ini.";
                    studentModalList.innerHTML = '';
                    customSelectNamaSiswaDisplay.textContent = customSelectNamaSiswaDisplay.dataset.placeholder;
                }
            } catch (error) {
                console.error("Gagal memuat data siswa:", error);
                message.style.color = "red";
                // Penanganan khusus jika index belum di-set di Firebase Rules
                if (error.message && error.message.includes('Index not defined')) {
                    message.textContent = "Error Database: Index 'class' belum diatur di Rules.";
                } else {
                    message.textContent = "Gagal memuat data. Periksa koneksi internet.";
                }
            }
        }

        function filterStudentsByClass() {
            const selectedClass = hiddenSelectKelas.value;
            studentModalList.innerHTML = '';
            hiddenSelectNamaSiswa.value = '';
            customSelectNamaSiswaDisplay.textContent = customSelectNamaSiswaDisplay.dataset.placeholder;
            customSelectNamaSiswaDisplay.classList.remove('selected');
            selectedStudentData = null;
            displayStudentId.value = "";
            inputTokenPrefix.value = "";
            const tokenInputGroup = inputTokenPrefix.closest('.token-input-group');
            if (tokenInputGroup) tokenInputGroup.classList.remove('is-valid', 'is-invalid');

            if (selectedClass) {
                const filteredStudents = allStudentsData; 
                filteredStudents.sort((a, b) => String(a.name || '').localeCompare(String(b.name || ''))).forEach(student => {
                    const listItem = document.createElement('li');
                    listItem.textContent = student.name;
                    listItem.dataset.value = student.id;
                    listItem.addEventListener('click', () => selectStudent(student.id, student.name));
                    studentModalList.appendChild(listItem);
                });
                customSelectNamaSiswaDisplay.classList.remove('disabled');
            } else {
                customSelectNamaSiswaDisplay.classList.add('disabled');
            }
            updateLoginButtonStatus();
        }

        function openClassModal() {
            if (customSelectKelasDisplay.classList.contains('disabled')) return;
            classModal.classList.add('show');
            isAnyModalOpen = true;
        }

        function closeClassModal() {
            classModal.classList.remove('show');
            isAnyModalOpen = false;
        }

        async function selectClass(className) {
            hiddenSelectKelas.value = className;
            customSelectKelasDisplay.textContent = className;
            customSelectKelasDisplay.classList.add('selected');
            closeClassModal();

            customSelectNamaSiswaDisplay.classList.add('disabled');
            customSelectNamaSiswaDisplay.innerHTML = 'Memuat... <span class="spinner" style="width:12px;height:12px;border-width:2px;"></span>';
            
            inputTokenPrefix.disabled = true;
            displayStudentId.value = "";
            
            // Load siswa dari DB yang sudah di-set saat pilih Grade
            await loadStudentsAndFilterByClass();
            updateLoginButtonStatus();
        }

        function openStudentModal() {
            if (customSelectNamaSiswaDisplay.classList.contains('disabled')) return;
            studentModal.classList.add('show');
            isAnyModalOpen = true;
        }

        function closeStudentModal() {
            studentModal.classList.remove('show');
            isAnyModalOpen = false;
        }

        function selectStudent(studentId, studentName) {
            hiddenSelectNamaSiswa.value = studentId;
            customSelectNamaSiswaDisplay.textContent = studentName;
            customSelectNamaSiswaDisplay.classList.add('selected');
            selectedStudentData = allStudentsData.find(student => padStudentId(student.id) === padStudentId(studentId));
            displayStudentId.value = padStudentId(studentId);
            closeStudentModal();
            updateLoginButtonStatus();
        }
        
        function updateSubmissionButtonState() {
            if (!submitAnswersButton || !nextQuestionBtn) return;

            let isDisabled = true;
            const allAnswered = !studentAnswers.includes(null);
            const infoEl = document.getElementById('submissionInfoMessage');
            let timeConstraintActive = false;

            if (minDurationSettingsGlobal.isMinDurationEnabled) {
                if (remainingTime > minDurationSettingsGlobal.minDurationSeconds) {
                    isDisabled = true;
                    timeConstraintActive = true;
                    if (infoEl) {
                        const thresholdMins = Math.ceil(minDurationSettingsGlobal.minDurationSeconds / 60);
                        infoEl.textContent = `TOMBOL KIRIM AKAN AKTIF JIKA SISA WAKTU KURANG DARI ${thresholdMins} MENIT`;
                        infoEl.style.display = 'block';
                    }
                } else {
                    isDisabled = !allAnswered;
                    if (infoEl) infoEl.style.display = 'none';
                }
            } else {
                isDisabled = !allAnswered;
                if (infoEl) infoEl.style.display = 'none';
            }

            submitAnswersButton.disabled = isDisabled;
            if (currentQuestionIndex === currentExamQuestions.length - 1) {
                nextQuestionBtn.disabled = isDisabled;
            }
        }

        function updateTimerDisplay() {
            if (!timerText) return;
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerText.textContent = formattedTime;
            updateSubmissionButtonState();

            if (remainingTime <= 300 && remainingTime > 0) {
                timerText.style.color = 'var(--danger-color)';
                warningCountdown.textContent = formattedTime;
                warningOverlay.classList.add('show');
            } else {
                timerText.style.color = 'var(--danger-color)';
                warningOverlay.classList.remove('show');
            }

            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                timerText.textContent = "00:00";
                warningOverlay.classList.remove('show');
                if (submitAnswersButton) submitAnswersButton.disabled = true;
                submitAnswers(true);
                return;
            }
            remainingTime--;
        }

        async function showSubmissionConfirmationOverlay(isAutoSubmit) {
            const tokenFirebaseKey = foundTokenGlobal?.key;
            const studentId = selectedStudentData?.id ? padStudentId(selectedStudentData.id) : null;
            const dbRefs = getDbRefs();
            
            sessionStorage.clear();
            stopAccessStatusListener();
            stopSubmissionStatusListener();
            stopExamUpdateListener();
            stopMinDurationListener(); 
            
            loginContainer.style.display = 'none';
            examContainer.style.opacity = 0;

            setTimeout(() => {
                examContainer.style.display = 'none';
                submissionConfirmationOverlay.classList.add('show');
                document.body.style.overflow = 'hidden';
                if (timerInterval) clearInterval(timerInterval);
                
                isInExamMode = false;
                toggleExamSecurityFeatures(false);
                isAnyModalOpen = true;

                if (isAutoSubmit) {
                    submissionOverlayTitle.innerHTML = '<span style="color: red; font-weight: bold;">WAKTU HABIS</span>';
                    submissionOverlayMessage.innerText = 'Jawaban kamu otomatis terkirim.';
                } else {
                    submissionOverlayTitle.innerText = 'SELAMAT!';
                    submissionOverlayTitle.style.color = '#4CAF50';
                    submissionOverlayMessage.innerText = 'JAWABAN ANDA BERHASIL TERKIRIM!';
                }

                const backBtn = document.getElementById('backToLoginFromSubmissionBtn');
                backBtn.innerText = 'KEMBALI';
                
                backBtn.onclick = async () => {
                    backBtn.disabled = true;
                    backBtn.textContent = 'MEMUAT...';
                    if (dbRefs && tokenFirebaseKey && studentId) {
                        try {
                            const accessStatusRef = child(dbRefs.examAccessStatusRef, `${tokenFirebaseKey}/${studentId}`);
                            await update(accessStatusRef, { isLoggedIn: false });
                        } catch (err) {
                            console.error("Gagal saat failsafe logout:", err);
                        }
                    }
                    window.location.reload(true);
                };
            }, 500);
        }

        function hideSubmissionConfirmationOverlay() {
            submissionConfirmationOverlay.classList.remove('show');
            setTimeout(() => {
                document.body.style.overflow = '';
                isAnyModalOpen = false;
            }, 300);
        }

        function toggleExamSecurityFeatures(enable) {
            if (enable) {
                document.addEventListener('copy', preventDefaultBehavior);
                document.addEventListener('cut', preventDefaultBehavior);
                document.addEventListener('paste', preventDefaultBehavior);
                document.body.classList.add('no-select');
                document.addEventListener('selectstart', preventDefaultBehavior);
                document.addEventListener('contextmenu', preventDefaultBehavior);
            } else {
                document.removeEventListener('copy', preventDefaultBehavior);
                document.removeEventListener('cut', preventDefaultBehavior);
                document.removeEventListener('paste', preventDefaultBehavior);
                document.body.classList.remove('no-select');
                document.removeEventListener('selectstart', preventDefaultBehavior);
                document.removeEventListener('contextmenu', preventDefaultBehavior);
            }
        }

        function preventDefaultBehavior(e) {
            e.preventDefault();
            return false;
        }
        
        async function startExamProcess(examDurationMinutes, examStartTime, initialData) {
            if (initialData.shuffledQuestionIndices && initialData.shuffledOptionOrders) {
                shuffledQuestionIndices = initialData.shuffledQuestionIndices;
                shuffledOptionOrders = initialData.shuffledOptionOrders;
            } else {
                shuffledQuestionIndices = Array.from({ length: currentExamQuestions.length }, (_, i) => i);
                if (isSoalAcakEnabled) shuffleArray(shuffledQuestionIndices);

                shuffledOptionOrders = currentExamQuestions.map(() => {
                    const options = ['A', 'B', 'C', 'D'];
                    if (isPilganAcakEnabled) shuffleArray(options);
                    return options;
                });
                await saveStudentAnswersToFirebase();
            }
            
            sessionStorage.setItem('shuffledQuestionIndices', JSON.stringify(shuffledQuestionIndices));
            sessionStorage.setItem('shuffledOptionOrders', JSON.stringify(shuffledOptionOrders));
            sessionStorage.setItem('isInExamMode', 'true');
            sessionStorage.setItem('selectedStudentData', JSON.stringify(selectedStudentData));
            sessionStorage.setItem('foundTokenGlobal', JSON.stringify(foundTokenGlobal));
            sessionStorage.setItem('examData', JSON.stringify(currentExamQuestions));
            sessionStorage.setItem('examStartTime', Number(examStartTime));
            sessionStorage.setItem('examDurationMinutes', examDurationMinutes);
            sessionStorage.setItem('selectedClass', hiddenSelectKelas.value);
            sessionStorage.setItem('selectedGrade', currentSelectedGrade);
            
            if (!localTerakhirUpdate && foundTokenGlobal && foundTokenGlobal.terakhirUpdate) {
                localTerakhirUpdate = foundTokenGlobal.terakhirUpdate;
            }
            sessionStorage.setItem('localTerakhirUpdate', localTerakhirUpdate);

            const numQuestions = currentExamQuestions.length;
            studentAnswers = (initialData.answers && initialData.answers.length === numQuestions) ? initialData.answers : Array(numQuestions).fill(null);
            raguRaguStatus = (initialData.ragu && initialData.ragu.length === numQuestions) ? initialData.ragu : Array(numQuestions).fill(false);
            const lastQuestionIndex = initialData.lastQuestionIndex || 0;

            sessionStorage.setItem('studentAnswers', JSON.stringify(studentAnswers));
            sessionStorage.setItem('raguRaguStatus', JSON.stringify(raguRaguStatus));
            sessionStorage.setItem('lastQuestionIndex', lastQuestionIndex);

            loginContainer.style.opacity = 0;
            setTimeout(() => {
                loginContainer.style.display = 'none';
                examContainer.style.display = 'flex';
                setTimeout(() => {
                    examContainer.style.opacity = 1;
                    isInExamMode = true;
                    toggleExamSecurityFeatures(true);
                    updateStudentIdentityPanel();
                    currentQuestionIndex = lastQuestionIndex;
                    displayQuestion(currentQuestionIndex);
                    renderQuestionGrid();
                    updateSubmissionButtonState();
                }, 10);
            }, 500);
            
            const totalDurationSeconds = examDurationMinutes * 60;
            const elapsedSeconds = Math.floor((Date.now() - examStartTime) / 1000);
            remainingTime = totalDurationSeconds - elapsedSeconds;
            
            if (remainingTime < 0) remainingTime = 0;

            timerInterval = setInterval(updateTimerDisplay, 1000);
            updateTimerDisplay();

            history.pushState(null, '', location.href);
            startAccessStatusListener();
            startSubmissionStatusListener();
            startMinDurationListener(); 
            
            const storedExamPath = sessionStorage.getItem('currentExamPath');
            if (storedExamPath) {
                startExamUpdateListener(storedExamPath);
            }
        }

        async function restoreExamState() {
            if (sessionStorage.getItem('isInExamMode') !== 'true') return false;
            
            selectedStudentData = JSON.parse(sessionStorage.getItem('selectedStudentData'));
            foundTokenGlobal = JSON.parse(sessionStorage.getItem('foundTokenGlobal'));
            currentExamQuestions = JSON.parse(sessionStorage.getItem('examData'));
            const examDurationMinutes = parseInt(sessionStorage.getItem('examDurationMinutes'), 10);
            const selectedClass = sessionStorage.getItem('selectedClass');
            const selectedGrade = sessionStorage.getItem('selectedGrade');
            let examStartTime = Number(sessionStorage.getItem('examStartTime'));
            localTerakhirUpdate = sessionStorage.getItem('localTerakhirUpdate');

            const initialData = {
                answers: JSON.parse(sessionStorage.getItem('studentAnswers')),
                ragu: JSON.parse(sessionStorage.getItem('raguRaguStatus')),
                lastQuestionIndex: parseInt(sessionStorage.getItem('lastQuestionIndex') || '0', 10),
                shuffledQuestionIndices: JSON.parse(sessionStorage.getItem('shuffledQuestionIndices')),
                shuffledOptionOrders: JSON.parse(sessionStorage.getItem('shuffledOptionOrders'))
            };
            
            if (!selectedStudentData || !foundTokenGlobal || !currentExamQuestions || isNaN(examDurationMinutes) || !selectedClass || !selectedGrade || isNaN(examStartTime) || !initialData.shuffledQuestionIndices) {
                sessionStorage.clear();
                return false;
            }

            // Restore Grade & Theme
            currentSelectedGrade = selectedGrade;
            document.body.classList.remove('theme-kelas7', 'theme-kelas8', 'theme-kelas9');
            document.body.classList.add(`theme-kelas${selectedGrade}`);

            // Restore DB Connection based on Grade
            const instances = getDbForGrade(selectedGrade);
            if (!instances) {
                sessionStorage.clear();
                return false;
            }
            currentDb = instances.db;
            currentAuth = instances.auth;

            const elapsedSeconds = Math.floor((Date.now() - examStartTime) / 1000);
            const totalDurationSeconds = examDurationMinutes * 60;
            remainingTime = totalDurationSeconds - elapsedSeconds;

            if (remainingTime > 0) {
                welcomeScreen.style.display = 'none';
                loginContainer.style.display = 'none';
                examContainer.style.display = 'flex';
                examContainer.style.opacity = 1;
                await startExamProcess(examDurationMinutes, examStartTime, initialData);
                return true;
            } else {
                sessionStorage.clear();
                examContainer.style.display = 'flex';
                examContainer.style.opacity = 1;
                timerText.textContent = "00:00";
                updateStudentIdentityPanel();
                submitAnswers(true);
                return true;
            }
        } 

        // === [FITUR BARU] LISTENER REAL-TIME ATURAN DURASI (Di luar fungsi lain) ===
        function startMinDurationListener() {
            stopMinDurationListener(); // Pastikan tidak ada listener ganda
            
            const refs = getSetupDbRefs();
            // Gunakan onValue agar terus memantau perubahan
            minDurationListenerRef = onValue(refs.minDurationSettingsRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    
                    // Simpan status lama untuk dibandingkan
                    const oldEnabled = minDurationSettingsGlobal.isMinDurationEnabled;
                    const oldSeconds = minDurationSettingsGlobal.minDurationSeconds;

                    // Update variabel global dengan data baru dari Admin
                    minDurationSettingsGlobal.isMinDurationEnabled = data.isMinDurationEnabled ?? false;
                    minDurationSettingsGlobal.minDurationSeconds = data.minDurationSeconds ?? 1800;

                    // Jika sedang dalam ujian, cek apakah ada perubahan signifikan
                    if (isInExamMode) {
                        const hasChanged = (oldEnabled !== minDurationSettingsGlobal.isMinDurationEnabled) || 
                                           (oldSeconds !== minDurationSettingsGlobal.minDurationSeconds);
                        
                        if (hasChanged) {
                            // 1. Update status tombol "Kirim Jawaban" (Langsung aktif/nonaktif)
                            updateSubmissionButtonState();

                            // 2. Beri Notifikasi ke Siswa
                            if (minDurationSettingsGlobal.isMinDurationEnabled) {
                                const mins = Math.ceil(minDurationSettingsGlobal.minDurationSeconds / 60);
                                showToast(`Update Aturan: Minimal waktu pengerjaan diubah menjadi ${mins} menit`, "info");
                            } else {
                                showToast("Update Aturan: Batasan waktu minimal DINONAKTIFKAN oleh Pengawas", "success");
                            }
                        }
                    }
                }
            });
        }

        function stopMinDurationListener() {
            if (minDurationListenerRef) {
                const refs = getSetupDbRefs();
                off(refs.minDurationSettingsRef, 'value', minDurationListenerRef);
                minDurationListenerRef = null;
            }
        }

        async function handleLanjutClick(foundToken) {
            if (!confirmCheckbox.checked) {
                modalMessage.style.display = 'block';
                modalMessage.textContent = "Anda harus mencentang cekbox untuk melanjutkan!";
                return;
            }
            modalMessage.style.display = 'none';
            confirmModal.classList.remove('show');
            isAnyModalOpen = false;

            if (!foundToken || !selectedStudentData || !currentDb) {
                window.showCustomMessageModal("Error", "Terjadi kesalahan data. Mohon muat ulang halaman.", "error");
                return;
            }

            loadingSpinner.querySelector('p').textContent = 'Mengunduh bank soal...';
            loadingSpinner.style.display = 'flex';

            const dbRefs = getDbRefs();
            if (!dbRefs) return;

            try {
                const tahunAjaranPath = foundToken.tahunAjaran.replace(/\//g, '-').trim();
                const ujianNamePath = foundToken.ujianName.replace(/\s+/g, '-').trim();
                const kelasPath = `Kelas-${foundToken.kelas.trim()}`;
                const subjectPath = foundToken.subject.replace(/\s+/g, '-').trim();
                const examPath = `ujian/${tahunAjaranPath}/${ujianNamePath}/${kelasPath}/${subjectPath}`;
                
                sessionStorage.setItem('currentExamPath', examPath);

                const examSnapshot = await get(ref(currentDb, examPath));
                if (!examSnapshot.exists()) throw new Error(`Bank soal tidak ditemukan.`);
                
                const examData = examSnapshot.val();
                if (!examData || !Array.isArray(examData.soal) || examData.soal.length <= 1) {
                    throw new Error("Struktur bank soal tidak valid atau kosong.");
                }
                
                currentExamQuestions = examData.soal.slice(1);
                localTerakhirUpdate = examData.terakhirUpdate || "";
                
                loadingSpinner.querySelector('p').textContent = 'Mempersiapkan sesi ujian...';

                const studentId = padStudentId(selectedStudentData.id);
                const tokenFirebaseKey = foundToken.key;
                const accessStatusRef = child(dbRefs.examAccessStatusRef, `${tokenFirebaseKey}/${studentId}`);
                
                const transactionResult = await runTransaction(accessStatusRef, (currentAccess) => {
                    const now = Date.now();
                    if (currentAccess === null || !currentAccess.isLoggedIn) {
                        return {
                            accessCount: (currentAccess?.accessCount || 0) + 1,
                            firstLoginTimestamp: currentAccess?.firstLoginTimestamp || now,
                            lastAccessTimestamp: now,
                            isLoggedIn: true,
                            examStartTime: currentAccess?.examStartTime || now,
                            studentId: studentId,
                        };
                    }
                    return;
                });

                if (transactionResult.committed) {
                    const examStartTime = Number(transactionResult.snapshot.val().examStartTime);
                    const savedAnswersSnapshot = await get(child(dbRefs.studentAnswersRef, `${tokenFirebaseKey}/${studentId}`));
                    const initialData = {};
                    if (savedAnswersSnapshot.exists()) {
                        const savedData = savedAnswersSnapshot.val();
                        initialData.answers = JSON.parse(savedData.answers || 'null');
                        initialData.ragu = JSON.parse(savedData.ragu || 'null');
                        if (savedData.shuffledQuestionIndices) initialData.shuffledQuestionIndices = JSON.parse(savedData.shuffledQuestionIndices);
                        if (savedData.shuffledOptionOrders) initialData.shuffledOptionOrders = JSON.parse(savedData.shuffledOptionOrders);
                    }
                    await startExamProcess(foundToken.durationMinutes, examStartTime, initialData);
                    loadingSpinner.style.display = 'none';
                } else {
                    throw new Error("Gagal memulai sesi. Akun anda masih Login, minta reset ke pengawas atau admin!");
                }
            } catch (err) {
                console.error("Error di handleLanjutClick:", err);
                loadingSpinner.style.display = 'none';
                window.showCustomMessageModal("Error", err.message, "error");
                loginBtn.disabled = false;
            }
        }
        
        function startExamUpdateListener(examPath) {
            stopExamUpdateListener();
            if (!currentDb) return;
            examUpdateListenerPath = child(ref(currentDb, examPath), 'terakhirUpdate');
            
            examUpdateListenerRef = onValue(examUpdateListenerPath, (snapshot) => {
                const serverUpdate = snapshot.val();
                const refreshBtn = document.getElementById('refreshSoalBtn');

                if (serverUpdate && localTerakhirUpdate && serverUpdate !== localTerakhirUpdate) {
                    // Jika ada update, tombol Update muncul, Refresh sembunyi
                    updateSoalBtn.style.display = 'flex';
                    if(refreshBtn) refreshBtn.style.display = 'none';
                } else {
                    // Jika tidak ada update, tombol Update sembunyi, Refresh muncul
                    updateSoalBtn.style.display = 'none';
                    if(refreshBtn) refreshBtn.style.display = 'flex';
                }
            });
        }
        
        function stopExamUpdateListener() {
            if (examUpdateListenerRef && examUpdateListenerPath) {
                off(examUpdateListenerPath, 'value', examUpdateListenerRef);
                examUpdateListenerRef = null;
                examUpdateListenerPath = null;
            }
        }

        // --- HELPER: BANDINGKAN SOAL LAMA & BARU ---
        function compareQuestions(oldArr, newArr) {
            let changes = [];
            // Kita asumsikan jumlah soal sama atau bertambah/berkurang,
            // yang penting kita cek indeks yang overlap dulu.
            let max = Math.max(oldArr.length, newArr.length);
            
            for(let i=0; i < max; i++) {
                // Jika salah satu undefined (karena panjang beda), pasti berubah
                if (!oldArr[i] || !newArr[i]) {
                    changes.push(i + 1);
                    continue;
                }
                
                // Bandingkan konten (Pertanyaan, Opsi, Kunci Jawaban)
                // Kita pakai JSON.stringify sederhana
                let s1 = JSON.stringify(oldArr[i]);
                let s2 = JSON.stringify(newArr[i]);
                
                if(s1 !== s2) {
                    changes.push(i + 1);
                }
            }
            return changes;
        }
        
        async function handleUpdateSoalClick() {
            const storedExamPath = sessionStorage.getItem('currentExamPath');
            if (!storedExamPath || !currentDb) return;

            // 1. Tampilkan Loading
            updateSpinnerOverlay.style.display = 'flex';
            updateSpinnerOverlay.querySelector('p').textContent = 'Mengecek detail perubahan...';
            
            try {
                // 2. Ambil Data Baru
                const snapshot = await get(ref(currentDb, storedExamPath));
                if (!snapshot.exists()) throw new Error("Gagal mengambil data update.");
                
                const newDataFull = snapshot.val();
                if (!newDataFull.soal || !Array.isArray(newDataFull.soal)) throw new Error("Format soal rusak.");
                
                const newQuestions = newDataFull.soal.slice(1); // Ingat, soal mulai index 1 di DB biasanya
                const oldQuestions = currentExamQuestions;

                // 3. Bandingkan
                const changedIndices = compareQuestions(oldQuestions, newQuestions);
                
                // Sembunyikan spinner sementara untuk menampilkan dialog konfirmasi
                updateSpinnerOverlay.style.display = 'none';
                
                let confirmMsg = "";
                if (changedIndices.length > 0) {
                    // Batasi jika terlalu banyak
                    let listStr = changedIndices.join(", ");
                    if (changedIndices.length > 10) {
                        listStr = changedIndices.slice(0, 10).join(", ") + ", dst...";
                    }
                    confirmMsg = `Terdapat perbaikan/revisi pada soal nomor: ${listStr}. Jawaban Anda mungkin perlu dicek ulang. Perbarui sekarang?`;
                } else {
                    confirmMsg = "Tidak terdeteksi perubahan isi soal, hanya pembaruan sistem. Lanjutkan update?";
                }

                // 4. Konfirmasi User
                const isConfirmed = await window.showCustomConfirmModal("Pembaruan Tersedia", confirmMsg);

                if (isConfirmed) {
                    // 5. Tampilkan spinner lagi & Terapkan
                    updateSpinnerOverlay.style.display = 'flex';
                    updateSpinnerOverlay.querySelector('p').textContent = 'Sedang memperbarui...';
                    
                    currentExamQuestions = newQuestions;
                    localTerakhirUpdate = newDataFull.terakhirUpdate;
                    
                    sessionStorage.setItem('examData', JSON.stringify(currentExamQuestions));
                    sessionStorage.setItem('localTerakhirUpdate', localTerakhirUpdate);
                    
                    // Render ulang soal saat ini agar perubahannya langsung terlihat
                    displayQuestion(currentQuestionIndex);
                    
                    setTimeout(() => {
                        updateSpinnerOverlay.style.display = 'none';
                        // Sembunyikan tombol update, Munculkan refresh
                        updateSoalBtn.style.display = 'none';
                        const refreshBtn = document.getElementById('refreshSoalBtn');
                        if(refreshBtn) refreshBtn.style.display = 'flex';

                        showToast("Soal berhasil diperbarui!", "success");
                    }, 800);
                } 

            } catch (error) {
                console.error("Gagal update soal:", error);
                updateSpinnerOverlay.style.display = 'none';
                window.showCustomMessageModal("Update Gagal", "Gagal mengunduh data. Periksa koneksi internet.", "error");
            }
        }

        // --- LOGIKA BARU: TOMBOL REFRESH SOAL ---
        async function handleRefreshSoalClick() {
            if (!navigator.onLine) {
                showToast("Tidak ada koneksi internet, refresh gagal", "error");
                return;
            }

            const storedExamPath = sessionStorage.getItem('currentExamPath');
            if (!storedExamPath || !currentDb) return;

            // Tampilkan Spinner
            updateSpinnerOverlay.querySelector('p').textContent = 'Merefresh Data...';
            updateSpinnerOverlay.style.display = 'flex';

            try {
                // Paksa download ulang dari Firebase
                const snapshot = await get(ref(currentDb, storedExamPath));
                
                if (!snapshot.exists()) throw new Error("Data tidak ditemukan");
                
                const newData = snapshot.val();
                if (!newData.soal || !Array.isArray(newData.soal)) throw new Error("Format data rusak");

                // Update data di memori & storage
                currentExamQuestions = newData.soal.slice(1);
                localTerakhirUpdate = newData.terakhirUpdate;
                
                sessionStorage.setItem('examData', JSON.stringify(currentExamQuestions));
                if (localTerakhirUpdate) {
                    sessionStorage.setItem('localTerakhirUpdate', localTerakhirUpdate);
                }

                // Render ulang soal saat ini (ini akan memaksa browser memuat ulang gambar)
                displayQuestion(currentQuestionIndex);

                setTimeout(() => {
                    updateSpinnerOverlay.style.display = 'none';
                    showToast("Refresh data soal berhasil", "success");
                }, 500);

            } catch (error) {
                console.error("Gagal refresh soal:", error);
                updateSpinnerOverlay.style.display = 'none';
                showToast("Sinyal lemah, refresh gagal", "error");
            }
        }

        if (refreshSoalBtn) {
            refreshSoalBtn.addEventListener('click', handleRefreshSoalClick);
        }
        
        function displayQuestion(shuffledIndex) {
            if (shuffledIndex < 0 || shuffledIndex >= currentExamQuestions.length) return;
            currentQuestionIndex = shuffledIndex;
            sessionStorage.setItem('lastQuestionIndex', shuffledIndex);

            const originalIndex = shuffledQuestionIndices[shuffledIndex];
            const question = currentExamQuestions[originalIndex];
            
            questionHeaderNumber.innerHTML = `Soal No. <span class="question-number-box">${shuffledIndex + 1}</span>`;
            questionContent.innerHTML = question.pertanyaan || "";
            
            cbtAnswerOptions.innerHTML = '';
            const optionOrder = shuffledOptionOrders[originalIndex];

            optionOrder.forEach(opt => {
                const optionKey = `pilihan${opt}`;
                if (question[optionKey]) {
                    const label = document.createElement('label');
                    label.className = 'cbt-option-label';
                    
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `question_${shuffledIndex}`;
                    radio.value = opt;
                    radio.onchange = () => selectAnswer(originalIndex, opt);

                    if (studentAnswers[originalIndex] === opt) {
                        radio.checked = true;
                        label.classList.add('selected');
                    }

                    const textDiv = document.createElement('div');
                    textDiv.className = 'option-text';
                    textDiv.innerHTML = question[optionKey];
                    
                    label.appendChild(radio);
                    label.appendChild(textDiv);
                    cbtAnswerOptions.appendChild(label);
                }
            });

            raguRaguCheckbox.checked = raguRaguStatus[originalIndex];
            
            if (shuffledIndex === currentExamQuestions.length - 1) {
                nextQuestionBtn.textContent = 'Kirim Jawaban';
                nextQuestionBtn.classList.add('submit-mode');
            } else {
                nextQuestionBtn.textContent = 'Selanjutnya';
                nextQuestionBtn.disabled = false;
                nextQuestionBtn.classList.remove('submit-mode');
            }
            prevQuestionBtn.disabled = shuffledIndex === 0;
            renderQuestionGrid();
            updateSubmissionButtonState();
            startSidebarCollapseTimer(); 
        }
        
        function selectAnswer(originalIndex, choice) {
            studentAnswers[originalIndex] = choice;
            sessionStorage.setItem('studentAnswers', JSON.stringify(studentAnswers));
            saveStudentAnswersToFirebase();
            
            const shuffledIndex = shuffledQuestionIndices.indexOf(originalIndex);
            if (shuffledIndex === currentQuestionIndex) {
                document.querySelectorAll('.cbt-option-label').forEach(label => label.classList.remove('selected'));
                const selectedRadio = document.querySelector(`input[name="question_${shuffledIndex}"][value="${choice}"]`);
                if (selectedRadio && selectedRadio.parentElement) {
                    selectedRadio.parentElement.classList.add('selected');
                }
            }
            
            renderQuestionGrid();
            updateSubmissionButtonState();
        }

        function toggleRaguRagu() {
            const originalIndex = shuffledQuestionIndices[currentQuestionIndex];
            raguRaguStatus[originalIndex] = !raguRaguStatus[originalIndex];
            sessionStorage.setItem('raguRaguStatus', JSON.stringify(raguRaguStatus));
            saveStudentAnswersToFirebase();
            renderQuestionGrid();
        }

        function renderQuestionGrid() {
            questionGridContainer.innerHTML = '';
            for (let i = 0; i < shuffledQuestionIndices.length; i++) {
                const originalIndex = shuffledQuestionIndices[i];
                const box = document.createElement('div');
                box.className = 'question-nav-box';
                box.textContent = i + 1;
                if (studentAnswers[originalIndex]) {
                    box.classList.add('answered');
                }
                if (raguRaguStatus[originalIndex]) {
                    box.classList.add('ragu');
                }
                if (i === currentQuestionIndex) {
                    box.classList.add('current');
                }
                box.onclick = () => displayQuestion(i);
                questionGridContainer.appendChild(box);
            }
        }

        async function saveStudentAnswersToFirebase() {
            if (!foundTokenGlobal || !selectedStudentData || !currentDb) return;
            const dbRefs = getDbRefs();
            if (!dbRefs) return;

            const studentAnswersPath = child(dbRefs.studentAnswersRef, `${foundTokenGlobal.key}/${padStudentId(selectedStudentData.id)}`);
            try {
                const payload = {
                    answers: JSON.stringify(studentAnswers),
                    ragu: JSON.stringify(raguRaguStatus),
                    shuffledQuestionIndices: JSON.stringify(shuffledQuestionIndices),
                    shuffledOptionOrders: JSON.stringify(shuffledOptionOrders),
                    timestamp: Date.now(),
                    studentName: selectedStudentData.name,
                    studentClass: selectedStudentData.class,
                    token: foundTokenGlobal.token,
                    subject: foundTokenGlobal.subject,
                    studentId: padStudentId(selectedStudentData.id)
                };
                await set(studentAnswersPath, payload);
            } catch (error) {
                console.error("Gagal menyimpan jawaban siswa ke Firebase:", error);
            }
        }

        async function submitAnswers(isAutoSubmit = false) {
            submissionWarningMessage.textContent = '';
            if (!foundTokenGlobal || !selectedStudentData || !currentDb) {
                submissionWarningMessage.textContent = 'Error: Data tidak lengkap.';
                return;
            }

            if (!isAutoSubmit) {
                const unansweredCount = studentAnswers.filter(a => a === null).length;
                if (unansweredCount > 0) {
                    const confirmed = await window.showCustomConfirmModal("Konfirmasi", `Masih ada ${unansweredCount} soal yang belum dijawab. Anda yakin ingin mengirim?`);
                    if (!confirmed) return;
                } else {
                     const confirmed = await window.showCustomConfirmModal("Konfirmasi", "Anda yakin ingin mengirim semua jawaban?");
                    if (!confirmed) return;
                }
            }

            submitAnswersButton.disabled = true;
            submitAnswersButton.textContent = 'Mengirim...';
            nextQuestionBtn.disabled = true;

            const dbRefs = getDbRefs();
            if (!dbRefs) return;
            
            try {
                manualSubmissionInProgress = true;
                await saveStudentAnswersToFirebase();
                const studentId = padStudentId(selectedStudentData.id);
                const tokenKey = foundTokenGlobal.key;
                
                await set(child(dbRefs.submittedExamsRef, `${tokenKey}/${studentId}`), { isSubmitted: true, timestamp: Date.now(), studentId });
                await update(child(dbRefs.examAccessStatusRef, `${tokenKey}/${studentId}`), { isLoggedIn: false, studentId });
                
                showSubmissionConfirmationOverlay(isAutoSubmit);
            } catch (error) {
                console.error("Gagal mengirimkan jawaban:", error);
                submissionWarningMessage.textContent = 'Gagal mengirim. Coba lagi.';
                submitAnswersButton.disabled = false;
                submitAnswersButton.textContent = 'KIRIM JAWABAN';
            } finally {
                manualSubmissionInProgress = false;
            }
        }

        window.showCustomMessageModal = function (title, messageText, type = 'info') {
            customMessageModalTitle.textContent = title;
            customMessageModalText.textContent = messageText;
            customMessageModal.classList.add('show');
            isAnyModalOpen = true;
        }

        window.hideCustomMessageModal = function () {
            customMessageModal.classList.remove('show');
            isAnyModalOpen = false;
        }

        window.showCustomConfirmModal = function (title, messageText) {
            return new Promise((resolve) => {
                customConfirmModalTitle.textContent = title;
                customConfirmModalText.textContent = messageText;
                customConfirmModal.classList.add('show');
                isAnyModalOpen = true;

                const onConfirm = () => { cleanup(); resolve(true); };
                const onCancel = () => { cleanup(); resolve(false); };
                const cleanup = () => {
                    customConfirmModal.classList.remove('show');
                    isAnyModalOpen = false;
                    customConfirmModalConfirmBtn.removeEventListener('click', onConfirm);
                    customConfirmModalCancelBtn.removeEventListener('click', onCancel);
                };

                customConfirmModalConfirmBtn.addEventListener('click', onConfirm);
                customConfirmModalCancelBtn.addEventListener('click', onCancel);
            });
        }
        
        async function loadAndRenderWelcomeButtons() {
            welcomeButtonsContainer.innerHTML = '';
            welcomeMessageElement.textContent = 'Memuat pilihan ujian...';

            if (!publicSettings) publicSettings = {};

            const activeButtons = [];

            ['kelas7', 'kelas8', 'kelas9'].forEach(kelas => {
                if (publicSettings[kelas] && publicSettings[kelas].enabled) {
                    activeButtons.push({
                        id: `btn-${kelas}`,
                        text: `PILIH ${kelas.toUpperCase().replace('KELAS', 'KELAS ')}`,
                        class: `welcome-button btn-${kelas}`,
                        action: () => handleCustomButtonClassClick(kelas, publicSettings[kelas].url)
                    });
                }
            });

            if (publicSettings.susulan && publicSettings.susulan.enabled && publicSettings.susulan.list && Object.keys(publicSettings.susulan.list).length > 0) {
                activeButtons.push({
                    id: `btn-susulan`,
                    text: `UJIAN SUSULAN`,
                    class: `welcome-button btn-susulan`,
                    action: showSusulanListModal
                });
            }

            if (activeButtons.length > 0) {
                activeButtons.forEach(buttonInfo => {
                    const button = document.createElement('button');
                    button.id = buttonInfo.id;
                    button.className = buttonInfo.class;
                    button.textContent = buttonInfo.text;
                    button.addEventListener('click', buttonInfo.action);
                    welcomeButtonsContainer.appendChild(button);
                });
                welcomeTitle.textContent = 'SELAMAT DATANG';
                welcomeMessageElement.textContent = 'Silakan pilih jenjang kelas Anda untuk melanjutkan ke halaman ujian:';
            } else {
                welcomeTitle.textContent = 'SELAMAT DATANG';
                welcomeMessageElement.textContent = 'Silakan pilih jenjang kelas Anda untuk melanjutkan ke halaman ujian:';
                
                const btnKelas7 = document.createElement('button');
                btnKelas7.id = 'btnKelas7';
                btnKelas7.className = 'welcome-button btn-kelas7';
                btnKelas7.textContent = 'KELAS 7';
                btnKelas7.addEventListener('click', () => window.selectGrade(7));
                welcomeButtonsContainer.appendChild(btnKelas7);

                const btnKelas8 = document.createElement('button');
                btnKelas8.id = 'btnKelas8';
                btnKelas8.className = 'welcome-button btn-kelas8';
                btnKelas8.textContent = 'KELAS 8';
                btnKelas8.addEventListener('click', () => window.selectGrade(8));
                welcomeButtonsContainer.appendChild(btnKelas8);

                const btnKelas9 = document.createElement('button');
                btnKelas9.id = 'btnKelas9';
                btnKelas9.className = 'welcome-button btn-kelas9';
                btnKelas9.textContent = 'KELAS 9';
                btnKelas9.addEventListener('click', () => window.selectGrade(9));
                welcomeButtonsContainer.appendChild(btnKelas9);
            }
        }

        function handleCustomButtonClassClick(kelas, url) {
            if (url) {
                let fullUrl = url;
                if (!/^https?:\/\//i.test(url)) {
                    fullUrl = 'https://' + url;
                }
                window.location.href = fullUrl;
            } else {
                window.showCustomMessageModal("URL Tidak Ditemukan", `URL untuk ${kelas.toUpperCase()} tidak ditemukan. Harap hubungi administrator.`, 'error');
            }
        }

        function showSusulanListModal() {
            const susulanModalListEl = document.getElementById('susulanModalList');
            susulanModalListEl.innerHTML = '';

            if (publicSettings && publicSettings.susulan && publicSettings.susulan.list) {
                const susulanItems = Object.values(publicSettings.susulan.list);
                susulanItems.sort((a, b) => a.name.localeCompare(b.name)); 

                susulanItems.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span class="item-name">${item.name}</span>`;
                    listItem.addEventListener('click', () => {
                        if (item.url) {
                            let fullUrl = item.url;
                             if (!/^https?:\/\//i.test(item.url)) {
                                fullUrl = 'https://' + item.url;
                            }
                            window.open(fullUrl, '_blank');
                            window.closeSusulanListModal();
                        } else {
                            window.showCustomMessageModal("URL Tidak Ditemukan", `URL untuk ${item.name} tidak ditemukan.`, 'error');
                        }
                    });
                    susulanModalListEl.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = 'Tidak ada ujian susulan yang tersedia saat ini.';
                susulanModalListEl.appendChild(listItem);
            }

            susulanListModal.classList.add('show');
            isAnyModalOpen = true;
        }

        window.closeSusulanListModal = function() {
            susulanListModal.classList.remove('show');
            isAnyModalOpen = false;
        }

        // --- FUNGSI SELECT GRADE (Diperbaiki dengan Error Handling & Expose ke Window) ---
        window.selectGrade = async function(grade) {
            try {
                console.log(`Memulai selectGrade untuk Kelas ${grade}`);
                
                // 1. Tampilkan Loading Sementara (agar user tahu ada proses)
                loadingSpinner.style.display = 'flex';
                loadingSpinner.querySelector('p').textContent = `Menyiapkan Kelas ${grade}...`;

                currentSelectedGrade = grade;
                
                // 2. Ganti Tema
                document.body.classList.remove('theme-kelas7', 'theme-kelas8', 'theme-kelas9');
                document.body.classList.add(`theme-kelas${grade}`);

                // 3. Update UI Login
                loginJudulUjian.textContent = `UJIAN KELAS ${grade}`;
                classModalTitle.textContent = `Pilih Kelas ${grade}`;

                // 4. Reset & Load Data Kelas
                // Pastikan DB sudah siap
                const instances = getDbForGrade(grade);
                if (!instances) {
                    throw new Error("Konfigurasi Database tidak ditemukan.");
                }
                
                // Set Global DB Active
                currentDb = instances.db;
                currentAuth = instances.auth; // (Optional, jika butuh auth spesifik)

                // 5. Pindah Layar
                welcomeScreen.style.display = 'none';
                loginContainer.classList.add('show');

                // 6. Cek Lokasi / Tampilkan Form
                if (isLocationEnabled) {
                    mainLoginControls.style.display = 'none';
                    getLocation();
                } else {
                    showMainLoginForm();
                }

                // 7. Load Data Kelas (Async)
                await loadClassDropdownForGrade(grade);

            } catch (error) {
                console.error("Error di selectGrade:", error);
                alert("Terjadi kesalahan saat memilih kelas: " + error.message);
                // Kembalikan ke welcome screen jika error fatal
                loadingSpinner.style.display = 'none';
                loginContainer.classList.remove('show');
                welcomeScreen.style.display = 'flex';
            } finally {
                // Sembunyikan loading jika sukses pindah layar (atau sudah di-handle di atas)
                if (loginContainer.classList.contains('show')) {
                     loadingSpinner.style.display = 'none';
                }
            }
        };
        
        function validateLocationKey() {
            const enteredKey = document.getElementById('locationKeyInput').value;
            if (enteredKey && enteredKey === locationAccessKey) {
                showMainLoginForm();
            } else {
                document.getElementById('locationKeyMessage').textContent = "Kunci Akses Lokasi salah.";
            }
        }
        
        function updateStudentIdentityPanel() {
            const identityDisplay = document.getElementById('studentIdentityDisplay');
            if (identityDisplay && selectedStudentData) {
                let displayName = selectedStudentData.name;
                if (displayName.length > 25) { 
                    displayName = displayName.substring(0, 22) + '...';
                }
                identityDisplay.textContent = `${displayName} | ${selectedStudentData.class}`;
                identityDisplay.title = `${selectedStudentData.name} | ${selectedStudentData.class}`;
            }
        }

        function startAccessStatusListener() {
            if (!foundTokenGlobal || !selectedStudentData || !currentDb) return;
            const dbRefs = getDbRefs();
            if (!dbRefs) return;

            stopAccessStatusListener();

            accessStatusListenerPath = child(dbRefs.examAccessStatusRef, `${foundTokenGlobal.key}/${padStudentId(selectedStudentData.id)}`);
            accessStatusListenerRef = onValue(accessStatusListenerPath, (snapshot) => {
                if (isInExamMode && snapshot.exists()) {
                    const data = snapshot.val();
                    if (data.isLoggedIn === false && !manualSubmissionInProgress) {
                        showForceLogoutModal();
                    }
                }
            }, (error) => {
                console.error("Gagal mendengarkan status akses:", error);
            });
        }

        function stopAccessStatusListener() {
            if (accessStatusListenerRef && accessStatusListenerPath) {
                off(accessStatusListenerPath, 'value', accessStatusListenerRef);
                accessStatusListenerRef = null;
                accessStatusListenerPath = null;
            }
        }

        function showForceLogoutModal() {
            stopAccessStatusListener();
            stopSubmissionStatusListener();
            stopExamUpdateListener();
            stopMinDurationListener(); // [TAMBAHAN] Matikan listener saat logout paksa
            if (timerInterval) clearInterval(timerInterval);
            isInExamMode = false;

            document.querySelectorAll('#examContainer button, #examContainer input').forEach(el => el.disabled = true);
            document.getElementById('examBody').style.filter = 'blur(5px)';

            forceLogoutModal.classList.add('show');
            isAnyModalOpen = true;
        }

        async function initializeAppFlow() {
            loadingSpinner.style.display = 'flex';
            
            // Cek Offline via Navigator dulu (Quick Check)
            if (!navigator.onLine) {
                 loadingSpinner.style.display = 'none';
                 // Langsung tampilkan modal mati kutu
                 document.getElementById('serverDownModal').classList.add('show');
                 isAnyModalOpen = true;
                 return;
            }

            async function fetchGlobalSettings() {
                const refs = getSetupDbRefs();
                const [locSnap, minDurSnap, pubSetSnap, shuffleSnap, blockKeySnap] = await Promise.all([
                    get(refs.settingsRef), 
                    get(refs.minDurationSettingsRef), 
                    get(refs.publicSettingsRef),
                    get(refs.shuffleSettingsRef),
                    get(refs.blockKeySettingsRef)
                ]);

                if (locSnap.exists()) {
                    const s = locSnap.val();
                    isLocationEnabled = s.isLocationEnabled ?? true;
                    firebaseAllowedRadiusKm = s.allowedRadiusKm ?? 0.075;
                    locationAccessKey = s.currentKey || "";
                }
                if (blockKeySnap.exists()) {
                    const s = blockKeySnap.val();
                    isBlockEnabled = s.isEnabled ?? false;
                    blockAccessKey = s.key || "";
                }
                if (minDurSnap.exists()) {
                    const s = minDurSnap.val();
                    minDurationSettingsGlobal.isMinDurationEnabled = s.isMinDurationEnabled ?? false;
                    minDurationSettingsGlobal.minDurationSeconds = s.minDurationSeconds ?? 1800;
                }
                if (pubSetSnap.exists()) publicSettings = pubSetSnap.val();
                if (shuffleSnap.exists()) {
                    const s = shuffleSnap.val();
                    isSoalAcakEnabled = s.soal ?? true;
                    isPilganAcakEnabled = s.pilgan ?? true;
                } else {
                    isSoalAcakEnabled = true;
                    isPilganAcakEnabled = true;
                }
            }

            try {
                // Mencoba Login Otomatis ke SEMUA Database
                const loginSuccess = await performAnonymousLogin();
                
                if (loginSuccess) {
                    await fetchGlobalSettings();

                    // === LOGIKA RESTORE ATAU WELCOME ===
                    if (isBlockEnabled && !isAllowedEnvironment()) {
                        unlockAccessBtn.onclick = async () => {
                            if (unlockKeyInput.value === blockAccessKey) {
                                accessBlockedOverlay.style.display = 'none';
                                loadingSpinner.style.display = 'flex';
                                const isRestored = await restoreExamState();
                                 if (!isRestored) {
                                    await loadAndRenderWelcomeButtons();
                                    loadingSpinner.style.display = 'none';
                                    welcomeScreen.style.display = 'flex';
                                } else {
                                    loadingSpinner.style.display = 'none';
                                }
                            } else {
                                unlockMessage.textContent = "Kunci yang dimasukkan salah.";
                            }
                        };
                        loadingSpinner.style.display = 'none';
                        accessBlockedOverlay.style.display = 'flex';
                    } else {
                        const isRestored = await restoreExamState();
                        if (!isRestored) {
                           await loadAndRenderWelcomeButtons();
                           loadingSpinner.style.display = 'none';
                           welcomeScreen.style.display = 'flex';
                        } else {
                           loadingSpinner.style.display = 'none';
                        }
                    }
                } else {
                    // Jika login gagal total
                    throw new Error("Gagal login otomatis");
                }
            } catch (error) {
                console.error("Inisialisasi aplikasi gagal:", error);
                loadingSpinner.style.display = 'none';

                // KILL SWITCH: Jika gagal login (karena kuota penuh, server down, atau sinyal mati)
                document.getElementById('serverDownModal').classList.add('show');
                isAnyModalOpen = true; 
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            await initializeAppFlow();
            
            setupPasswordToggle(
                document.getElementById('togglePasswordVisibility'),
                document.getElementById('unlockKeyInput'),
                document.getElementById('eye-open'),
                document.getElementById('eye-closed')
            );

            setupPasswordToggle(
                document.getElementById('toggleLocationKeyVisibility'),
                document.getElementById('locationKeyInput'),
                document.getElementById('loc-eye-open'),
                document.getElementById('loc-eye-closed')
            );
            
            // Tambahkan listener tombol Enter untuk Buka Akses
            unlockKeyInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    unlockAccessBtn.click();
                }
            });
            
            customSelectKelasDisplay.addEventListener('click', openClassModal);
            customSelectNamaSiswaDisplay.addEventListener('click', openStudentModal);
            document.getElementById('validateLocationKeyBtn').addEventListener('click', validateLocationKey);

            classModal.addEventListener('click', e => e.target === classModal && closeClassModal());
            studentModal.addEventListener('click', e => e.target === studentModal && closeStudentModal());

            inputTokenPrefix.addEventListener('input', () => window.formatTokenPrefix(inputTokenPrefix));
            inputTokenPrefix.addEventListener('keydown', e => e.key === 'Enter' && !loginBtn.disabled && window.cekToken());

            loginBtn.addEventListener('click', window.cekToken);
            
            forceLogoutModalButton.addEventListener('click', () => {
                sessionStorage.clear();
                window.location.reload(true);
            });
            
            const backToWelcomeBtn = document.getElementById('backToWelcomeBtn');
            backToWelcomeBtn.addEventListener('click', () => {
                 loginContainer.classList.remove('show');
                 welcomeScreen.style.display = 'flex';
                 customSelectKelasDisplay.textContent = customSelectKelasDisplay.dataset.placeholder;
                 hiddenSelectKelas.value = '';
                 customSelectNamaSiswaDisplay.textContent = customSelectNamaSiswaDisplay.dataset.placeholder;
                 hiddenSelectNamaSiswa.value = '';
                 inputTokenPrefix.value = '';
                 displayStudentId.value = '';
                 message.textContent = '';
                 
                 // RESET WARNA KE DEFAULT (Hapus class tema)
                 document.body.classList.remove('theme-kelas7', 'theme-kelas8', 'theme-kelas9');
            });
            
            if(updateSoalBtn) {
                updateSoalBtn.addEventListener('click', handleUpdateSoalClick);
            }
            
            if(refreshSoalBtn) {
                refreshSoalBtn.addEventListener('click', handleRefreshSoalClick);
            }

            window.onpopstate = e => isInExamMode && history.pushState(null, '', location.href);

            prevQuestionBtn.addEventListener('click', () => displayQuestion(currentQuestionIndex - 1));
            nextQuestionBtn.addEventListener('click', () => {
                if (currentQuestionIndex === currentExamQuestions.length - 1) {
                    submitAnswers(false);
                } else {
                    displayQuestion(currentQuestionIndex + 1);
                }
            });
            raguRaguCheckbox.addEventListener('change', toggleRaguRagu);
            submitAnswersButton.addEventListener('click', () => submitAnswers(false));
            
            const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
            const examSidePanel = document.getElementById('examSidePanel');
            
            mobileSidebarToggle.addEventListener('click', () => {
                const wrapper = document.querySelector('.sidebar-content-wrapper');
                wrapper.classList.toggle('collapsed');
                mobileSidebarToggle.classList.toggle('up');
                
                if (!wrapper.classList.contains('collapsed')) {
                    startSidebarCollapseTimer();
                } else {
                    clearTimeout(sidebarCollapseTimer);
                }
            });

            examSidePanel.addEventListener('click', startSidebarCollapseTimer);
            examSidePanel.addEventListener('scroll', startSidebarCollapseTimer, true);


            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // --- LOGIKA LONG PRESS UNTUK ADMIN ---
            function startLongPress() {
                if (adminAccessControls.style.display === 'block') return;
                longPressTimer = setTimeout(() => {
                    adminAccessControls.style.display = 'block';
                }, 3000);
            }

            function cancelLongPress() {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            }

            blockedTitle.addEventListener('mousedown', startLongPress);
            blockedTitle.addEventListener('mouseup', cancelLongPress);
            blockedTitle.addEventListener('mouseleave', cancelLongPress);

            blockedTitle.addEventListener('touchstart', (e) => {
                startLongPress();
            });
            blockedTitle.addEventListener('touchend', cancelLongPress);
            blockedTitle.addEventListener('touchcancel', cancelLongPress);

            // LOGIKA BARU: TOMBOL DOWNLOAD APLIKASI (TAB BARU)
            const btnDownloadApp = document.getElementById('btnDownloadApp');
            if (btnDownloadApp) {
                btnDownloadApp.style.display = 'block';
                btnDownloadApp.addEventListener('click', () => {
                    window.open('https://appsperopa.pages.dev', '_blank');
                });
            }
        });
        
        function startSubmissionStatusListener() {
            if (!foundTokenGlobal || !selectedStudentData || !currentDb) return;
            const dbRefs = getDbRefs();
            if (!dbRefs) return;
            const selectedStudentId = selectedStudentData.id;

            stopSubmissionStatusListener();

            submissionStatusListenerPath = child(dbRefs.submittedExamsRef, `${foundTokenGlobal.key}/${padStudentId(selectedStudentId)}`);
            submissionStatusListenerRef = onValue(submissionStatusListenerPath, (snapshot) => {
                if (isInExamMode && snapshot.exists() && snapshot.val().isSubmitted) {
                    stopAccessStatusListener();
                    stopSubmissionStatusListener();
                    stopExamUpdateListener();
                    stopMinDurationListener(); // [TAMBAHAN] Matikan listener saat selesai
                    if (timerInterval) clearInterval(timerInterval);
                    isInExamMode = false;
                    
                    document.querySelectorAll('#examContainer button, #examContainer input').forEach(el => el.disabled = true);
                    document.getElementById('examBody').style.filter = 'blur(5px)';

                    submissionOverlayTitle.innerText = 'Ujian Telah Dikirim';
                    submissionOverlayMessage.innerText = 'Jawaban Anda telah dikirim oleh administrator.';
                    backToLoginFromSubmissionBtn.innerText = 'Logout';
                    submissionConfirmationOverlay.classList.add('show');
                    isAnyModalOpen = true;

                    const backBtn = document.getElementById('backToLoginFromSubmissionBtn');
                    backBtn.onclick = () => {
                        backBtn.disabled = true;
                        backBtn.textContent = 'MEMUAT...';
                        window.location.reload(true);
                    };
                }
            });
        }

        function stopSubmissionStatusListener() {
            if (submissionStatusListenerRef && submissionStatusListenerPath) {
                off(submissionStatusListenerPath, 'value', submissionStatusListenerRef);
                submissionStatusListenerRef = null;
                submissionStatusListenerPath = null;
            }
        }

        window.cekToken = async function() {
            const tokenPrefix = inputTokenPrefix.value.trim().toUpperCase();
            const studentId = displayStudentId.value.trim();
            const studentClassNum = selectedStudentData.class.match(/^\d+/)[0];
            
            if (!hiddenSelectKelas.value || !hiddenSelectNamaSiswa.value || !tokenPrefix) {
                message.textContent = "Harap lengkapi semua pilihan.";
                return;
            }

            loginBtn.disabled = true;
            message.innerHTML = `Memvalidasi data... <span class="spinner"></span>`;

            const dbRefs = getDbRefs();
            if (!dbRefs) {
                message.textContent = "Database tidak siap.";
                loginBtn.disabled = false;
                return;
            }

            try {
                // --- PERBAIKAN OPTIMASI: Query Token Spesifik (Server-Side) ---
                // Menggunakan query untuk mencari token yang spesifik saja, bukan download semua.
                // WAJIB: Tambahkan "tokens": { ".indexOn": ["token"] } di Firebase Rules
                
                // 1. Query ke Firebase: Cari data di 'tokens' yang field 'token' == tokenPrefix
                const tokenQuery = query(dbRefs.tokensRef, orderByChild('token'), equalTo(tokenPrefix));
                const tokensSnapshot = await get(tokenQuery);
                
                let foundToken = null;
                let tokenFoundForOtherClass = false;

                // 2. Iterasi hasil query (Hanya data yang token-nya cocok yang didownload)
                if (tokensSnapshot.exists()) {
                    tokensSnapshot.forEach(child => {
                        const data = child.val();
                        // Query sudah memfilter 'token' (equalTo), sekarang validasi kelas
                        // Pastikan token yang diketik cocok dengan kelas siswa
                        if (String(data.kelas) === String(studentClassNum)) {
                             foundToken = { ...data, key: child.key };
                        } else {
                             tokenFoundForOtherClass = true;
                        }
                    });
                }

                if (!foundToken) {
                    if (tokenFoundForOtherClass) {
                         throw new Error(`Token ini bukan untuk kelas ${studentClassNum}.`);
                    } else {
                         throw new Error("Token ujian tidak ditemukan.");
                    }
                }
                
                foundTokenGlobal = foundToken;

                const hasSubmitted = (await get(child(dbRefs.submittedExamsRef, `${foundToken.key}/${studentId}`))).exists();
                if (hasSubmitted) throw new Error("Anda sudah menyelesaikan ujian ini.");

                const now = Date.now();
                const startTime = new Date(foundToken.startTime).getTime();
                const endTime = new Date(foundToken.endTime).getTime();
                
                // --- LOGIKA PESAN WAKTU TOKEN (DIPERBARUI) ---
                if (!foundToken.isForceActive) {
                    if (now < startTime) {
                        const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false };
                        const jamMulai = new Date(startTime).toLocaleTimeString('id-ID', timeOptions).replace(':', '.');
                        const jamSelesai = new Date(endTime).toLocaleTimeString('id-ID', timeOptions).replace(':', '.');
                        throw new Error(`Token dapat diakses pukul ${jamMulai} sampai ${jamSelesai} saja!`);
                    } else if (now > endTime) {
                        throw new Error("Token sudah tidak aktif, minta admin untuk mengaktifkannya!");
                    }
                }

                if (String(studentClassNum) !== String(foundToken.kelas)) {
                    throw new Error(`Token ini bukan untuk kelas ${studentClassNum}.`);
                }
                
                const accessStatus = (await get(child(dbRefs.examAccessStatusRef, `${foundToken.key}/${studentId}`))).val();
                
                // --- LOGIKA PESAN LOGIN (DIPERBARUI) ---
                if (accessStatus?.isLoggedIn) throw new Error("Akun anda masih Login, minta reset ke pengawas atau admin!");
                
                message.textContent = "";
                loginBtn.disabled = false;
                
                document.getElementById("modalIdSiswa").textContent = selectedStudentData.id;
                document.getElementById("modalNamaLengkap").textContent = selectedStudentData.name;
                document.getElementById("modalKelas").textContent = selectedStudentData.class;
                document.getElementById("modalMapel").textContent = foundToken.subject;
                modalExamDuration.textContent = `${foundToken.durationMinutes} Menit`;
                
                document.getElementById("btnLanjut").onclick = () => handleLanjutClick(foundToken);

                confirmModal.classList.add('show');
                isAnyModalOpen = true;

            } catch (err) {
                console.error("Error di cekToken:", err);
                message.textContent = err.message;
                loginBtn.disabled = false;
            }
        };
    </script>
</body>
</html>
