<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=2.0" />
    <title>Ujian Siswa</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            --primary-color: #0066cc; /* Default untuk Kelas 7 */
            --accent-color: #007bff; /* Warna tombol default */
            --warning-color: #ea4b16; /* Default untuk Judul Ujian */
            --light-bg: #f4f7f9;
            --border-color: #e0e0e0;
            --danger-color: #dc3545;
            --success-color: #28a745;
        }

        body {
            font-family: 'Inter', Arial, sans-serif;
            background-color: #e0e0e0;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow: hidden;
        }

        /* Gaya untuk layar login baru */
        .initial-login-screen {
            max-width: 380px;
            width: 90%;
            margin: 20px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            padding: 30px 20px;
            display: none; /* Awalnya tersembunyi */
            flex-direction: column;
            gap: 15px;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }

        .initial-login-screen h2 {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .initial-login-screen p {
            font-size: 1em;
            color: #666;
            margin-bottom: 20px;
        }

        .initial-login-screen input[type="email"],
        .initial-login-screen input[type="password"] {
            padding: 12px 15px;
            font-size: 1.1em;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        .initial-login-screen button {
            padding: 15px 25px;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            background-color: var(--accent-color);
            border: none;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 100%;
        }

        .initial-login-screen button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            background-color: var(--primary-color);
        }

        .initial-login-screen button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .welcome-screen {
            max-width: 400px;
            width: 90%;
            margin: 20px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            padding: 30px 20px;
            display: none; /* Awalnya tersembunyi */
            flex-direction: column;
            gap: 15px;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }

        .welcome-screen h2 {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .welcome-screen p {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 20px;
        }

        .welcome-button {
            padding: 15px 25px;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 9999px; /* Lebih oval */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .welcome-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .welcome-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .btn-kelas7 {
            background-color: #007bff; /* Biru */
        }
        .btn-kelas7:hover {
            background-color: #0056b3;
        }

        .btn-kelas8 {
            background-color: #ff9900; /* Oranye */
        }
        .btn-kelas8:hover {
            background-color: #cc7a00;
        }

        .btn-kelas9 {
            background-color: #800000; /* Merah Marun */
        }
        .btn-kelas9:hover {
            background-color: #5a0000;
        }

        .btn-susulan {
            background-color: #28a745; /* Hijau */
        }
        .btn-susulan:hover {
            background-color: #218838;
        }

        .container {
            max-width: 400px;
            width: 90%;
            margin: 20px auto;
            border: 1px solid #ddd;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            flex-shrink: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            display: none; /* Awalnya tersembunyi */
        }
        .container.show {
            display: block;
            opacity: 1;
        }

        .header-box {
            background-color: var(--primary-color);
            padding: 20px 15px;
            color: white;
            position: relative;
            text-align: center;
        }
        
        .back-button {
            position: absolute;
            top: 15px;
            left: 15px;
            cursor: pointer;
            color: white;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            z-index: 2;
        }

        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .header-box .logo {
            width: 80px;
            height: auto;
        }

        .header-box .title {
            font-size: 22px;
            font-weight: bold;
            margin-top: 10px;
            color: white;
        }

        .card-body {
            padding: 20px;
        }

        .judul-ujian {
            color: var(--warning-color); /* Warna dinamis */
            font-size: 22px;
            font-weight: bold;
            margin: 10px 0;
        }

        .token-input-group {
            display: flex;
            align-items: center;
            width: calc(100% - 20px);
            margin: 10px auto;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .token-input-group input {
            padding: 10px;
            font-size: 16px;
            border: none;
            margin: 0;
            box-sizing: border-box;
            text-align: center;
            height: 40px;
        }

        #inputTokenPrefix {
            flex-grow: 1;
            min-width: 0;
            border-right: 1px solid #ccc;
        }

        .token-separator {
            background-color: #f0f0f0;
            padding: 10px 5px;
            font-size: 16px;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            box-sizing: border-box;
        }

        #displayStudentId {
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            background-color: #f0f0f0;
            cursor: not-allowed;
        }

        input {
            padding: 10px;
            width: calc(100% - 20px);
            font-size: 16px;
            margin: 10px auto;
            display: block;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: center;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .custom-dropdown-container {
            position: relative;
            width: calc(100% - 20px);
            margin: 10px auto;
            display: block;
        }

        .custom-dropdown-display {
            padding: 10px;
            width: 100%;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: center;
            background-color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 40px;
            color: #555;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .custom-dropdown-display.selected {
            color: #000;
        }

        .custom-dropdown-display.disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }

        .custom-dropdown-display::after {
            content: 'â–¼';
            position: absolute;
            right: 15px;
            font-size: 0.8em;
            color: #888;
        }

        .token-input-group.is-valid {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .token-input-group.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            width: 100%;
            background-color: var(--accent-color); /* Warna dinamis */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 10px auto;
            display: block;
        }

        button:hover {
            background-color: var(--primary-color); /* Warna sedikit lebih gelap dari primer untuk hover */
        }

        button:active {
            transform: scale(0.98);
        }

        #btnBatal {
            background-color: #dc3545;
        }

        #btnBatal:hover {
            background-color: #c82333;
        }

        .message {
            margin-bottom: 10px;
            font-size: 14px;
            min-height: 30px;
            text-align: center;
            word-wrap: break-word;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid black;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            padding-bottom: 10px;
        }

        .custom-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .custom-modal.show {
            display: flex;
            opacity: 1;
        }
        
        .custom-modal.static-backdrop {
            background: rgba(0, 0, 0, 0.8);
            pointer-events: all;
        }

        .custom-modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .custom-modal-content h4 {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color); /* Warna dinamis */
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0;
        }

        .custom-modal-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        .custom-modal-list li {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            text-align: left;
            font-size: 1.1em;
            transition: background-color 0.2s ease;
        }

        .custom-modal-list li:nth-child(odd) {
            background-color: white;
        }
        .custom-modal-list li:nth-child(even) {
            background-color: #f9f9f9;
        }

        .custom-modal-list li:last-child {
            border-bottom: none;
        }

        .custom-modal-list li:hover {
            background-color: #e0e0e0;
        }

        #susulanListModal .custom-modal-content {
            max-width: 450px;
        }

        #susulanListModal .custom-modal-list li {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 15px 20px;
            gap: 5px;
        }

        #susulanListModal .custom-modal-list li .item-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        #susulanListModal .custom-modal-list li .item-url {
            font-size: 0.85em;
            color: #666;
            word-break: break-all;
        }


        #confirmModal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        #confirmModal.show {
            display: flex;
            opacity: 1;
        }

        #confirmModal .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            max-width: 380px;
            text-align: left;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        #confirmModal .modal-content h4 {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary-color); /* Warna dinamis */
            margin-bottom: 15px;
            text-align: center;
        }

        #confirmModal .modal-content .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        #confirmModal .modal-content .info-table tr {
            border-bottom: 1px solid #eee;
        }

        #confirmModal .modal-content .info-table tr:last-child {
            border-bottom: none;
        }

        #confirmModal .modal-content .info-table td {
            padding: 8px 0;
            font-size: 1.1em;
        }

        #confirmModal .modal-content td:first-child {
            font-weight: bold;
            color: #333;
            width: 120px;
            padding-right: 10px;
        }

        #confirmModal .modal-content td:last-child {
            text-align: left;
            color: #000;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-top: 15px;
            margin-bottom: 15px;
            font-size: 1em;
            color: #333;
            padding-left: 10px;
        }

        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0 8px 0 0;
            cursor: pointer;
            vertical-align: middle;
            box-shadow: none;
            display: inline-block;
        }

        .checkbox-container label {
            cursor: pointer;
            vertical-align: middle;
        }

        #modalMessage {
            color: red;
            font-size: 0.9em;
            text-align: center;
            margin-top: -10px;
            margin-bottom: 10px;
            min-height: 1.2em;
        }

        /* === [START] GAYA TAMPILAN UJIAN BARU === */
        #examContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            flex-direction: column;
            background-color: var(--light-bg);
            z-index: 500;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        #examBody {
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 15px;
            flex-grow: 1;
            overflow-y: auto; 
            padding-bottom: 70px; 
        }

        #examMainContent {
            order: 2;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        #examSidePanel {
            order: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #ffffff;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 15px;
            position: relative;
            border-bottom: 1px solid var(--border-color);
            background-color: #f8f9fa;
        }
        
        .sidebar-header #timerText {
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 2.2em;
            color: var(--danger-color);
            text-align: center;
        }
        
        #mobileSidebarToggle {
            display: block; 
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            margin: 0;
            width: 30px;
            height: 30px;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
        #mobileSidebarToggle .arrow-icon {
            width: 100%;
            height: 100%;
            stroke: black;
            transition: transform 0.3s ease;
        }
        #mobileSidebarToggle.up .arrow-icon {
            transform: rotate(180deg);
        }

        .sidebar-content-wrapper {
            transition: max-height 0.4s ease-in-out;
            max-height: 500px; 
            overflow: hidden;
        }
        .sidebar-content-wrapper > * {
            transition: opacity 0.2s ease-in-out;
        }
        .sidebar-content-wrapper.collapsed {
            max-height: 0;
            border-top: none;
            padding-top: 0;
            padding-bottom: 0;
        }
        .sidebar-content-wrapper.collapsed > * {
            opacity: 0;
            pointer-events: none;
        }

        #questionGridContainer {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); 
            gap: 10px;
            align-content: flex-start;
        }

        @media (min-width: 992px) {
            #examBody {
                display: grid;
                grid-template-columns: 1fr 2.5fr; 
                padding: 25px;
                gap: 25px;
                padding-bottom: 50px;
            }
            #examMainContent {
                order: 2;
                overflow-y: auto; 
            }
            #examSidePanel {
                order: 1;
                max-height: none;
            }
            #mobileSidebarToggle {
                display: none;
            }
            .sidebar-content-wrapper.collapsed {
                max-height: 500px;
            }
            .sidebar-content-wrapper.collapsed > * {
                opacity: 1;
                pointer-events: auto;
            }
        }
        
        #questionPanelHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        #questionPanelHeader .ragu-checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #questionPanelHeader label {
            cursor: pointer;
            font-weight: 500;
        }
        #questionPanelHeader input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        #questionHeaderNumber {
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .question-number-box {
            background-color: var(--primary-color);
            color: white;
            padding: 3px 9px;
            border-radius: 5px;
            margin-left: 8px;
            font-size: 1em;
        }


        #questionDisplayBox {
            flex-grow: 1;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 30px;
            background-color: #ffffff;
        }

        #questionContent {
            font-size: 1.1em;
            line-height: 1.7;
            margin-bottom: 30px;
            text-align: left;
        }
        
        #questionContent img, .cbt-option-label .option-text img {
            max-width: 100%;
            height: auto;
            margin: 10px 5px;
            border-radius: 5px;
            vertical-align: middle;
        }

        #cbtAnswerOptions {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .cbt-option-label {
            display: flex;
            align-items: center;
            justify-content: flex-start; 
            gap: 15px; 
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .cbt-option-label:hover {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
        }
        .cbt-option-label.selected {
            background-color: #e2f0ff;
            border-color: var(--primary-color);
        }
        .cbt-option-label input[type="radio"] {
            margin: 0; 
            flex-shrink: 0;
            width: 18px;
            height: 18px;
        }
        .cbt-option-label .option-text {
            flex-grow: 1;
            text-align: left;
        }

        #examNavigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        #examNavigation button {
            width: auto;
            padding: 10px 30px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 8px;
            margin: 0;
        }
        #prevQuestionBtn, #nextQuestionBtn {
            background-color: var(--accent-color);
        }
        #prevQuestionBtn:hover, #nextQuestionBtn:hover {
            background-color: var(--primary-color);
        }
        
        #nextQuestionBtn.submit-mode {
            background-color: var(--danger-color);
        }
        #nextQuestionBtn.submit-mode:hover {
            background-color: #c82333;
        }

        #examNavigation button:disabled {
            background-color: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .question-nav-box {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        .question-nav-box:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        .question-nav-box.answered {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        .question-nav-box.current {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-color);
            transform: scale(1.05);
        }
        .question-nav-box.ragu::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 12px 12px 0;
            border-color: transparent var(--danger-color) transparent transparent;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }
        #submissionWarningMessage {
            color: red;
            font-weight: bold;
            text-align: center;
            font-size: 0.9em;
            min-height: 1.2em;
            margin-bottom: 10px;
        }
        #submitAnswersButton {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            background-color: var(--danger-color);
        }
        #submitAnswersButton:hover {
            background-color: #c82333;
        }
        #submitAnswersButton:disabled {
             background-color: #cccccc;
             cursor: not-allowed;
        }
        /* === [END] GAYA TAMPILAN UJIAN BARU === */

        #examFooter {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #343a40;
            color: white;
            padding: 8px 15px;
            box-sizing: border-box;
            z-index: 501; 
            text-align: center;
            font-size: 0.9em;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #studentIdentityDisplay {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
        }


        #warningOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0);
            z-index: 10;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #warningOverlay.show {
            display: flex;
            opacity: 1;
        }

        .warning-content-box {
            background: rgba(255, 255, 255, 0.03);
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: none;
            text-align: center;
            box-sizing: border-box;
            pointer-events: none;
        }

        #warningCountdown {
            font-size: 4em;
            font-weight: bold;
            color: red;
            text-shadow: 0 0 10px rgba(255,0,0,0.5);
            margin-bottom: 10px;
            pointer-events: none;
            animation: blink-smooth 1.5s infinite alternate;
        }

        @keyframes blink-smooth {
            0% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        #warningMessage {
            font-size: 1.5em;
            color: black;
            font-weight: bold;
            pointer-events: none;
        }

        #submissionConfirmationOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            pointer-events: auto;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #submissionConfirmationOverlay.show {
            display: flex;
            opacity: 1;
        }

        .submission-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            text-align: center;
            box-sizing: border-box;
        }

        #submissionConfirmationOverlay h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            font-weight: bold;
            color: #4CAF50;
        }

        #submissionConfirmationOverlay p {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 20px;
        }

        #submissionConfirmationOverlay button {
            padding: 12px 25px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #submissionConfirmationOverlay button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        #submissionConfirmationOverlay button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,128,0,0.4);
        }
        
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Gaya Spinner */
        #loadingSpinner {
            display: none; /* Awalnya tersembunyi */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
            background-color: rgba(224, 224, 224, 0.8); /* Latar belakang semi-transparan */
            z-index: 10000; /* Pastikan di atas */
            transition: opacity 0.3s ease-in-out;
        }

        #loadingSpinner .spinner-border {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }

        #loadingSpinner p {
            font-size: 1.2em;
            color: #555;
            font-weight: bold;
        }

        /* Gaya untuk Overlay Blokir Akses */
        #accessBlockedOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #e0e0e0;
            z-index: 9999;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }

        .blocked-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            text-align: center;
            box-sizing: border-box;
        }

        .blocked-content h1 {
            font-size: 2em;
            color: #dc3545; /* Merah */
            font-weight: bold;
            margin-bottom: 15px;
        }

        .blocked-content p {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .password-input-container {
            position: relative;
            margin-bottom: 15px;
        }

        .password-input-container input {
            padding-right: 45px; /* Ruang untuk ikon mata */
        }
        
        .password-toggle-icon {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            cursor: pointer;
            color: #888;
            width: 24px;
            height: 24px;
        }
        
        .password-toggle-icon:hover {
            color: #333;
        }

        #unlockAccessBtn {
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 8px;
            width: 100%;
        }

        #unlockMessage {
            color: red;
            font-size: 0.9em;
            margin-top: 10px;
            min-height: 1.2em;
        }

        @media (max-width: 991px) {
            #examBody {
                display: flex;
                flex-direction: column;
            }
            #examMainContent {
                order: 2;
                flex-grow: 1;
                overflow: visible; 
            }
            #examSidePanel {
                order: 1;
                flex-shrink: 0;
            }
            #mobileSidebarToggle {
                display: block;
            }
            #questionGridContainer {
                grid-template-columns: repeat(10, 1fr);
                gap: 5px; 
            }
            .question-nav-box {
                font-size: 0.9em; 
            }
            .sidebar-footer {
                padding: 10px;
            }
            #submitAnswersButton {
                font-size: 1em;
                padding: 10px;
            }
            #submissionWarningMessage {
                margin-bottom: 5px;
            }
        }

        @media (max-width: 600px) {
            .initial-login-screen, .welcome-screen, .container {
                margin-top: 0; margin-bottom: 0; border-radius: 0; box-shadow: none; width: 100%; height: 100%; justify-content: center;
            }
            #confirmModal .modal-content, .custom-modal-content, .submission-content, .blocked-content {
                max-width: 95%; width: 95%;
            }
            #examBody {
                padding: 15px;
                gap: 15px;
            }
            #questionDisplayBox {
                padding: 15px;
            }
            #warningCountdown { font-size: 3em; }
            #warningMessage { font-size: 1.2em; }
        }
    </style>
</head>
<body>
    
    <div id="loadingSpinner">
        <div class="spinner-border"></div>
        <p>Memuat aplikasi...</p>
    </div>
    
    <div id="accessBlockedOverlay">
        <div class="blocked-content">
            <h1>AKSES DIBLOKIR</h1>
            <p>Ujian hanya bisa diakses melalui aplikasi yang sudah disosialisasikan. Silahkan hubungi Admin jika terdapat kendala.</p>
            <div class="password-input-container">
                <input type="password" id="unlockKeyInput" placeholder="Masukkan Kunci Akses">
                <span class="password-toggle-icon" id="togglePasswordVisibility">
                     <svg id="eye-open" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                     <svg id="eye-closed" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>
                </span>
            </div>
            <button id="unlockAccessBtn">BUKA AKSES</button>
            <p id="unlockMessage"></p>
        </div>
    </div>

    
    <div id="initialLoginScreen" class="initial-login-screen">
        <h2>LOGIN SISWA</h2>
        <p>Masukkan email dan password Anda untuk melanjutkan.</p>
        <input type="email" id="loginEmail" placeholder="Email" />
        <input type="password" id="loginPassword" placeholder="Password" />
        <p class="message" id="loginMessage"></p>
        <button id="loginButton">Login</button>
    </div>

    <div id="welcomeScreen" class="welcome-screen">
        <h2 id="welcomeTitle">SELAMAT DATANG</h2>
        <p id="welcomeMessage">Memuat pilihan ujian...</p>
        <div id="welcomeButtonsContainer" style="display: flex; flex-direction: column; gap: 15px;">
            
        </div>
    </div>

    <div id="loginContainer" class="container">
        <div class="header-box">
            
            <div id="backToWelcomeBtn" class="back-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <img src="https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/logosmpn2pjg.png" alt="Logo" class="logo" />
            <div class="title">SMPN 2 PAJANGAN</div>
        </div>
        <div class="card-body">
            <div class="judul-ujian" id="loginJudulUjian">UJIAN KELAS</div>
            
             
            <div id="locationBlockedDiv" style="display: none; color: red; margin-bottom: 10px; font-weight: bold; text-align: center;"></div>
             
            <div id="locationKeyContainer" style="display: none;">
                <p>Jika lokasi tetap tidak valid, silahkan hubungi pengawas untuk mendapatkan kunci akses lokasi.</p>
                <div class="password-input-container">
                    <input type="password" id="locationKeyInput" placeholder="Masukkan Kunci Akses">
                    <span class="password-toggle-icon" id="toggleLocationKeyVisibility">
                        <svg id="loc-eye-open" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        <svg id="loc-eye-closed" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>
                    </span>
                </div>
                <button id="validateLocationKeyBtn">Validasi Kunci</button>
                <p class="message" id="locationKeyMessage"></p>
            </div>
            
            <p class="message" id="message"></p>
            <p id="locationStatus" style="color: gray; font-size: 12px; text-align: center; display: none;">Memuat status lokasi...</p>

            <div id="mainLoginControls" style="display: none;">
                <div class="custom-dropdown-container">
                    <div id="customSelectKelasDisplay" class="custom-dropdown-display" data-placeholder="-- Pilih Kelas --">
                        -- Pilih Kelas --
                    </div>
                    <input type="hidden" id="selectKelas" value="" />
                </div>

                <div class="custom-dropdown-container">
                    <div id="customSelectNamaSiswaDisplay" class="custom-dropdown-display" data-placeholder="-- Pilih Nama Siswa --">
                        -- Pilih Nama Siswa --
                    </div>
                    <input type="hidden" id="selectNamaSiswa" value="" />
                </div>

                <div class="token-input-group">
                    <input type="text" id="inputTokenPrefix" placeholder="TOKEN (contoh: ABCDE)" />
                    <span class="token-separator">-</span>
                    <input type="text" id="displayStudentId" placeholder="ID Siswa" readonly />
                </div>

                <button id="loginBtn">Login</button>
            </div>
        </div>
        <div class="footer">
            Â© Admin SMPN 2 Pajangan<br>
            <span id="datetime"></span>
        </div>
    </div>

    
    <div id="examContainer" style="display: none;">
        <div id="examBody">
            <div id="examSidePanel">
                <div class="sidebar-header">
                    <span id="timerText">00:00</span>
                    <button id="mobileSidebarToggle">
                        <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </button>
                </div>
                <div class="sidebar-content-wrapper">
                    <div id="questionGridContainer"></div>
                    <div class="sidebar-footer">
                        <button id="submitAnswersButton" disabled>KIRIM JAWABAN</button>
                        <p id="submissionWarningMessage"></p>
                    </div>
                </div>
            </div>
            <div id="examMainContent">
                <div id="questionDisplayBox">
                    <div id="questionPanelHeader">
                        <span id="questionHeaderNumber">Soal No. 1</span>
                        <div class="header-controls-right">
                            <div class="ragu-checkbox-container">
                                <label for="raguRaguCheckbox">Ragu-ragu</label>
                                <input type="checkbox" id="raguRaguCheckbox" />
                            </div>
                        </div>
                    </div>
                    <div id="resizableContent">
                        <div id="questionContent"></div>
                        <div id="cbtAnswerOptions"></div>
                    </div>
                    <div id="examNavigation">
                        <button id="prevQuestionBtn" disabled>Sebelumnya</button>
                        <button id="nextQuestionBtn">Selanjutnya</button>
                    </div>
                </div>
            </div>
        </div>
        
        
        <div id="warningOverlay" style="display: none;">
            <div class="warning-content-box">
                <div id="warningCountdown"></div>
                <div id="warningMessage">SEGERA KIRIMKAN JAWABAN, JANGAN SAMPAI KEHABISAN WAKTU!</div>
            </div>
        </div>
        
        <div id="examFooter">
            <span id="studentIdentityDisplay"></span>
        </div>
    </div>
    
    <div id="confirmModal">
        <div class="modal-content">
            <h4>DATA UJIAN ONLINE</h4>
            <table class="info-table">
                <tr>
                    <td>ID Siswa</td>
                    <td>: <span id="modalIdSiswa"></span></td>
                </tr>
                <tr>
                    <td>Nama Lengkap</td>
                    <td>: <span id="modalNamaLengkap"></span></td>
                </tr>
                <tr>
                    <td>Kelas</td>
                    <td>: <span id="modalKelas"></span></td>
                </tr>
                <tr>
                    <td>Mapel</td>
                    <td>: <span id="modalMapel"></span></td>
                </tr>
                <tr>
                    <td>Waktu Ujian</td>
                    <td>: <span id="modalExamDuration"></span></td>
                </tr>
            </table>

            <div class="checkbox-container">
                <input type="checkbox" id="confirmCheckbox">
                <label for="confirmCheckbox">Data di atas sudah benar</label>
            </div>
            <p id="modalMessage" style="display: none;"></p>
            <div class="button-container">
                <button id="btnLanjut">Lanjutkan</button>
                <button id="btnBatal" onclick="window.tutupModal()">Batal</button>
            </div>
        </div>
    </div>

    <div id="submissionConfirmationOverlay">
        <div class="submission-content">
            <h1 id="submissionOverlayTitle"></h1>
            <p id="submissionOverlayMessage"></p>
            <button id="backToLoginFromSubmissionBtn">KEMBALI</button>
        </div>
    </div>

    <div id="classModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4 id="classModalTitle">Pilih Kelas</h4>
            <ul id="classModalList" class="custom-modal-list">
            </ul>
        </div>
    </div>

    <div id="studentModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4>Pilih Nama Siswa</h4>
            <ul id="studentModalList" class="custom-modal-list">
            </ul>
        </div>
    </div>
    
    <div id="susulanListModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4 id="susulanModalTitle">Pilih Ujian Susulan</h4>
            <ul id="susulanModalList" class="custom-modal-list">
            </ul>
            <button id="closeSusulanModalButton" onclick="window.closeSusulanListModal()">TUTUP</button>
        </div>
    </div>

    <div id="customMessageModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4 id="customMessageModalTitle"></h4>
            <p id="customMessageModalText"></p>
            <button id="customMessageModalButton" onclick="window.hideCustomMessageModal()">OK</button>
        </div>
    </div>

    <div id="customConfirmModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4 id="customConfirmModalTitle"></h4>
            <p id="customConfirmModalText"></p>
            <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                <button id="customConfirmModalConfirmBtn" style="background-color: #28a745; width: 45%;">Ya</button>
                <button id="customConfirmModalCancelBtn" style="background-color: #dc3545; width: 45%;">Tidak</button>
            </div>
        </div>
    </div>

    <!-- [BARU] Modal untuk notifikasi force logout -->
    <div id="forceLogoutModal" class="custom-modal static-backdrop">
        <div class="custom-modal-content" style="text-align: center;">
            <h4 id="forceLogoutModalTitle" style="color: var(--danger-color);">Sesi Direset</h4>
            <p id="forceLogoutModalText">Sesi ujian Anda telah direset oleh administrator. Silakan login kembali.</p>
            <button id="forceLogoutModalButton" style="margin-top: 20px; background-color: var(--primary-color);">Logout</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getDatabase, ref, get, child, runTransaction, set, onValue, off, update, remove } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

        // Konfigurasi Firebase untuk SETUP (login utama dan pengaturan global)
        const setupFirebaseConfig = {
            apiKey: "AIzaSyBbXJ4VuACXyHJhl2eVSB2vHiT6hrx-XnE",
            authDomain: "setup-73809.firebaseapp.com",
            databaseURL: "https://setup-73809-default-rtdb.firebaseio.com",
            projectId: "setup-73809",
            storageBucket: "setup-73809.firebasestorage.app",
            messagingSenderId: "843995999446",
            appId: "1:843995999446:web:7fd92546f2d0bea73fed77"
        };
        const setupApp = initializeApp(setupFirebaseConfig, "setupApp");
        const setupAuth = getAuth(setupApp);
        const setupDb = getDatabase(setupApp);


        // Global variables for authenticated user credentials
        let globalUserEmail = '';
        let globalUserPassword = '';

        // Konfigurasi Firebase untuk setiap grup kelas (3 Angkatan)
        const allFirebaseConfigs = {
            'kelas7-group1': { /* 7ABC */
                apiKey: "AIzaSyBAKwT7JY_HGnvK6h3u30-dfgRPXfef8l8",
                authDomain: "abc-a13ea.firebaseapp.com",
                databaseURL: "https://abc-a13ea-default-rtdb.firebaseio.com",
                projectId: "abc-a13ea",
                storageBucket: "abc-a13ea.firebasestorage.app",
                messagingSenderId: "1052966795599",
                appId: "1:1052966795599:web:d4d331199ca9081321ed3a",
                theme: {
                    primary: '#0066cc',
                    accent: '#007bff',
                    warning: '#0066cc'
                },
                allowedClasses: ['7A', '7B', '7C']
            },
            'kelas7-group2': { /* 7DEF */
                apiKey: "AIzaSyBkhBZw3oADXUAJ9FXY9-g7XBsSmQhzZVk",
                authDomain: "def-ab5ee.firebaseapp.com",
                databaseURL: "https://def-ab5ee-default-rtdb.firebaseio.com",
                projectId: "def-ab5ee",
                storageBucket: "def-ab5ee.firebasestorage.app",
                messagingSenderId: "129712840107",
                appId: "1:129712840107:web:ab10576fed95f735dd46ee",
                 theme: {
                    primary: '#0066cc',
                    accent: '#007bff',
                    warning: '#0066cc'
                },
                allowedClasses: ['7D', '7E', '7F']
            },
            'kelas8-group1': { /* 8ABC */
                apiKey: "AIzaSyAwilwwwEJ2MAdSf09BotxNH-z6RiXaHXY",
                authDomain: "abc-43e73.firebaseapp.com",
                databaseURL: "https://abc-43e73-default-rtdb.firebaseio.com",
                projectId: "abc-43e73",
                storageBucket: "abc-43e73.firebasestorage.app",
                messagingSenderId: "1043754727577",
                appId: "1:1043754727577:web:56c3732bf2a6ac900c2008",
                theme: {
                    primary: '#cc7a00',
                    accent: '#ff9900',
                    warning: '#ff9900'
                },
                allowedClasses: ['8A', '8B', '8C']
            },
            'kelas8-group2': { /* 8DEF */
                apiKey: "AIzaSyBeCI57lmZ4-8DAKYJ7nvYjnXOfvy0vqrk",
                authDomain: "def-efcb2.firebaseapp.com",
                databaseURL: "https://def-efcb2-default-rtdb.firebaseio.com",
                projectId: "def-efcb2",
                storageBucket: "def-efcb2.firebasestorage.app",
                messagingSenderId: "12569956361",
                appId: "1:12569956361:web:fea36c4e034e65f33ba8d8",
                theme: {
                    primary: '#cc7a00',
                    accent: '#ff9900',
                    warning: '#ff9900'
                },
                allowedClasses: ['8D', '8E', '8F']
            },
            'kelas9-group1': { /* 9ABC */
                apiKey: "AIzaSyBZ6JR3ggnUiZFQ-wdrewbfhzMUwFaGGzQ",
                authDomain: "abc-d272a.firebaseapp.com",
                databaseURL: "https://abc-d272a-default-rtdb.firebaseio.com",
                projectId: "abc-d272a",
                storageBucket: "abc-d272a.firebasestorage.app",
                messagingSenderId: "1036605132828",
                appId: "1:1036605132828:web:2b59f91290d50afe304fd9",
                theme: {
                    primary: '#5a0000',
                    accent: '#800000',
                    warning: '#800000'
                },
                allowedClasses: ['9A', '9B', '9C']
            },
            'kelas9-group2': { /* 9DEF */
                apiKey: "AIzaSyC2iwuDMWTaJIG8g464Wt0En3CXI2DZiz4",
                authDomain: "def-85f32.firebaseapp.com",
                databaseURL: "https://def-85f32-default-rtdb.firebaseio.com",
                projectId: "def-85f32",
                storageBucket: "def-85f32.firebasestorage.app",
                messagingSenderId: "82670626048",
                appId: "1:82670626048:web:f5fdfda8fe078245b6bfe5",
                theme: {
                    primary: '#5a0000',
                    accent: '#800000',
                    warning: '#800000'
                },
                allowedClasses: ['9D', '9E', '9F']
            }
        };

        const firebaseApps = {};
        const firebaseDBs = {};
        const firebaseAuths = {};
        let currentDb = null;
        let currentAuth = null;
        let currentSelectedGrade = null;
        let currentClassGroupKeys = [];

        function getClassGroupKeysByGrade(grade) {
            const keys = [];
            for (const key in allFirebaseConfigs) {
                if (key.startsWith(`kelas${grade}`)) {
                    keys.push(key);
                }
            }
            return keys;
        }

        async function getFirebaseInstanceForClass(className) {
            let classGroupKey = null;
            for (const key in allFirebaseConfigs) {
                if (allFirebaseConfigs[key].allowedClasses.includes(className)) {
                    classGroupKey = key;
                    break;
                }
            }

            if (!classGroupKey || !allFirebaseConfigs[classGroupKey]) {
                console.error(`Error: Tidak ada konfigurasi Firebase yang ditemukan untuk kelas: ${className}`);
                return null;
            }

            if (!firebaseApps[classGroupKey]) {
                const config = allFirebaseConfigs[classGroupKey];
                const appInstance = initializeApp(config, classGroupKey);
                firebaseApps[classGroupKey] = appInstance;
                firebaseDBs[classGroupKey] = getDatabase(appInstance);
                firebaseAuths[classGroupKey] = getAuth(appInstance);

                try {
                    if (globalUserEmail && globalUserPassword) {
                        await signInWithEmailAndPassword(firebaseAuths[classGroupKey], globalUserEmail, globalUserPassword);
                    } else {
                       console.warn(`Peringatan: Kredensial pengguna tidak tersedia. Tidak bisa login ke DB kelas ${classGroupKey}.`);
                    }
                } catch (error) {
                    console.error(`Gagal login ke database kelas ${classGroupKey}:`, error);
                    window.showCustomMessageModal("Kesalahan Autentikasi Kelas", `Gagal mengautentikasi ke database untuk kelas ini. Mohon hubungi administrator.`, 'error');
                    return null;
                }
            }
            return { db: firebaseDBs[classGroupKey], auth: firebaseAuths[classGroupKey] };
        }

        function getDbRefs() {
            if (!currentDb) {
                console.error("Instance database (currentDb) tidak diinisialisasi.");
                return null;
            }
            return {
                studentsRef: ref(currentDb, 'students'),
                tokensRef: ref(currentDb, 'tokens'),
                examAccessStatusRef: ref(currentDb, 'exam_access_status'),
                submittedExamsRef: ref(currentDb, 'submitted_exams'),
                studentAnswersRef: ref(currentDb, 'student_answers'),
                ujianRef: ref(currentDb, 'ujian')
            };
        }
        
        function getSetupDbRefs() {
             return {
                settingsRef: ref(setupDb, 'setlokasi'),
                minDurationSettingsRef: ref(setupDb, 'min_duration_settings'),
                publicSettingsRef: ref(setupDb, 'publicSettings'),
                shuffleSettingsRef: ref(setupDb, 'acaksoalpilgan'),
                blockKeySettingsRef: ref(setupDb, 'block_key_settings')
            };
        }

        let isLocationEnabled = true;
        let firebaseAllowedRadiusKm = 0.075;
        let locationAccessKey = "";

        // Variabel untuk blokir akses
        let isBlockEnabled = false;
        let blockAccessKey = "";

        let minDurationSettingsGlobal = { isMinDurationEnabled: false, minDurationSeconds: 1800 };
        let isSoalAcakEnabled = true;
        let isPilganAcakEnabled = true;
        let publicSettings = null;

        const allowedLatitude = -7.8589546;
        const allowedLongitude = 110.2655596;

        const loadingSpinner = document.getElementById('loadingSpinner');
        const accessBlockedOverlay = document.getElementById('accessBlockedOverlay');
        const unlockKeyInput = document.getElementById('unlockKeyInput');
        const unlockAccessBtn = document.getElementById('unlockAccessBtn');
        const unlockMessage = document.getElementById('unlockMessage');
        const togglePasswordVisibility = document.getElementById('togglePasswordVisibility');

        const initialLoginScreen = document.getElementById('initialLoginScreen');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginMessage = document.getElementById('loginMessage');
        const loginButton = document.getElementById('loginButton');

        const welcomeScreen = document.getElementById('welcomeScreen');
        const welcomeTitle = document.getElementById('welcomeTitle');
        const welcomeMessageElement = document.getElementById('welcomeMessage');
        const welcomeButtonsContainer = document.getElementById('welcomeButtonsContainer');
        const loginContainer = document.getElementById('loginContainer');
        const examContainer = document.getElementById('examContainer');
        const timerText = document.getElementById('timerText');
        const warningOverlay = document.getElementById('warningOverlay');
        const warningCountdown = document.getElementById('warningCountdown');

        const locationBlockedDiv = document.getElementById('locationBlockedDiv');
        const locationKeyContainer = document.getElementById('locationKeyContainer');
        const mainLoginControls = document.getElementById('mainLoginControls');
        const message = document.getElementById('message');
        const loginBtn = document.getElementById('loginBtn');
        const confirmModal = document.getElementById('confirmModal');
        const locationStatus = document.getElementById('locationStatus');
        
        const inputTokenPrefix = document.getElementById('inputTokenPrefix');
        const displayStudentId = document.getElementById('displayStudentId');
        
        const customSelectKelasDisplay = document.getElementById('customSelectKelasDisplay');
        const hiddenSelectKelas = document.getElementById('selectKelas');
        const customSelectNamaSiswaDisplay = document.getElementById('customSelectNamaSiswaDisplay');
        const hiddenSelectNamaSiswa = document.getElementById('selectNamaSiswa');

        const confirmCheckbox = document.getElementById('confirmCheckbox');
        const modalMessage = document.getElementById('modalMessage');
        const modalExamDuration = document.getElementById('modalExamDuration');

        const submissionConfirmationOverlay = document.getElementById('submissionConfirmationOverlay');
        const submissionOverlayTitle = document.getElementById('submissionOverlayTitle');
        const submissionOverlayMessage = document.getElementById('submissionOverlayMessage');
        const backToLoginFromSubmissionBtn = document.getElementById('backToLoginFromSubmissionBtn');
        
        const forceLogoutModal = document.getElementById('forceLogoutModal');
        const forceLogoutModalButton = document.getElementById('forceLogoutModalButton');

        const classModal = document.getElementById('classModal');
        const classModalList = document.getElementById('classModalList');
        const studentModal = document.getElementById('studentModal');
        const studentModalList = document.getElementById('studentModalList');
        
        const susulanListModal = document.getElementById('susulanListModal');
        
        const questionGridContainer = document.getElementById('questionGridContainer');
        const submitAnswersButton = document.getElementById('submitAnswersButton');
        const submissionWarningMessage = document.getElementById('submissionWarningMessage');
        const questionHeaderNumber = document.getElementById('questionHeaderNumber');
        const questionContent = document.getElementById('questionContent');
        const cbtAnswerOptions = document.getElementById('cbtAnswerOptions');
        const prevQuestionBtn = document.getElementById('prevQuestionBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const raguRaguCheckbox = document.getElementById('raguRaguCheckbox');

        const loginJudulUjian = document.getElementById('loginJudulUjian');
        
        let allStudentsData = [];
        let selectedStudentData = null;
        let isLocationValid = false;
        let foundTokenGlobal = null;
        let timerInterval;
        let remainingTime;
        
        let accessStatusListenerRef = null;
        let accessStatusListenerPath = null;

        let isInExamMode = false;
        let isAnyModalOpen = false;

        let currentExamQuestions = [];
        let studentAnswers = [];
        let raguRaguStatus = [];
        let currentQuestionIndex = 0;

        let shuffledQuestionIndices = [];
        let shuffledOptionOrders = [];

        let sidebarCollapseTimer = null;

        const customMessageModal = document.getElementById('customMessageModal');
        const customMessageModalTitle = document.getElementById('customMessageModalTitle');
        const customMessageModalText = document.getElementById('customMessageModalText');

        const customConfirmModal = document.getElementById('customConfirmModal');
        const customConfirmModalTitle = document.getElementById('customConfirmModalTitle');
        const customConfirmModalText = document.getElementById('customConfirmModalText');
        const customConfirmModalConfirmBtn = document.getElementById('customConfirmModalConfirmBtn');
        const customConfirmModalCancelBtn = document.getElementById('customConfirmModalCancelBtn');

        let manualSubmissionInProgress = false;
        let submissionStatusListenerRef = null;
        let submissionStatusListenerPath = null;

        function padStudentId(id) {
            return String(id).padStart(3, '0');
        }

        function isTouchDevice() {
            return window.matchMedia('(pointer: coarse)').matches;
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c;
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('datetime').textContent = now.toLocaleDateString('id-ID', options);
        }

        function isAllowedEnvironment() {
            const ua = navigator.userAgent.toLowerCase();
            const isSEB = ua.includes('seb/');
            const isAndroidWebView = ua.includes('wv') || (ua.includes('android') && !ua.includes('chrome') && !ua.includes('firefox'));
            const isIOSWebView = (ua.includes('iphone') || ua.includes('ipad')) && !ua.includes('safari');
            return isSEB || isAndroidWebView || isIOSWebView;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        window.formatTokenPrefix = function (inputElement) {
            if (!inputElement || typeof inputElement.value === 'undefined') {
                console.error("Error: inputElement atau nilainya tidak terdefinisi dalam formatTokenPrefix.");
                return;
            }

            const tokenInputGroup = inputElement.closest('.token-input-group');
            if (tokenInputGroup) {
                tokenInputGroup.classList.remove('is-valid', 'is-invalid');
            }

            let value = inputElement.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            inputElement.value = value;

            if (value.length > 0) {
                if (tokenInputGroup) tokenInputGroup.classList.add('is-valid');
            } else {
                if (tokenInputGroup) tokenInputGroup.classList.remove('is-valid');
            }
            updateLoginButtonStatus();
        };

        function updateLoginButtonStatus() {
            const isLocationCheckPassed = isLocationValid;
            const isClassAndStudentSelected = hiddenSelectKelas.value !== "" && hiddenSelectNamaSiswa.value !== "";
            const isTokenPrefixFilled = inputTokenPrefix.value.trim() !== "";
            const isStudentIdDisplayed = displayStudentId.value.trim() !== "";

            if (isClassAndStudentSelected) {
                inputTokenPrefix.disabled = false;
            } else {
                inputTokenPrefix.disabled = true;
                inputTokenPrefix.value = "";
                const tokenInputGroup = inputTokenPrefix.closest('.token-input-group');
                if (tokenInputGroup) {
                    tokenInputGroup.classList.remove('is-valid', 'is-invalid');
                }
            }

            if (hiddenSelectKelas.value === "") {
                customSelectNamaSiswaDisplay.classList.add('disabled');
            } else {
                customSelectNamaSiswaDisplay.classList.remove('disabled');
            }

            if (isLocationCheckPassed && isClassAndStudentSelected && isTokenPrefixFilled && isStudentIdDisplayed) {
                loginBtn.disabled = false;
                loginBtn.style.opacity = 1;
            } else {
                loginBtn.disabled = true;
                loginBtn.style.opacity = 0.6;
            }
        }

        window.tutupModal = async function () {
            confirmModal.classList.remove('show');
            isAnyModalOpen = false;
            message.textContent = "";
            modalMessage.textContent = "";
            confirmCheckbox.checked = false;
            updateLoginButtonStatus();

            sessionStorage.clear();
        };
        
        function showLocationFailureScreen(errorText, showKeyInput = false) {
            locationBlockedDiv.textContent = errorText;
            locationBlockedDiv.style.display = 'block';
            if (showKeyInput) {
                locationKeyContainer.style.display = 'block';
            } else {
                locationKeyContainer.style.display = 'none';
            }
            mainLoginControls.style.display = 'none';
            locationStatus.style.display = 'none';
            isLocationValid = false;
        }
        
        function showMainLoginForm() {
            locationKeyContainer.style.display = 'none';
            locationBlockedDiv.style.display = 'none';
            locationStatus.style.display = 'none';
            mainLoginControls.style.display = 'block';
            isLocationValid = true;
            updateLoginButtonStatus();
        }

        function checkLocation(latitude, longitude) {
            const distance = getDistanceFromLatLonInKm(allowedLatitude, allowedLongitude, latitude, longitude);
            if (distance <= firebaseAllowedRadiusKm) {
                showMainLoginForm();
                locationStatus.textContent = "Lokasi valid.";
                locationStatus.style.color = "green";
                locationStatus.style.display = 'block';
            } else {
                const errorText = `Lokasi Anda saat ini berada ${distance.toFixed(2)} km dari radius yg diizinkan! keluar aplikasi, hidupkan mode pesawat dan matikan lokasi. Kemudian matikan mode pesawat, hidupkan lokasi dan coba akses ujian kembali`;
                showLocationFailureScreen(errorText, true);
            }
        }

        function handleLocation(position) {
            checkLocation(position.coords.latitude, position.coords.longitude);
        }

        function handleLocationError(error) {
            console.error("Gagal mendapatkan lokasi. Objek error mentah:", JSON.stringify(error, Object.getOwnPropertyNames(error)));

            let errorMessage;
            let showKey = true;

            if (error && typeof error.code === 'number') {
                switch (error.code) {
                    case 1: // PERMISSION_DENIED
                        errorMessage = "Aktifkan lokasi di perangkat Anda! keluar aplikasi, hidupkan mode pesawat dan matikan lokasi. Kemudian matikan mode pesawat, hidupkan lokasi dan coba akses ujian kembali";
                        showKey = false;
                        break;
                    case 2: // POSITION_UNAVAILABLE
                        errorMessage = "Informasi lokasi tidak tersedia saat ini. Pastikan GPS aktif dan sinyal memadai.";
                        break;
                    case 3: // TIMEOUT
                        errorMessage = "Waktu permintaan lokasi habis. Mohon coba refresh halaman.";
                        break;
                    default:
                        errorMessage = "Terjadi kesalahan lokasi yang tidak diketahui (Kode: " + error.code + ").";
                        break;
                }
            } else if (error && error.message) {
                 errorMessage = `Terjadi kesalahan lokasi: ${error.message}`;
            } else {
                errorMessage = "Gagal mengakses layanan lokasi. Pastikan GPS dan izin lokasi untuk aplikasi ini telah diaktifkan.";
                showKey = false;
            }
            
            showLocationFailureScreen(errorMessage, showKey);
        }


        function getLocation() {
            if (isLocationEnabled && isTouchDevice()) {
                locationStatus.style.display = 'block';
                locationStatus.textContent = 'Memvalidasi lokasi...';
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(handleLocation, handleLocationError, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                } else {
                    showLocationFailureScreen('Layanan Geolocation tidak didukung oleh perangkat ini.', true);
                }
            } else {
                showMainLoginForm();
            }
        }

        function loadClassDropdownForGrade(grade) {
            customSelectKelasDisplay.classList.add('disabled');
            customSelectNamaSiswaDisplay.classList.add('disabled');
            inputTokenPrefix.disabled = true;
            displayStudentId.value = "";
            message.innerHTML = `Memuat daftar kelas untuk kelas ${grade}... <span class="spinner"></span>`;

            const classNames = [];
            currentClassGroupKeys.forEach(groupKey => {
                const config = allFirebaseConfigs[groupKey];
                classNames.push(...config.allowedClasses);
            });
            classNames.sort();

            classModalList.innerHTML = '';
            classNames.forEach(cls => {
                const listItem = document.createElement('li');
                listItem.textContent = cls;
                listItem.dataset.value = cls;
                listItem.addEventListener('click', () => selectClass(cls));
                classModalList.appendChild(listItem);
            });
            customSelectKelasDisplay.classList.remove('disabled');
            message.textContent = "";
        }

        async function loadStudentsAndFilterByClass() {
            if (!currentDb) {
                message.style.color = "red";
                message.textContent = "Database belum diinisialisasi. Pilih kelas terlebih dahulu.";
                return;
            }

            const dbRefs = getDbRefs();
            if (!dbRefs) return;

            customSelectNamaSiswaDisplay.classList.add('disabled');
            inputTokenPrefix.disabled = true;
            displayStudentId.value = "";
            message.innerHTML = `Memuat data siswa untuk kelas ${hiddenSelectKelas.value}... <span class="spinner"></span>`;

            try {
                const snapshot = await get(dbRefs.studentsRef);
                if (snapshot.exists()) {
                    allStudentsData = [];
                    snapshot.forEach(childSnapshot => {
                        allStudentsData.push({ ...childSnapshot.val(), key: childSnapshot.key });
                    });

                    filterStudentsByClass();
                    message.textContent = "";
                } else {
                    message.style.color = "orange";
                    message.textContent = "Tidak ada data siswa ditemukan di database ini untuk kelas yang dipilih.";
                }
            } catch (error) {
                console.error("Gagal memuat data siswa:", error);
                message.style.color = "red";
                message.textContent = "Gagal memuat data siswa dari database yang dipilih.";
            }
        }

        function filterStudentsByClass() {
            const selectedClass = hiddenSelectKelas.value;
            studentModalList.innerHTML = '';
            hiddenSelectNamaSiswa.value = '';
            customSelectNamaSiswaDisplay.textContent = customSelectNamaSiswaDisplay.dataset.placeholder;
            customSelectNamaSiswaDisplay.classList.remove('selected');
            selectedStudentData = null;
            displayStudentId.value = "";
            inputTokenPrefix.value = "";
            const tokenInputGroup = inputTokenPrefix.closest('.token-input-group');
            if (tokenInputGroup) {
                tokenInputGroup.classList.remove('is-valid', 'is-invalid');
            }

            if (selectedClass) {
                const filteredStudents = allStudentsData.filter(student => student.class === selectedClass);
                filteredStudents.sort((a, b) => String(a.name || '').localeCompare(String(b.name || ''))).forEach(student => {
                    const listItem = document.createElement('li');
                    listItem.textContent = student.name;
                    listItem.dataset.value = student.id;
                    listItem.addEventListener('click', () => selectStudent(student.id, student.name));
                    studentModalList.appendChild(listItem);
                });
                customSelectNamaSiswaDisplay.classList.remove('disabled');
            } else {
                customSelectNamaSiswaDisplay.classList.add('disabled');
            }
            updateLoginButtonStatus();
        }

        function openClassModal() {
            if (customSelectKelasDisplay.classList.contains('disabled')) return;
            classModal.classList.add('show');
            isAnyModalOpen = true;
        }

        function closeClassModal() {
            classModal.classList.remove('show');
            isAnyModalOpen = false;
        }

        async function selectClass(className) {
            hiddenSelectKelas.value = className;
            customSelectKelasDisplay.textContent = className;
            customSelectKelasDisplay.classList.add('selected');
            closeClassModal();

            const instances = await getFirebaseInstanceForClass(className);
            if (!instances) {
                message.style.color = "red";
                message.textContent = "Gagal memuat konfigurasi database untuk kelas ini.";
                updateLoginButtonStatus();
                return;
            }
            currentDb = instances.db;
            currentAuth = instances.auth;

            await loadStudentsAndFilterByClass();
            updateLoginButtonStatus();
        }

        function openStudentModal() {
            if (customSelectNamaSiswaDisplay.classList.contains('disabled')) return;
            studentModal.classList.add('show');
            isAnyModalOpen = true;
        }

        function closeStudentModal() {
            studentModal.classList.remove('show');
            isAnyModalOpen = false;
        }

        function selectStudent(studentId, studentName) {
            hiddenSelectNamaSiswa.value = studentId;
            customSelectNamaSiswaDisplay.textContent = studentName;
            customSelectNamaSiswaDisplay.classList.add('selected');
            selectedStudentData = allStudentsData.find(student => padStudentId(student.id) === padStudentId(studentId));
            displayStudentId.value = padStudentId(studentId);
            closeStudentModal();
            updateLoginButtonStatus();
        }
        
        function updateSubmissionButtonState() {
            if (!submitAnswersButton || !nextQuestionBtn) return;

            let isDisabled = true;
            const allAnswered = !studentAnswers.includes(null);

            if (minDurationSettingsGlobal.isMinDurationEnabled) {
                isDisabled = (remainingTime > minDurationSettingsGlobal.minDurationSeconds) || !allAnswered;
            } else {
                isDisabled = !allAnswered;
            }

            submitAnswersButton.disabled = isDisabled;
            
            if (currentQuestionIndex === currentExamQuestions.length - 1) {
                nextQuestionBtn.disabled = isDisabled;
            }
        }

        function updateTimerDisplay() {
            if (!timerText) return;

            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;

            const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerText.textContent = formattedTime;

            updateSubmissionButtonState();

            if (remainingTime <= 300 && remainingTime > 0) {
                timerText.style.color = 'var(--danger-color)';
                warningCountdown.textContent = formattedTime;
                warningOverlay.classList.add('show');
            } else {
                timerText.style.color = 'var(--danger-color)';
                warningOverlay.classList.remove('show');
            }

            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                timerText.textContent = "00:00";
                warningOverlay.classList.remove('show');

                if (submitAnswersButton) {
                    submitAnswersButton.disabled = true;
                }

                submitAnswers(true);
                return;
            }

            remainingTime--;
        }

        async function showSubmissionConfirmationOverlay(isAutoSubmit) {
            sessionStorage.clear();
            stopAccessStatusListener();
            stopSubmissionStatusListener();
            loginContainer.style.display = 'none';
            examContainer.style.opacity = 0;
            setTimeout(async () => {
                examContainer.style.display = 'none';
                submissionConfirmationOverlay.classList.add('show');
                document.body.style.overflow = 'hidden';
                if (timerInterval) clearInterval(timerInterval);
                
                isInExamMode = false;
                toggleExamSecurityFeatures(false);
                isAnyModalOpen = true;

                if (isAutoSubmit) {
                    submissionOverlayTitle.innerHTML = '<span style="color: red; font-weight: bold;">WAKTU HABIS</span>';
                    submissionOverlayMessage.innerText = 'Jawaban kamu otomatis terkirim.';
                } else {
                    submissionOverlayTitle.innerText = 'SELAMAT!';
                    submissionOverlayTitle.style.color = '#4CAF50';
                    submissionOverlayMessage.innerText = 'JAWABAN ANDA BERHASIL TERKIRIM!';
                }
                backToLoginFromSubmissionBtn.innerText = 'KEMBALI';

                const tokenFirebaseKey = foundTokenGlobal?.key;
                const studentId = selectedStudentData?.id ? padStudentId(selectedStudentData.id) : null;
                const dbRefs = getDbRefs();

                if (dbRefs && tokenFirebaseKey && studentId) {
                    const accessStatusRef = child(dbRefs.examAccessStatusRef, `${tokenFirebaseKey}/${studentId}`);
                    try {
                        manualSubmissionInProgress = true;
                        await update(accessStatusRef, { isLoggedIn: false, studentId: studentId });
                        manualSubmissionInProgress = false;
                    } catch (error) {
                        console.error("Gagal mengatur isLoggedIn ke false saat pengiriman:", error);
                    }
                }

            }, 500);
        }

        function hideSubmissionConfirmationOverlay() {
            submissionConfirmationOverlay.classList.remove('show');
            setTimeout(() => {
                document.body.style.overflow = '';
                isAnyModalOpen = false;
            }, 300);
        }

        function toggleExamSecurityFeatures(enable) {
            if (enable) {
                document.addEventListener('copy', preventDefaultBehavior);
                document.addEventListener('cut', preventDefaultBehavior);
                document.addEventListener('paste', preventDefaultBehavior);
                document.body.classList.add('no-select');
                document.addEventListener('selectstart', preventDefaultBehavior);
                document.addEventListener('contextmenu', preventDefaultBehavior);
            } else {
                document.removeEventListener('copy', preventDefaultBehavior);
                document.removeEventListener('cut', preventDefaultBehavior);
                document.removeEventListener('paste', preventDefaultBehavior);
                document.body.classList.remove('no-select');
                document.removeEventListener('selectstart', preventDefaultBehavior);
                document.removeEventListener('contextmenu', preventDefaultBehavior);
            }
        }

        function preventDefaultBehavior(e) {
            e.preventDefault();
            return false;
        }
        
        async function startExamProcess(examDurationMinutes, examStartTime, initialData) {
            
            if (initialData.shuffledQuestionIndices && initialData.shuffledOptionOrders) {
                shuffledQuestionIndices = initialData.shuffledQuestionIndices;
                shuffledOptionOrders = initialData.shuffledOptionOrders;
            } else {
                shuffledQuestionIndices = Array.from({ length: currentExamQuestions.length }, (_, i) => i);
                if (isSoalAcakEnabled) {
                    shuffleArray(shuffledQuestionIndices);
                }

                shuffledOptionOrders = currentExamQuestions.map(() => {
                    const options = ['A', 'B', 'C', 'D'];
                    if (isPilganAcakEnabled) {
                        shuffleArray(options);
                    }
                    return options;
                });

                await saveStudentAnswersToFirebase();
            }
            
            sessionStorage.setItem('shuffledQuestionIndices', JSON.stringify(shuffledQuestionIndices));
            sessionStorage.setItem('shuffledOptionOrders', JSON.stringify(shuffledOptionOrders));

            sessionStorage.setItem('isInExamMode', 'true');
            sessionStorage.setItem('selectedStudentData', JSON.stringify(selectedStudentData));
            sessionStorage.setItem('foundTokenGlobal', JSON.stringify(foundTokenGlobal));
            sessionStorage.setItem('examData', JSON.stringify(currentExamQuestions));
            sessionStorage.setItem('examStartTime', Number(examStartTime));
            sessionStorage.setItem('examDurationMinutes', examDurationMinutes);
            sessionStorage.setItem('selectedClass', hiddenSelectKelas.value);
            sessionStorage.setItem('selectedGrade', currentSelectedGrade);

            const numQuestions = currentExamQuestions.length;
            studentAnswers = (initialData.answers && initialData.answers.length === numQuestions) ? initialData.answers : Array(numQuestions).fill(null);
            raguRaguStatus = (initialData.ragu && initialData.ragu.length === numQuestions) ? initialData.ragu : Array(numQuestions).fill(false);
            const lastQuestionIndex = initialData.lastQuestionIndex || 0;

            sessionStorage.setItem('studentAnswers', JSON.stringify(studentAnswers));
            sessionStorage.setItem('raguRaguStatus', JSON.stringify(raguRaguStatus));
            sessionStorage.setItem('lastQuestionIndex', lastQuestionIndex);

            loginContainer.style.opacity = 0;
            setTimeout(() => {
                loginContainer.style.display = 'none';
                examContainer.style.display = 'flex';
                setTimeout(() => {
                    examContainer.style.opacity = 1;
                    isInExamMode = true;
                    toggleExamSecurityFeatures(true);
                    updateStudentIdentityPanel();
                    currentQuestionIndex = lastQuestionIndex;
                    displayQuestion(currentQuestionIndex);
                    renderQuestionGrid();
                    updateSubmissionButtonState();
                }, 10);
            }, 500);
            
            const totalDurationSeconds = examDurationMinutes * 60;
            const elapsedSeconds = Math.floor((Date.now() - examStartTime) / 1000);
            remainingTime = totalDurationSeconds - elapsedSeconds;
            
            if (remainingTime < 0) remainingTime = 0;

            timerInterval = setInterval(updateTimerDisplay, 1000);
            updateTimerDisplay();

            history.pushState(null, '', location.href);
            startAccessStatusListener();
            startSubmissionStatusListener();
        }

        async function restoreExamState() {
            if (sessionStorage.getItem('isInExamMode') !== 'true') return false;
            
            selectedStudentData = JSON.parse(sessionStorage.getItem('selectedStudentData'));
            foundTokenGlobal = JSON.parse(sessionStorage.getItem('foundTokenGlobal'));
            currentExamQuestions = JSON.parse(sessionStorage.getItem('examData'));
            const examDurationMinutes = parseInt(sessionStorage.getItem('examDurationMinutes'), 10);
            const selectedClass = sessionStorage.getItem('selectedClass');
            const selectedGrade = sessionStorage.getItem('selectedGrade');
            let examStartTime = Number(sessionStorage.getItem('examStartTime'));
            
            const initialData = {
                answers: JSON.parse(sessionStorage.getItem('studentAnswers')),
                ragu: JSON.parse(sessionStorage.getItem('raguRaguStatus')),
                lastQuestionIndex: parseInt(sessionStorage.getItem('lastQuestionIndex') || '0', 10),
                shuffledQuestionIndices: JSON.parse(sessionStorage.getItem('shuffledQuestionIndices')),
                shuffledOptionOrders: JSON.parse(sessionStorage.getItem('shuffledOptionOrders'))
            };
            
            if (!selectedStudentData || !foundTokenGlobal || !currentExamQuestions || isNaN(examDurationMinutes) || !selectedClass || !selectedGrade || isNaN(examStartTime) || !initialData.shuffledQuestionIndices) {
                sessionStorage.clear();
                return false;
            }

            currentSelectedGrade = selectedGrade;
            const gradeConfig = allFirebaseConfigs[`kelas${currentSelectedGrade}-group1`];
            if (gradeConfig && gradeConfig.theme) {
                Object.keys(gradeConfig.theme).forEach(key => {
                    document.documentElement.style.setProperty(`--${key}-color`, gradeConfig.theme[key]);
                });
            }

            const instances = await getFirebaseInstanceForClass(selectedClass);
            if (!instances) {
                sessionStorage.clear();
                return false;
            }
            currentDb = instances.db;
            currentAuth = instances.auth;

            const elapsedSeconds = Math.floor((Date.now() - examStartTime) / 1000);
            const totalDurationSeconds = examDurationMinutes * 60;
            remainingTime = totalDurationSeconds - elapsedSeconds;

            if (remainingTime > 0) {
                initialLoginScreen.style.display = 'none';
                welcomeScreen.style.display = 'none';
                loginContainer.style.display = 'none';
                examContainer.style.display = 'flex';
                examContainer.style.opacity = 1;
                
                await startExamProcess(examDurationMinutes, examStartTime, initialData);
                return true;
            } else {
                sessionStorage.clear();
                examContainer.style.display = 'flex';
                examContainer.style.opacity = 1;
                timerText.textContent = "00:00";
                updateStudentIdentityPanel();
                submitAnswers(true);
                return true;
            }
        }

        async function handleLanjutClick(foundToken) {
            if (!confirmCheckbox.checked) {
                modalMessage.style.display = 'block';
                modalMessage.textContent = "Anda harus mencentang cekbox untuk melanjutkan!";
                return;
            }
            modalMessage.style.display = 'none';
            confirmModal.classList.remove('show');
            isAnyModalOpen = false;

            if (!foundToken || !selectedStudentData || !currentDb) {
                window.showCustomMessageModal("Error", "Terjadi kesalahan data. Mohon muat ulang halaman.", "error");
                return;
            }

            loadingSpinner.querySelector('p').textContent = 'Mengunduh bank soal...';
            loadingSpinner.style.display = 'flex';

            const dbRefs = getDbRefs();
            if (!dbRefs) return;

            try {
                const tahunAjaranPath = foundToken.tahunAjaran.replace(/\//g, '-').trim();
                const ujianNamePath = foundToken.ujianName.replace(/\s+/g, '-').trim();
                const kelasPath = `Kelas-${foundToken.kelas.trim()}`;
                const subjectPath = foundToken.subject.replace(/\s+/g, '-').trim();
                const examPath = `ujian/${tahunAjaranPath}/${ujianNamePath}/${kelasPath}/${subjectPath}`;
                
                const examSnapshot = await get(ref(currentDb, examPath));
                
                if (!examSnapshot.exists()) {
                    throw new Error(`Bank soal tidak ditemukan.`);
                }
                const examData = examSnapshot.val();
                if (!examData || !Array.isArray(examData.soal) || examData.soal.length <= 1) {
                    throw new Error("Struktur bank soal tidak valid atau kosong.");
                }
                
                currentExamQuestions = examData.soal.slice(1);
                
                loadingSpinner.querySelector('p').textContent = 'Mempersiapkan sesi ujian...';

                const studentId = padStudentId(selectedStudentData.id);
                const tokenFirebaseKey = foundToken.key;
                const accessStatusRef = child(dbRefs.examAccessStatusRef, `${tokenFirebaseKey}/${studentId}`);
                
                const transactionResult = await runTransaction(accessStatusRef, (currentAccess) => {
                    const now = Date.now();
                    if (currentAccess === null || !currentAccess.isLoggedIn) {
                        return {
                            accessCount: (currentAccess?.accessCount || 0) + 1,
                            firstLoginTimestamp: currentAccess?.firstLoginTimestamp || now,
                            lastAccessTimestamp: now,
                            isLoggedIn: true,
                            examStartTime: currentAccess?.examStartTime || now,
                            studentId: studentId,
                        };
                    }
                    return;
                });

                if (transactionResult.committed) {
                    
                    const examStartTime = Number(transactionResult.snapshot.val().examStartTime);
                    
                    const savedAnswersSnapshot = await get(child(dbRefs.studentAnswersRef, `${tokenFirebaseKey}/${studentId}`));
                    const initialData = {};
                    if (savedAnswersSnapshot.exists()) {
                        const savedData = savedAnswersSnapshot.val();
                        initialData.answers = JSON.parse(savedData.answers || 'null');
                        initialData.ragu = JSON.parse(savedData.ragu || 'null');
                        if (savedData.shuffledQuestionIndices) initialData.shuffledQuestionIndices = JSON.parse(savedData.shuffledQuestionIndices);
                        if (savedData.shuffledOptionOrders) initialData.shuffledOptionOrders = JSON.parse(savedData.shuffledOptionOrders);
                    }
                    
                    await startExamProcess(foundToken.durationMinutes, examStartTime, initialData);
                    loadingSpinner.style.display = 'none';

                } else {
                    throw new Error("Gagal memulai sesi. Akun mungkin sedang digunakan di perangkat lain.");
                }
            } catch (err) {
                console.error("Error di handleLanjutClick:", err);
                loadingSpinner.style.display = 'none';
                window.showCustomMessageModal("Error", err.message, "error");
                loginBtn.disabled = false;
            }
        }

        function displayQuestion(shuffledIndex) {
            if (shuffledIndex < 0 || shuffledIndex >= currentExamQuestions.length) return;
            currentQuestionIndex = shuffledIndex;
            sessionStorage.setItem('lastQuestionIndex', shuffledIndex);

            const originalIndex = shuffledQuestionIndices[shuffledIndex];
            const question = currentExamQuestions[originalIndex];
            
            questionHeaderNumber.innerHTML = `Soal No. <span class="question-number-box">${shuffledIndex + 1}</span>`;
            questionContent.innerHTML = question.pertanyaan || "";
            
            cbtAnswerOptions.innerHTML = '';
            const optionOrder = shuffledOptionOrders[originalIndex];

            optionOrder.forEach(opt => {
                const optionKey = `pilihan${opt}`;
                if (question[optionKey]) {
                    const label = document.createElement('label');
                    label.className = 'cbt-option-label';
                    
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `question_${shuffledIndex}`;
                    radio.value = opt;
                    radio.onchange = () => selectAnswer(originalIndex, opt);

                    if (studentAnswers[originalIndex] === opt) {
                        radio.checked = true;
                        label.classList.add('selected');
                    }

                    const textDiv = document.createElement('div');
                    textDiv.className = 'option-text';
                    textDiv.innerHTML = question[optionKey];
                    
                    label.appendChild(radio);
                    label.appendChild(textDiv);
                    cbtAnswerOptions.appendChild(label);
                }
            });

            raguRaguCheckbox.checked = raguRaguStatus[originalIndex];
            
            if (shuffledIndex === currentExamQuestions.length - 1) {
                nextQuestionBtn.textContent = 'Kirim Jawaban';
                nextQuestionBtn.classList.add('submit-mode');
            } else {
                nextQuestionBtn.textContent = 'Selanjutnya';
                nextQuestionBtn.disabled = false;
                nextQuestionBtn.classList.remove('submit-mode');
            }
            prevQuestionBtn.disabled = shuffledIndex === 0;
            
            renderQuestionGrid();
            updateSubmissionButtonState();

            if (window.innerWidth < 992) {
                const wrapper = document.querySelector('.sidebar-content-wrapper');
                const toggleBtn = document.getElementById('mobileSidebarToggle');
                if (wrapper.classList.contains('collapsed')) {
                    wrapper.classList.remove('collapsed');
                    toggleBtn.classList.add('up');
                }
            }
            startSidebarCollapseTimer(); 
        }
        
        function selectAnswer(originalIndex, choice) {
            studentAnswers[originalIndex] = choice;
            sessionStorage.setItem('studentAnswers', JSON.stringify(studentAnswers));
            saveStudentAnswersToFirebase();
            
            const shuffledIndex = shuffledQuestionIndices.indexOf(originalIndex);
            if (shuffledIndex === currentQuestionIndex) {
                document.querySelectorAll('.cbt-option-label').forEach(label => label.classList.remove('selected'));
                const selectedRadio = document.querySelector(`input[name="question_${shuffledIndex}"][value="${choice}"]`);
                if (selectedRadio && selectedRadio.parentElement) {
                    selectedRadio.parentElement.classList.add('selected');
                }
            }
            
            renderQuestionGrid();
            updateSubmissionButtonState();
        }

        function toggleRaguRagu() {
            const originalIndex = shuffledQuestionIndices[currentQuestionIndex];
            raguRaguStatus[originalIndex] = !raguRaguStatus[originalIndex];
            sessionStorage.setItem('raguRaguStatus', JSON.stringify(raguRaguStatus));
            saveStudentAnswersToFirebase();
            renderQuestionGrid();
        }

        function renderQuestionGrid() {
            questionGridContainer.innerHTML = '';
            for (let i = 0; i < shuffledQuestionIndices.length; i++) {
                const originalIndex = shuffledQuestionIndices[i];
                const box = document.createElement('div');
                box.className = 'question-nav-box';
                box.textContent = i + 1;
                if (studentAnswers[originalIndex]) {
                    box.classList.add('answered');
                }
                if (raguRaguStatus[originalIndex]) {
                    box.classList.add('ragu');
                }
                if (i === currentQuestionIndex) {
                    box.classList.add('current');
                }
                box.onclick = () => displayQuestion(i);
                questionGridContainer.appendChild(box);
            }
        }

        async function saveStudentAnswersToFirebase() {
            if (!foundTokenGlobal || !selectedStudentData || !currentDb) return;
            const dbRefs = getDbRefs();
            if (!dbRefs) return;

            const studentAnswersPath = child(dbRefs.studentAnswersRef, `${foundTokenGlobal.key}/${padStudentId(selectedStudentData.id)}`);
            try {
                const payload = {
                    answers: JSON.stringify(studentAnswers),
                    ragu: JSON.stringify(raguRaguStatus),
                    shuffledQuestionIndices: JSON.stringify(shuffledQuestionIndices),
                    shuffledOptionOrders: JSON.stringify(shuffledOptionOrders),
                    timestamp: Date.now(),
                    studentName: selectedStudentData.name,
                    studentClass: selectedStudentData.class,
                    token: foundTokenGlobal.token,
                    subject: foundTokenGlobal.subject,
                    studentId: padStudentId(selectedStudentData.id)
                };
                await set(studentAnswersPath, payload);
            } catch (error) {
                console.error("Gagal menyimpan jawaban siswa ke Firebase:", error);
            }
        }

        async function submitAnswers(isAutoSubmit = false) {
            submissionWarningMessage.textContent = '';
            if (!foundTokenGlobal || !selectedStudentData || !currentDb) {
                submissionWarningMessage.textContent = 'Error: Data tidak lengkap.';
                return;
            }

            if (!isAutoSubmit) {
                const unansweredCount = studentAnswers.filter(a => a === null).length;
                if (unansweredCount > 0) {
                    const confirmed = await window.showCustomConfirmModal("Konfirmasi", `Masih ada ${unansweredCount} soal yang belum dijawab. Anda yakin ingin mengirim?`);
                    if (!confirmed) return;
                } else {
                     const confirmed = await window.showCustomConfirmModal("Konfirmasi", "Anda yakin ingin mengirim semua jawaban?");
                    if (!confirmed) return;
                }
            }

            submitAnswersButton.disabled = true;
            submitAnswersButton.textContent = 'Mengirim...';
            nextQuestionBtn.disabled = true;

            const dbRefs = getDbRefs();
            if (!dbRefs) return;
            
            try {
                manualSubmissionInProgress = true;
                await saveStudentAnswersToFirebase();
                const studentId = padStudentId(selectedStudentData.id);
                const tokenKey = foundTokenGlobal.key;
                
                await set(child(dbRefs.submittedExamsRef, `${tokenKey}/${studentId}`), { isSubmitted: true, timestamp: Date.now(), studentId });
                await update(child(dbRefs.examAccessStatusRef, `${tokenKey}/${studentId}`), { isLoggedIn: false, studentId });
                
                showSubmissionConfirmationOverlay(isAutoSubmit);
            } catch (error) {
                console.error("Gagal mengirimkan jawaban:", error);
                submissionWarningMessage.textContent = 'Gagal mengirim. Coba lagi.';
                submitAnswersButton.disabled = false;
                submitAnswersButton.textContent = 'KIRIM JAWABAN';
            } finally {
                manualSubmissionInProgress = false;
            }
        }

        window.showCustomMessageModal = function (title, messageText, type = 'info') {
            customMessageModalTitle.textContent = title;
            customMessageModalText.textContent = messageText;
            customMessageModal.classList.add('show');
            isAnyModalOpen = true;
        }

        window.hideCustomMessageModal = function () {
            customMessageModal.classList.remove('show');
            isAnyModalOpen = false;
        }

        window.showCustomConfirmModal = function (title, messageText) {
            return new Promise((resolve) => {
                customConfirmModalTitle.textContent = title;
                customConfirmModalText.textContent = messageText;
                customConfirmModal.classList.add('show');
                isAnyModalOpen = true;

                const onConfirm = () => { cleanup(); resolve(true); };
                const onCancel = () => { cleanup(); resolve(false); };
                const cleanup = () => {
                    customConfirmModal.classList.remove('show');
                    isAnyModalOpen = false;
                    customConfirmModalConfirmBtn.removeEventListener('click', onConfirm);
                    customConfirmModalCancelBtn.removeEventListener('click', onCancel);
                };

                customConfirmModalConfirmBtn.addEventListener('click', onConfirm);
                customConfirmModalCancelBtn.addEventListener('click', onCancel);
            });
        }
        
        async function loadAndRenderWelcomeButtons() {
            welcomeButtonsContainer.innerHTML = '';
            welcomeMessageElement.textContent = 'Memuat pilihan ujian...';

            if (!publicSettings) {
                console.warn("Node publicSettings tidak ditemukan di Firebase. Menampilkan tombol default.");
                publicSettings = {};
            }

            const activeButtons = [];

            ['kelas7', 'kelas8', 'kelas9'].forEach(kelas => {
                if (publicSettings[kelas] && publicSettings[kelas].enabled) {
                    activeButtons.push({
                        id: `btn-${kelas}`,
                        text: `PILIH ${kelas.toUpperCase().replace('KELAS', 'KELAS ')}`,
                        class: `welcome-button btn-${kelas}`,
                        action: () => handleCustomButtonClassClick(kelas, publicSettings[kelas].url)
                    });
                }
            });

            if (publicSettings.susulan && publicSettings.susulan.enabled && publicSettings.susulan.list && Object.keys(publicSettings.susulan.list).length > 0) {
                activeButtons.push({
                    id: `btn-susulan`,
                    text: `UJIAN SUSULAN`,
                    class: `welcome-button btn-susulan`,
                    action: showSusulanListModal
                });
            }

            if (activeButtons.length > 0) {
                activeButtons.forEach(buttonInfo => {
                    const button = document.createElement('button');
                    button.id = buttonInfo.id;
                    button.className = buttonInfo.class;
                    button.textContent = buttonInfo.text;
                    button.addEventListener('click', buttonInfo.action);
                    welcomeButtonsContainer.appendChild(button);
                });
                welcomeTitle.textContent = 'SELAMAT DATANG';
                welcomeMessageElement.textContent = 'Silakan pilih jenjang kelas Anda untuk melanjutkan ke halaman ujian:';
            } else {
                welcomeTitle.textContent = 'SELAMAT DATANG';
                welcomeMessageElement.textContent = 'Silakan pilih jenjang kelas Anda untuk melanjutkan ke halaman ujian:';
                
                const btnKelas7 = document.createElement('button');
                btnKelas7.id = 'btnKelas7';
                btnKelas7.className = 'welcome-button btn-kelas7';
                btnKelas7.textContent = 'KELAS 7';
                btnKelas7.addEventListener('click', () => selectGrade(7));
                welcomeButtonsContainer.appendChild(btnKelas7);

                const btnKelas8 = document.createElement('button');
                btnKelas8.id = 'btnKelas8';
                btnKelas8.className = 'welcome-button btn-kelas8';
                btnKelas8.textContent = 'KELAS 8';
                btnKelas8.addEventListener('click', () => selectGrade(8));
                welcomeButtonsContainer.appendChild(btnKelas8);

                const btnKelas9 = document.createElement('button');
                btnKelas9.id = 'btnKelas9';
                btnKelas9.className = 'welcome-button btn-kelas9';
                btnKelas9.textContent = 'KELAS 9';
                btnKelas9.addEventListener('click', () => selectGrade(9));
                welcomeButtonsContainer.appendChild(btnKelas9);
            }
        }

        function handleCustomButtonClassClick(kelas, url) {
            if (url) {
                let fullUrl = url;
                if (!/^https?:\/\//i.test(url)) {
                    fullUrl = 'https://' + url;
                }
                window.location.href = fullUrl;
            } else {
                window.showCustomMessageModal("URL Tidak Ditemukan", `URL untuk ${kelas.toUpperCase()} tidak ditemukan. Harap hubungi administrator.`, 'error');
            }
        }

        function showSusulanListModal() {
            const susulanModalListEl = document.getElementById('susulanModalList');
            susulanModalListEl.innerHTML = '';

            if (publicSettings && publicSettings.susulan && publicSettings.susulan.list) {
                const susulanItems = Object.values(publicSettings.susulan.list);
                susulanItems.sort((a, b) => a.name.localeCompare(b.name)); 

                susulanItems.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span class="item-name">${item.name}</span>`;
                    listItem.addEventListener('click', () => {
                        if (item.url) {
                            let fullUrl = item.url;
                             if (!/^https?:\/\//i.test(item.url)) {
                                fullUrl = 'https://' + item.url;
                            }
                            window.open(fullUrl, '_blank');
                            window.closeSusulanListModal();
                        } else {
                            window.showCustomMessageModal("URL Tidak Ditemukan", `URL untuk ${item.name} tidak ditemukan.`, 'error');
                        }
                    });
                    susulanModalListEl.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = 'Tidak ada ujian susulan yang tersedia saat ini.';
                susulanModalListEl.appendChild(listItem);
            }

            susulanListModal.classList.add('show');
            isAnyModalOpen = true;
        }

        window.closeSusulanListModal = function() {
            susulanListModal.classList.remove('show');
            isAnyModalOpen = false;
        }

        async function selectGrade(grade) {
            currentSelectedGrade = grade;
            welcomeScreen.style.display = 'none';
            loginContainer.classList.add('show');
            if (isLocationEnabled) {
                mainLoginControls.style.display = 'none';
                getLocation();
            } else {
                showMainLoginForm();
            }

            const gradeConfig = allFirebaseConfigs[`kelas${grade}-group1`];
            if (gradeConfig && gradeConfig.theme) {
                Object.keys(gradeConfig.theme).forEach(key => {
                    document.documentElement.style.setProperty(`--${key}-color`, gradeConfig.theme[key]);
                });
            }

            loginJudulUjian.textContent = `UJIAN KELAS ${grade}`;
            classModalTitle.textContent = `Pilih Kelas ${grade}`;

            currentClassGroupKeys = getClassGroupKeysByGrade(grade);
            loadClassDropdownForGrade(grade);
        }
        
        function validateLocationKey() {
            const enteredKey = document.getElementById('locationKeyInput').value;
            if (enteredKey && enteredKey === locationAccessKey) {
                showMainLoginForm();
            } else {
                document.getElementById('locationKeyMessage').textContent = "Kunci Akses Lokasi salah.";
            }
        }
        
        // [PERBAIKAN] Memindahkan definisi fungsi ke atas
        function startSidebarCollapseTimer() {
            clearTimeout(sidebarCollapseTimer);
            if (window.innerWidth < 992 && !document.querySelector('.sidebar-content-wrapper').classList.contains('collapsed')) {
                sidebarCollapseTimer = setTimeout(() => {
                    const wrapper = document.querySelector('.sidebar-content-wrapper');
                    const toggleBtn = document.getElementById('mobileSidebarToggle');
                    wrapper.classList.add('collapsed');
                    toggleBtn.classList.remove('up');
                }, 6000); // 6 detik
            }
        }
        
        function updateStudentIdentityPanel() {
            const identityDisplay = document.getElementById('studentIdentityDisplay');
            if (identityDisplay && selectedStudentData) {
                let displayName = selectedStudentData.name;
                if (displayName.length > 25) { 
                    displayName = displayName.substring(0, 22) + '...';
                }
                identityDisplay.textContent = `${displayName} | ${selectedStudentData.class}`;
                identityDisplay.title = `${selectedStudentData.name} | ${selectedStudentData.class}`;
            }
        }

        function startAccessStatusListener() {
            if (!foundTokenGlobal || !selectedStudentData || !currentDb) return;
            const dbRefs = getDbRefs();
            if (!dbRefs) return;

            stopAccessStatusListener();

            accessStatusListenerPath = child(dbRefs.examAccessStatusRef, `${foundTokenGlobal.key}/${padStudentId(selectedStudentData.id)}`);
            accessStatusListenerRef = onValue(accessStatusListenerPath, (snapshot) => {
                if (isInExamMode && snapshot.exists()) {
                    const data = snapshot.val();
                    if (data.isLoggedIn === false && !manualSubmissionInProgress) {
                        showForceLogoutModal();
                    }
                }
            }, (error) => {
                console.error("Gagal mendengarkan status akses:", error);
            });
        }

        function stopAccessStatusListener() {
            if (accessStatusListenerRef && accessStatusListenerPath) {
                off(accessStatusListenerPath, 'value', accessStatusListenerRef);
                accessStatusListenerRef = null;
                accessStatusListenerPath = null;
            }
        }

        function showForceLogoutModal() {
            stopAccessStatusListener();
            stopSubmissionStatusListener();
            if (timerInterval) clearInterval(timerInterval);
            isInExamMode = false;

            document.querySelectorAll('#examContainer button, #examContainer input').forEach(el => el.disabled = true);
            document.getElementById('examBody').style.filter = 'blur(5px)';

            forceLogoutModal.classList.add('show');
            isAnyModalOpen = true;
        }

        async function initializeAppFlow() {
            loadingSpinner.style.display = 'flex';
            
            async function fetchGlobalSettings() {
                try {
                    const refs = getSetupDbRefs();
                    const [locSnap, minDurSnap, pubSetSnap, shuffleSnap, blockKeySnap] = await Promise.all([
                        get(refs.settingsRef), 
                        get(refs.minDurationSettingsRef), 
                        get(refs.publicSettingsRef),
                        get(refs.shuffleSettingsRef),
                        get(refs.blockKeySettingsRef)
                    ]);

                    if (locSnap.exists()) {
                        const s = locSnap.val();
                        isLocationEnabled = s.isLocationEnabled ?? true;
                        firebaseAllowedRadiusKm = s.allowedRadiusKm ?? 0.075;
                        locationAccessKey = s.currentKey || "";
                    }
                    if (blockKeySnap.exists()) {
                        const s = blockKeySnap.val();
                        isBlockEnabled = s.isEnabled ?? false;
                        blockAccessKey = s.key || "";
                    }
                    if (minDurSnap.exists()) {
                        const s = minDurSnap.val();
                        minDurationSettingsGlobal.isMinDurationEnabled = s.isMinDurationEnabled ?? false;
                        minDurationSettingsGlobal.minDurationSeconds = s.minDurationSeconds ?? 1800;
                    }
                    if (pubSetSnap.exists()) publicSettings = pubSetSnap.val();
                    if (shuffleSnap.exists()) {
                        const s = shuffleSnap.val();
                        isSoalAcakEnabled = s.soal ?? true;
                        isPilganAcakEnabled = s.pilgan ?? true;
                    } else {
                        isSoalAcakEnabled = true;
                        isPilganAcakEnabled = true;
                    }

                } catch (error) {
                    console.error("Gagal mengambil pengaturan global:", error);
                }
            }

            try {
                await signInWithEmailAndPassword(setupAuth, "speropa@gmail.com", "Pajangan201184*");
                globalUserEmail = "speropa@gmail.com";
                globalUserPassword = "Pajangan201184*";
                await fetchGlobalSettings();

                if (isBlockEnabled && !isAllowedEnvironment()) {
                    unlockAccessBtn.onclick = async () => {
                        if (unlockKeyInput.value === blockAccessKey) {
                            accessBlockedOverlay.style.display = 'none';
                            loadingSpinner.style.display = 'flex';
                            const isRestored = await restoreExamState();
                             if (!isRestored) {
                                await loadAndRenderWelcomeButtons();
                                loadingSpinner.style.display = 'none';
                                welcomeScreen.style.display = 'flex';
                            } else {
                                loadingSpinner.style.display = 'none';
                            }
                        } else {
                            unlockMessage.textContent = "Kunci yang dimasukkan salah.";
                        }
                    };
                    loadingSpinner.style.display = 'none';
                    accessBlockedOverlay.style.display = 'flex';
                } else {
                    const isRestored = await restoreExamState();
                    if (!isRestored) {
                       await loadAndRenderWelcomeButtons();
                       loadingSpinner.style.display = 'none';
                       welcomeScreen.style.display = 'flex';
                    } else {
                        loadingSpinner.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error("Login otomatis gagal:", error);
                loadingSpinner.style.display = 'none';
                initialLoginScreen.style.display = 'flex';
                loginMessage.textContent = "Login otomatis gagal. Silakan masuk secara manual.";
                loginButton.onclick = async () => {
                     window.showCustomMessageModal("Fitur Belum Tersedia", "Login manual saat ini tidak diaktifkan.", "warning");
                };
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            await initializeAppFlow();
            
            customSelectKelasDisplay.addEventListener('click', openClassModal);
            customSelectNamaSiswaDisplay.addEventListener('click', openStudentModal);
            document.getElementById('validateLocationKeyBtn').addEventListener('click', validateLocationKey);

            classModal.addEventListener('click', e => e.target === classModal && closeClassModal());
            studentModal.addEventListener('click', e => e.target === studentModal && closeStudentModal());

            inputTokenPrefix.addEventListener('input', () => window.formatTokenPrefix(inputTokenPrefix));
            inputTokenPrefix.addEventListener('keydown', e => e.key === 'Enter' && !loginBtn.disabled && window.cekToken());

            loginBtn.addEventListener('click', window.cekToken);
            
            backToLoginFromSubmissionBtn.addEventListener('click', () => window.location.reload(true));
            forceLogoutModalButton.addEventListener('click', () => {
                sessionStorage.clear();
                window.location.reload(true);
            });
            
            const backToWelcomeBtn = document.getElementById('backToWelcomeBtn');
            backToWelcomeBtn.addEventListener('click', () => {
                 loginContainer.classList.remove('show');
                 welcomeScreen.style.display = 'flex';
                 customSelectKelasDisplay.textContent = customSelectKelasDisplay.dataset.placeholder;
                 hiddenSelectKelas.value = '';
                 customSelectNamaSiswaDisplay.textContent = customSelectNamaSiswaDisplay.dataset.placeholder;
                 hiddenSelectNamaSiswa.value = '';
                 inputTokenPrefix.value = '';
                 displayStudentId.value = '';
                 message.textContent = '';
            });

            window.onpopstate = e => isInExamMode && history.pushState(null, '', location.href);

            prevQuestionBtn.addEventListener('click', () => displayQuestion(currentQuestionIndex - 1));
            nextQuestionBtn.addEventListener('click', () => {
                if (currentQuestionIndex === currentExamQuestions.length - 1) {
                    submitAnswers(false);
                } else {
                    displayQuestion(currentQuestionIndex + 1);
                }
            });
            raguRaguCheckbox.addEventListener('change', toggleRaguRagu);
            submitAnswersButton.addEventListener('click', () => submitAnswers(false));
            
            const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
            const examSidePanel = document.getElementById('examSidePanel');
            
            mobileSidebarToggle.addEventListener('click', () => {
                const wrapper = document.querySelector('.sidebar-content-wrapper');
                wrapper.classList.toggle('collapsed');
                mobileSidebarToggle.classList.toggle('up');
                clearTimeout(sidebarCollapseTimer);
            });

            examSidePanel.addEventListener('click', startSidebarCollapseTimer);
            examSidePanel.addEventListener('scroll', startSidebarCollapseTimer, true);


            updateDateTime();
            setInterval(updateDateTime, 1000);
        });

        function startSubmissionStatusListener() {
            if (!foundTokenGlobal || !selectedStudentData || !currentDb) return;
            const dbRefs = getDbRefs();
            if (!dbRefs) return;

            stopSubmissionStatusListener();

            submissionStatusListenerPath = child(dbRefs.submittedExamsRef, `${foundTokenGlobal.key}/${padStudentId(selectedStudentData.id)}`);
            submissionStatusListenerRef = onValue(submissionStatusListenerPath, (snapshot) => {
                if (isInExamMode && snapshot.exists() && snapshot.val().isSubmitted) {
                    stopAccessStatusListener();
                    stopSubmissionStatusListener();
                    if (timerInterval) clearInterval(timerInterval);
                    isInExamMode = false;
                    
                    document.querySelectorAll('#examContainer button, #examContainer input').forEach(el => el.disabled = true);
                    document.getElementById('examBody').style.filter = 'blur(5px)';

                    submissionOverlayTitle.innerText = 'Ujian Telah Dikirim';
                    submissionOverlayMessage.innerText = 'Jawaban Anda telah dikirim oleh administrator.';
                    backToLoginFromSubmissionBtn.innerText = 'Logout';
                    submissionConfirmationOverlay.classList.add('show');
                    isAnyModalOpen = true;
                }
            });
        }

        function stopSubmissionStatusListener() {
            if (submissionStatusListenerRef && submissionStatusListenerPath) {
                off(submissionStatusListenerPath, 'value', submissionStatusListenerRef);
                submissionStatusListenerRef = null;
                submissionStatusListenerPath = null;
            }
        }

        window.cekToken = async function() {
            const tokenPrefix = inputTokenPrefix.value.trim().toUpperCase();
            const studentId = displayStudentId.value.trim();
            
            if (!hiddenSelectKelas.value || !hiddenSelectNamaSiswa.value || !tokenPrefix) {
                message.textContent = "Harap lengkapi semua pilihan.";
                return;
            }

            loginBtn.disabled = true;
            message.innerHTML = `Memvalidasi data... <span class="spinner"></span>`;

            const dbRefs = getDbRefs();
            if (!dbRefs) {
                message.textContent = "Database tidak siap.";
                loginBtn.disabled = false;
                return;
            }

            try {
                const tokensSnapshot = await get(dbRefs.tokensRef);
                let foundToken = null;
                tokensSnapshot.forEach(child => {
                    const data = child.val();
                    if (data.token.toUpperCase() === tokenPrefix) {
                        foundToken = { ...data, key: child.key };
                    }
                });

                if (!foundToken) {
                    throw new Error("Token ujian tidak ditemukan.");
                }
                foundTokenGlobal = foundToken;

                const hasSubmitted = (await get(child(dbRefs.submittedExamsRef, `${foundToken.key}/${studentId}`))).exists();
                if (hasSubmitted) {
                    throw new Error("Anda sudah menyelesaikan ujian ini.");
                }

                const now = Date.now();
                const startTime = new Date(foundToken.startTime).getTime();
                const endTime = new Date(foundToken.endTime).getTime();
                if (!foundToken.isForceActive && (now < startTime || now > endTime)) {
                    throw new Error("Token belum aktif atau sudah kadaluarsa.");
                }

                const studentClassNum = selectedStudentData.class.match(/^\d+/)[0];
                if (String(studentClassNum) !== String(foundToken.kelas)) {
                    throw new Error(`Token ini bukan untuk kelas ${studentClassNum}.`);
                }
                
                const accessStatus = (await get(child(dbRefs.examAccessStatusRef, `${foundToken.key}/${studentId}`))).val();
                if (accessStatus?.isLoggedIn) {
                    throw new Error("Akun sedang login di perangkat lain.");
                }
                
                message.textContent = "";
                loginBtn.disabled = false;
                
                document.getElementById("modalIdSiswa").textContent = selectedStudentData.id;
                document.getElementById("modalNamaLengkap").textContent = selectedStudentData.name;
                document.getElementById("modalKelas").textContent = selectedStudentData.class;
                document.getElementById("modalMapel").textContent = foundToken.subject;
                modalExamDuration.textContent = `${foundToken.durationMinutes} Menit`;
                
                document.getElementById("btnLanjut").onclick = () => handleLanjutClick(foundToken);

                confirmModal.classList.add('show');
                isAnyModalOpen = true;

            } catch (err) {
                console.error("Error di cekToken:", err);
                message.textContent = err.message;
                loginBtn.disabled = false;
            }
        };
    </script>
</body>
</html>

