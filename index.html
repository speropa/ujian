<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=2.0" />
    <title>Ujian Siswa</title>
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            /* Warna primer default, akan ditimpa oleh JS */
            --primary-color: #0066cc; /* Default untuk Kelas 7 */
            --accent-color: #007bff; /* Warna tombol default */
            --warning-color: #ea4b16; /* Default untuk Judul Ujian */
        }

        body {
            font-family: 'Inter', Arial, sans-serif;
            background-color: #e0e0e0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1),
                        inset 0 -2px 4px rgba(255,255,255,0.7);
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow: hidden;
        }

        /* Gaya untuk layar login baru */
        .initial-login-screen {
            max-width: 380px;
            width: 90%;
            margin: 20px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            padding: 30px 20px;
            display: none; /* Awalnya tersembunyi, diganti spinner */
            flex-direction: column;
            gap: 15px;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }

        .initial-login-screen h2 {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .initial-login-screen p {
            font-size: 1em;
            color: #666;
            margin-bottom: 20px;
        }

        .initial-login-screen input[type="email"],
        .initial-login-screen input[type="password"] {
            padding: 12px 15px;
            font-size: 1.1em;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        .initial-login-screen button {
            padding: 15px 25px;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            background-color: var(--accent-color);
            border: none;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 100%;
        }

        .initial-login-screen button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            background-color: var(--primary-color);
        }

        .initial-login-screen button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .welcome-screen {
            max-width: 400px;
            width: 90%;
            margin: 20px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }

        .welcome-screen h2 {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .welcome-screen p {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 20px;
        }

        .welcome-button {
            padding: 15px 25px;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 9999px; /* Lebih oval */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .welcome-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .welcome-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .btn-kelas7 {
            background-color: #007bff; /* Biru */
        }
        .btn-kelas7:hover {
            background-color: #0056b3;
        }

        .btn-kelas8 {
            background-color: #ff9900; /* Oranye */
        }
        .btn-kelas8:hover {
            background-color: #cc7a00;
        }

        .btn-kelas9 {
            background-color: #800000; /* Merah Marun */
        }
        .btn-kelas9:hover {
            background-color: #5a0000;
        }

        /* Gaya untuk tombol susulan */
        .btn-susulan {
            background-color: #28a745; /* Hijau */
        }
        .btn-susulan:hover {
            background-color: #218838;
        }

        .container {
            max-width: 400px;
            width: 90%;
            margin: 20px auto;
            border: 1px solid #ddd;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            flex-shrink: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            display: none; /* Awalnya tersembunyi */
        }
        .container.show {
            display: block;
            opacity: 1;
        }

        .header-box {
            background-color: var(--primary-color);
            padding: 20px 15px;
            color: white;
        }

        .header-box .logo {
            width: 80px;
        }

        .title {
            font-size: 22px;
            font-weight: bold;
            margin-top: 10px;
            color: white;
        }

        .card-body {
            padding: 20px;
        }

        .judul-ujian {
            color: var(--warning-color); /* Warna dinamis */
            font-size: 22px;
            font-weight: bold;
            margin: 10px 0;
        }

        .token-input-group {
            display: flex;
            align-items: center;
            width: calc(100% - 20px);
            margin: 10px auto;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .token-input-group input {
            padding: 10px;
            font-size: 16px;
            border: none;
            margin: 0;
            box-sizing: border-box;
            text-align: center;
            height: 40px;
        }

        #inputTokenPrefix {
            flex-grow: 1;
            min-width: 0;
            border-right: 1px solid #ccc;
        }

        .token-separator {
            background-color: #f0f0f0;
            padding: 10px 5px;
            font-size: 16px;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            box-sizing: border-box;
        }

        #displayStudentId {
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            background-color: #f0f0f0;
            cursor: not-allowed;
        }

        input {
            padding: 10px;
            width: calc(100% - 20px);
            font-size: 16px;
            margin: 10px auto;
            display: block;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: center;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .custom-dropdown-container {
            position: relative;
            width: calc(100% - 20px);
            margin: 10px auto;
            display: block;
        }

        .custom-dropdown-display {
            padding: 10px;
            width: 100%;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: center;
            background-color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 40px;
            color: #555;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .custom-dropdown-display.selected {
            color: #000;
        }

        .custom-dropdown-display.disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }

        .custom-dropdown-display::after {
            content: 'â–¼';
            position: absolute;
            right: 15px;
            font-size: 0.8em;
            color: #888;
        }

        .token-input-group.is-valid {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .token-input-group.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            width: 100%;
            background-color: var(--accent-color); /* Warna dinamis */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 10px auto;
            display: block;
        }

        button:hover {
            background-color: var(--primary-color); /* Warna sedikit lebih gelap dari primer untuk hover */
        }

        button:active {
            transform: scale(0.98);
        }

        #btnBatal {
            background-color: #dc3545;
        }

        #btnBatal:hover {
            background-color: #c82333;
        }

        .message {
            margin-bottom: 10px;
            font-size: 14px;
            min-height: 30px;
            text-align: center;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid black;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            padding-bottom: 10px;
        }

        .custom-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .custom-modal.show {
            display: flex;
            opacity: 1;
        }

        .custom-modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .custom-modal-content h4 {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color); /* Warna dinamis */
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0;
        }

        .custom-modal-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        .custom-modal-list li {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            text-align: left;
            font-size: 1.1em;
            transition: background-color 0.2s ease;
        }

        .custom-modal-list li:nth-child(odd) {
            background-color: white;
        }
        .custom-modal-list li:nth-child(even) {
            background-color: #f9f9f9;
        }

        .custom-modal-list li:last-child {
            border-bottom: none;
        }

        .custom-modal-list li:hover {
            background-color: #e0e0e0;
        }

        /* Gaya untuk modal daftar ujian susulan */
        #susulanListModal .custom-modal-content {
            max-width: 450px; /* Sedikit lebih lebar */
        }

        #susulanListModal .custom-modal-list li {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 15px 20px; /* Lebih banyak padding */
            gap: 5px;
        }

        #susulanListModal .custom-modal-list li .item-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        #susulanListModal .custom-modal-list li .item-url {
            font-size: 0.85em;
            color: #666;
            word-break: break-all; /* Memastikan URL tidak melebar */
        }


        #confirmModal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        #confirmModal.show {
            display: flex;
            opacity: 1;
        }

        #confirmModal .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            max-width: 380px;
            text-align: left;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        #confirmModal .modal-content h4 {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary-color); /* Warna dinamis */
            margin-bottom: 15px;
            text-align: center;
        }

        #confirmModal .modal-content .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        #confirmModal .modal-content .info-table tr {
            border-bottom: 1px solid #eee;
        }

        #confirmModal .modal-content .info-table tr:last-child {
            border-bottom: none;
        }

        #confirmModal .modal-content .info-table td {
            padding: 8px 0;
            font-size: 1.1em;
        }

        #confirmModal .modal-content td:first-child {
            font-weight: bold;
            color: #333;
            width: 120px;
            padding-right: 10px;
        }

        #confirmModal .modal-content td:last-child {
            text-align: left;
            color: #000;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-top: 15px;
            margin-bottom: 15px;
            font-size: 1em;
            color: #333;
            padding-left: 10px;
        }

        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0 8px 0 0;
            cursor: pointer;
            vertical-align: middle;
            box-shadow: none;
            display: inline-block;
        }

        .checkbox-container label {
            cursor: pointer;
            vertical-align: middle;
        }

        #modalMessage {
            color: red;
            font-size: 0.9em;
            text-align: center;
            margin-top: -10px;
            margin-bottom: 10px;
            min-height: 1.2em;
        }

        #examContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            flex-direction: column;
            background-color: #f0f0f0;
            z-index: 500;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        #countdownDisplay {
            background-color: var(--primary-color); /* Warna dinamis */
            color: white;
            padding: 10px;
            font-size: 1.5em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-shrink: 0;
            gap: 10px;
            overflow: hidden;
        }

        #countdownDisplay #timerText {
            flex-shrink: 0;
        }

        #countdownDisplay #studentNameDisplay,
        #countdownDisplay #classDisplay {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            min-width: 0;
        }

        #examContentWrapper {
            display: flex;
            flex-grow: 1;
            width: 100%;
            position: relative;
            overflow: hidden;
            background-color: transparent;
        }

        #examIframe {
            flex-grow: 1;
            width: 100%;
            border: none;
            margin: 0;
            padding: 0;
            display: block;
            transition: filter 0.3s ease, width 0.3s ease, transform 0.3s ease;
            transform-origin: top left;
            cursor: grab;
            overflow: auto;
        }
        #examIframe.blurred {
            filter: grayscale(100%) blur(5px);
            pointer-events: none;
        }
        #examIframe.dragging {
            cursor: grabbing;
            pointer-events: none;
        }

        #topIframeBlocker {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 25%;
            background: transparent;
            z-index: 550;
            pointer-events: auto;
        }

        #answerSidebar {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 250px;
            background-color: transparent;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            transform: translateX(calc(100% - 56px));
            transition: transform 0.3s ease-in-out;
            z-index: 600;
        }

        #answerSidebar.open {
            transform: translateX(0);
        }

        #sidebarToggle {
            background-color: #28a745;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            position: absolute;
            right: 0;
            top: 0;
            height: 56px;
            width: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            box-shadow: none;
            transition: background-color 0.2s ease, transform 0.3s ease-in-out, opacity 0.2s ease;
            padding: 0;
            box-sizing: border-box;
            z-index: 601;
            transform: translateX(0);
            opacity: 0.5;
        }

        #sidebarToggle:hover {
            background-color: #218838;
            opacity: 1;
        }

        #sidebarToggle #sidebarText {
            writing-mode: horizontal-tb;
            text-orientation: unset;
            transform: none;
            white-space: nowrap;
            padding: 10px 5px;
            font-size: 0.8em;
        }

        #closeSidebarButton {
            background-color: #dc3545;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            box-shadow: none;
            display: none;
            position: absolute;
            left: 0;
            top: 0;
            height: 56px;
            width: 56px;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, opacity 0.2s ease;
            z-index: 602;
            padding: 0;
            box-sizing: border-box;
            opacity: 0.5;
        }

        #closeSidebarButton:hover {
            background-color: #c82333;
            opacity: 1;
        }

        #closeSidebarButton #closeSidebarText {
            writing-mode: horizontal-tb;
            text-orientation: unset;
            transform: none;
            white-space: nowrap;
            padding: 10px 5px;
            font-size: 0.8em;
        }

        #examContentWrapper.sidebar-open #examIframe {
            width: calc(100% - 250px);
        }

        #examContentWrapper.sidebar-open #sidebarToggle {
            display: none;
        }

        #examContentWrapper.sidebar-open #answerSidebar {
            transform: translateX(0);
        }

        #examContentWrapper.sidebar-open #closeSidebarButton {
            display: flex;
        }

        #answerListContainer {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
            gap: 8px;
            flex-shrink: 1;
            margin-left: 56px;
        }

        .answer-box {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 5px 3px;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 30px;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .answer-box:hover {
            background-color: #e0e0e0;
        }

        .answer-box .question-number {
            font-weight: bold;
            margin-bottom: 2px;
            color: #333;
            font-size: 0.7em;
            line-height: 1;
        }

        .answer-box .selected-answer {
            font-weight: bold;
            color: #555;
            font-size: 0.7em;
            line-height: 1;
        }

        .answer-box.answered {
            background-color: #d4edda;
            border-color: #28a745;
        }

        .answer-box.unanswered {
            background-color: #f8d7da;
            border-color: #dc3545;
        }

        .submission-warning-message {
            color: red;
            font-weight: bold;
            text-align: center;
            margin: 5px 0 10px 56px;
            font-size: 0.9em;
            min-height: 1.2em;
        }

        #submitAnswersButton {
            background-color: var(--accent-color); /* Warna dinamis */
            color: white;
            padding: 12px;
            margin-top: 0px;
            margin-bottom: 10px;
            margin-left: 56px;
            margin-right: 10px;
            width: calc(100% - 66px);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            flex-shrink: 0;
            transition: background-color 0.2s ease;
        }

        #submitAnswersButton:hover {
            background-color: var(--primary-color); /* Warna dinamis */
        }

        .custom-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .custom-modal.show {
            display: flex;
            opacity: 1;
        }

        .custom-modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        #answerSelectionModal .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            max-width: 300px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            text-align: center;
        }

        #answerSelectionModal h4 {
            font-size: 1.5em;
            color: var(--primary-color); /* Warna dinamis */
            margin-bottom: 20px;
        }

        #answerOptions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        #answerOptions button {
            width: 60px;
            height: 60px;
            font-size: 1.5em;
            border-radius: 50%;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        #answerOptions button:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
        }

        #answerOptions button:active {
            transform: translateY(0);
        }

        #answerOptions button.selected {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        #clearAnswerButton {
            background-color: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }
        #clearAnswerButton:hover {
            background-color: #c82333;
        }

        #warningOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0);
            z-index: 10;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #warningOverlay.show {
            display: flex;
            opacity: 1;
        }

        .warning-content-box {
            background: rgba(255, 255, 255, 0.03);
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: none;
            text-align: center;
            box-sizing: border-box;
            pointer-events: none;
        }

        #warningCountdown {
            font-size: 4em;
            font-weight: bold;
            color: red;
            text-shadow: 0 0 10px rgba(255,0,0,0.5);
            margin-bottom: 10px;
            pointer-events: none;
            animation: blink-smooth 1.5s infinite alternate;
        }

        @keyframes blink-smooth {
            0% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        #warningMessage {
            font-size: 1.5em;
            color: black;
            font-weight: bold;
            pointer-events: none;
        }

        #submissionConfirmationOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            pointer-events: auto;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #submissionConfirmationOverlay.show {
            display: flex;
            opacity: 1;
        }

        .submission-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            text-align: center;
            box-sizing: border-box;
        }

        #submissionConfirmationOverlay h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            font-weight: bold;
            color: #4CAF50;
        }

        #submissionConfirmationOverlay p {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 20px;
        }

        #submissionConfirmationOverlay button {
            padding: 12px 25px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #submissionConfirmationOverlay button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        #submissionConfirmationOverlay button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,128,0,0.4);
        }

        #fullscreenExitWarningOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            pointer-events: auto;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            flex-direction: column;
        }
        #fullscreenExitWarningOverlay.show {
            display: flex;
            opacity: 1;
        }
        .exit-warning-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            text-align: center;
            box-sizing: border-box;
        }
        .exit-warning-content h2 {
            font-size: 2.2em;
            color: #dc3545;
            margin-bottom: 15px;
        }
        .exit-warning-content p {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 20px;
        }
        .exit-warning-button {
            padding: 12px 25px;
            font-size: 1.2em;
            background-color: var(--accent-color); /* Warna dinamis */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .exit-warning-button:hover {
            background-color: var(--primary-color); /* Warna dinamis */
        }

        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #fullscreenOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #fullscreenOverlay.show {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }
        #fullscreenOverlay .overlay-content {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-color) 100%); /* Warna dinamis */
            color: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            box-sizing: border-box;
            animation: fadeInScale 0.5s ease-out forwards;
        }

        #fullscreenOverlay .overlay-title {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        #fullscreenOverlay .overlay-instructions {
            list-style: none;
            padding: 0;
            margin-bottom: 30px;
            font-size: 1.2em;
            line-height: 1.6;
        }

        #fullscreenOverlay .overlay-instructions li {
            margin-bottom: 10px;
            position: relative;
            padding-left: 30px;
            text-align: left;
        }

        #fullscreenOverlay .overlay-instructions li::before {
            content: 'âœ…';
            position: absolute;
            left: 0;
            color: #d4edda;
            font-size: 1.2em;
        }

        #fullscreenOverlay .overlay-button {
            background-color: #28a745;
            color: white;
            padding: 15px 30px;
            font-size: 1.3em;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        #fullscreenOverlay .overlay-button:hover {
            background-color: #218838;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        #fullscreenOverlay .overlay-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #zoomControls {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 700;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.3s ease-in-out;
        }

        #mainToggleBtnContainer {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        #zoomControls button {
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            background-color: var(--accent-color); /* Warna dinamis */
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, opacity 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            opacity: 0.5;
        }

        #zoomControls button:hover {
            background-color: var(--primary-color); /* Warna dinamis */
            transform: scale(1.05);
            opacity: 1;
        }

        #zoomControls button:active {
            transform: scale(0.95);
        }

        #zoomControls button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.5;
        }

        #controlsGrid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            height: 0;
            opacity: 0;
            pointer-events: none;
        }

        #zoomControls.show-controls #controlsGrid {
            height: auto;
            opacity: 1;
            pointer-events: auto;
        }

        #refreshIframeBtn .icon {
            font-size: 1.2em;
        }

        #panLeftBtn .icon, #panRightBtn .icon {
            font-size: 1.5em;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Gaya Spinner */
        #loadingSpinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #e0e0e0; /* Sesuaikan dengan latar belakang body */
            z-index: 10000; /* Pastikan di atas */
            transition: opacity 0.3s ease-in-out;
        }

        #loadingSpinner .spinner-border {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }

        #loadingSpinner p {
            font-size: 1.2em;
            color: #555;
            font-weight: bold;
        }

        /* Penyesuaian responsif */
        @media (max-width: 600px) {
            .initial-login-screen {
                margin-top: 40px;
                margin-bottom: 40px;
                border-radius: 0;
                box-shadow: none;
                width: 100%;
            }
            .initial-login-screen h2 {
                font-size: 1.8em;
            }
            .initial-login-screen p {
                font-size: 0.9em;
            }
            .initial-login-screen input {
                font-size: 1em;
                padding: 10px;
            }
            .initial-login-screen button {
                font-size: 1.1em;
                padding: 12px 20px;
            }

            .welcome-screen {
                margin-top: 40px;
                margin-bottom: 40px;
                border-radius: 0;
                box-shadow: none;
                width: 100%;
            }
            .welcome-screen h2 {
                font-size: 1.8em;
            }
            .welcome-screen p {
                font-size: 0.9em;
            }
            .welcome-button {
                font-size: 1.2em;
                padding: 12px 20px;
            }

            .container {
                margin-top: 40px;
                margin-bottom: 40px;
                border-radius: 0;
                border: none;
                box-shadow: none;
                width: 100%;
            }
            .header-box {
                border-radius: 0;
            }
            #confirmModal .modal-content {
                padding: 20px;
                max-width: 90%;
            }
            #confirmModal .modal-content h4 {
                font-size: 1.5em;
            }
            #confirmModal .modal-content .info-table td {
                font-size: 1em;
            }
            #confirmModal .modal-content td:first-child {
                width: 90px;
            }
            .checkbox-container {
                padding-left: 5px;
            }
            #fullscreenOverlay .overlay-content {
                padding: 25px;
                max-width: 95%;
            }
            #fullscreenOverlay .overlay-title {
                font-size: 2em;
            }
            #fullscreenOverlay .overlay-instructions {
                font-size: 0.9em;
            }
            #fullscreenOverlay .overlay-instructions li {
                padding-left: 25px;
            }
            #fullscreenOverlay .overlay-instructions li::before {
                font-size: 1em;
            }
            #fullscreenOverlay .overlay-button {
                font-size: 1.1em;
                padding: 12px 25px;
            }
            #countdownDisplay {
                font-size: 1.1em;
                padding: 8px;
            }
            #countdownDisplay #studentNameDisplay,
            #countdownDisplay #classDisplay {
                font-size: 0.9em;
            }
            #warningCountdown {
                font-size: 3em;
            }
            #warningMessage {
                font-size: 1.2em;
            }
            .warning-content-box {
                padding: 20px;
                max-width: 90%;
            }
            #submissionConfirmationOverlay h1 {
                font-size: 2em;
            }
            #submissionConfirmationOverlay p {
                font-size: 1.2em;
            }
            #submissionConfirmationOverlay button {
                font-size: 1em;
                padding: 12px 25px;
            }
            .submission-content {
                padding: 20px;
                max-width: 90%;
            }
            .exit-warning-content {
                padding: 20px;
                max-width: 90%;
            }
            .exit-warning-content h2 {
                font-size: 1.8em;
            }
            .exit-warning-content p {
                font-size: 1em;
            }
            .exit-warning-button {
                font-size: 1em;
                padding: 10px 20px;
            }

            .custom-modal-content {
                padding: 15px;
                width: 95%;
                max-height: 90vh;
            }
            .custom-modal-content h4 {
                font-size: 1.2em;
            }
            .custom-modal-list li {
                padding: 10px 12px;
                font-size: 1em;
            }

            #answerSidebar {
                width: 180px;
                transform: translateX(calc(100% - 56px));
            }
            #answerSidebar.open {
                transform: translateX(0);
            }
            #sidebarToggle {
                width: 56px;
                height: 56px;
            }
            #sidebarToggle #sidebarText {
                font-size: 0.7em;
            }
            #closeSidebarButton {
                width: 56px;
                height: 56px;
            }
            #closeSidebarButton #closeSidebarText {
                font-size: 0.7em;
            }
            #answerListContainer {
                grid-template-columns: repeat(auto-fill, minmax(25px, 1fr));
                gap: 5px;
                margin-left: 56px;
            }
            .answer-box {
                height: 30px;
                font-size: 0.8em;
            }
            .answer-box .question-number,
            .answer-box .selected-answer {
                font-size: 0.7em;
            }
            #submitAnswersButton {
                font-size: 0.9em;
                padding: 10px;
                width: calc(100% - 66px);
            }
            #answerSelectionModal .modal-content {
                max-width: 280px;
            }
            #answerOptions button {
                width: 50px;
                height: 50px;
                font-size: 1.2em;
            }
            #zoomControls button {
                width: 35px;
                height: 35px;
                font-size: 1.2em;
            }
        }

        @media (max-width: 400px) {
            .header-box .logo {
                width: 60px;
            }
            .title {
                font-size: 18px;
            }
            .card-body {
                padding: 15px;
            }
            input {
                font-size: 14px;
                padding: 8px;
            }
            button {
                font-size: 14px;
                padding: 8px 15px;
            }
            .footer {
                font-size: 10px;
            }
            .checkbox-container {
                font-size: 0.9em;
            }
            .custom-dropdown-display {
                font-size: 14px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loadingSpinner">
        <div class="spinner-border"></div>
        <p>Memuat aplikasi...</p>
    </div>

    <!-- Initial Login Screen (hidden by default) -->
    <div id="initialLoginScreen" class="initial-login-screen">
        <h2>LOGIN SISWA</h2>
        <p>Masukkan email dan password Anda untuk melanjutkan.</p>
        <input type="email" id="loginEmail" placeholder="Email" />
        <input type="password" id="loginPassword" placeholder="Password" />
        <p class="message" id="loginMessage"></p>
        <button id="loginButton">Login</button>
    </div>

    <div id="welcomeScreen" class="welcome-screen" style="display: none;">
        <h2 id="welcomeTitle">SELAMAT DATANG</h2>
        <p id="welcomeMessage">Memuat pilihan ujian...</p>
        <div id="welcomeButtonsContainer" style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Tombol akan dimuat di sini oleh JavaScript -->
        </div>
    </div>

    <div id="loginContainer" class="container" style="display: none;">
        <div class="header-box">
            <img src="https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/logosmpn2pjg.png" alt="Logo" class="logo" />
            <div class="title">SMPN 2 PAJANGAN</div>
        </div>
        <div class="card-body">
            <div class="judul-ujian" id="loginJudulUjian">UJIAN KELAS</div>
            <div id="locationBlocked" style="display: none; color: red; margin-bottom: 10px; font-weight: bold; text-align: center;">
                AKSES UJIAN DIBLOKIR, silahkan aktifkan lokasi perangkat Anda di SMPN 2 Pajangan! Setelah diaktifkan, silahkan refresh halaman login!
            </div>
            <p class="message" id="message"></p>
            <p id="locationStatus" style="color: gray; font-size: 12px; text-align: center;">Memuat status lokasi...</p>

            <div class="custom-dropdown-container">
                <div id="customSelectKelasDisplay" class="custom-dropdown-display" data-placeholder="-- Pilih Kelas --">
                    -- Pilih Kelas --
                </div>
                <input type="hidden" id="selectKelas" value="" />
            </div>

            <div class="custom-dropdown-container">
                <div id="customSelectNamaSiswaDisplay" class="custom-dropdown-display" data-placeholder="-- Pilih Nama Siswa --">
                    -- Pilih Nama Siswa --
                </div>
                <input type="hidden" id="selectNamaSiswa" value="" />
            </div>

            <div class="token-input-group">
                <input type="text" id="inputTokenPrefix" placeholder="TOKEN (contoh: ABCDE)" />
                <span class="token-separator">-</span>
                <input type="text" id="displayStudentId" placeholder="ID Siswa" readonly />
            </div>

            <button id="loginBtn">Login</button>
        </div>
        <div class="footer">
            Â© Admin SMPN 2 Pajangan<br>
            <span id="datetime"></span>
        </div>
    </div>

    <div id="examContainer" style="display: none;">
        <div id="countdownDisplay">
            <span id="timerText"></span> | <span id="studentNameDisplay"></span> | <span id="classDisplay"></span>
        </div>
        <div id="examContentWrapper">
            <iframe id="examIframe" src="" frameborder="0"></iframe>
            <div id="topIframeBlocker"></div>

            <div id="zoomControls">
                <div id="mainToggleBtnContainer">
                    <button id="toggleControlsBtn" title="Alihkan Kontrol">
                        <span class="icon">&#9776;</span> </button>
                    <button id="refreshIframeBtn" title="Muat Ulang Iframe">
                        <span class="icon">&#x21BB;</span>
                    </button>
                </div>
                <div id="controlsGrid">
                    <button id="zoomInBtn">+</button>
                    <button id="zoomOutBtn">-</button>
                    <button id="panLeftBtn"><span class="icon">&larr;</span></button>
                    <button id="panRightBtn"><span class="icon">&rarr;</span></button>
                </div>
            </div>

            <button id="sidebarToggle">
                <span id="sidebarText">JAWAB</span>
            </button>

            <div id="answerSidebar">
                <button id="closeSidebarButton">
                    <span id="closeSidebarText">TUTUP</span>
                </button>

                <div id="answerListContainer">
                </div>
                <p id="submissionWarningMessage" class="submission-warning-message"></p>
                <button id="submitAnswersButton" disabled style="background-color: #cccccc; cursor: not-allowed;">KIRIM JAWABAN</button>
            </div>
        </div>

        <div id="warningOverlay" style="display: none;">
            <div class="warning-content-box">
                <div id="warningCountdown"></div>
                <div id="warningMessage">SEGERA KIRIMKAN JAWABAN, JANGAN SAMPAI KEHABISAN WAKTU!</div>
            </div>
        </div>

        <div id="fullscreenExitWarningOverlay" style="display: none;">
            <div class="exit-warning-content">
                <h2 id="exitWarningTitle">PERINGATAN!</h2>
                <p id="exitWarningMessage">Anda telah keluar dari mode layar penuh. Mohon kembali ke mode layar penuh untuk melanjutkan ujian.</p>
                <p id="attemptsLeftInfo" style="font-size: 1.1em; color: #0066cc; font-weight: bold; margin-top: 10px; display: none;"></p>

                <div id="lockKeySection" style="margin-top: 20px; display: none;">
                    <p style="font-size: 1.1em; color: #333; margin-bottom: 10px;">Masukkan kunci untuk melanjutkan:</p>
                    <input type="password" id="lockKeyInput" placeholder="Kunci..." style="width: calc(100% - 20px); padding: 10px; border: 1px solid #ccc; border-radius: 5px; text-align: center; margin-bottom: 10px;">
                    <p id="lockKeyMessage" style="color: red; font-size: 0.9em; min-height: 1.2em;"></p>
                    <button id="lockKeySubmitBtn" class="exit-warning-button" style="background-color: #28a745;">Masuk dengan Kunci</button>
                </div>

                <button id="reEnterFullscreenBtn" class="exit-warning-button">Kembali ke Layar Penuh</button>
            </div>
        </div>

        <div id="answerSelectionModal" class="custom-modal">
            <div class="modal-content">
                <h4 id="answerModalTitle">Pilih Jawaban Soal No. <span id="currentQuestionNumber"></span></h4>
                <div id="answerOptions">
                    <button data-answer="A">A</button>
                    <button data-answer="B">B</button>
                    <button data-answer="C">C</button>
                    <button data-answer="D">D</button>
                </div>
                <button id="clearAnswerButton">Hapus Jawaban</button>
            </div>
        </div>

        <div id="customMessageModal" class="custom-modal">
            <div class="custom-modal-content">
                <h4 id="customMessageModalTitle"></h4>
                <p id="customMessageModalText"></p>
                <button id="customMessageModalButton" onclick="window.hideCustomMessageModal()">OK</button>
            </div>
        </div>

        <div id="customConfirmModal" class="custom-modal">
            <div class="custom-modal-content">
                <h4 id="customConfirmModalTitle"></h4>
                <p id="customConfirmModalText"></p>
                <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                    <button id="customConfirmModalConfirmBtn" style="background-color: #28a745; width: 45%;">Ya</button>
                    <button id="customConfirmModalCancelBtn" style="background-color: #dc3545; width: 45%;">Tidak</button>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmModal">
        <div class="modal-content">
            <h4>DATA UJIAN ONLINE</h4>
            <table class="info-table">
                <tr>
                    <td>ID Siswa</td>
                    <td>: <span id="modalIdSiswa"></span></td>
                </tr>
                <tr>
                    <td>Nama Lengkap</td>
                    <td>: <span id="modalNamaLengkap"></span></td>
                </tr>
                <tr>
                    <td>Kelas</td>
                    <td>: <span id="modalKelas"></span></td>
                </tr>
                <tr>
                    <td>Mapel</td>
                    <td>: <span id="modalMapel"></span></td>
                </tr>
                <tr>
                    <td>Waktu Ujian</td>
                    <td>: <span id="modalExamDuration"></span></td>
                </tr>
            </table>

            <div class="checkbox-container">
                <input type="checkbox" id="confirmCheckbox">
                <label for="confirmCheckbox">Data di atas sudah benar</label>
            </div>
            <p id="modalMessage" style="display: none;"></p>
            <div class="button-container">
                <button id="btnLanjut">Lanjutkan</button>
                <button id="btnBatal" onclick="window.tutupModal()">Batal</button>
            </div>
        </div>
    </div>

    <div id="fullscreenOverlay" style="display: none;">
        <div class="overlay-content">
            <h2 class="overlay-title">PERHATIKAN HAL-HAL BERIKUT:</h2>
            <ul class="overlay-instructions">
                <li>Berdoa & kerjakan sungguh-sungguh</li>
                <li>Dilarang curang</li>
                <li>Pastikan jaringan stabil</li>
                <li>Klik "JAWAB" di kanan untuk mengisi</li>
                <li>"Kirim Jawaban" aktif sisa 30 menit</li>
                <li>Ujian otomatis terkirim jika waktu habis</li>
            </ul>
            <button id="overlayUnderstandBtn" class="overlay-button">SAYA MENGERTI</button>
        </div>
    </div>

    <div id="submissionConfirmationOverlay">
        <div class="submission-content">
            <h1 id="submissionOverlayTitle"></h1>
            <p id="submissionOverlayMessage"></p>
            <button id="backToLoginFromSubmissionBtn">KEMBALI</button>
        </div>
    </div>

    <div id="classModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4 id="classModalTitle">Pilih Kelas</h4>
            <ul id="classModalList" class="custom-modal-list">
            </ul>
        </div>
    </div>

    <div id="studentModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4>Pilih Nama Siswa</h4>
            <ul id="studentModalList" class="custom-modal-list">
            </ul>
        </div>
    </div>
    <!-- Modal baru untuk daftar ujian susulan -->
    <div id="susulanListModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4 id="susulanModalTitle">Pilih Ujian Susulan</h4>
            <ul id="susulanModalList" class="custom-modal-list">
            </ul>
            <button id="closeSusulanModalButton" onclick="window.closeSusulanListModal()">TUTUP</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getDatabase, ref, get, child, runTransaction, set, onValue, off, update, remove } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
        // Import tambahan untuk otentikasi email/password
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

        // Konfigurasi Firebase untuk login awal (email/password)
        const initialLoginFirebaseConfig = {
            apiKey: "AIzaSyAOBCX8x60pYqxtXmXMz2xc5dwC3HJH5EE",
            authDomain: "ujian-online-berbasis-android.firebaseapp.com",
            databaseURL: "https://ujian-online-berbasis-android-default-rtdb.firebaseio.com",
            projectId: "ujian-online-berbasis-android",
            storageBucket: "ujian-online-berbasis-android.firebasestorage.app",
            messagingSenderId: "923446282537",
            appId: "1:923446282537:web:60d374dde8aca61f6a0f38"
        };
        const initialLoginApp = initializeApp(initialLoginFirebaseConfig, "initialLoginApp");
        const initialLoginAuth = getAuth(initialLoginApp);

        // Global variables for authenticated user credentials
        let globalUserEmail = '';
        let globalUserPassword = '';

        // Firebase for Custom Buttons (now links to initialLoginApp)
        let buttonConfigDb = null;
        let publicSettings = null; // Untuk menyimpan konfigurasi publicSettings dari Firebase
        let buttonConfigAuth = null; // Will be set to initialLoginAuth

        // Fungsi untuk menginisialisasi Firebase untuk konfigurasi tombol.
        // Sekarang akan menggunakan instance aplikasi utama.
        async function initializeButtonConfigFirebase() {
            try {
                // Karena initialLoginFirebaseConfig dan buttonConfigFirebaseConfig (sebelumnya) identik,
                // kita bisa langsung menggunakan instance database dan auth dari initialLoginApp.
                buttonConfigDb = getDatabase(initialLoginApp);
                buttonConfigAuth = initialLoginAuth; // Menggunakan kembali instance auth dari login awal

                // Status autentikasi dikelola oleh login utama (initialLoginAuth).
                // Tidak perlu signInAnonymously terpisah di sini.
                // console.log("Firebase untuk konfigurasi tombol terhubung ke aplikasi login utama."); // Dihapus
            } catch (error) {
                console.error("Gagal menginisialisasi Firebase untuk konfigurasi tombol (saat menghubungkan ke aplikasi utama):", error);
                document.getElementById('welcomeMessage').textContent = 'Gagal memuat konfigurasi. Silakan refresh halaman. (Error: ' + error.message + ')';
            }
        }


        const allFirebaseConfigs = {
            'kelas7-group1': {
                apiKey: "AIzaSyBJBl_HWsOsnBBI1EPs1yQlJd0Hso8HcSo",
                authDomain: "ujianpdf-7abc.firebaseapp.com",
                databaseURL: "https://ujianpdf-7abc-default-rtdb.firebaseio.com",
                projectId: "ujianpdf-7abc",
                storageBucket: "ujianpdf-7abc.firebasestorage.app",
                messagingSenderId: "1035978389542",
                appId: "1:1035978389542:web:413eb32b04c0d09bc48ee7",
                theme: {
                    primary: '#0066cc', // Biru lebih gelap untuk header, hitung mundur, dll.
                    accent: '#007bff',  // Biru lebih terang untuk tombol
                    warning: '#0066cc' // Judul Ujian sama dengan primer
                },
                allowedClasses: ['7A', '7B', '7C']
            },
            'kelas7-group2': {
                apiKey: "AIzaSyDQKdbwaG0Tg7_tfHs0hCbNR3xlqT3vWLA",
                authDomain: "ujianpdf-7def.firebaseapp.com",
                databaseURL: "https://ujianpdf-7def-default-rtdb.firebaseio.com",
                projectId: "ujianpdf-7def",
                storageBucket: "ujianpdf-7def.firebasestorage.app",
                messagingSenderId: "210211262444",
                appId: "1:210211262444:web:a06a988913ede65369bac9",
                theme: {
                    primary: '#0066cc',
                    accent: '#007bff',
                    warning: '#0066cc'
                },
                allowedClasses: ['7D', '7E', '7F']
            },
            'kelas8-group1': {
                apiKey: "AIzaSyAsbVn2qVIgH278ZjPfkMihlGYmyL8zJFA",
                authDomain: "ujianpdf8abc-3bedf.firebaseapp.com",
                databaseURL: "https://ujianpdf8abc-3bedf-default-rtdb.firebaseio.com",
                projectId: "ujianpdf8abc-3bedf",
                storageBucket: "ujianpdf8abc-3bedf.firebasestorage.app",
                messagingSenderId: "408487358048",
                appId: "1:408487358048:web:10cc8796510f4b8ab99d05",
                theme: {
                    primary: '#cc7a00', // Oranye lebih gelap
                    accent: '#ff9900',  // Oranye lebih terang
                    warning: '#ff9900' // Judul Ujian sama dengan aksen
                },
                allowedClasses: ['8A', '8B', '8C']
            },
            'kelas8-group2': {
                apiKey: "AIzaSyBvkIMTkJkDqe2nKspIMXOCeT9vc6h8xjA",
                authDomain: "ujianpdf8def-9bdcd.firebaseapp.com",
                databaseURL: "https://ujianpdf8def-9bdcd-default-rtdb.firebaseio.com",
                projectId: "ujianpdf8def-9bdcd",
                storageBucket: "ujianpdf8def-9bdcd.firebasestorage.app",
                messagingSenderId: "69381651529",
                appId: "1:69381651529:web:af517e87735d2ad51a9398",
                theme: {
                    primary: '#cc7a00',
                    accent: '#ff9900',
                    warning: '#ff9900'
                },
                allowedClasses: ['8D', '8E', '8F']
            },
            'kelas9-group1': {
                apiKey: "AIzaSyCjf42a3CCB3IuNto2K8MGpTX_SM1FXyrw",
                authDomain: "ujianpdf-9abc.firebaseapp.com",
                databaseURL: "https://ujianpdf-9abc-default-rtdb.firebaseio.com",
                projectId: "ujianpdf-9abc",
                storageBucket: "ujianpdf-9abc.firebasestorage.app",
                messagingSenderId: "939178637981",
                appId: "1:939178637981:web:b9a15dfa72180d15d77274",
                theme: {
                    primary: '#5a0000', // Merah marun lebih gelap
                    accent: '#800000',  // Merah marun lebih terang
                    warning: '#800000' // Judul Ujian sama dengan aksen
                },
                allowedClasses: ['9A', '9B', '9C']
            },
            'kelas9-group2': {
                apiKey: "AIzaSyDK50Amn6N8gl_q6CVhDjV_DRPpdCpCTrw",
                authDomain: "ujianpdf-9def.firebaseapp.com",
                databaseURL: "https://ujianpdf-9def-default-rtdb.firebaseio.com",
                projectId: "ujianpdf-9def",
                storageBucket: "ujianpdf-9def.firebasestorage.app",
                messagingSenderId: "450883192159",
                appId: "1:450883192159:web:6ad39c42db5756ff0f62ea",
                theme: {
                    primary: '#5a0000',
                    accent: '#800000',
                    warning: '#800000'
                },
                allowedClasses: ['9D', '9E', '9F']
            }
        };

        const firebaseApps = {};
        const firebaseDBs = {};
        const firebaseAuths = {};
        let currentDb = null;
        let currentAuth = null;
        let currentSelectedGrade = null;
        let currentClassGroupKeys = [];

        function getClassGroupKeysByGrade(grade) {
            const keys = [];
            for (const key in allFirebaseConfigs) {
                if (key.startsWith(`kelas${grade}`)) {
                    keys.push(key);
                }
            }
            return keys;
        }

        async function getFirebaseInstanceForClass(className) {
            let classGroupKey = null;
            for (const key in allFirebaseConfigs) {
                if (allFirebaseConfigs[key].allowedClasses.includes(className)) {
                    classGroupKey = key;
                    break;
                }
            }

            if (!classGroupKey || !allFirebaseConfigs[classGroupKey]) {
                console.error(`Error: Tidak ada konfigurasi Firebase yang ditemukan untuk kelas: ${className}`);
                return null;
            }

            if (!firebaseApps[classGroupKey]) {
                const config = allFirebaseConfigs[classGroupKey];
                const appInstance = initializeApp(config, classGroupKey); // Inisialisasi instance aplikasi baru untuk proyek yang berbeda
                firebaseApps[classGroupKey] = appInstance;
                firebaseDBs[classGroupKey] = getDatabase(appInstance);
                firebaseAuths[classGroupKey] = getAuth(appInstance);
                // console.log(`Aplikasi Firebase diinisialisasi untuk grup kelas: ${classGroupKey}`); // Dihapus

                try {
                    // Coba masuk dengan email/kata sandi yang sama dengan yang digunakan untuk login awal
                    if (globalUserEmail && globalUserPassword) {
                        await signInWithEmailAndPassword(firebaseAuths[classGroupKey], globalUserEmail, globalUserPassword);
                        // console.log(`Berhasil login email/kata sandi untuk aplikasi Firebase: ${classGroupKey}`); // Dihapus
                    } else {
                        console.warn(`Peringatan: Kredensial pengguna tidak tersedia (mungkin belum login atau memulihkan sesi). Mencoba login anonim sebagai fallback untuk ${classGroupKey}.`);
                        await signInAnonymously(firebaseAuths[classGroupKey]); // Fallback jika kredensial tidak diatur (misalnya, memulihkan sesi)
                    }
                } catch (error) {
                    console.error(`Gagal login email/kata sandi untuk aplikasi Firebase ${classGroupKey}:`, error);
                    // Tangani kesalahan autentikasi tertentu jika pengguna tidak ada di autentikasi proyek tertentu ini
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-email' || error.code === 'auth/invalid-credential') {
                        console.warn(`Peringatan: Akun login email/kata sandi tidak ditemukan atau tidak valid di proyek Firebase untuk ${classGroupKey}. Ini mungkin karena setiap proyek memiliki basis data pengguna yang terpisah. Mencoba login anonim sebagai fallback.`);
                        try {
                            await signInAnonymously(firebaseAuths[classGroupKey]); // Fallback jika email/kata sandi gagal untuk proyek tertentu
                            // console.log(`Berhasil login anonim ke Firebase ${classGroupKey} sebagai fallback.`); // Dihapus
                        } catch (anonError) {
                            console.error(`Gagal login anonim ke Firebase ${classGroupKey} sebagai fallback:`, anonError);
                            window.showCustomMessageModal("Kesalahan Autentikasi", `Gagal mengautentikasi ke database untuk kelas ini (${classGroupKey}). Mohon hubungi administrator. (Error: ${anonError.message})`, 'error');
                            return null;
                        }
                    } else if (error.code === 'auth/network-request-failed') {
                        console.error(`Kesalahan Jaringan saat login ke Firebase ${classGroupKey}:`, error);
                        window.showCustomMessageModal("Kesalahan Jaringan", `Gagal terhubung ke database untuk kelas ini (${classGroupKey}). Mohon periksa koneksi internet Anda.`, 'error');
                        return null;
                    } else {
                        window.showCustomMessageModal("Kesalahan Autentikasi", `Gagal mengautentikasi ke database untuk kelas ini (${classGroupKey}). Mohon hubungi administrator. (Error: ${error.message})`, 'error');
                        return null;
                    }
                }
            }
            return { db: firebaseDBs[classGroupKey], auth: firebaseAuths[classGroupKey] };
        }

        function getDbRefs() {
            if (!currentDb) {
                console.error("Instance database (currentDb) tidak diinisialisasi.");
                return null;
            }
            return {
                settingsRef: ref(currentDb, 'setlokasi'),
                lockSettingsRef: ref(currentDb, 'lock_settings'),
                studentsRef: ref(currentDb, 'students'),
                tokensRef: ref(currentDb, 'tokens'),
                examAccessStatusRef: ref(currentDb, 'exam_access_status'),
                adminSettingsRef: ref(currentDb, 'admin_settings'),
                submittedExamsRef: ref(currentDb, 'submitted_exams'),
                studentAnswersRef: ref(currentDb, 'student_answers')
            };
        }

        let isLocationEnabled = true;
        let firebaseAllowedRadiusKm = 0.075;

        let isLockEnabledGlobal = false;
        let lockKeyGlobal = "";
        let toleranceLimitGlobal = 0;
        let currentAttemptsLeft = 0;

        const allowedLatitude = -7.8589546;
        const allowedLongitude = 110.2655596;

        const loadingSpinner = document.getElementById('loadingSpinner');
        const initialLoginScreen = document.getElementById('initialLoginScreen');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginMessage = document.getElementById('loginMessage');
        const loginButton = document.getElementById('loginButton');

        const welcomeScreen = document.getElementById('welcomeScreen');
        const welcomeTitle = document.getElementById('welcomeTitle');
        const welcomeMessageElement = document.getElementById('welcomeMessage');
        const welcomeButtonsContainer = document.getElementById('welcomeButtonsContainer');
        const loginContainer = document.getElementById('loginContainer');
        const examContainer = document.getElementById('examContainer');
        const countdownDisplay = document.getElementById('countdownDisplay');
        const timerText = document.getElementById('timerText');
        const studentNameDisplay = document.getElementById('studentNameDisplay');
        const classDisplay = document.getElementById('classDisplay');
        const examIframe = document.getElementById('examIframe');
        const fullscreenOverlay = document.getElementById('fullscreenOverlay');
        const overlayUnderstandBtn = document.getElementById('overlayUnderstandBtn');
        const warningOverlay = document.getElementById('warningOverlay');
        const warningCountdown = document.getElementById('warningCountdown');

        const locationBlockedDiv = document.getElementById('locationBlocked');
        const message = document.getElementById('message');
        const loginBtn = document.getElementById('loginBtn');
        const confirmModal = document.getElementById('confirmModal');
        const locationStatus = document.getElementById('locationStatus');
        
        const inputTokenPrefix = document.getElementById('inputTokenPrefix');
        const displayStudentId = document.getElementById('displayStudentId');
        
        const customSelectKelasDisplay = document.getElementById('customSelectKelasDisplay');
        const hiddenSelectKelas = document.getElementById('selectKelas');
        const customSelectNamaSiswaDisplay = document.getElementById('customSelectNamaSiswaDisplay');
        const hiddenSelectNamaSiswa = document.getElementById('selectNamaSiswa');

        const confirmCheckbox = document.getElementById('confirmCheckbox');
        const modalMessage = document.getElementById('modalMessage');
        const modalExamDuration = document.getElementById('modalExamDuration');

        const submissionConfirmationOverlay = document.getElementById('submissionConfirmationOverlay');
        const submissionOverlayTitle = document.getElementById('submissionOverlayTitle');
        const submissionOverlayMessage = document.getElementById('submissionOverlayMessage');
        const backToLoginFromSubmissionBtn = document.getElementById('backToLoginFromSubmissionBtn');

        const fullscreenExitWarningOverlay = document.getElementById('fullscreenExitWarningOverlay');
        const exitWarningTitle = document.getElementById('exitWarningTitle');
        const exitWarningMessage = document.getElementById('exitWarningMessage');
        const attemptsLeftInfo = document.getElementById('attemptsLeftInfo');
        const lockKeySection = document.getElementById('lockKeySection');
        const lockKeyInput = document.getElementById('lockKeyInput');
        const lockKeyMessage = document.getElementById('lockKeyMessage');
        const lockKeySubmitBtn = document.getElementById('lockKeySubmitBtn');
        const reEnterFullscreenBtn = document.getElementById('reEnterFullscreenBtn');

        const classModal = document.getElementById('classModal');
        const classModalList = document.getElementById('classModalList');
        const studentModal = document.getElementById('studentModal');
        const studentModalList = document.getElementById('studentModalList');

        const susulanListModal = document.getElementById('susulanListModal');
        const susulanModalList = document.getElementById('susulanModalList');


        const answerSidebar = document.getElementById('answerSidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const answerListContainer = document.getElementById('answerListContainer');
        const submitAnswersButton = document.getElementById('submitAnswersButton');
        const submissionWarningMessage = document.getElementById('submissionWarningMessage');

        const sidebarText = document.getElementById('sidebarText');
        const closeSidebarButton = document.getElementById('closeSidebarButton');
        const closeSidebarText = document.getElementById('closeSidebarText');

        const examContentWrapper = document.getElementById('examContentWrapper');

        const zoomControls = document.getElementById('zoomControls');
        const toggleControlsBtn = document.getElementById('toggleControlsBtn');
        const controlsGrid = document.getElementById('controlsGrid');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const panLeftBtn = document.getElementById('panLeftBtn');
        const panRightBtn = document.getElementById('panRightBtn');
        const refreshIframeBtn = document.getElementById('refreshIframeBtn');

        const loginJudulUjian = document.getElementById('loginJudulUjian');

        let allStudentsData = [];
        let selectedStudentData = null;
        let isLocationValid = false;
        let foundTokenGlobal = null;
        let timerInterval;
        let remainingTime;
        let submissionListenerRef = null;

        let isInExamMode = false;
        let isAnyModalOpen = false;

        let totalQuestions = 0;
        let studentAnswers = [];
        let currentQuestionIndexForModal = -1;

        const answerSelectionModal = document.getElementById('answerSelectionModal');
        const currentQuestionNumberSpan = document.getElementById('currentQuestionNumber');
        const answerOptionsContainer = document.getElementById('answerOptions');
        const clearAnswerButton = document.getElementById('clearAnswerButton');

        const customMessageModal = document.getElementById('customMessageModal');
        const customMessageModalTitle = document.getElementById('customMessageModalTitle');
        const customMessageModalText = document.getElementById('customMessageModalText');
        const customMessageModalButton = document.getElementById('customMessageModalButton');

        const customConfirmModal = document.getElementById('customConfirmModal');
        const customConfirmModalTitle = document.getElementById('customConfirmModalTitle');
        const customConfirmModalText = document.getElementById('customConfirmModalText');
        const customConfirmModalConfirmBtn = document.getElementById('customConfirmModalConfirmBtn');
        const customConfirmModalCancelBtn = document.getElementById('customConfirmModalCancelBtn');

        let globalExamUrl = '';
        let globalExamDurationMinutes = 0;
        let globalNumQuestions = 0;
        let globalExamStartTime = 0;
        let globalInitialAnswers = null;

        let currentZoom = 1.0;
        const MIN_ZOOM = 1.0;
        const MAX_ZOOM = 2.0;
        const ZOOM_STEP = 0.1;
        const PAN_STEP = 10;

        let isDragging = false;
        let startX, startY;
        let currentTranslateX = 0;
        let currentTranslateY = 0;
        let autoHideTimer;

        let panIntervalId = null;
        let panDirection = 0;
        const PAN_START_DELAY = 1500;
        const PAN_INTERVAL = 150;
        let panPressTimer = null;

        function padStudentId(id) {
            return String(id).padStart(3, '0');
        }

        function isTouchDevice() {
            return window.matchMedia('(pointer: coarse)').matches;
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c;
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('datetime').textContent = now.toLocaleDateString('id-ID', options);
        }

        window.formatTokenPrefix = function (inputElement) {
            if (!inputElement || typeof inputElement.value === 'undefined') {
                console.error("Error: inputElement atau nilainya tidak terdefinisi dalam formatTokenPrefix.");
                return;
            }

            const tokenInputGroup = inputElement.closest('.token-input-group');
            if (tokenInputGroup) {
                tokenInputGroup.classList.remove('is-valid', 'is-invalid');
            }

            let value = inputElement.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            inputElement.value = value;

            if (value.length > 0) {
                if (tokenInputGroup) tokenInputGroup.classList.add('is-valid');
            } else {
                if (tokenInputGroup) tokenInputGroup.classList.remove('is-valid');
            }
            updateLoginButtonStatus();
        };

        function updateLoginButtonStatus() {
            const isLocationCheckPassed = (isLocationEnabled && isTouchDevice()) ? isLocationValid : true;
            const isClassAndStudentSelected = hiddenSelectKelas.value !== "" && hiddenSelectNamaSiswa.value !== "";
            const isTokenPrefixFilled = inputTokenPrefix.value.trim() !== "";
            const isStudentIdDisplayed = displayStudentId.value.trim() !== "";

            if (isClassAndStudentSelected) {
                inputTokenPrefix.disabled = false;
            } else {
                inputTokenPrefix.disabled = true;
                inputTokenPrefix.value = "";
                const tokenInputGroup = inputTokenPrefix.closest('.token-input-group');
                if (tokenInputGroup) {
                    tokenInputGroup.classList.remove('is-valid', 'is-invalid');
                }
            }

            if (hiddenSelectKelas.value === "") {
                customSelectNamaSiswaDisplay.classList.add('disabled');
            } else {
                customSelectNamaSiswaDisplay.classList.remove('disabled');
            }

            if (isLocationCheckPassed && isClassAndStudentSelected && isTokenPrefixFilled && isStudentIdDisplayed) {
                loginBtn.disabled = false;
                loginBtn.style.opacity = 1;
            } else {
                loginBtn.disabled = true;
                loginBtn.style.opacity = 0.6;
            }
        }

        window.tutupModal = async function () {
            confirmModal.classList.remove('show');
            isAnyModalOpen = false;
            message.textContent = "";
            modalMessage.textContent = "";
            confirmCheckbox.checked = false;
            updateLoginButtonStatus();

            // Hapus sesi penyimpanan jika modal dibatalkan agar tidak dipulihkan setengah jalan
            sessionStorage.clear();
        };

        function checkLocation(latitude, longitude) {
            const distance = getDistanceFromLatLonInKm(allowedLatitude, allowedLongitude, latitude, longitude);
            if (distance <= firebaseAllowedRadiusKm) {
                locationBlockedDiv.style.display = 'none';
                isLocationValid = true;
                locationStatus.textContent = "Lokasi valid.";
                locationStatus.style.color = "green";
            } else {
                locationBlockedDiv.style.display = 'block';
                locationBlockedDiv.textContent = 'AKSES UJIAN DIBLOKIR, silahkan aktifkan lokasi perangkat Anda di SMPN 2 Pajangan! Setelah diaktifkan, silahkan refresh halaman login!';
                isLocationValid = false;
                locationStatus.textContent = `Anda berada ${distance.toFixed(2)} km dari lokasi yang diizinkan.`;
                locationStatus.style.color = "red";
            }
            updateLoginButtonStatus();
        }

        function handleLocation(position) {
            checkLocation(position.coords.latitude, position.coords.longitude);
        }

        function handleLocationError(error) {
            console.error("Error mendapatkan lokasi:", error);

            locationBlockedDiv.style.display = 'block';
            locationBlockedDiv.textContent = 'AKSES UJIAN DIBLOKIR, silahkan aktifkan lokasi perangkat Anda di SMPN 2 Pajangan! Setelah diaktifkan, silahkan refresh halaman login!';
            message.style.color = "orange";

            let errorMessage = "Terjadi kesalahan tak terduga dengan layanan lokasi. Pastikan GPS aktif dan izin lokasi diberikan.";

            if (error && typeof error.code === 'number') {
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = "Lokasi belum diaktifkan, mohon aktifkan lokasi di pengaturan perangkat Anda.";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = "Informasi lokasi tidak tersedia.";
                        break;
                    case error.TIMEOUT:
                        errorMessage = "Waktu permintaan lokasi habis.";
                        break;
                }
            } else if (error && error.message) {
                errorMessage = `Terjadi kesalahan: ${error.message}`;
            }

            message.textContent = errorMessage;
            isLocationValid = false;
            updateLoginButtonStatus();
        }

        function getLocation() {
            if (isLocationEnabled && isTouchDevice()) {
                locationStatus.style.display = 'block';
                locationStatus.textContent = 'Mencari lokasi Anda...';
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(handleLocation, handleLocationError, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                } else {
                    locationBlockedDiv.style.display = 'block';
                    locationBlockedDiv.textContent = 'Geolocation tidak didukung oleh perangkat ini.';
                    message.style.color = "red";
                    isLocationValid = false;
                    updateLoginButtonStatus();
                }
            } else {
                locationBlockedDiv.style.display = 'none';
                isLocationValid = true;
                locationStatus.style.display = 'none';
                updateLoginButtonStatus();
            }
        }

        function loadClassDropdownForGrade(grade) {
            customSelectKelasDisplay.classList.add('disabled');
            customSelectNamaSiswaDisplay.classList.add('disabled');
            inputTokenPrefix.disabled = true;
            displayStudentId.value = "";
            message.innerHTML = `Memuat daftar kelas untuk kelas ${grade}... <span class="spinner"></span>`;

            const classNames = [];
            currentClassGroupKeys.forEach(groupKey => {
                const config = allFirebaseConfigs[groupKey];
                classNames.push(...config.allowedClasses);
            });
            classNames.sort();

            classModalList.innerHTML = '';
            classNames.forEach(cls => {
                const listItem = document.createElement('li');
                listItem.textContent = cls;
                listItem.dataset.value = cls;
                listItem.addEventListener('click', () => selectClass(cls));
                classModalList.appendChild(listItem);
            });
            customSelectKelasDisplay.classList.remove('disabled');
            message.textContent = "";
        }

        async function loadStudentsAndFilterByClass() {
            if (!currentDb) {
                message.style.color = "red";
                message.textContent = "Database belum diinisialisasi. Pilih kelas terlebih dahulu.";
                return;
            }

            const dbRefs = getDbRefs();
            if (!dbRefs) return;

            customSelectNamaSiswaDisplay.classList.add('disabled');
            inputTokenPrefix.disabled = true;
            displayStudentId.value = "";
            message.innerHTML = `Memuat data siswa untuk kelas ${hiddenSelectKelas.value}... <span class="spinner"></span>`;

            try {
                const snapshot = await get(dbRefs.studentsRef);
                if (snapshot.exists()) {
                    allStudentsData = [];
                    snapshot.forEach(childSnapshot => {
                        allStudentsData.push({ ...childSnapshot.val(), key: childSnapshot.key });
                    });

                    filterStudentsByClass();
                    message.textContent = "";
                } else {
                    message.style.color = "orange";
                    message.textContent = "Tidak ada data siswa ditemukan di database ini untuk kelas yang dipilih.";
                }
            } catch (error) {
                console.error("Gagal memuat data siswa:", error);
                message.style.color = "red";
                message.textContent = "Gagal memuat data siswa dari database yang dipilih.";
            }
        }

        function filterStudentsByClass() {
            const selectedClass = hiddenSelectKelas.value;
            studentModalList.innerHTML = '';
            hiddenSelectNamaSiswa.value = '';
            customSelectNamaSiswaDisplay.textContent = customSelectNamaSiswaDisplay.dataset.placeholder;
            customSelectNamaSiswaDisplay.classList.remove('selected');
            selectedStudentData = null;
            displayStudentId.value = "";
            inputTokenPrefix.value = "";
            const tokenInputGroup = inputTokenPrefix.closest('.token-input-group');
            if (tokenInputGroup) {
                tokenInputGroup.classList.remove('is-valid', 'is-invalid');
            }

            if (selectedClass) {
                const filteredStudents = allStudentsData.filter(student => student.class === selectedClass);
                filteredStudents.sort((a, b) => String(a.name || '').localeCompare(String(b.name || ''))).forEach(student => {
                    const listItem = document.createElement('li');
                    listItem.textContent = student.name;
                    listItem.dataset.value = student.id;
                    listItem.addEventListener('click', () => selectStudent(student.id, student.name));
                    studentModalList.appendChild(listItem);
                });
                customSelectNamaSiswaDisplay.classList.remove('disabled');
            } else {
                customSelectNamaSiswaDisplay.classList.add('disabled');
            }
            updateLoginButtonStatus();
        }

        function openClassModal() {
            if (customSelectKelasDisplay.classList.contains('disabled')) return;
            classModal.classList.add('show');
            isAnyModalOpen = true;
        }

        function closeClassModal() {
            classModal.classList.remove('show');
            isAnyModalOpen = false;
        }

        async function selectClass(className) {
            hiddenSelectKelas.value = className;
            customSelectKelasDisplay.textContent = className;
            customSelectKelasDisplay.classList.add('selected');
            closeClassModal();

            const instances = await getFirebaseInstanceForClass(className);
            if (!instances) {
                message.style.color = "red";
                message.textContent = "Gagal memuat konfigurasi database untuk kelas ini.";
                updateLoginButtonStatus();
                return;
            }
            currentDb = instances.db;
            currentAuth = instances.auth; // Set currentAuth di sini

            await loadStudentsAndFilterByClass();
            updateLoginButtonStatus();
        }

        function openStudentModal() {
            if (customSelectNamaSiswaDisplay.classList.contains('disabled')) return;
            studentModal.classList.add('show');
            isAnyModalOpen = true;
        }

        function closeStudentModal() {
            studentModal.classList.remove('show');
            isAnyModalOpen = false;
        }

        function selectStudent(studentId, studentName) {
            hiddenSelectNamaSiswa.value = studentId;
            customSelectNamaSiswaDisplay.textContent = studentName;
            customSelectNamaSiswaDisplay.classList.add('selected');
            selectedStudentData = allStudentsData.find(student => padStudentId(student.id) === padStudentId(studentId));
            displayStudentId.value = padStudentId(studentId);
            closeStudentModal();
            updateLoginButtonStatus();
        }

        function updateTimerDisplay() {
            if (!timerText || !studentNameDisplay || !classDisplay) return;

            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;

            const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerText.textContent = formattedTime;
            studentNameDisplay.textContent = selectedStudentData ? selectedStudentData.name : '';
            classDisplay.textContent = selectedStudentData ? selectedStudentData.class : '';

            const thirtyMinutesInSeconds = 30 * 60;
            if (submitAnswersButton) {
                if (remainingTime <= thirtyMinutesInSeconds && remainingTime > 0) {
                    submitAnswersButton.disabled = false;
                    submitAnswersButton.style.backgroundColor = document.documentElement.style.getPropertyValue('--accent-color');
                    submitAnswersButton.style.cursor = 'pointer';
                } else {
                    submitAnswersButton.disabled = true;
                    submitAnswersButton.style.backgroundColor = '#cccccc';
                    submitAnswersButton.style.cursor = 'not-allowed';
                }
            }

            if (remainingTime <= 300 && remainingTime > 0) {
                countdownDisplay.style.display = 'none';
                warningCountdown.textContent = formattedTime;
                warningOverlay.style.display = 'flex';
                setTimeout(() => { warningOverlay.style.opacity = 1; }, 10);
            } else {
                warningOverlay.style.opacity = 0;
                setTimeout(() => { warningOverlay.style.display = 'none'; }, 300);
            }

            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                timerText.textContent = "00:00";
                countdownDisplay.style.display = 'block';
                warningOverlay.style.opacity = 0;
                setTimeout(() => { warningOverlay.style.display = 'none'; }, 300);

                if (submitAnswersButton) {
                    submitAnswersButton.disabled = true;
                    submitAnswersButton.style.backgroundColor = '#cccccc';
                    submitAnswersButton.style.cursor = 'not-allowed';
                }

                // console.log("Waktu habis! Mengirim jawaban secara otomatis..."); // Dihapus
                submitAnswers(true);
                return;
            }

            remainingTime--;
        }

        function showOverlay(initialAnswers = null) {
            globalInitialAnswers = initialAnswers;
            loginContainer.style.opacity = 0;
            setTimeout(() => {
                loginContainer.style.display = 'none';
                fullscreenOverlay.style.display = 'flex';
                fullscreenOverlay.classList.add('show');
                document.body.style.overflow = 'hidden';
                examIframe.classList.add('blurred');
                isAnyModalOpen = true;
            }, 500);
        }

        function hideOverlay() {
            fullscreenOverlay.classList.remove('show');
            setTimeout(() => {
                fullscreenOverlay.style.display = 'none';
                document.body.style.overflow = '';
                examIframe.classList.remove('blurred');
                isAnyModalOpen = false;
                startExamProcess(globalExamUrl, globalExamDurationMinutes, globalNumQuestions, globalExamStartTime, globalInitialAnswers);
            }, 300);
        }

        async function showSubmissionConfirmationOverlay(isAutoSubmit) {
            sessionStorage.clear();
            loginContainer.style.display = 'none';
            examContainer.style.opacity = 0;
            setTimeout(async () => {
                examContainer.style.display = 'none';
                submissionConfirmationOverlay.style.display = 'flex';
                setTimeout(() => { submissionConfirmationOverlay.style.opacity = 1; }, 10);
                document.body.style.overflow = 'hidden';
                if (timerInterval) clearInterval(timerInterval);
                if (submissionListenerRef) {
                    const dbRefs = getDbRefs();
                    if (dbRefs) off(dbRefs.submittedExamsRef);
                    submissionListenerRef = null;
                }
                isInExamMode = false;
                toggleExamSecurityFeatures(false);
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }
                answerSidebar.classList.remove('open');
                examContentWrapper.classList.remove('sidebar-open');
                examIframe.style.width = '100%';
                isAnyModalOpen = true;

                if (isAutoSubmit) {
                    submissionOverlayTitle.innerHTML = '<span style="color: red; font-weight: bold;">WAKTU HABIS</span>';
                    submissionOverlayMessage.innerText = 'Jawaban kamu otomatis terkirim.';
                } else {
                    submissionOverlayTitle.innerText = 'SELAMAT!';
                    submissionOverlayTitle.style.color = '#4CAF50';
                    submissionOverlayMessage.innerText = 'JAWABAN ANDA BERHASIL TERKIRIM!';
                }
                backToLoginFromSubmissionBtn.innerText = 'KEMBALI';

                const tokenFirebaseKey = foundTokenGlobal?.key;
                const studentId = selectedStudentData?.id ? padStudentId(selectedStudentData.id) : null;
                const studentFirebaseKey = selectedStudentData?.key;
                const dbRefs = getDbRefs();

                if (dbRefs && tokenFirebaseKey && studentId && studentFirebaseKey) {
                    const accessStatusRef = child(dbRefs.examAccessStatusRef, `${tokenFirebaseKey}/${studentId}`);
                    const studentIsLoggedInRef = child(dbRefs.studentsRef, `${studentFirebaseKey}/isLoggedIn`);
                    try {
                        await update(accessStatusRef, { isLoggedIn: false, studentId: studentId });
                        // console.log("isLoggedIn diatur ke false di exam_access_status saat pengiriman."); // Dihapus

                        await set(studentIsLoggedInRef, false);
                        // console.log(`Status isLoggedIn siswa ${selectedStudentData.id} di node siswa diatur ke false saat pengiriman.`); // Dihapus

                    } catch (error) {
                        console.error("Gagal mengatur isLoggedIn ke false saat pengiriman:", error);
                    }
                }

            }, 500);
        }

        function hideSubmissionConfirmationOverlay() {
            submissionConfirmationOverlay.style.opacity = 0;
            setTimeout(() => {
                submissionConfirmationOverlay.style.display = 'none';
                document.body.style.overflow = '';
                isAnyModalOpen = false;
            }, 300);
        }

        function toggleExamSecurityFeatures(enable) {
            if (enable) {
                document.addEventListener('copy', preventDefaultBehavior);
                document.addEventListener('cut', preventDefaultBehavior);
                document.addEventListener('paste', preventDefaultBehavior);

                document.body.classList.add('no-select');
                document.addEventListener('selectstart', preventDefaultBehavior);
                document.addEventListener('contextmenu', preventDefaultBehavior);
                
            } else {
                document.removeEventListener('copy', preventDefaultBehavior);
                document.removeEventListener('cut', preventDefaultBehavior);
                document.removeEventListener('paste', preventDefaultBehavior);

                document.body.classList.remove('no-select');
                document.removeEventListener('selectstart', preventDefaultBehavior);
                document.removeEventListener('contextmenu', preventDefaultBehavior);
            }
        }

        function preventDefaultBehavior(e) {
            e.preventDefault();
            return false;
        }

        function attemptFullscreen() {
            if (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement) {
                // console.log("Sudah dalam mode layar penuh."); // Dihapus
                return;
            }

            if (examContainer.requestFullscreen) {
                examContainer.requestFullscreen().catch(err => {
                    console.warn(`Gagal masuk layar penuh: ${err.message}`);
                });
            } else if (examContainer.mozRequestFullScreen) {
                examContainer.mozRequestFullScreen().catch(err => console.warn(`Gagal masuk layar penuh (Firefox): ${err.message}`));
            } else if (examContainer.webkitRequestFullscreen) {
                examContainer.webkitRequestFullscreen().catch(err => console.warn(`Gagal masuk layar penuh (Webkit): ${err.message}`));
            } else if (examContainer.msRequestFullscreen) {
                examContainer.msRequestFullscreen().catch(err => console.warn(`Gagal masuk layar penuh (MS): ${err.message}`));
            }
        }

        async function handleFullscreenChange() {
            const dbRefs = getDbRefs();
            if (!dbRefs || !foundTokenGlobal || !selectedStudentData) return;

            const studentId = padStudentId(selectedStudentData.id);
            const accessStatusRef = child(dbRefs.examAccessStatusRef, `${foundTokenGlobal.key}/${studentId}`);

            if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement && isInExamMode) {
                examIframe.classList.add('blurred');
                document.body.style.overflow = 'hidden';
                
                countdownDisplay.style.display = 'none';
                zoomControls.style.display = 'none';
                sidebarToggle.style.display = 'none';
                closeSidebarButton.style.display = 'none';
                answerSidebar.classList.remove('open');
                examContentWrapper.classList.remove('sidebar-open');
                examIframe.style.width = '100%';
                isAnyModalOpen = true;

                if (isLockEnabledGlobal) {
                    let currentAttempts = parseInt(sessionStorage.getItem('attemptsLeft')) || toleranceLimitGlobal;
                    if (currentAttempts > 0) {
                        currentAttempts--;
                        sessionStorage.setItem('attemptsLeft', currentAttempts);
                        try {
                            await update(accessStatusRef, { attemptsLeft: currentAttempts, studentId: studentId });
                        } catch (error) {
                            console.error("Gagal memperbarui attemptsLeft di Firebase:", error);
                        }
                    }
                    currentAttemptsLeft = currentAttempts;

                    attemptsLeftInfo.style.display = 'block';
                    lockKeySection.style.display = 'none';
                    lockKeyInput.value = '';
                    lockKeyMessage.textContent = '';

                    if (currentAttemptsLeft > 0) {
                        exitWarningMessage.textContent = "Anda telah keluar dari mode layar penuh. Mohon kembali ke mode layar penuh untuk melanjutkan ujian.";
                        if (currentAttemptsLeft === 1) {
                            attemptsLeftInfo.textContent = `Ini adalah kesempatan terakhir Anda untuk keluar dari mode layar penuh!`;
                        } else {
                            attemptsLeftInfo.textContent = `Anda memiliki ${currentAttemptsLeft} kesempatan tersisa untuk keluar dari mode layar penuh.`;
                        }
                        reEnterFullscreenBtn.style.display = 'block';
                    } else {
                        exitWarningMessage.textContent = "Anda telah melebihi batas toleransi keluar dari mode layar penuh. Anda harus memasukkan kunci untuk melanjutkan ujian.";
                        attemptsLeftInfo.textContent = "Kesempatan keluar sudah habis.";
                        reEnterFullscreenBtn.style.display = 'none';
                        lockKeySection.style.display = 'block';
                        lockKeyInput.focus();
                    }
                } else {
                    exitWarningMessage.textContent = "Anda telah keluar dari mode layar penuh. Mohon kembali ke mode layar penuh untuk melanjutkan ujian.";
                    attemptsLeftInfo.style.display = 'none';
                    lockKeySection.style.display = 'none';
                    reEnterFullscreenBtn.style.display = 'block';
                }

                fullscreenExitWarningOverlay.style.display = 'flex';
                setTimeout(() => { fullscreenExitWarningOverlay.style.opacity = 1; }, 10);

            } else if (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement) {
                fullscreenExitWarningOverlay.style.opacity = 0;
                setTimeout(() => { fullscreenExitWarningOverlay.style.display = 'none'; }, 300);
                examIframe.classList.remove('blurred');
                document.body.style.overflow = '';
                isAnyModalOpen = false;

                countdownDisplay.style.display = 'flex';
                zoomControls.style.display = 'flex';
                sidebarToggle.style.display = 'flex';
                closeSidebarButton.style.display = 'none';
            }
        }

        function startSubmissionStatusListener() {
            if (!foundTokenGlobal || !selectedStudentData || !currentDb) {
                console.warn("Token, data siswa, atau database tidak lengkap untuk memulai listener pengiriman.");
                return;
            }

            const dbRefs = getDbRefs();
            if (!dbRefs) return;

            const tokenFirebaseKey = foundTokenGlobal.key;
            const studentId = padStudentId(selectedStudentData.id);
            
            const studentSubmissionRef = child(dbRefs.submittedExamsRef, `${tokenFirebaseKey}/${studentId}`);

            if (submissionListenerRef) {
                off(submissionListenerRef);
                submissionListenerRef = null;
            }

            onValue(studentSubmissionRef, (snapshot) => {
                if (snapshot.exists() && snapshot.val().isSubmitted === true) {
                    if (examContainer.style.display === 'flex') {
                        // console.log("Deteksi: Jawaban siswa direkam di Firebase secara real-time."); // Dihapus
                        showSubmissionConfirmationOverlay(true);
                        examIframe.src = '';
                    }
                }
            }, (error) => {
                console.error("Gagal mendengarkan status pengiriman:", error);
            });
            // console.log("Listener real-time untuk status pengiriman dimulai."); // Dihapus
        }

        function startExamProcess(examUrl, examDurationMinutes, numQuestions, examStartTime, initialAnswers = null) {
            // console.log("startExamProcess dipanggil. Jawaban Awal:", initialAnswers); // Dihapus

            sessionStorage.setItem('isInExamMode', 'true');
            sessionStorage.setItem('selectedStudentData', JSON.stringify(selectedStudentData));
            sessionStorage.setItem('foundTokenGlobal', JSON.stringify(foundTokenGlobal));
            sessionStorage.setItem('examIframeSrc', examUrl);
            sessionStorage.setItem('examStartTime', Number(examStartTime));
            sessionStorage.setItem('examDurationMinutes', examDurationMinutes);
            sessionStorage.setItem('totalQuestions', numQuestions);
            sessionStorage.setItem('selectedClass', hiddenSelectKelas.value);
            sessionStorage.setItem('selectedGrade', currentSelectedGrade);

            if (initialAnswers && initialAnswers.length > 0) {
                studentAnswers = initialAnswers;
                sessionStorage.setItem('studentAnswers', studentAnswers.join(','));
                // console.log("studentAnswers diatur dari initialAnswers:", studentAnswers); // Dihapus
            } else {
                studentAnswers = Array(numQuestions).fill('');
                sessionStorage.removeItem('studentAnswers');
                // console.log("studentAnswers diinisialisasi kosong."); // Dihapus
            }

            loginContainer.style.opacity = 0;
            setTimeout(() => {
                loginContainer.style.display = 'none';
                examContainer.style.display = 'flex';
                setTimeout(() => {
                    examContainer.style.opacity = 1;
                    isInExamMode = true;
                    toggleExamSecurityFeatures(true);
                    renderAnswerBoxes();
                }, 10);
            }, 500);

            examIframe.src = examUrl;
            
            const totalDurationSeconds = examDurationMinutes * 60;
            const elapsedSeconds = Math.floor((Date.now() - examStartTime) / 1000);
            remainingTime = totalDurationSeconds - elapsedSeconds;
            
            // console.log(`DEBUG: startExamProcess - totalDurationSeconds: ${totalDurationSeconds}, elapsedSeconds: ${elapsedSeconds}, calculated remainingTime: ${remainingTime}`); // Dihapus
            if (remainingTime < 0) remainingTime = 0;
            // console.log(`DEBUG: startExamProcess - final remainingTime (setelah clamping): ${remainingTime}`); // Dihapus


            timerInterval = setInterval(updateTimerDisplay, 1000);
            countdownDisplay.style.display = 'flex';
            updateTimerDisplay();

            attemptFullscreen();
            history.pushState(null, '', location.href);
            startSubmissionStatusListener();

            sidebarToggle.style.display = 'flex';
            closeSidebarButton.style.display = 'none';
        }

        async function restoreExamState() {
            const storedIsInExamMode = sessionStorage.getItem('isInExamMode');
            if (storedIsInExamMode === 'true') {
                const storedSelectedStudentData = JSON.parse(sessionStorage.getItem('selectedStudentData'));
                const storedFoundTokenGlobal = JSON.parse(sessionStorage.getItem('foundTokenGlobal'));
                const storedExamIframeSrc = sessionStorage.getItem('examIframeSrc');
                const storedExamDurationMinutes = parseInt(sessionStorage.getItem('examDurationMinutes'), 10);
                const storedTotalQuestions = parseInt(sessionStorage.getItem('totalQuestions'), 10);
                const storedSelectedClass = sessionStorage.getItem('selectedClass');
                const storedSelectedGrade = sessionStorage.getItem('selectedGrade');

                let storedExamStartTimeRaw = sessionStorage.getItem('examStartTime');
                let storedExamStartTime = Number(storedExamStartTimeRaw);

                if (isNaN(storedExamStartTime) || storedExamStartTime <= 0) {
                    console.error("Restore State: Gagal mengambil examStartTime yang valid dari sessionStorage. Menggunakan 0. Raw:", storedExamStartTimeRaw);
                    storedExamStartTime = 0;
                }

                // console.log("Restore State: selectedStudentData", storedSelectedStudentData); // Dihapus
                // console.log("Restore State: foundTokenGlobal", storedFoundTokenGlobal); // Dihapus
                // console.log("Restore State: storedExamStartTime (setelah parsing):", storedExamStartTime); // Dihapus
                // console.log("Restore State: storedExamDurationMinutes:", storedExamDurationMinutes); // Dihapus
                // console.log("Restore State: storedTotalQuestions (dari sessionStorage):", storedTotalQuestions); // Dihapus
                // console.log("Restore State: storedSelectedClass:", storedSelectedClass); // Dihapus
                // console.log("Restore State: storedSelectedGrade:", storedSelectedGrade); // Dihapus

                if (storedSelectedStudentData && storedFoundTokenGlobal && storedExamIframeSrc &&
                    !isNaN(storedExamStartTime) && storedExamStartTime > 0 &&
                    !isNaN(storedExamDurationMinutes) && storedExamDurationMinutes > 0 &&
                    !isNaN(storedTotalQuestions) && storedTotalQuestions >= 0 &&
                    storedSelectedClass && storedSelectedGrade) {
                    
                    selectedStudentData = storedSelectedStudentData;
                    foundTokenGlobal = storedFoundTokenGlobal;
                    isInExamMode = true;
                    totalQuestions = storedTotalQuestions;
                    currentSelectedGrade = storedSelectedGrade;

                    // Terapkan warna tema terlebih dahulu
                    const gradeConfig = allFirebaseConfigs[`kelas${currentSelectedGrade}-group1`]; // Asumsikan grup pertama memiliki info tema
                    if (gradeConfig && gradeConfig.theme) {
                        document.documentElement.style.setProperty('--primary-color', gradeConfig.theme.primary);
                        document.documentElement.style.setProperty('--accent-color', gradeConfig.theme.accent);
                        document.documentElement.style.setProperty('--warning-color', gradeConfig.theme.warning);

                        // Juga perbarui gaya elemen tertentu
                        document.querySelector('.header-box').style.backgroundColor = gradeConfig.theme.primary;
                        document.querySelector('.judul-ujian').style.color = gradeConfig.theme.warning;
                        document.querySelector('#loginBtn').style.backgroundColor = gradeConfig.theme.accent;
                        document.querySelector('#loginBtn').onmouseover = () => document.querySelector('#loginBtn').style.backgroundColor = gradeConfig.theme.primary;
                        document.querySelector('#loginBtn').onmouseout = () => document.querySelector('#loginBtn').style.backgroundColor = gradeConfig.theme.accent;

                        document.querySelector('#countdownDisplay').style.backgroundColor = gradeConfig.theme.primary;
                        document.querySelector('#customMessageModalButton').style.backgroundColor = gradeConfig.theme.accent;
                        document.querySelector('#customConfirmModalConfirmBtn').style.backgroundColor = gradeConfig.theme.accent;
                        
                        // Perbarui event listener untuk tombol kontrol zoom secara dinamis
                        const zoomButtons = document.querySelectorAll('#zoomControls button');
                        zoomButtons.forEach(btn => {
                            btn.style.backgroundColor = gradeConfig.theme.accent;
                            btn.onmouseover = (e) => e.target.style.backgroundColor = gradeConfig.theme.primary;
                            btn.onmouseout = (e) => e.target.style.backgroundColor = gradeConfig.theme.accent;
                        });

                        document.querySelector('#fullscreenOverlay .overlay-content').style.background = `linear-gradient(135deg, ${gradeConfig.theme.primary} 0%, ${gradeConfig.theme.primary} 100%)`;
                        document.querySelector('.custom-modal-content h4').style.color = gradeConfig.theme.primary;
                        document.querySelector('#confirmModal .modal-content h4').style.color = gradeConfig.theme.primary;
                        document.querySelector('#answerSelectionModal h4').style.color = gradeConfig.theme.primary;
                        document.querySelector('#submitAnswersButton').style.backgroundColor = gradeConfig.theme.accent;
                        document.querySelector('#submitAnswersButton').onmouseover = () => document.querySelector('#submitAnswersButton').style.backgroundColor = gradeConfig.theme.primary;
                        document.querySelector('#submitAnswersButton').onmouseout = () => document.querySelector('#submitAnswersButton').style.backgroundColor = gradeConfig.theme.accent;
                        
                        const exitWarningButtons = document.querySelectorAll('.exit-warning-button');
                        exitWarningButtons.forEach(btn => {
                            btn.style.backgroundColor = gradeConfig.theme.accent;
                            btn.onmouseover = () => btn.style.backgroundColor = gradeConfig.theme.primary;
                            btn.onmouseout = () => btn.style.backgroundColor = gradeConfig.theme.accent;
                        });
                    }
                    loginJudulUjian.textContent = `UJIAN KELAS ${currentSelectedGrade}`;

                    const instances = await getFirebaseInstanceForClass(storedSelectedClass);
                    if (!instances) {
                        console.error("Restore State: Gagal menginisialisasi database untuk kelas yang disimpan. Membersihkan sesi.");
                        sessionStorage.clear();
                        return;
                    }
                    currentDb = instances.db;
                    currentAuth = instances.auth; // Set currentAuth di sini
                    
                    const dbRefs = getDbRefs();
                    if (!dbRefs) {
                        console.error("Restore State: Gagal mendapatkan referensi database saat memulihkan jawaban.");
                        sessionStorage.clear();
                        return;
                    }

                    const tokenFirebaseKey = foundTokenGlobal.key;
                    const studentId = padStudentId(selectedStudentData.id);
                    const accessStatusRef = child(dbRefs.examAccessStatusRef, `${tokenFirebaseKey}/${studentId}`);
                    const studentAnswersPath = child(dbRefs.studentAnswersRef, `${tokenFirebaseKey}/${studentId}`);
                    
                    let loadedAnswers = Array(totalQuestions).fill('');
                    let storedAttemptsLeft = toleranceLimitGlobal;

                    try {
                        const answersSnapshot = await get(studentAnswersPath);
                        if (answersSnapshot.exists()) {
                            const savedAnswersData = answersSnapshot.val();
                            loadedAnswers = savedAnswersData.answers ? savedAnswersData.answers.split(',') : Array(totalQuestions).fill('');
                            // console.log("Restore State: Jawaban siswa dimuat dari Firebase:", loadedAnswers); // Dihapus
                        } else {
                            console.warn("Restore State: Tidak ada jawaban yang disimpan di Firebase pada jalur ini, dimulai dengan array kosong.");
                        }

                        const accessStatusSnapshot = await get(accessStatusRef);
                        if (accessStatusSnapshot.exists()) {
                            const accessData = accessStatusSnapshot.val();
                            if (accessData.attemptsLeft !== undefined) {
                                storedAttemptsLeft = accessData.attemptsLeft;
                            }
                            if (accessData.isLoggedIn === true) {
                                message.style.color = "red";
                                message.textContent = "Anda sudah Login di perangkat lain. Mohon hubungi admin untuk mereset akun Anda.";
                                initialLoginScreen.style.display = 'none';
                                welcomeScreen.style.display = 'none';
                                loginContainer.style.display = 'flex';
                                loginContainer.style.opacity = 1;
                                examContainer.style.display = 'none';
                                sessionStorage.clear();
                                updateLoginButtonStatus();
                                return;
                            }
                        }
                    } catch (error) {
                        console.error("Restore State: Gagal memuat jawaban atau status akses dari Firebase:", error);
                    }
                    sessionStorage.setItem('attemptsLeft', storedAttemptsLeft);
                    currentAttemptsLeft = storedAttemptsLeft;

                    const elapsedSeconds = Math.floor((Date.now() - storedExamStartTime) / 1000);
                    const totalDurationSeconds = storedExamDurationMinutes * 60;
                    remainingTime = totalDurationSeconds - elapsedSeconds;

                    if (remainingTime > 0) {
                        initialLoginScreen.style.display = 'none';
                        welcomeScreen.style.display = 'none';
                        loginContainer.style.opacity = 0;
                        setTimeout(() => {
                            loginContainer.style.display = 'none';
                            examContainer.style.display = 'flex';
                            setTimeout(() => {
                                examContainer.style.opacity = 1;
                                startExamProcess(storedExamIframeSrc, storedExamDurationMinutes, storedTotalQuestions, storedExamStartTime, loadedAnswers);
                                examContentWrapper.classList.remove('sidebar-open');
                                sidebarToggle.style.display = 'flex';
                                closeSidebarButton.style.display = 'none';
                            }, 10);
                        }, 500);
                    } else {
                        sessionStorage.clear();
                        initialLoginScreen.style.display = 'none';
                        welcomeScreen.style.display = 'none';
                        loginContainer.style.display = 'none';
                        examContainer.style.display = 'flex';
                        examContainer.style.opacity = 1;
                        timerText.textContent = "00:00";
                        countdownDisplay.style.display = 'block';
                        submitAnswers(true);
                    }
                } else {
                    console.warn("Restore State: Status ujian tidak lengkap atau tidak valid ditemukan di penyimpanan sesi. Membersihkan.");
                    sessionStorage.clear();
                }
            }
        }

        async function handleLanjutClick(fullTokenId, examDurationMinutes, numQuestions, initialAnswers = null) {
            if (!confirmCheckbox.checked) {
                modalMessage.style.display = 'block';
                modalMessage.textContent = "Anda harus mencentang cekbox untuk melanjutkan!";
                return;
            } else {
                modalMessage.style.display = 'none';
            }

            confirmModal.classList.remove('show');
            isAnyModalOpen = false;

            if (!foundTokenGlobal || !selectedStudentData || !currentDb) {
                console.error("Error: Data ujian, data siswa, atau database tidak ditemukan untuk pengalihan (handleLanjutClick).");
                message.style.color = "red";
                message.textContent = "Terjadi kesalahan saat menyiapkan tautan ujian. Pastikan koneksi internet Anda stabil dan coba lagi.";
                updateLoginButtonStatus();
                loginContainer.style.display = 'flex';
                examContainer.style.display = 'none';
                sessionStorage.clear();
                return;
            }

            message.innerHTML = `Mencatat akses ujian... <span class="spinner"></span>`;

            const dbRefs = getDbRefs();
            if (!dbRefs) return;

            const tokenFirebaseKey = foundTokenGlobal.key;
            const studentId = padStudentId(selectedStudentData.id);
            const accessStatusRef = child(dbRefs.examAccessStatusRef, `${tokenFirebaseKey}/${studentId}`);
            const studentFirebaseKey = selectedStudentData.key;

            try {
                let examAccessDataAfterTransaction = await runTransaction(accessStatusRef, (currentAccess) => {
                    const nowAccess = Date.now();
                    let updatedAccess = currentAccess;

                    if (currentAccess === null || currentAccess.isLoggedIn === false) {
                        updatedAccess = {
                            accessCount: (currentAccess ? currentAccess.accessCount || 0 : 0) + 1,
                            firstLoginTimestamp: currentAccess ? currentAccess.firstLoginTimestamp : nowAccess,
                            lastAccessTimestamp: nowAccess,
                            isLoggedIn: true,
                            examStartTime: currentAccess ? currentAccess.examStartTime : nowAccess,
                            studentId: studentId,
                            attemptsLeft: toleranceLimitGlobal
                        };
                        if (updatedAccess.logoutTimestamp) {
                            delete updatedAccess.logoutUserTimestamp;
                        }
                    } else {
                        updatedAccess.accessCount = (currentAccess.accessCount || 0) + 1;
                        updatedAccess.lastAccessTimestamp = nowAccess;
                        updatedAccess.isLoggedIn = true;
                        if (foundTokenGlobal.isForceActive && (!currentAccess.examStartTime || isNaN(currentAccess.examStartTime) || currentAccess.examStartTime <= 0)) {
                            updatedAccess.examStartTime = nowAccess;
                        }
                        updatedAccess.studentId = currentAccess.studentId || studentId;
                        updatedAccess.attemptsLeft = currentAccess.attemptsLeft !== undefined ? currentAccess.attemptsLeft : toleranceLimitGlobal;
                    }
                    return updatedAccess;
                });

                if (examAccessDataAfterTransaction.committed) {
                    // console.log(`Akses ke token ${foundTokenGlobal.key} oleh siswa ${selectedStudentData.id} berhasil diperbarui. accessCount baru: ${examAccessDataAfterTransaction.snapshot.val().accessCount}`); // Dihapus
                    
                    if (studentFirebaseKey) {
                        const studentIsLoggedInRef = child(dbRefs.studentsRef, `${studentFirebaseKey}/isLoggedIn`);
                        await set(studentIsLoggedInRef, true);
                        // console.log(`Status isLoggedIn siswa ${selectedStudentData.id} di node siswa diatur ke true pada 'Lanjutkan'.`); // Dihapus
                    } else {
                        console.warn(`Tidak dapat menemukan kunci Firebase untuk siswa ${selectedStudentData.id} untuk memperbarui status isLoggedIn di node siswa.`);
                    }

                    globalExamUrl = foundTokenGlobal.googleDriveUrl;

                    if (globalExamUrl.includes('drive.google.com/file/d/')) {
                        globalExamUrl = globalExamUrl.replace('/view', '/preview');
                        
                        if (!globalExamUrl.includes('/preview')) {
                            const parts = globalExamUrl.split('/file/d/');
                            if (parts.length > 1) {
                                const fileIdAndRest = parts[1].split('/');
                                const fileId = fileIdAndRest[0];
                                globalExamUrl = `${parts[0]}/file/d/${fileId}/preview`;
                                if (fileIdAndRest.length > 1) {
                                    globalExamUrl += fileIdAndRest.slice(1).join('/');
                                }
                            }
                        }

                        const hasQueryParams = globalExamUrl.includes('?');
                        if (!globalExamUrl.includes('chrome=false')) {
                            globalExamUrl += hasQueryParams ? '&chrome=false' : '?chrome=false';
                        }
                    }
                    // console.log("Final Google Drive URL:", globalExamUrl); // Dihapus

                    globalExamDurationMinutes = examDurationMinutes;
                    globalNumQuestions = numQuestions;
                    globalExamStartTime = Number(examAccessDataAfterTransaction.snapshot.val().examStartTime);
                    globalInitialAnswers = initialAnswers;

                    if (isNaN(globalExamStartTime) || globalExamStartTime <= 0) {
                        console.error("Kesalahan Kritis: globalExamStartTime tidak valid setelah transaksi di handleLanjutClick. Menggunakan Date.now() sebagai fallback.");
                        globalExamStartTime = Date.now();
                    }
                    
                    currentAttemptsLeft = toleranceLimitGlobal;
                    sessionStorage.setItem('attemptsLeft', currentAttemptsLeft);

                    message.textContent = "";
                    showOverlay(globalInitialAnswers);
                } else {
                    console.warn("Transaksi untuk status akses ujian dibatalkan di handleLanjutClick.");
                    message.style.color = "orange";
                    message.textContent = "Gagal merekam akses ujian. Silakan coba lagi.";
                    updateLoginButtonStatus();
                    loginContainer.style.display = 'flex';
                    examContainer.style.display = 'none';
                    sessionStorage.clear();
                }

            } catch (err) {
                console.error("Error di handleLanjutClick (selama transaksi akses ujian):", err);
                message.style.color = "red";
                message.textContent = "Terjadi kesalahan saat merekam akses ujian. Silakan coba lagi atau hubungi administrator.";
                updateLoginButtonStatus();
                loginContainer.style.display = 'flex';
                examContainer.style.display = 'none';
                sessionStorage.clear();
            }
        }

        function toggleSidebar() {
            const isSidebarOpen = examContentWrapper.classList.contains('sidebar-open');
            
            if (!isSidebarOpen) {
                examContentWrapper.classList.add('sidebar-open');
                sidebarToggle.style.display = 'none';
                closeSidebarButton.style.display = 'flex';
            } else {
                examContentWrapper.classList.remove('sidebar-open');
                sidebarToggle.style.display = 'flex';
                closeSidebarButton.style.display = 'none';

                submissionWarningMessage.textContent = '';
            }
            resetIframePan();
        }

        function closeSidebarOnClickOutside(event) {
            if (examContentWrapper.classList.contains('sidebar-open')) {
                const isAnswerSelectionModalVisible = answerSelectionModal.classList.contains('show');
                if (!answerSidebar.contains(event.target) &&
                    event.target !== sidebarToggle &&
                    !sidebarToggle.contains(event.target) &&
                    event.target !== closeSidebarButton &&
                    !closeSidebarButton.contains(event.target) &&
                    (!isAnyModalOpen || !answerSelectionModal.contains(event.target))) {
                    toggleSidebar();
                }
            }
        }

        function renderAnswerBoxes() {
            const effectiveTotalQuestions = (totalQuestions > 0) ? totalQuestions : studentAnswers.length;
            // console.log(`Merender kotak jawaban. Total pertanyaan efektif: ${effectiveTotalQuestions}`); // Dihapus
            
            answerListContainer.innerHTML = '';
            for (let i = 0; i < effectiveTotalQuestions; i++) {
                const questionNumber = i + 1;
                const answer = studentAnswers[i];
                const answerBox = document.createElement('div');
                answerBox.classList.add('answer-box');
                answerBox.dataset.questionIndex = i;
                answerBox.innerHTML = `
                    <span class="question-number">${questionNumber}</span>
                    <span class="selected-answer">${answer || '...'}</span>
                `;
                if (answer) {
                    answerBox.classList.add('answered');
                    answerBox.classList.remove('unanswered');
                } else {
                    answerBox.classList.add('unanswered');
                    answerBox.classList.remove('answered');
                }
                answerBox.addEventListener('click', () => openAnswerSelectionModal(i));
                answerListContainer.appendChild(answerBox);
                // console.log(`Kotak jawaban dibuat dan ditambahkan untuk pertanyaan: ${questionNumber}, Jawaban: ${answer}`); // Dihapus
            }
        }

        function openAnswerSelectionModal(index) {
            currentQuestionIndexForModal = index;
            currentQuestionNumberSpan.textContent = index + 1;

            const currentAnswer = studentAnswers[index];
            answerOptionsContainer.querySelectorAll('button').forEach(button => {
                if (button.dataset.answer === currentAnswer) {
                    button.classList.add('selected');
                } else {
                    button.classList.remove('selected');
                }
            });

            answerSelectionModal.classList.add('show');
            isAnyModalOpen = true;
        }

        function closeAnswerSelectionModal() {
            answerSelectionModal.classList.remove('show');
            currentQuestionIndexForModal = -1;
            isAnyModalOpen = false;
        }

        function selectAnswer(answer) {
            if (currentQuestionIndexForModal !== -1) {
                studentAnswers[currentQuestionIndexForModal] = answer;
                renderAnswerBoxes();
                sessionStorage.setItem('studentAnswers', studentAnswers.join(','));
                saveStudentAnswersToFirebase();
                closeAnswerSelectionModal();
            }
        }

        function clearAnswer() {
            if (currentQuestionIndexForModal !== -1) {
                studentAnswers[currentQuestionIndexForModal] = '';
                renderAnswerBoxes();
                sessionStorage.setItem('studentAnswers', studentAnswers.join(','));
                saveStudentAnswersToFirebase();
                closeAnswerSelectionModal();
            }
        }

        async function saveStudentAnswersToFirebase() {
            if (!foundTokenGlobal || !selectedStudentData || !currentDb) {
                console.warn("Data token, data siswa, atau database tidak lengkap. Tidak dapat menyimpan jawaban ke Firebase.");
                return;
            }

            const dbRefs = getDbRefs();
            if (!dbRefs) return;

            const tokenFirebaseKey = foundTokenGlobal.key;
            const studentId = padStudentId(selectedStudentData.id);
            const studentAnswersPath = child(dbRefs.studentAnswersRef, `${tokenFirebaseKey}/${studentId}`);

            try {
                await set(studentAnswersPath, {
                    answers: studentAnswers.join(','),
                    timestamp: Date.now(),
                    studentName: selectedStudentData.name,
                    studentClass: selectedStudentData.class,
                    token: foundTokenGlobal.token,
                    subject: foundTokenGlobal.subject,
                    studentId: studentId
                });
                // console.log("Jawaban siswa berhasil disimpan ke Firebase."); // Dihapus
            } catch (error) {
                console.error("Gagal menyimpan jawaban siswa ke Firebase:", error);
            }
        }

        async function submitAnswers(isAutoSubmit = false) {
            submissionWarningMessage.textContent = '';

            if (!foundTokenGlobal || !selectedStudentData || !currentDb) {
                submissionWarningMessage.textContent = 'Error: Data ujian, data siswa, atau database tidak ditemukan. Tidak dapat mengirimkan jawaban.';
                return;
            }

            const dbRefs = getDbRefs();
            if (!dbRefs) return;

            if (!isAutoSubmit) {
                const unansweredQuestions = studentAnswers.filter(answer => answer === '').length;
                if (unansweredQuestions > 0) {
                    submissionWarningMessage.textContent = `Ada ${unansweredQuestions} jawaban yang belum terisi! Harap periksa kembali.`;
                    return;
                }
            }

            if (!isAutoSubmit) {
                const confirmed = await window.showCustomConfirmModal("Konfirmasi Pengiriman", "Apakah Anda yakin ingin mengirimkan semua jawaban? Setelah dikirim, Anda tidak dapat mengubahnya lagi.");
                if (!confirmed) {
                    return;
                }
            }

            submitAnswersButton.disabled = true;
            submitAnswersButton.textContent = 'Mengirim Jawaban...';
            submitAnswersButton.style.backgroundColor = '#cccccc';

            const tokenFirebaseKey = foundTokenGlobal.key;
            const studentId = padStudentId(selectedStudentData.id);
            const studentFirebaseKey = selectedStudentData.key;

            try {
                await saveStudentAnswersToFirebase();

                const submittedExamPath = child(dbRefs.submittedExamsRef, `${tokenFirebaseKey}/${studentId}`);
                await set(submittedExamPath, {
                    isSubmitted: true,
                    timestamp: Date.now(),
                    studentId: studentId
                });
                // console.log("Status ujian berhasil diperbarui menjadi dikirim di submitted_exams."); // Dihapus

                const accessStatusRef = child(dbRefs.examAccessStatusRef, `${tokenFirebaseKey}/${studentId}`);
                await update(accessStatusRef, {
                    isLoggedIn: false,
                    studentId: studentId,
                    attemptsLeft: toleranceLimitGlobal
                });
                // console.log("isLoggedIn diatur ke false dan attemptsLeft direset di exam_access_status saat pengiriman."); // Dihapus

                if (studentFirebaseKey) {
                    const studentIsLoggedInRef = child(dbRefs.studentsRef, `${studentFirebaseKey}/isLoggedIn`);
                    await set(studentIsLoggedInRef, false);
                    // console.log(`Status isLoggedIn siswa ${selectedStudentData.id} di node siswa diatur ke false saat pengiriman.`); // Dihapus
                } else {
                    console.warn(`Tidak dapat menemukan kunci Firebase untuk siswa ${selectedStudentData.id} untuk memperbarui status isLoggedIn di node siswa.`);
                }

                showSubmissionConfirmationOverlay(isAutoSubmit);

            } catch (error) {
                console.error("Gagal mengirimkan jawaban:", error);
                submissionWarningMessage.textContent = 'Gagal mengirimkan jawaban. Silakan coba lagi atau hubungi administrator.';
            } finally {
                submitAnswersButton.textContent = 'KIRIM JAWABAN';
            }
        }

        window.showCustomMessageModal = function (title, messageText, type = 'info') {
            customMessageModalTitle.textContent = title;
            customMessageModalText.textContent = messageText;

            customMessageModalTitle.style.color = '';
            customMessageModalButton.style.backgroundColor = '';
            switch (type) {
                case 'success':
                    customMessageModalTitle.style.color = '#4CAF50';
                    customMessageModalButton.style.backgroundColor = '#4CAF50';
                    break;
                case 'error':
                    customMessageModalTitle.style.color = '#dc3545';
                    customMessageModalButton.style.backgroundColor = '#dc3545';
                    break;
                case 'warning':
                    customMessageModalTitle.style.color = '#ffc107';
                    customMessageModalButton.style.backgroundColor = '#ffc107';
                    break;
                default:
                    customMessageModalTitle.style.color = document.documentElement.style.getPropertyValue('--primary-color');
                    customMessageModalButton.style.backgroundColor = document.documentElement.style.getPropertyValue('--accent-color');
            }

            customMessageModal.classList.add('show');
            isAnyModalOpen = true;
        }

        window.hideCustomMessageModal = function () {
            customMessageModal.classList.remove('show');
            isAnyModalOpen = false;
        }

        window.showCustomConfirmModal = function (title, messageText) {
            return new Promise((resolve) => {
                customConfirmModalTitle.textContent = title;
                customConfirmModalText.textContent = messageText;

                customConfirmModal.classList.add('show');
                isAnyModalOpen = true;

                const handleConfirm = () => {
                    customConfirmModal.classList.remove('show');
                    isAnyModalOpen = false;
                    customConfirmModalConfirmBtn.removeEventListener('click', handleConfirm);
                    customConfirmModalCancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    customConfirmModal.classList.remove('show');
                    isAnyModalOpen = false;
                    customConfirmModalConfirmBtn.removeEventListener('click', handleConfirm);
                    customConfirmModalCancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                customConfirmModalConfirmBtn.addEventListener('click', handleConfirm);
                customConfirmModalCancelBtn.addEventListener('click', handleCancel);
            });
        }

        function getTranslateValues(element) {
            const style = window.getComputedStyle(element);
            const matrix = style.transform;

            if (matrix === 'none') {
                return { x: 0, y: 0 };
            }

            const matrixValues = matrix.match(/matrix.*\((.+)\)/)[1].split(', ');
            return {
                x: parseFloat(matrixValues[4]),
                y: parseFloat(matrixValues[5])
            };
        }

        function applyIframeTransform() {
            examIframe.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentZoom})`;
            // console.log(`Menerapkan transform: translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentZoom})`); // Dihapus
        }

        function resetIframePan() {
            currentTranslateX = 0;
            currentTranslateY = 0;
            applyIframeTransform();
        }

        function updateZoomButtonStates() {
            zoomInBtn.disabled = currentZoom >= MAX_ZOOM;
            zoomOutBtn.disabled = currentZoom <= MIN_ZOOM;
            
            const isZoomedIn = currentZoom > MIN_ZOOM;
            panLeftBtn.disabled = !isZoomedIn;
            panRightBtn.disabled = !isZoomedIn;

            refreshIframeBtn.disabled = false;
        }

        function resetAutoHideTimer() {
            clearTimeout(autoHideTimer);
            autoHideTimer = setTimeout(() => {
                if (zoomControls.classList.contains('show-controls')) {
                    zoomControls.classList.remove('show-controls');
                }
            }, 3000);
        }

        function toggleControlsPanel() {
            zoomControls.classList.toggle('show-controls');
            if (zoomControls.classList.contains('show-controls')) {
                resetAutoHideTimer();
            } else {
                clearTimeout(autoHideTimer);
            }
        }
        
        function startAutoPan() {
            if (panIntervalId) clearInterval(panIntervalId);
            panIntervalId = setInterval(() => {
                if (currentZoom > MIN_ZOOM) {
                    let newTranslateX = currentTranslateX + (panDirection * PAN_STEP);
                    
                    const unscaledIframeWidth = examIframe.offsetWidth;
                    const scaledIframeWidth = unscaledIframeWidth * currentZoom;
                    const containerWidth = examContentWrapper.offsetWidth;

                    const maxNegativeX = -(Math.max(0, scaledIframeWidth - containerWidth));
                    newTranslateX = Math.max(maxNegativeX, Math.min(0, newTranslateX));

                    if (newTranslateX === currentTranslateX) {
                        stopAutoPan();
                        return;
                    }

                    currentTranslateX = newTranslateX;
                    applyIframeTransform();
                } else {
                    stopAutoPan();
                }
            }, PAN_INTERVAL);
        }

        function stopAutoPan() {
            if (panIntervalId) {
                clearInterval(panIntervalId);
                panIntervalId = null;
                // console.log("Pan otomatis dihentikan."); // Dihapus
            }
        }

        // Fungsi untuk memuat dan menampilkan tombol berdasarkan konfigurasi Firebase (publicSettings)
        async function loadAndRenderWelcomeButtons() {
            welcomeButtonsContainer.innerHTML = ''; // Bersihkan tombol yang ada
            welcomeMessageElement.textContent = 'Memuat pilihan ujian...'; // Perbarui pesan pemuatan

            if (!buttonConfigDb) {
                console.error("Database konfigurasi tombol belum diinisialisasi.");
                welcomeMessageElement.textContent = 'Gagal memuat konfigurasi. Silakan refresh halaman.';
                return;
            }

            try {
                const publicSettingsRef = ref(buttonConfigDb, 'publicSettings'); // Use ref from buttonConfigDb
                const snapshot = await get(publicSettingsRef); // Use get from buttonConfigDb

                if (snapshot.exists()) {
                    publicSettings = snapshot.val();
                    // console.log("Konfigurasi publicSettings dari Firebase:", publicSettings); // Dihapus

                    const activeButtons = [];

                    // Cek Kelas 7, 8, 9
                    ['kelas7', 'kelas8', 'kelas9'].forEach(kelas => {
                        if (publicSettings[kelas] && publicSettings[kelas].enabled) {
                            activeButtons.push({
                                id: `btn-${kelas}`,
                                text: `PILIH ${kelas.toUpperCase().replace('KELAS', 'KELAS ')}`,
                                class: `welcome-button btn-${kelas}`,
                                action: () => handleCustomButtonClassClick(kelas, publicSettings[kelas].url)
                            });
                        }
                    });

                    // Cek Susulan
                    if (publicSettings.susulan && publicSettings.susulan.enabled && publicSettings.susulan.list && Object.keys(publicSettings.susulan.list).length > 0) {
                        activeButtons.push({
                            id: `btn-susulan`,
                            text: `UJIAN SUSULAN`,
                            class: `welcome-button btn-susulan`,
                            action: showSusulanListModal
                        });
                    }

                    if (activeButtons.length > 0) {
                        activeButtons.forEach(buttonInfo => {
                            const button = document.createElement('button');
                            button.id = buttonInfo.id;
                            button.className = buttonInfo.class;
                            button.textContent = buttonInfo.text;
                            button.addEventListener('click', buttonInfo.action);
                            welcomeButtonsContainer.appendChild(button);
                        });
                        welcomeTitle.textContent = 'SELAMAT DATANG';
                        welcomeMessageElement.textContent = 'Silakan pilih jenjang kelas Anda untuk melanjutkan ke halaman ujian:';
                    } else {
                        // Tidak ada tombol kustom yang aktif, tampilkan tombol default
                        welcomeTitle.textContent = 'SELAMAT DATANG';
                        welcomeMessageElement.textContent = 'Silakan pilih jenjang kelas Anda untuk melanjutkan ke halaman ujian:';
                        
                        const btnKelas7 = document.createElement('button');
                        btnKelas7.id = 'btnKelas7';
                        btnKelas7.className = 'welcome-button btn-kelas7';
                        btnKelas7.textContent = 'KELAS 7';
                        btnKelas7.addEventListener('click', () => selectGrade(7));
                        welcomeButtonsContainer.appendChild(btnKelas7);

                        const btnKelas8 = document.createElement('button');
                        btnKelas8.id = 'btnKelas8';
                        btnKelas8.className = 'welcome-button btn-kelas8';
                        btnKelas8.textContent = 'KELAS 8';
                        btnKelas8.addEventListener('click', () => selectGrade(8));
                        welcomeButtonsContainer.appendChild(btnKelas8);

                        const btnKelas9 = document.createElement('button');
                        btnKelas9.id = 'btnKelas9';
                        btnKelas9.className = 'welcome-button btn-kelas9';
                        btnKelas9.textContent = 'KELAS 9';
                        btnKelas9.addEventListener('click', () => selectGrade(9));
                        welcomeButtonsContainer.appendChild(btnKelas9);
                    }
                } else {
                    console.warn("Node publicSettings tidak ditemukan di Firebase. Menampilkan tombol default.");
                    // Tampilkan tombol default jika publicSettings tidak ada
                    welcomeTitle.textContent = 'SELAMAT DATANG';
                    welcomeMessageElement.textContent = 'Silakan pilih jenjang kelas Anda untuk melanjutkan ke halaman ujian:';
                    
                    const btnKelas7 = document.createElement('button');
                    btnKelas7.id = 'btnKelas7';
                    btnKelas7.className = 'welcome-button btn-kelas7';
                    btnKelas7.textContent = 'KELAS 7';
                    btnKelas7.addEventListener('click', () => selectGrade(7));
                    welcomeButtonsContainer.appendChild(btnKelas7);

                    const btnKelas8 = document.createElement('button');
                    btnKelas8.id = 'btnKelas8';
                    btnKelas8.className = 'welcome-button btn-kelas8';
                    btnKelas8.textContent = 'KELAS 8';
                    btnKelas8.addEventListener('click', () => selectGrade(8));
                    welcomeButtonsContainer.appendChild(btnKelas8);

                    const btnKelas9 = document.createElement('button');
                    btnKelas9.id = 'btnKelas9';
                    btnKelas9.className = 'welcome-button btn-kelas9';
                    btnKelas9.textContent = 'KELAS 9';
                    btnKelas9.addEventListener('click', () => selectGrade(9));
                    welcomeButtonsContainer.appendChild(btnKelas9);
                }
            } catch (error) {
                console.error("Gagal memuat konfigurasi tombol dari Firebase:", error);
                welcomeMessageElement.textContent = 'Gagal memuat konfigurasi. Silakan refresh halaman.';
                // Tampilkan tombol default sebagai fallback jika terjadi error
                welcomeTitle.textContent = 'SELAMAT DATANG';
                welcomeMessageElement.textContent = 'Silakan pilih jenjang kelas Anda untuk melanjutkan ke halaman ujian:';
                
                const btnKelas7 = document.createElement('button');
                btnKelas7.id = 'btnKelas7';
                btnKelas7.className = 'welcome-button btn-kelas7';
                btnKelas7.textContent = 'KELAS 7';
                btnKelas7.addEventListener('click', () => selectGrade(7));
                welcomeButtonsContainer.appendChild(btnKelas7);

                const btnKelas8 = document.createElement('button');
                btnKelas8.id = 'btnKelas8';
                btnKelas8.className = 'welcome-button btn-kelas8';
                btnKelas8.textContent = 'KELAS 8';
                btnKelas8.addEventListener('click', () => selectGrade(8));
                welcomeButtonsContainer.appendChild(btnKelas8);

                const btnKelas9 = document.createElement('button');
                btnKelas9.id = 'btnKelas9';
                btnKelas9.className = 'welcome-button btn-kelas9';
                btnKelas9.textContent = 'KELAS 9';
                btnKelas9.addEventListener('click', () => selectGrade(9));
                welcomeButtonsContainer.appendChild(btnKelas9);
            }
        }

        // Fungsi handler untuk tombol Kelas 7, 8, 9 yang kustom
        function handleCustomButtonClassClick(kelas, url) {
            // console.log(`Mengklik tombol kustom untuk ${kelas}, URL: ${url}`); // Dihapus
            if (url) {
                // Arahkan langsung ke URL ujian (misal Google Form)
                // Ini akan keluar dari aplikasi ujian ini.
                window.location.href = url;
            } else {
                window.showCustomMessageModal("URL Tidak Ditemukan", `URL untuk ${kelas.toUpperCase()} tidak ditemukan. Harap hubungi administrator.`, 'error');
            }
        }

        // Fungsi untuk menampilkan modal ujian susulan
        function showSusulanListModal() {
            const susulanModalList = document.getElementById('susulanModalList');
            susulanModalList.innerHTML = ''; // Bersihkan daftar yang ada

            if (publicSettings && publicSettings.susulan && publicSettings.susulan.list) {
                const susulanItems = Object.values(publicSettings.susulan.list);
                // Urutkan berdasarkan nama ujian
                susulanItems.sort((a, b) => a.name.localeCompare(b.name)); 

                susulanItems.forEach(item => {
                    const listItem = document.createElement('li');
                    // Hanya menyertakan nama ujian, bukan URL
                    listItem.innerHTML = `<span class="item-name">${item.name}</span>`;
                    listItem.addEventListener('click', () => {
                        if (item.url) {
                            window.open(item.url, '_blank'); // Buka di tab baru
                            window.closeSusulanListModal();
                        } else {
                            window.showCustomMessageModal("URL Tidak Ditemukan", `URL untuk ${item.name} tidak ditemukan.`, 'error');
                        }
                    });
                    susulanModalList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = 'Tidak ada ujian susulan yang tersedia saat ini.';
                susulanModalList.appendChild(listItem);
            }

            susulanListModal.classList.add('show');
            isAnyModalOpen = true; // Tandai bahwa modal terbuka
        }

        // Fungsi untuk menutup modal ujian susulan
        window.closeSusulanListModal = function() { // Buat ini global agar bisa diakses dari onclick
            susulanListModal.classList.remove('show');
            isAnyModalOpen = false;
        }


        async function selectGrade(grade) {
            currentSelectedGrade = grade;
            welcomeScreen.style.opacity = 0;
            setTimeout(() => {
                welcomeScreen.style.display = 'none';
                loginContainer.style.display = 'block';
                loginContainer.classList.add('show');
                document.body.style.overflow = '';
            }, 500);

            // Setel variabel CSS dinamis berdasarkan tema kelas yang dipilih
            const gradeConfig = allFirebaseConfigs[`kelas${grade}-group1`]; // Asumsikan grup pertama memiliki informasi tema
            if (gradeConfig && gradeConfig.theme) {
                document.documentElement.style.setProperty('--primary-color', gradeConfig.theme.primary);
                document.documentElement.style.setProperty('--accent-color', gradeConfig.theme.accent);
                document.documentElement.style.setProperty('--warning-color', gradeConfig.theme.warning);

                // Juga perbarui gaya elemen tertentu
                document.querySelector('.header-box').style.backgroundColor = gradeConfig.theme.primary;
                document.querySelector('.judul-ujian').style.color = gradeConfig.theme.warning; // Warna Judul ujian
                document.querySelector('#loginBtn').style.backgroundColor = gradeConfig.theme.accent;
                document.querySelector('#loginBtn').onmouseover = () => document.querySelector('#loginBtn').style.backgroundColor = gradeConfig.theme.primary; // Warna hover
                document.querySelector('#loginBtn').onmouseout = () => document.querySelector('#loginBtn').style.backgroundColor = gradeConfig.theme.accent; // Pulihkan saat mouseout

                document.querySelector('#countdownDisplay').style.backgroundColor = gradeConfig.theme.primary;
                document.querySelector('#customMessageModalButton').style.backgroundColor = gradeConfig.theme.accent;
                document.querySelector('#customConfirmModalConfirmBtn').style.backgroundColor = gradeConfig.theme.accent;
                
                // Perbarui event listener untuk tombol kontrol zoom secara dinamis
                const zoomButtons = document.querySelectorAll('#zoomControls button');
                zoomButtons.forEach(btn => {
                    btn.style.backgroundColor = gradeConfig.theme.accent;
                    btn.onmouseover = (e) => e.target.style.backgroundColor = gradeConfig.theme.primary;
                    btn.onmouseout = (e) => e.target.style.backgroundColor = gradeConfig.theme.accent;
                });

                // Latar belakang overlay layar penuh
                document.querySelector('#fullscreenOverlay .overlay-content').style.background = `linear-gradient(135deg, ${gradeConfig.theme.primary} 0%, ${gradeConfig.theme.primary} 100%)`;
                
                document.querySelector('.custom-modal-content h4').style.color = gradeConfig.theme.primary;
                document.querySelector('#confirmModal .modal-content h4').style.color = gradeConfig.theme.primary;
                document.querySelector('#answerSelectionModal h4').style.color = gradeConfig.theme.primary;
                document.querySelector('#submitAnswersButton').style.backgroundColor = gradeConfig.theme.accent;
                document.querySelector('#submitAnswersButton').onmouseover = () => document.querySelector('#submitAnswersButton').style.backgroundColor = gradeConfig.theme.primary;
                document.querySelector('#submitAnswersButton').onmouseout = () => document.querySelector('#submitAnswersButton').style.backgroundColor = gradeConfig.theme.accent;

                const exitWarningButtons = document.querySelectorAll('.exit-warning-button');
                exitWarningButtons.forEach(btn => {
                    btn.style.backgroundColor = gradeConfig.theme.accent;
                    btn.onmouseover = () => btn.style.backgroundColor = gradeConfig.theme.primary;
                    btn.onmouseout = () => btn.style.backgroundColor = gradeConfig.theme.accent;
                });
            }

            loginJudulUjian.textContent = `UJIAN KELAS ${grade}`;
            classModalTitle.textContent = `Pilih Kelas ${grade}`;

            currentClassGroupKeys = getClassGroupKeysByGrade(grade);

            if (currentClassGroupKeys.length > 0) {
                await loadSettingsAndStudents(currentClassGroupKeys[0]);
            } else {
                console.error(`Tidak ada konfigurasi Firebase ditemukan untuk kelas ${grade}.`);
                message.style.color = "red";
                message.textContent = `Tidak ada konfigurasi Firebase ditemukan untuk kelas ${grade}. Hubungi administrator.`;
            }

            loadClassDropdownForGrade(grade);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Sembunyikan semua kecuali spinner loading segera
            welcomeScreen.style.display = 'none';
            loginContainer.style.display = 'none';
            examContainer.style.display = 'none';
            initialLoginScreen.style.display = 'none'; /* Pastikan login awal tersembunyi */
            loadingSpinner.style.display = 'flex'; /* Tampilkan spinner */
            loadingSpinner.style.opacity = 1;

            // Fungsi untuk melakukan login otomatis
            const performAutomaticLogin = async () => {
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;
                
                loginButton.disabled = true;
                loginButton.textContent = 'Memuat...'; // Teks tombol saat proses login

                try {
                    // Pastikan initialLoginAuth sudah siap
                    if (!initialLoginAuth) {
                        console.error("initialLoginAuth belum diinisialisasi.");
                        throw new Error('Firebase Auth belum siap.');
                    }

                    await signInWithEmailAndPassword(initialLoginAuth, email, password);
                    // console.log('Login email/password berhasil!'); // Dihapus
                    
                    // Store the credentials globally after successful initial login
                    globalUserEmail = email;
                    globalUserPassword = password;

                    // Sembunyikan spinner setelah login berhasil
                    loadingSpinner.style.opacity = 0;
                    setTimeout(async () => {
                        loadingSpinner.style.display = 'none';
                        // Inisialisasi Firebase untuk konfigurasi tombol kustom dan muat tombol setelah login berhasil
                        await initializeButtonConfigFirebase();
                        await loadAndRenderWelcomeButtons();
                        welcomeScreen.style.display = 'flex';
                        welcomeScreen.style.opacity = 1;
                        document.body.style.overflow = '';
                    }, 500);

                } catch (error) {
                    console.error("Login gagal:", error.message);
                    let errorMessage = "Login gagal. Periksa kembali email dan password Anda.";
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = "Email atau password salah.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Format email tidak valid.";
                    } else {
                        errorMessage = `Terjadi kesalahan: ${error.message}`;
                    }
                    
                    // Jika login gagal, sembunyikan spinner dan tampilkan layar login awal dengan pesan error
                    loadingSpinner.style.opacity = 0;
                    setTimeout(() => {
                        loadingSpinner.style.display = 'none';
                        initialLoginScreen.style.display = 'flex';
                        initialLoginScreen.style.opacity = 1;
                        loginMessage.style.color = 'red';
                        loginMessage.textContent = errorMessage;
                        loginButton.disabled = false;
                        loginButton.textContent = 'Login';
                    }, 500);
                }
            };

            // Set nilai input (meskipun layar tersembunyi)
            loginEmailInput.value = "siswa@gmail.com";
            loginPasswordInput.value = "12345678";

            // Tambahkan event listener ke tombol login (jika pengguna mengklik secara manual)
            loginButton.addEventListener('click', performAutomaticLogin);

            // Panggil fungsi login otomatis secara langsung
            // Menggunakan setTimeout 0 untuk memastikan event loop memproses pendaftaran event listener terlebih dahulu
            setTimeout(performAutomaticLogin, 0);


            customSelectKelasDisplay.addEventListener('click', openClassModal);
            customSelectNamaSiswaDisplay.addEventListener('click', openStudentModal);


            classModal.addEventListener('click', (event) => {
                if (event.target === classModal) {
                    closeClassModal();
                }
            });
            studentModal.addEventListener('click', (event) => {
                if (event.target === studentModal) {
                    closeStudentModal();
                }
            });

            inputTokenPrefix.addEventListener('input', () => window.formatTokenPrefix(inputTokenPrefix));
            inputTokenPrefix.addEventListener('input', updateLoginButtonStatus);

            inputTokenPrefix.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !loginBtn.disabled) {
                    event.preventDefault();
                    window.cekToken();
                }
            });

            loginBtn.addEventListener('click', window.cekToken);

            overlayUnderstandBtn.addEventListener('click', hideOverlay);
            
            backToLoginFromSubmissionBtn.addEventListener('click', async () => {
                submissionConfirmationOverlay.style.opacity = 0;
                setTimeout(async () => {
                    submissionConfirmationOverlay.style.display = 'none';
                    // Kembali ke layar login email/password
                    initialLoginScreen.style.display = 'flex';
                    initialLoginScreen.style.opacity = 1;
                    welcomeScreen.style.display = 'none';
                    loginContainer.style.display = 'none';
                    examContainer.style.display = 'none';
                    document.body.style.overflow = '';
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                    isInExamMode = false;
                    toggleExamSecurityFeatures(false);
                    message.textContent = '';

                    // Logout dari semua sesi Firebase jika diperlukan
                    if (initialLoginAuth.currentUser) {
                        await signOut(initialLoginAuth);
                        // console.log("Logout dari otentikasi email/password awal berhasil."); // Dihapus
                    }
                    // buttonConfigAuth sekarang merujuk ke initialLoginAuth, jadi tidak perlu logout terpisah di sini.

                    // Logout dari semua instance Firebase spesifik kelas
                    for (const key in firebaseAuths) {
                        const authInstance = firebaseAuths[key];
                        if (authInstance.currentUser) {
                            try {
                                await signOut(authInstance);
                                // console.log(`Logout dari otentikasi kelas ${key} berhasil.`); // Dihapus
                            } catch (e) {
                                console.warn(`Gagal logout dari otentikasi kelas ${key}:`, e);
                            }
                        }
                    }

                    // Clear global credentials
                    globalUserEmail = '';
                    globalUserPassword = '';

                    const tokenFirebaseKey = foundTokenGlobal?.key;
                    const studentId = selectedStudentData?.id ? padStudentId(selectedStudentData.id) : null;
                    const studentFirebaseKey = selectedStudentData?.key;
                    const dbRefs = getDbRefs();

                    if (dbRefs && tokenFirebaseKey && studentId && studentFirebaseKey) {
                        const accessStatusRef = child(dbRefs.examAccessStatusRef, `${tokenFirebaseKey}/${studentId}`);
                        await update(accessStatusRef, {
                            isLoggedIn: false,
                            studentId: studentId,
                            attemptsLeft: toleranceLimitGlobal
                        });
                        // console.log(`Status exam_access_status siswa ${studentId} diperbarui (isLoggedIn: false, attemptsLeft direset) saat kembali ke login.`); // Dihapus

                        const studentIsLoggedInRef = child(dbRefs.studentsRef, `${studentFirebaseKey}/isLoggedIn`);
                        await set(studentIsLoggedInRef, false);
                        // console.log(`Status isLoggedIn siswa ${selectedStudentData.id} di node siswa diatur ke false saat kembali ke login.`); // Dihapus
                    }

                    // Reset warna tema ke default (misal, untuk Kelas 7)
                    document.documentElement.style.setProperty('--primary-color', '#0066cc');
                    document.documentElement.style.setProperty('--accent-color', '#007bff');
                    document.documentElement.style.setProperty('--warning-color', '#0066cc');

                    document.querySelector('.header-box').style.backgroundColor = '#0066cc';
                    document.querySelector('.judul-ujian').style.color = '#0066cc'; // Reset ke warna primer tema default
                    document.querySelector('#loginBtn').style.backgroundColor = '#007bff';
                    document.querySelector('#loginBtn').onmouseover = null; // Hapus hover dinamis
                    document.querySelector('#loginBtn').onmouseout = null; // Hapus mouseout dinamis

                    document.querySelector('#countdownDisplay').style.backgroundColor = '#0066cc';
                    document.querySelector('#customMessageModalButton').style.backgroundColor = '#007bff';
                    document.querySelector('#customConfirmModalConfirmBtn').style.backgroundColor = '#007bff';
                    
                    // Reset event listener tombol kontrol zoom
                    const zoomButtons = document.querySelectorAll('#zoomControls button');
                    zoomButtons.forEach(btn => {
                        btn.style.backgroundColor = '#007bff'; // Aksen default
                        btn.onmouseover = null;
                        btn.onmouseout = null;
                    });
                    
                    document.querySelector('#fullscreenOverlay .overlay-content').style.background = `linear-gradient(135deg, #007bff 0%, #0056b3 100%)`; // Reset ke default

                    document.querySelector('.custom-modal-content h4').style.color = '#0066cc';
                    document.querySelector('#confirmModal .modal-content h4').style.color = '#0066cc';
                    document.querySelector('#answerSelectionModal h4').style.color = '#0066cc';
                    document.querySelector('#submitAnswersButton').style.backgroundColor = '#007bff';
                    document.querySelector('#submitAnswersButton').onmouseover = null;
                    document.querySelector('#submitAnswersButton').onmouseout = null;

                    const exitWarningButtons = document.querySelectorAll('.exit-warning-button');
                    exitWarningButtons.forEach(btn => {
                        btn.style.backgroundColor = '#007bff';
                        btn.onmouseover = null;
                        btn.onmouseout = null;
                    });


                    hiddenSelectKelas.value = '';
                    customSelectKelasDisplay.textContent = customSelectKelasDisplay.dataset.placeholder;
                    customSelectKelasDisplay.classList.remove('selected');
                    customSelectKelasDisplay.classList.remove('disabled');

                    hiddenSelectNamaSiswa.value = '';
                    customSelectNamaSiswaDisplay.textContent = customSelectNamaSiswaDisplay.dataset.placeholder;
                    customSelectNamaSiswaDisplay.classList.remove('selected');
                    customSelectNamaSiswaDisplay.classList.add('disabled');
                    selectedStudentData = null;

                    inputTokenPrefix.value = '';
                    inputTokenPrefix.disabled = true;
                    const tokenInputGroup = inputTokenPrefix.closest('.token-input-group');
                    if (tokenInputGroup) {
                        tokenInputGroup.classList.remove('is-valid', 'is-invalid');
                    }

                    displayStudentId.value = '';

                    locationBlockedDiv.style.display = 'none';
                    locationStatus.style.display = 'block';
                    locationStatus.textContent = 'Memuat status lokasi...';
                    isLocationValid = false;

                    getLocation();

                    updateLoginButtonStatus();
                    sessionStorage.clear();
                    isAnyModalOpen = false;
                    currentDb = null;
                    currentAuth = null; // Reset currentAuth
                    currentSelectedGrade = null;
                    currentClassGroupKeys = [];

                }, 300);
            });

            window.onpopstate = function(event) {
                if (isInExamMode) {
                    history.pushState(null, '', location.href);
                    // console.log("Navigasi kembali dicegah selama ujian."); // Dihapus
                }
            };

            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('msfullscreenchange', handleFullscreenChange);

            reEnterFullscreenBtn.addEventListener('click', attemptFullscreen);

            lockKeySubmitBtn.addEventListener('click', async () => {
                const enteredKey = lockKeyInput.value;
                lockKeyMessage.textContent = '';

                if (enteredKey === lockKeyGlobal) {
                    currentAttemptsLeft = toleranceLimitGlobal;
                    sessionStorage.setItem('attemptsLeft', currentAttemptsLeft);
                    
                    const dbRefs = getDbRefs();
                    if (dbRefs && foundTokenGlobal && selectedStudentData) {
                        const studentId = padStudentId(selectedStudentData.id);
                        const accessStatusRef = child(dbRefs.examAccessStatusRef, `${foundTokenGlobal.key}/${studentId}`);
                        try {
                            await update(accessStatusRef, { attemptsLeft: currentAttemptsLeft, studentId: studentId });
                            // console.log("attemptsLeft direset di Firebase setelah entri kunci yang berhasil."); // Dihapus
                        } catch (error) {
                            console.error("Gagal mereset attemptsLeft di Firebase:", error);
                        }
                    }

                    lockKeySection.style.display = 'none';
                    attemptsLeftInfo.style.display = 'none';
                    reEnterFullscreenBtn.style.display = 'block';
                    lockKeyInput.value = '';
                    lockKeyMessage.textContent = '';

                    attemptFullscreen();
                } else {
                    lockKeyMessage.style.color = 'red';
                    lockKeyMessage.textContent = 'Kunci salah. Silakan coba lagi.';
                    lockKeyInput.value = '';
                    lockKeyInput.focus();
                }
            });
            lockKeyInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    lockKeySubmitBtn.click();
                }
            });

            sidebarToggle.addEventListener('click', toggleSidebar);
            closeSidebarButton.addEventListener('click', toggleSidebar);
            document.addEventListener('click', closeSidebarOnClickOutside);

            answerSelectionModal.addEventListener('click', (event) => {
                if (event.target === answerSelectionModal) {
                    closeAnswerSelectionModal();
                }
            });

            answerOptionsContainer.addEventListener('click', (event) => {
                event.stopPropagation();
            });

            answerOptionsContainer.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', () => selectAnswer(button.dataset.answer));
            });
            clearAnswerButton.addEventListener('click', clearAnswer);
            submitAnswersButton.addEventListener('click', () => submitAnswers(false));

            examIframe.addEventListener('wheel', (event) => {
                if (event.ctrlKey) {
                    event.preventDefault();
                    resetAutoHideTimer();
                    
                    if (event.deltaY < 0) {
                        currentZoom += ZOOM_STEP;
                    } else {
                        currentZoom -= ZOOM_STEP;
                    }

                    currentZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, currentZoom));

                    if (currentZoom <= MIN_ZOOM) {
                        currentZoom = MIN_ZOOM;
                        currentTranslateX = 0;
                        currentTranslateY = 0;
                    }
                    applyIframeTransform();
                    updateZoomButtonStates();
                }
            }, { passive: false });

            zoomInBtn.addEventListener('click', () => {
                resetAutoHideTimer();
                currentZoom += ZOOM_STEP;
                currentZoom = Math.min(MAX_ZOOM, currentZoom);
                currentTranslateX = 0;
                currentTranslateY = 0;
                applyIframeTransform();
                updateZoomButtonStates();
            });

            zoomOutBtn.addEventListener('click', () => {
                resetAutoHideTimer();
                currentZoom -= ZOOM_STEP;
                currentZoom = Math.max(MIN_ZOOM, currentZoom);
                if (currentZoom <= MIN_ZOOM) {
                    currentZoom = MIN_ZOOM;
                    currentTranslateX = 0;
                    currentTranslateY = 0;
                }
                applyIframeTransform();
                updateZoomButtonStates();
            });

            panLeftBtn.addEventListener('mousedown', (e) => {
                if (e.button === 0) {
                    resetAutoHideTimer();
                    if (currentZoom > MIN_ZOOM) {
                        if (panPressTimer) clearTimeout(panPressTimer);
                        panPressTimer = setTimeout(() => {
                            panDirection = PAN_STEP;
                            startAutoPan();
                        }, PAN_START_DELAY);
                    }
                }
            });
            panLeftBtn.addEventListener('click', () => {
                if (currentZoom > MIN_ZOOM && panIntervalId === null) {
                    currentTranslateX += PAN_STEP;
                    const unscaledIframeWidth = examIframe.offsetWidth;
                    const scaledIframeWidth = unscaledIframeWidth * currentZoom;
                    const containerWidth = examContentWrapper.offsetWidth;
                    const maxNegativeX = -(Math.max(0, scaledIframeWidth - containerWidth));
                    currentTranslateX = Math.max(maxNegativeX, Math.min(0, currentTranslateX));
                    applyIframeTransform();
                    resetAutoHideTimer();
                }
            });
            panLeftBtn.addEventListener('mouseup', () => {
                stopAutoPan();
                if (panPressTimer) clearTimeout(panPressTimer);
            });
            panLeftBtn.addEventListener('mouseleave', () => {
                stopAutoPan();
                if (panPressTimer) clearTimeout(panPressTimer);
            });
            panLeftBtn.addEventListener('touchstart', (e) => {
                resetAutoHideTimer();
                if (currentZoom > MIN_ZOOM && e.touches.length === 1) {
                    if (panPressTimer) clearTimeout(panPressTimer);
                    panPressTimer = setTimeout(() => {
                        panDirection = PAN_STEP;
                        startAutoPan();
                    }, PAN_START_DELAY);
                }
            }, { passive: true });
            panLeftBtn.addEventListener('touchend', () => {
                stopAutoPan();
                if (panPressTimer) clearTimeout(panPressTimer);
            });

            panRightBtn.addEventListener('mousedown', (e) => {
                if (e.button === 0) {
                    resetAutoHideTimer();
                    if (currentZoom > MIN_ZOOM) {
                        if (panPressTimer) clearTimeout(panPressTimer);
                        panPressTimer = setTimeout(() => {
                            panDirection = -PAN_STEP;
                            startAutoPan();
                        }, PAN_START_DELAY);
                    }
                }
            });
            panRightBtn.addEventListener('click', () => {
                if (currentZoom > MIN_ZOOM && panIntervalId === null) {
                    currentTranslateX -= PAN_STEP;
                    const unscaledIframeWidth = examIframe.offsetWidth;
                    const scaledIframeWidth = unscaledIframeWidth * currentZoom;
                    const containerWidth = examContentWrapper.offsetWidth;
                    const maxNegativeX = -(Math.max(0, scaledIframeWidth - containerWidth));
                    currentTranslateX = Math.max(maxNegativeX, Math.min(0, currentTranslateX));
                    applyIframeTransform();
                    resetAutoHideTimer();
                }
            });
            panRightBtn.addEventListener('mouseup', () => {
                stopAutoPan();
                if (panPressTimer) clearTimeout(panPressTimer);
            });
            panRightBtn.addEventListener('mouseleave', () => {
                stopAutoPan();
                if (panPressTimer) clearTimeout(panPressTimer);
            });
            panRightBtn.addEventListener('touchstart', (e) => {
                resetAutoHideTimer();
                if (currentZoom > MIN_ZOOM && e.touches.length === 1) {
                    if (panPressTimer) clearTimeout(panPressTimer);
                    panPressTimer = setTimeout(() => {
                        panDirection = -PAN_STEP;
                        startAutoPan();
                    }, PAN_START_DELAY);
                }
            }, { passive: true });
            panRightBtn.addEventListener('touchend', () => {
                stopAutoPan();
                if (panPressTimer) clearTimeout(panPressTimer);
            });

            refreshIframeBtn.addEventListener('click', () => {
                resetAutoHideTimer();
                const currentIframeSrc = examIframe.src;
                // console.log("Tombol refresh diklik. Src iframe saat ini:", examIframe.src); // Dihapus
                // console.log("globalExamUrl yang tersimpan:", globalExamUrl); // Dihapus
                examIframe.src = '';
                setTimeout(() => {
                    examIframe.src = currentIframeSrc;
                    // console.log("Iframe di-refresh dengan mereset src."); // Dihapus
                }, 50);
            });

            examIframe.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                resetAutoHideTimer();
                if (currentZoom > MIN_ZOOM) {
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    const translate = getTranslateValues(examIframe);
                    currentTranslateX = translate.x;
                    currentTranslateY = translate.y;
                    examIframe.classList.add('dragging');
                    // console.log(`Pan Mulai (Mouse): translateX awal=${currentTranslateX}, translateY awal=${currentTranslateY}`); // Dihapus
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();

                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                let newTranslateX = currentTranslateX + dx;
                let newTranslateY = currentTranslateY + dy;

                const unscaledIframeWidth = examIframe.offsetWidth;
                const unscaledIframeHeight = examIframe.offsetHeight;

                const scaledIframeWidth = unscaledIframeWidth * currentZoom;
                const scaledIframeHeight = unscaledIframeHeight * currentZoom;

                const containerWidth = examContentWrapper.offsetWidth;
                const containerHeight = examContentWrapper.offsetHeight;

                const maxNegativeX = -(Math.max(0, scaledIframeWidth - containerWidth));
                const maxNegativeY = -(Math.max(0, scaledIframeHeight - containerHeight));

                newTranslateX = Math.max(maxNegativeX, Math.min(0, newTranslateX));
                newTranslateY = Math.max(maxNegativeY, Math.min(0, newTranslateY));

                examIframe.style.transform = `translate(${newTranslateX}px, ${newTranslateY}px) scale(${currentZoom})`;
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    const translate = getTranslateValues(examIframe);
                    currentTranslateX = translate.x;
                    currentTranslateY = translate.y;
                    examIframe.classList.remove('dragging');
                    // console.log(`Pan Selesai (Mouse): translateX akhir=${currentTranslateX}, translateY akhir=${currentTranslateY}`); // Dihapus
                }
            });

            examIframe.addEventListener('touchstart', (e) => {
                e.stopPropagation();
                resetAutoHideTimer();
                if (currentZoom > MIN_ZOOM && e.touches.length === 1) {
                    isDragging = true;
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    const translate = getTranslateValues(examIframe);
                    currentTranslateX = translate.x;
                    currentTranslateY = translate.y;
                    examIframe.classList.add('dragging');
                    // console.log(`Pan Mulai (Sentuh): translateX awal=${currentTranslateX}, translateY awal=${currentTranslateY}`); // Dihapus
                }
            });

            document.addEventListener('touchmove', (e) => {
                if (!isDragging || e.touches.length !== 1) return;
                e.preventDefault();

                const dx = e.touches[0].clientX - startX;
                const dy = e.touches[0].clientY - startY;

                let newTranslateX = currentTranslateX + dx;
                let newTranslateY = currentTranslateY + dy;

                const unscaledIframeWidth = examIframe.offsetWidth;
                const unscaledIframeHeight = examIframe.offsetHeight;

                const scaledIframeWidth = unscaledIframeWidth * currentZoom;
                const scaledIframeHeight = unscaledIframeHeight * currentZoom;

                const containerWidth = examContentWrapper.offsetWidth;
                const containerHeight = examContentWrapper.offsetHeight;

                const maxNegativeX = -(Math.max(0, scaledIframeWidth - containerWidth));
                const maxNegativeY = -(Math.max(0, scaledIframeHeight - containerHeight));

                newTranslateX = Math.max(maxNegativeX, Math.min(0, newTranslateX));
                newTranslateY = Math.max(maxNegativeY, Math.min(0, newTranslateY));

                examIframe.style.transform = `translate(${newTranslateX}px, ${newTranslateY}px) scale(${currentZoom})`;
            });

            document.addEventListener('touchend', () => {
                if (isDragging) {
                    isDragging = false;
                    const translate = getTranslateValues(examIframe);
                    currentTranslateX = translate.x;
                    currentTranslateY = translate.y;
                    examIframe.classList.remove('dragging');
                    // console.log(`Pan Selesai (Sentuh): translateX akhir=${currentTranslateX}, translateY akhir=${currentTranslateY}`); // Dihapus
                }
            });

            zoomControls.addEventListener('mousemove', resetAutoHideTimer);
            zoomControls.addEventListener('touchstart', resetAutoHideTimer);
            zoomControls.addEventListener('click', resetAutoHideTimer);

            applyIframeTransform();
            updateZoomButtonStates();
            resetAutoHideTimer();

            toggleControlsBtn.addEventListener('click', toggleControlsPanel);

            updateDateTime();
            setInterval(updateDateTime, 1000);

            // Coba pulihkan sesi ujian jika ada
            await restoreExamState();
        });

        async function loadSettingsAndStudents(initialGroupKey) {
            locationStatus.style.display = 'block';
            locationStatus.textContent = 'Memuat status lokasi dan data siswa...';

            const initialDbInstance = await getFirebaseInstanceForClass(allFirebaseConfigs[initialGroupKey].allowedClasses[0]);
            if (!initialDbInstance || !initialDbInstance.db) {
                console.error("Gagal menginisialisasi database awal untuk pengaturan lokasi.");
                locationStatus.style.color = "red";
                locationStatus.textContent = "Gagal menginisialisasi database awal.";
                return;
            }
            const db = initialDbInstance.db;

            try {
                const settingsSnapshot = await get(ref(db, 'setlokasi'));
                if (settingsSnapshot.exists()) {
                    const settings = settingsSnapshot.val();
                    isLocationEnabled = settings.isLocationEnabled !== undefined ? settings.isLocationEnabled : true;
                    firebaseAllowedRadiusKm = settings.allowedRadiusKm !== undefined ? settings.allowedRadiusKm : 0.075;
                    // console.log("Status Lokasi dari Firebase:", isLocationEnabled); // Dihapus
                    // console.log("Radius dari Firebase:", firebaseAllowedRadiusKm); // Dihapus
                } else {
                    console.warn("Tidak dapat mengambil pengaturan lokasi dari Firebase, menggunakan default.");
                }

                const lockSettingsSnapshot = await get(ref(db, 'lock_settings'));
                if (lockSettingsSnapshot.exists()) {
                    const lockSettings = lockSettingsSnapshot.val();
                    isLockEnabledGlobal = lockSettings.isLockEnabled !== undefined ? lockSettings.isLockEnabled : false;
                    lockKeyGlobal = lockSettings.lockKey !== undefined ? lockSettings.lockKey : "";
                    toleranceLimitGlobal = lockSettings.toleranceLimit !== undefined ? lockSettings.toleranceLimit : 3;
                    // console.log("Pengaturan Kunci dari Firebase:", { isLockEnabledGlobal, lockKeyGlobal, toleranceLimitGlobal }); // Dihapus
                } else {
                    console.warn("Tidak dapat mengambil pengaturan kunci dari Firebase, menggunakan default.");
                }

            } catch (error) {
                console.error("Gagal mengambil pengaturan lokasi atau kunci dari Firebase:", error);
            }
            locationStatus.textContent = '';
            updateLoginButtonStatus();
            getLocation();
        }

        window.cekToken = async function() {
            const tokenPrefix = inputTokenPrefix.value.trim().toUpperCase();
            const studentId = displayStudentId.value.trim();
            const fullInputToken = `${tokenPrefix}-${studentId}`;

            const selectedClass = hiddenSelectKelas.value;
            const selectedStudentId = hiddenSelectNamaSiswa.value;

            if (!selectedClass || !selectedStudentId || tokenPrefix === "" || studentId === "") {
                message.style.color = "red";
                message.textContent = "Harap lengkapi semua pilihan (Kelas, Nama Siswa, dan Token).";
                updateLoginButtonStatus();
                return;
            }

            if (studentId !== padStudentId(selectedStudentId)) {
                message.style.color = "red";
                message.textContent = "ID Siswa tidak cocok dengan nama siswa yang dipilih.";
                updateLoginButtonStatus();
                return;
            }
            
            const tokenInputGroup = inputTokenPrefix.closest('.token-input-group');
            if (tokenInputGroup) {
                tokenInputGroup.classList.remove('is-valid', 'is-invalid');
            }

            loginBtn.disabled = true;
            loginBtn.style.opacity = 0.6;
            message.style.color = "black";
            message.innerHTML = `Memproses data... <span class="spinner"></span>`;

            if (!currentDb) {
                message.style.color = "red";
                message.textContent = "Database belum diinisialisasi. Pilih kelas terlebih dahulu.";
                updateLoginButtonStatus();
                return;
            }
            const dbRefs = getDbRefs();
            if (!dbRefs) return;


            try {
                const tokensSnapshot = await get(dbRefs.tokensRef);
                let foundToken = null;

                tokensSnapshot.forEach(child => {
                    const data = child.val();
                    if (data.token.toUpperCase() === tokenPrefix) {
                        foundToken = { ...data, key: child.key };
                        return true;
                    }
                });

                if (!foundToken) {
                    message.style.color = "red";
                    message.textContent = "Token ujian yang Anda masukkan tidak ditemukan. Mohon periksa kembali token Anda.";
                    if (tokenInputGroup) tokenInputGroup.classList.add('is-invalid');
                    updateLoginButtonStatus();
                    return;
                }

                foundTokenGlobal = foundToken;

                const hasSubmittedSnapshot = await get(child(dbRefs.submittedExamsRef, `${foundTokenGlobal.key}/${studentId}`));
                if (hasSubmittedSnapshot.exists() && hasSubmittedSnapshot.val().isSubmitted === true) {
                    message.style.color = "red";
                    message.textContent = "Anda sudah menyelesaikan ujian ini dan tidak dapat login kembali.";
                    updateLoginButtonStatus();
                    sessionStorage.clear();
                    return;
                }

                // console.log("cekToken: foundToken.answerKey is:", foundToken.answerKey); // Dihapus

                const now = new Date();
                const startTime = new Date(foundToken.startTime);
                const endTime = new Date(foundToken.endTime);
                let tokenStatus = '';

                if (foundToken.isForceActive === true) {
                    tokenStatus = 'valid';
                } else if (foundToken.isActive === true) {
                    if (now >= startTime && now <= endTime) {
                        tokenStatus = 'valid';
                    } else {
                        tokenStatus = 'expired';
                    }
                } else {
                    tokenStatus = 'inactive';
                }

                if (tokenStatus !== 'valid') {
                    message.style.color = "red";
                    if (tokenStatus === 'expired') {
                        message.textContent = "Token belum aktif atau sudah kadaluarsa.";
                    } else {
                        message.textContent = "Token saat ini tidak aktif.";
                    }
                    if (tokenInputGroup) tokenInputGroup.classList.add('is-invalid');
                    updateLoginButtonStatus();
                    return;
                }
                
                if (tokenInputGroup) tokenInputGroup.classList.add('is-valid');

                const studentClassNumericMatch = selectedStudentData.class.match(/^\d+/);
                const studentClassNumeric = studentClassNumericMatch ? studentClassNumericMatch[0] : null;

                if (!studentClassNumeric || String(studentClassNumeric) !== String(foundToken.kelas)) {
                    message.style.color = "red";
                    message.textContent = `Siswa dari kelas ${selectedStudentData.class} tidak dapat mengakses token untuk kelas ${foundToken.kelas}.`;
                    updateLoginButtonStatus();
                    return;
                }

                let examDurationMinutes = foundToken.durationMinutes;
                if (typeof examDurationMinutes !== 'number' || isNaN(examDurationMinutes) || examDurationMinutes <= 0) {
                    message.style.color = "red";
                    message.textContent = "Durasi ujian tidak valid. Harap hubungi administrator.";
                    updateLoginButtonStatus();
                    return;
                }
                
                const answerKeyArray = foundToken.answerKey ? foundToken.answerKey.split(',') : [];
                const numQuestions = answerKeyArray.length;
                // console.log("cekToken: Jumlah pertanyaan yang dihitung:", numQuestions); // Dihapus

                const accessStatusRef = child(dbRefs.examAccessStatusRef, `${foundTokenGlobal.key}/${studentId}`);
                const accessStatusSnapshot = await get(accessStatusRef);
                let loadedAnswers = Array(numQuestions).fill('');
                let examAccessData = accessStatusSnapshot.val();
                
                if (examAccessData && examAccessData.isLoggedIn === true) {
                    message.style.color = "red";
                    message.textContent = "Anda sudah Login di perangkat lain. Mohon hubungi admin untuk mereset akun Anda.";
                    updateLoginButtonStatus();
                    return;
                }
                else {
                    message.innerHTML = `Memuat jawaban siswa... <span class="spinner"></span>`;
                    const studentAnswersPath = child(dbRefs.studentAnswersRef, `${foundTokenGlobal.key}/${selectedStudentData.id}`);
                    const answersSnapshot = await get(studentAnswersPath);
                    if (answersSnapshot.exists()) {
                        const savedAnswersData = answersSnapshot.val();
                        loadedAnswers = savedAnswersData.answers ? savedAnswersData.answers.split(',') : Array(numQuestions).fill('');
                        // console.log("Jawaban siswa dimuat dari Firebase (login pertama):", loadedAnswers); // Dihapus
                    } else {
                        console.warn("Tidak ada jawaban yang disimpan di Firebase pada jalur ini, dimulai dengan array kosong.");
                    }

                    document.getElementById("modalIdSiswa").textContent = selectedStudentData.id || "-";
                    document.getElementById("modalNamaLengkap").textContent = selectedStudentData.name || "-";
                    document.getElementById("modalKelas").textContent = selectedClass || "-";
                    document.getElementById("modalMapel").textContent = foundToken.subject || "-";
                    modalExamDuration.textContent = `${examDurationMinutes} Menit`;

                    confirmCheckbox.checked = false;
                    modalMessage.style.display = 'none';
                    modalMessage.textContent = '';

                    confirmModal.classList.add('show');
                    isAnyModalOpen = true;
                    message.textContent = "";

                    document.getElementById("btnLanjut").onclick = () => handleLanjutClick(fullInputToken, examDurationMinutes, numQuestions, loadedAnswers);
                }

            } catch (err) {
                console.error("Error di cekToken:", err);
                message.style.color = "red";
                message.textContent = "Terjadi kesalahan saat memverifikasi token. Silakan coba lagi atau hubungi administrator.";
                if (tokenInputGroup) tokenInputGroup.classList.add('is-invalid');
                updateLoginButtonStatus();
            }
        };
    </script>
</body>
</html>
