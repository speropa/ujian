<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Panel Admin Ujian</title>
  <meta name="viewport" content="width=device-width, initial-scale=0.67" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    /* UPDATE: Hardening Layout untuk html dan body agar tahan terhadap Zoom Out */
    html, body {
      height: 100%; /* Paksa tinggi 100% */
      margin: 0;
      padding: 0;
      overflow: hidden; /* Mencegah scroll ganda pada body */
    }

      body {
      font-family: 'Inter', sans-serif;
      background-color: #f4f7f6;
      display: flex;
      width: 100%;
    }
    
    /* Sidebar disembunyikan secara default */
    .sidebar {
      width: 220px;
      background-color: #2c3e50;
      color: white;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      display: none; /* Disembunyikan, akan ditampilkan via JS setelah login */
      flex-direction: column;
      align-items: center;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      flex-shrink: 0;
      z-index: 20;
      box-sizing: border-box;
      transition: width 0.3s ease;
    }
    
    /* Konten utama */
    .main-content {
      flex-grow: 1;
      padding: 20px;
      background-color: #f4f7f6;
      display: flex;
      flex-direction: column;
      overflow-y: auto; /* Scroll hanya terjadi di sini */
      height: 100%; /* Mengikuti tinggi induk (body) */
      box-sizing: border-box;
      width: 100%;
      position: relative; /* Penting untuk konteks stacking */
    }
    
    /* Kontainer umum untuk bagian-bagian */
    .container {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      width: 100%;
      box-sizing: border-box;
    }
    /* Logo di sidebar */
    .sidebar .logo-container {
      text-align: center;
      margin-bottom: 30px;
      width: 100%;
    }
    .sidebar .logo {
      width: 60px; height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #3498db;
      padding: 3px;
      background-color: white;
    }
    .sidebar h2 {
      font-size: 0.9em;
      margin-top: 10px;
      color: #ecf0f1;
      white-space: nowrap;
      overflow: hidden;
    }
    /* Navigasi sidebar */
    .sidebar-nav { width: 100%; flex-grow: 1; }
    .sidebar-nav button {
      background-color: transparent;
      color: white; border: none; padding: 12px 20px;
      margin-bottom: 10px; width: 100%; text-align: left;
      font-size: 16px; border-radius: 8px; cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      display: flex; align-items: center; gap: 12px;
    }
    .sidebar-nav button i {
        font-size: 1.1em;
        width: 20px;
        text-align: center;
    }
    .sidebar-nav button .menu-text {
        transition: opacity 0.3s ease;
    }
    .sidebar-nav button:hover { background-color: #34495e; transform: translateX(5px); }
    .sidebar-nav button.active {
      background-color: #3498db; font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .flex-column-full {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0; /* Penting untuk nested flex scrolling */
    }

    /* Input field umum */
    input, select, textarea {
      padding: 12px; margin: 8px 0; width: 100%;
      box-sizing: border-box; font-size: 16px;
      border: 1px solid #ccc; border-radius: 6px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      outline: none;
    }
    /* Tombol umum */
    button {
      padding: 12px 25px; margin: 10px auto;
      display: block; font-size: 16px; cursor: pointer;
      background-color: #3498db; color: white; border: none;
      border-radius: 6px;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    button:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    /* Gaya tombol teks */
    .text-button {
      padding: 10px 20px; margin: 0; font-size: 15px;
      cursor: pointer; border: none; border-radius: 6px;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: inline-flex; align-items: center; gap: 8px;
      text-align: center; white-space: nowrap;
    }
    .text-button:hover { background-color: #455a64; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .text-button:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .text-button.blue-gray { background-color: #607d8b; color: white; }
    .text-button.blue-gray:hover { background-color: #455a64; }
    .text-button.green { background-color: #4CAF50; color: white; }
    .text-button.green:hover { background-color: #43A047; }
    .text-button.red { background-color: #f44336; color: white; }
    .text-button.red:hover { background-color: #e53935; }
    .text-button.gray { background-color: #9e9e9e; color: white; }
    .text-button.gray:hover { background-color: #757575; }
    .text-button.light-blue { background-color: #2196F3; color: white; }
    .text-button.light-blue:hover { background-color: #1976D2; }
    .text-button.orange { background-color: #FF9800; color: white; }
    .text-button.orange:hover { background-color: #FB8C00; }
    .text-button.purple { background-color: #9b59b6; color: white; }
    .text-button.purple:hover { background-color: #8e44ad; }

    /* Gaya tombol ikon */
    .icon-button {
      background: none; border: none; cursor: pointer;
      padding: 8px; margin: 0; display: inline-flex;
      align-items: center; justify-content: center;
      width: 28px; height: 28px; border-radius: 50%;
      transition: background-color 0.2s ease, transform 0.1s ease;
      flex-shrink: 0;
    }
    .icon-button:hover { background-color: #cfe2f3; transform: translateY(-1px); }
    .icon-button:active { transform: translateY(0); }
    .icon-button i { font-size: 16px; color: #2c3e50; }
    .icon-button.edit i { color: #3498db; }
    .icon-button.delete i { color: #e74c3c; }
    .icon-button.reset i { color: #8e44ad; }
    .icon-button.submit i { color: #27ae60; }
    .icon-button.erase i { color: #f39c12; }
    .icon-button.pdf i { color: #c0392b; }
    .icon-button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background-color: transparent !important;
        transform: none !important;
    }
    .icon-button:disabled i {
        color: #9e9e9e !important;
    }
    /* Tabel responsif */
    .table-responsive {
      overflow-x: auto; -webkit-overflow-scrolling: touch;
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #e0e0e0; padding: 10px;
      word-wrap: break-word; text-align: left;
      vertical-align: middle;
    }
    th {
      background-color: #ecf0f1; text-align: center;
      font-weight: bold; color: #2c3e50;
      white-space: nowrap;
    }
    tr:nth-child(even) { background-color: #f9f9f9; }
    #tokenTableBody td, #studentTableBody td, #scoreTableBody td, #studentStatusTableBody td {
        white-space: nowrap;
    }
    #tokenTableBody td.mapel-cell {
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        max-width: 180px;
    }
    #tokenTableBody td.mapel-cell .subject-display {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        display: block;
        font-weight: bold;
    }
    #tokenTableBody td.mapel-cell .link-display {
        display: block;
        font-size: 0.85em;
        margin-top: 5px;
    }
    #tokenTableBody td.time-cell,
    #tokenTableBody td.duration-cell {
        text-align: center;
        white-space: nowrap;
    }
    #scoreTableBody td:nth-child(2) {
        white-space: normal;
    }
    /* Status token */
    .token-status {
      cursor: pointer;
      font-weight: bold;
      text-decoration: underline;
    }
    .token-status.on { color: #27ae60; }
    .token-status.off { color: #e74c3c; }
    #locationSettingsTableBody th, #locationSettingsTableBody td,
    #blockKeySettingsTableBody th, #blockKeySettingsTableBody td { text-align: center; }
    #locationSettingsTableBody td:nth-child(4) button, #blockKeySettingsTableBody td:nth-child(3) button { display: inline-block; margin: 0; }
    #tokenTableBody td:nth-child(1) { text-align: center; }
    #studentTableBody td:nth-child(1), #studentTableBody td:nth-child(2), #studentTableBody td:nth-child(4), #studentTableBody td:nth-child(5), #studentTableBody td:last-child,
    #studentStatusTableBody td:nth-child(1), #studentStatusTableBody td:nth-child(2), #studentStatusTableBody td:nth-child(4), #studentStatusTableBody td:nth-child(5), #studentStatusTableBody td:nth-child(6), #studentStatusTableBody td:last-child { 
        text-align: center; 
    }
    .action-buttons-group { display: flex; justify-content: center; gap: 5px; flex-wrap: nowrap; flex-shrink: 0; }
    #tokenTableBody td:nth-child(3) {
        text-align: center;
    }
    #scoreTableBody td:nth-child(1),
    #scoreTableBody td:nth-child(3),
    #scoreTableBody td:nth-child(n+4) {
        text-align: center;
    }
    #minDurationSettingsTableBody td, #shuffleSettingsTableBody td {
        text-align: center;
    }
    /* Modal */
    .modal {
      display: none; position: fixed; z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center; align-items: center;
      overflow-y: auto;
      padding: 20px 0;
    }
    .modal-content {
      background: #fff; padding: 30px; border-radius: 10px;
      width: 90%; max-width: 450px; box-sizing: border-box;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2); text-align: left;
      margin: auto;
    }
    .modal h4 { color: #2c3e50; margin-top: 0; margin-bottom: 20px; font-size: 1.5em; text-align: center; }
    .modal p { margin-bottom: 20px; color: #34495e; }
    .modal .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .modal button {
      margin: 0;
      display: inline-block; width: auto; min-width: 100px;
      padding: 10px 20px; font-size: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }

    /* Specific modal button styles */
    .modal button.confirm-button { background-color: #28a745; color: white; }
    .modal button.confirm-button:hover { background-color: #218838; }
    .modal button.cancel-button { background-color: #dc3545; color: white; }
    .modal button.cancel-button:hover { background-color: #c82333; }
    .modal button.warning-button { background-color: #ffc107; color: black; }
    .modal button.warning-button:hover { background-color: #e0a800; }
    .modal button.gray { background-color: #9e9e9e; color: white; }
    .modal button.gray:hover { background-color: #757575; }
    .modal button.light-blue { background-color: #2196F3; color: white; }
    .modal button.light-blue:hover { background-color: #1976D2; }
    .modal button.orange { background-color: #FF9800; color: white; }
    .modal button.orange:hover { background-color: #FB8C00; }
    .modal button.purple { background-color: #9b59b6; color: white; }
    .modal button.purple:hover { background-color: #8e44ad; }

    /* Style untuk tombol tutup modal yang lebih profesional */
    .modal-close-btn {
        background: transparent;
        border: none;
        font-size: 1.5rem;
        color: #95a5a6;
        cursor: pointer;
        transition: color 0.2s ease, transform 0.2s ease;
        padding: 4px 8px;
        line-height: 1;
    }
    .modal-close-btn:hover {
        color: #e74c3c;
        transform: scale(1.1);
    }

    /* Overlay loading */
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex; justify-content: center; align-items: center;
      z-index: 99999;
    }
    .spinner {
      border: 5px solid rgba(0, 0, 0, 0.1);
      width: 40px; height: 40px; border-radius: 50%;
      border-left-color: #3498db;
      animation: spin 1s ease infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    /* Notifikasi */
    #notification {
      display: none; position: fixed; top: 20px; left: 50%;
      transform: translateX(-50%); background-color: #28a745;
      color: white; padding: 15px 25px; border-radius: 8px;
      z-index: 10000; text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: bold;
    }
    #notification.error {
        background-color: #e74c3c;
    }
    .error { color: #e74c3c; font-size: 14px; text-align: center; margin-top: 5px; }
    .footer { text-align: center; margin-top: 20px; color: #7f8c8d; font-size: 13px; }
    .date-time { font-size: 14px; color: #555; }
    /* Header kontrol */
    .controls-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    .actions-group, .filters-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .filters-group input,
    .filters-group select {
      margin: 0;
      flex-grow: 1;
      min-width: 120px;
      max-width: 180px;
    }
    .filters-group label { margin-right: 5px; font-weight: 500; }
    
    .bank-soal-info {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 10px;
      font-size: 0.9em;
      margin-top: 10px;
      min-height: 40px;
      /* UPDATE: Menambahkan properti wrapping agar kunci jawaban tidak overflow */
      white-space: normal;       /* Pastikan teks bisa turun baris */
      word-wrap: break-word;     /* Support browser lama */
      overflow-wrap: break-word; /* Standar modern */
      word-break: break-all;     /* Memaksa break pada string panjang tanpa spasi (seperti A,A,A,A) */
      max-height: 150px;         /* Opsional: Batasi tinggi jika kuncinya sangat banyak */
      overflow-y: auto;          /* Opsional: Tambahkan scroll jika terlalu tinggi */
    }
    .bank-soal-info.not-found { color: #dc3545; font-weight: bold; }
    .bank-soal-info.found { color: #28a745; }

    .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    .pagination-controls button {
        padding: 8px 15px;
        margin: 0;
        font-size: 14px;
    }
    .pagination-controls button:hover:not(:disabled) { transform: translateY(-1px); }
    .pagination-controls button:disabled { background-color: #cccccc; cursor: not-allowed; box-shadow: none; }
    .pagination-controls span { font-size: 15px; font-weight: bold; color: #2c3e50; }
    .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    
    .highlight-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    .highlight-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        gap: 15px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .highlight-card:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0,0,0,0.12); }
    .highlight-card .icon {
        width: 60px; height: 60px;
        border-radius: 50%; color: white;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0;
    }
    .highlight-card .icon i { font-size: 24px; }
    .highlight-card .icon.active-exams { background-color: #27ae60; }
    .highlight-card .icon.online-users { background-color: #f39c12; }
    .highlight-card .icon.submitted-users { background-color: #3498db; }
    .highlight-card .icon.total-users { background-color: #9b59b6; }
    .highlight-card .info h3 { margin: 0; font-size: 1.8em; color: #2c3e50; }
    .highlight-card .info p { margin: 0; color: #7f8c8d; font-size: 0.9em; }
    
    .progress-cards-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    .progress-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    .progress-card-header {
        padding: 15px 20px;
        border-bottom: 1px solid #ecf0f1;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .progress-card-header h4 { margin: 0; color: #2c3e50; font-size: 1.1em; }
    .progress-card-header .token-code {
        font-size: 0.85em; background-color: #ecf0f1;
        color: #7f8c8d; padding: 3px 8px; border-radius: 5px;
    }
    .progress-card-body { padding: 20px; display: flex; flex-direction: column; gap: 15px; flex-grow: 1; }
    .progress-item { display: flex; flex-direction: column; gap: 5px; }
    .progress-text-info {
        display: flex; justify-content: space-between;
        align-items: baseline; font-size: 0.9em;
        color: #333; font-weight: 500;
    }
    .progress-bar-container {
        width: 100%; background-color: #e0e0e0;
        border-radius: 8px; overflow: hidden; height: 25px;
    }
    .progress-bar-fill {
        height: 100%; border-radius: 8px;
        transition: width 0.5s ease-in-out;
        display: flex; align-items: center; justify-content: flex-end;
        padding-right: 8px; box-sizing: border-box; color: white;
        font-weight: bold; font-size: 0.85em;
        white-space: nowrap; overflow: hidden;
    }
    .progress-card-footer {
        background-color: #f9fafb; padding: 10px 20px;
        border-top: 1px solid #ecf0f1;
        display: flex; justify-content: space-between;
        align-items: center; font-size: 0.85em;
    }
    .status-text.forced { color: #8e44ad; font-weight: bold; }
    .status-text.expired { color: #e74c3c; font-weight: bold; }
    .status-text .countdown { font-weight: bold; }
    .status-text .end-time { color: #7f8c8d; }
    #studentStatusInitialMessage {
      color: #34495e;
      font-size: 1.1em; text-align: center;
      margin: 20px 0; animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .password-input-container {
      position: relative; width: 100%; margin: 8px 0;
    }
    .password-input-container input { padding-right: 40px; margin: 0; }
    .password-input-container .toggle-password {
      position: absolute; right: 10px; top: 50%;
      transform: translateY(-50%); cursor: pointer;
      color: #7f8c8d; font-size: 1.2em;
    }
    .password-input-container .toggle-password:hover { color: #2c3e50; }
    .set-pilih-kelas-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }

    @media (min-width: 768px) { .set-pilih-kelas-grid { grid-template-columns: 1fr 1fr; } }

    .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .card h3 { color: #2c3e50; margin-top: 0; margin-bottom: 15px; text-align: left; }
    .setting-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
    .setting-group > div { display: flex; align-items: center; justify-content: space-between; }
    .setting-group label { flex-shrink: 0; font-weight: bold; margin-right: 10px; }
    .setting-group input[type="url"] { flex-grow: 1; margin: 0; padding: 8px 12px; font-size: 14px; }
    .switch { position: relative; display: inline-block; width: 40px; height: 20px; flex-shrink: 0; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #2196F3; }
    input:focus + .slider { box-shadow: 0 0 1px #2196F3; }
    input:checked + .slider:before { transform: translateX(20px); }

    .info-list { list-style: none; padding: 0; }
    .info-list-item { display: flex; flex-direction: column; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.95em; }
    .info-list-item:last-child { border-bottom: none; }
    .info-list-item div:first-child { display: flex; align-items: center; font-weight: bold; color: #333; margin-bottom: 4px; }
    .info-list-item .link-info { font-size: 0.9em; color: #666; margin-left: 18px; word-break: break-all; }
    .info-list-item a { color: #3498db; text-decoration: none; word-break: break-all; margin-left: 5px; }
    .info-list-item .delete-button { background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 1em; margin-left: auto; padding: 0 5px; }
    .status-indicator { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; display: inline-block; vertical-align: middle; }
    .status-indicator.on { background-color: #27ae60; }
    .status-indicator.off { background-color: #e74c3c; }
    .status-indicator.grey { background-color: #9e9e9e; }
    .sidebar .footer {
        margin-top: auto;
        width: 100%;
        text-align: center;
    }

    /* UPDATE: Gaya untuk Floating Action Bar */
    .floating-bulk-actions {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(100px); /* Tersembunyi di bawah */
        background-color: #2c3e50;
        padding: 15px 25px;
        border-radius: 50px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        gap: 15px;
        z-index: 9999;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.27);
    }
    .floating-bulk-actions.visible {
        transform: translateX(-50%) translateY(0); /* Muncul */
    }
    .floating-bulk-actions span {
        color: white;
        font-weight: bold;
        margin-right: 10px;
        border-right: 1px solid #7f8c8d;
        padding-right: 15px;
    }
    .floating-bulk-actions button {
        margin: 0;
        padding: 8px 20px;
        border-radius: 25px;
        font-size: 14px;
        box-shadow: none;
    }

    @media (max-width: 768px) {
      body {
        flex-direction: row;
      }
      .sidebar { 
        width: 60px;
        padding: 10px 5px;
        align-items: center;
        overflow-x: hidden;
      }
      .sidebar .logo-container {
          margin-bottom: 15px;
      }
      .sidebar .logo {
          width: 36px; height: 36px;
          border-width: 2px;
          padding: 2px;
      }
      .sidebar h2 {
          display: none;
      }
      .sidebar .footer {
          display: none;
      }
      .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .sidebar-nav button {
        width: 44px; height: 44px;
        padding: 0;
        justify-content: center;
        gap: 0;
      }
      .sidebar-nav button:hover {
          transform: none;
      }
      .sidebar-nav button .menu-text {
          display: none;
      }
      .sidebar-nav button i {
        font-size: 1.2rem;
        width: auto;
        margin: 0;
      }
      .main-content {
        padding: 10px;
        width: calc(100% - 60px);
        height: 100vh;
        overflow-y: auto;
      }
      .container { padding: 10px; }
      h1 { font-size: 1.2rem; }
      .highlight-card {
          padding: 10px;
          gap: 10px;
          flex-direction: column;
          text-align: center;
      }
      .highlight-card .icon { width: 40px; height: 40px; }
      .highlight-card .icon i { font-size: 18px; }
      .highlight-card .info h3 { font-size: 1.4em; }
      .highlight-card .info p { font-size: 0.8em; }

      input, select, textarea, .text-button { font-size: 12px; padding: 8px; }
      button { font-size: 13px; padding: 8px 12px; }
      table { font-size: 10px; }
      th, td { padding: 5px; }
      .modal-content { padding: 20px; }
      .modal h4 { font-size: 1.2em; }
      .action-buttons-group { gap: 2px; }
      .icon-button { width: 22px; height: 22px; }
      .icon-button i { font-size: 12px; }

      .controls-header { justify-content: center; gap: 8px; margin-bottom: 10px;}
      .filters-group input, .filters-group select { max-width: 100px; }
      .actions-group .text-button i { display: none; }
      .actions-group .text-button { padding: 8px 10px; }

      .pagination-controls {
          flex-direction: row;
          gap: 5px;
      }
      .pagination-controls button {
          width: auto;
          padding: 6px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <div class="logo-container">
      <img src="https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/logosmpn2pjg.png" alt="Logo SMPN 2 Pajangan" class="logo">
      <h2>SMPN 2 PAJANGAN</h2> 
    </div>
    <nav class="sidebar-nav">
      <button id="dashboardMenuBtn" data-section-id="dashboardSection" onclick="handleMenuClick(this)" title="Dashboard">
          <i class="fas fa-tachometer-alt"></i><span class="menu-text">Dashboard</span>
      </button>
      <button id="bankSoalMenuBtn" data-section-id="bankSoalSection" onclick="handleMenuClick(this)" title="Bank Soal">
          <i class="fas fa-book"></i><span class="menu-text">Bank Soal</span>
      </button>
      <button id="tokenMenuBtn" data-section-id="tokenSection" onclick="handleMenuClick(this)" title="Token">
          <i class="fas fa-key"></i><span class="menu-text">Token</span>
      </button>
      <button id="examStatusMenuBtn" data-section-id="examStatusSelectionSection" onclick="handleMenuClick(this)" title="Status Ujian">
          <i class="fas fa-tasks"></i><span class="menu-text">Status Ujian</span>
      </button>
      <button id="studentStatusMenuBtn" data-section-id="studentStatusSection" onclick="handleMenuClick(this)" title="Status Peserta">
          <i class="fas fa-user-check"></i><span class="menu-text">Status Peserta</span>
      </button>
      <button id="pesertaMenuBtn" data-section-id="studentSection" onclick="handleMenuClick(this)" title="Peserta">
          <i class="fas fa-users"></i><span class="menu-text">Peserta</span>
      </button>
      <button id="scoreMenuBtn" data-section-id="scoreSection" onclick="handleMenuClick(this)" title="Nilai Ujian">
          <i class="fas fa-graduation-cap"></i><span class="menu-text">Nilai Ujian</span>
      </button>
      <button id="backupRestoreMenuBtn" data-section-id="backupRestoreSection" onclick="handleMenuClick(this)" title="Backup">
          <i class="fas fa-database"></i><span class="menu-text">Backup</span>
      </button>
      <button id="aturanMenuBtn" data-section-id="rulesSection" onclick="handleMenuClick(this)" title="Aturan">
          <i class="fas fa-gavel"></i><span class="menu-text">Aturan</span>
      </button>
      <button id="setSelectClassMenuBtn" data-section-id="setSelectClassSection" onclick="handleMenuClick(this)" title="Set Pilih Kelas">
          <i class="fas fa-list-ol"></i><span class="menu-text">Set PilihKelas</span>
      </button>
      <button data-action="promptLogout" onclick="handleMenuClick(this)" title="Keluar">
          <i class="fas fa-sign-out-alt"></i><span class="menu-text">Keluar</span>
      </button>
    </nav>
    <div class="footer">
      <div id="adminDateTime" class="date-time" style="color: #bdc3c7;"></div>
    </div>
  </div>
  <div class="main-content" id="mainContent">
    <!-- Login form disembunyikan secara default (display: none) -->
    <div class="container" id="loginSection" style="max-width: 400px; margin: auto; display: none;">
      <h3 style="text-align: center; color: #2c3e50;">LOGIN ADMINISTRATOR</h3>
      <p id="loginError" class="error"></p>
      
      <!-- Container untuk Akun Tersimpan -->
      <div id="savedAccountsWrapper" style="display:none; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #e9ecef;">
          <label style="font-size: 12px; color: #555; font-weight: bold; display: block; margin-bottom: 5px;">Pilih Akun Tersimpan:</label>
          <div style="display: flex; gap: 5px;">
              <select id="savedAccountsSelect" style="margin: 0; flex-grow: 1; padding: 8px; font-size: 14px;" onchange="fillCredentialsFromSaved()">
                  <option value="">-- Pilih Akun --</option>
              </select>
              <button onclick="deleteSelectedAccount()" title="Hapus Akun Ini" style="width: auto; padding: 0 12px; margin: 0; background-color: #e74c3c; color: white; border-radius: 4px;">
                  <i class="fas fa-trash-alt"></i>
              </button>
          </div>
      </div>

      <!-- Atribut autocomplete="off" ditambahkan untuk mencegah browser menampilkan dropdown email -->
      <input type="email" id="email" placeholder="Email" autocomplete="off" />
      <div class="password-input-container">
        <!-- Atribut autocomplete="new-password" ditambahkan agar browser tidak otomatis mengisi password -->
        <input type="password" id="password" placeholder="Password" autocomplete="new-password" />
        <i class="fas fa-eye toggle-password" id="togglePassword"></i>
      </div>
      
      <!-- Checkbox Simpan Akun -->
      <div style="display: flex; align-items: center; margin-bottom: 15px; margin-top: 5px;">
          <input type="checkbox" id="rememberAccount" style="width: auto; margin: 0 8px 0 0;">
          <label for="rememberAccount" style="font-size: 14px; color: #555; cursor: pointer;">Simpan Akun di Perangkat Ini</label>
      </div>

      <button onclick="login()">Login</button>
      <div class="footer">
        <div>@Admin SMPN 2 Pajangan</div>
        <div id="currentTime" class="date-time"></div>
      </div>
    </div>
    
    <!-- UPDATE: Hardening Flex Layout untuk Dashboard Content -->
    <!-- 'height: 100%' mewarisi height 100% dari .main-content yang mewarisi height 100% dari body -->
    <div id="dashboardContent" style="display:none; flex-direction: column; flex: 1; height: 100%; min-height: 0;">
      <div id="dashboardSection" class="dashboard-section container">
        <div class="highlight-cards" id="highlightCards">
        </div>
        <div class="dashboard-grid">
            <div class="progress-cards-container" id="progressCardsContainer">
            </div>
        </div>
      </div>
      
      <!-- UPDATE: Absolute Positioning Iframe Container -->
      <!-- Menggunakan 'flex: 1' untuk mengambil sisa ruang, dan 'position: relative' sebagai jangkar absolute child -->
      <div id="bankSoalSection" class="dashboard-section container" style="display: flex; flex-direction: column; flex: 1; margin-bottom: 0; min-height: 0; padding-bottom: 10px; position: relative;">
        <h1 id="bankSoalSectionTitle" style="text-align: left; color: #34495e; flex-shrink: 0;">Manajemen Bank Soal</h1>
        
        <!-- Wrapper Absolute untuk Iframe: Memaksa iframe memenuhi ruang sisa tanpa peduli flex-basis bug -->
        <div style="flex: 1; position: relative; width: 100%; overflow: hidden; background: #fff;">
          <iframe id="bankSoalFrame" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;" title="Bank Soal"></iframe>
        </div>
      </div>
      
      <div id="tokenSection" class="dashboard-section container">
        <h1 id="tokenSectionTitle" style="text-align: left; color: #34495e;">Manajemen Token</h1>
        <div class="controls-header">
            <div class="actions-group">
                <button onclick="openAddTokenModal()" class="text-button green">
                    <i class="fas fa-plus"></i> Tambah Token
                </button>
                <button class="text-button gray" onclick="openCopyPrintModal('tokenTable', 'Cetak Daftar Token')"><i class="fas fa-print"></i> Cetak</button>
                <button class="text-button red" onclick="promptEmptyTokens()"><i class="fas fa-trash-alt"></i> Kosongkan</button>
            </div>
            <div class="filters-group">
                 <input type="text" id="tokenSearchSubject" placeholder="Cari Mapel..." />
            </div>
        </div>
        <p style="font-size: 11px; color: #555; margin-top: 10px; margin-bottom: 10px; text-align: center;">
          Token yang ditambahkan akan dihapus otomatis setelah 30 hari!
        </p>
        <div class="table-responsive">
          <table id="tokenTable">
            <thead>
              <tr>
                <th>NO</th>
                <th>MAPEL</th>
                <th>KELAS</th>
                <th>TOKEN</th>
                <th class="time-cell">DIBUKA</th>
                <th class="time-cell">DITUTUP</th>
                <th class="duration-cell">DURASI</th>
                <th style="text-align: center;">PROGRES</th>
                <th>AKSI</th>
              </tr>
            </thead>
            <tbody id="tokenTableBody"></tbody>
          </table>
        </div>
      </div>
      <div id="examStatusSelectionSection" class="dashboard-section container">
        <h1 style="text-align: left; color: #34495e;">Status Ujian</h1>
        <p style="font-size: 0.9em; color: #555; margin-top: 5px; margin-bottom: 15px;">
          Pilihlah token ujian yang akan ditampilkan di menu Status Peserta.
        </p>
        <div style="margin-bottom: 15px;">
          <label for="grade7TokenSelect" style="display: block; margin-bottom: 5px;">Kelas 7:</label>
          <select id="grade7TokenSelect" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd;"></select>
        </div>
        <div style="margin-bottom: 15px;">
          <label for="grade8TokenSelect" style="display: block; margin-bottom: 5px;">Kelas 8:</label>
          <select id="grade8TokenSelect" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd;"></select>
        </div>
        <div style="margin-bottom: 20px;">
          <label for="grade9TokenSelect" style="display: block; margin-bottom: 5px;">Kelas 9:</label>
          <select id="grade9TokenSelect" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd;"></select>
        </div>
        <button onclick="saveSelectedExamTokens()" class="text-button green">Simpan</button>
      </div>
      <div id="studentStatusSection" class="dashboard-section container">
        <h1 style="text-align: left; margin-bottom: 20px; color: #34495e;">Status Peserta</h1>
        <div class="controls-header">
            <div class="filters-group" style="flex-grow: 1; justify-content: flex-start; align-items: flex-end; width: 100%;">
                <input type="text" id="studentStatusSearchId" placeholder="Cari ID..." style="max-width: 150px;"/>
                <input type="text" id="studentStatusSearchName" placeholder="Cari Nama..." style="max-width: 200px;" />
                <input type="text" id="studentStatusSearchClass" placeholder="Cari Kelas..." style="max-width: 150px;" />
            </div>
        </div>
        <p id="studentStatusInitialMessage">
            Jika ingin melihat status peserta ujian, klik menu <button class="text-button light-blue" style="padding: 5px 10px; font-size: 0.9em; margin: 0 5px;" onclick="showSection('examStatusSelectionSection')">Status Ujian</button> dan pilih token ujian yang ingin ditampilkan.
        </p>
        <div class="table-responsive" id="studentStatusTableContainer" style="display: none;">
            <table id="studentStatusTable">
                <thead>
                    <tr>
                        <!-- Checkbox Pilih Semua -->
                        <th style="width: 50px;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                                <input type="checkbox" id="selectAllStatus" style="margin: 0; width: 16px; height: 16px;" onchange="toggleSelectAllStatus(this)">
                                <span>NO</span>
                            </div>
                        </th>
                        <th>ID SISWA</th>
                        <th>NAMA</th>
                        <th>KELAS</th>
                        <th>RUANG</th>
                        <th>STATUS</th>
                        <th>AKSI</th>
                    </tr>
                </thead>
                <tbody id="studentStatusTableBody"></tbody>
            </table>
        </div>
        <div id="studentStatusPagination" class="pagination-controls"></div>
      </div>
      
      <div id="rulesSection" class="dashboard-section container">
        <h1 id="rulesSectionTitle" style="text-align: left; margin-bottom: 20px; color: #34495e;">Pengaturan Ujian Global</h1>
        
        <div style="margin-bottom: 20px;">
          <h3>ATUR AKSES LOKASI</h3>
          <p style="text-align: left; font-size: 0.9em; color: #555; margin-top: 5px; margin-bottom: 15px;">
            Atur akses login siswa hanya sesuai radius lokasi saja.
          </p>
          <div class="table-responsive">
            <table id="locationSettingsTable">
              <thead>
                <tr>
                  <th>KUNCI</th>
                  <th>KOORDINAT LOKASI</th>
                  <th>RADIUS</th>
                  <th>STATUS</th>
                  <th>AKSI</th>
                </tr>
              </thead>
              <tbody id="locationSettingsTableBody"></tbody>
            </table>
          </div>
        </div>

        <div style="margin-top: 30px;">
            <h3>ATUR ACAK SOAL & PILIHAN GANDA</h3>
            <p style="text-align: left; font-size: 0.9em; color: #555; margin-top: 5px; margin-bottom: 15px;">
                Aktifkan untuk mengacak urutan soal dan/atau urutan pilihan ganda untuk semua ujian.
            </p>
            <div class="table-responsive">
                <table id="shuffleSettingsTable">
                    <thead>
                        <tr>
                            <th>PENGATURAN</th>
                            <th>STATUS</th>
                            <th>AKSI</th>
                        </tr>
                    </thead>
                    <tbody id="shuffleSettingsTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div style="margin-top: 30px;">
          <h3>ATUR KUNCI BLOKIR</h3>
          <p style="text-align: left; font-size: 0.9em; color: #555; margin-top: 5px; margin-bottom: 15px;">
            Atur kunci yang harus dimasukkan siswa ketika mereka terblokir karena membuka aplikasi bukan dengan aplikasi resmi.
          </p>
          <div class="table-responsive">
            <table id="blockKeySettingsTable">
              <thead>
                <tr>
                  <th>KUNCI</th>
                  <th>STATUS</th>
                  <th>AKSI</th>
                </tr>
              </thead>
              <tbody id="blockKeySettingsTableBody"></tbody>
            </table>
          </div>
        </div>

        <div style="margin-top: 30px;">
          <h3>ATUR DURASI KIRIM JAWABAN</h3>
          <p style="text-align: left; font-size: 0.9em; color: #555; margin-top: 5px; margin-bottom: 15px;">
            Atur sisa durasi minimal yang harus dicapai siswa agar dapat mengirim jawaban (mengaktifkan tombol kirim jawaban).
          </p>
          <div class="table-responsive">
            <table id="minDurationSettingsTable">
              <thead>
                <tr>
                  <th>DURASI SISA MINIMAL</th>
                  <th>STATUS</th>
                  <th>AKSI</th>
                </tr>
              </thead>
              <tbody id="minDurationSettingsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="setSelectClassSection" class="dashboard-section container">
        <h1 style="text-align: left; color: #34495e;">Pengaturan Tampilan Pilih Kelas</h1>
        <p style="font-size: 0.9em; color: #555; margin-top: 5px; margin-bottom: 15px;">
          Jika ada tombol yang aktif, tampilan aplikasi siswa akan menampilkan pilihan kelas tersebut. Jika tidak ada yang aktif, aplikasi akan menggunakan ujian berbasis token ini secara default.
        </p>
        <div class="set-pilih-kelas-grid">
            <div>
                <div class="card">
                    <h3>Pengaturan Tombol Utama</h3>
                    <div class="setting-group">
                        <div>
                            <label for="kelas7Toggle">Kelas 7:</label>
                            <label class="switch">
                                <input type="checkbox" id="kelas7Toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <input type="url" id="kelas7Url" placeholder="URL tombol Kelas 7">
                    </div>
                    <div class="setting-group">
                        <div>
                            <label for="kelas8Toggle">Kelas 8:</label>
                            <label class="switch">
                                <input type="checkbox" id="kelas8Toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <input type="url" id="kelas8Url" placeholder="URL tombol Kelas 8">
                    </div>
                    <div class="setting-group">
                        <div>
                            <label for="kelas9Toggle">Kelas 9:</label>
                            <label class="switch">
                                <input type="checkbox" id="kelas9Toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <input type="url" id="kelas9Url" placeholder="URL tombol Kelas 9">
                    </div>
                    <div class="setting-group">
                        <div>
                            <label for="susulanToggle">Susulan:</label>
                            <label class="switch">
                                <input type="checkbox" id="susulanToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <button class="text-button green" onclick="savePublicSettings()">
                        <i class="fas fa-save"></i> Simpan Pengaturan
                    </button>
                </div>

                <div class="card">
                    <h3>Pengaturan Ujian Susulan</h3>
                    <p style="font-size: 0.9em; color: #555; text-align: left; margin-bottom: 10px;">
                        Tambahkan daftar ujian susulan. List akan terhapus otomatis setelah 1 minggu.
                    </p>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="addSusulanName" placeholder="Nama Ujian Susulan">
                        <input type="url" id="addSusulanUrl" placeholder="URL Ujian Susulan">
                    </div>
                    <button class="text-button blue-gray" onclick="addSusulanUjian()">
                        <i class="fas fa-plus"></i> Simpan Susulan
                    </button>
                </div>
            </div>

            <div class="card">
                <h3>Informasi Tombol Aktif</h3>
                <ul class="info-list" id="activeButtonsInfoList">
                </ul>
            </div>
        </div>
      </div>
      <div id="studentSection" class="dashboard-section container">
        <h1 id="studentSectionTitle" style="text-align: left; margin-bottom: 20px; color: #34495e;">Manajemen Peserta</h1>
        <div class="controls-header">
            <div class="actions-group">
                <button onclick="openAddStudentModal()" class="text-button green"><i class="fas fa-user-plus"></i> Tambah</button>
                <button class="text-button blue-gray" onclick="openImportStudentModal()"><i class="fas fa-file-csv"></i> Impor</button>
                <button class="text-button gray" onclick="openPrintCardModal()"><i class="fas fa-print"></i> Cetak Kartu</button>
                <button class="text-button red" onclick="openEmptyStudentsModal()"><i class="fas fa-trash-alt"></i> Kosongkan</button>
            </div>
        </div>
        <div class="controls-header">
            <div class="filters-group" style="flex-grow: 1; justify-content: flex-start; align-items: flex-end; width: 100%;">
                <input type="text" id="studentSearchId" placeholder="Cari ID..." style="max-width: 150px;"/>
                <input type="text" id="studentSearchName" placeholder="Cari Nama..." style="max-width: 200px;" />
                <input type="text" id="studentSearchClass" placeholder="Cari Kelas..." style="max-width: 150px;" />
                <select id="itemsPerPageSelect" onchange="window.updateItemsPerPage(this.value)">
                    <option value="25">25 per halaman</option>
                    <option value="50" selected>50 per halaman</option>
                    <option value="75">75 per halaman</option>
                    <option value="100">100 per halaman</option>
                    <option value="200">200 per halaman</option>
                    <option value="500">500 per halaman</option>
                    <option value="1000">1000 per halaman</option>
                </select>
            </div>
        </div>
        <div class="table-responsive" id="studentTableContainer">
          <table id="studentTable">
            <thead>
              <tr>
                <th>NO</th>
                <th>ID SISWA</th>
                <th>NAMA</th>
                <th>KELAS</th>
                <th>RUANG</th>
                <th>AKSI</th>
              </tr>
            </thead>
            <tbody id="studentTableBody"></tbody>
          </table>
        </div>
        <div id="studentPagination" class="pagination-controls"></div>
      </div>
      <div id="scoreSection" class="dashboard-section container">
        <h1 id="scoreSectionTitle" style="text-align: left; margin-bottom: 20px; color: #34495e;">Daftar Nilai Ujian</h1>
        <div class="controls-header">
            <div class="actions-group">
                <button class="text-button light-blue" onclick="window.currentScoreGradeFilter = '7'; window.renderScoreTable(1);"><i class="fas fa-graduation-cap"></i> Kelas 7</button>
                <button class="text-button light-blue" onclick="window.currentScoreGradeFilter = '8'; window.renderScoreTable(1);"><i class="fas fa-graduation-cap"></i> Kelas 8</button>
                <button class="text-button light-blue" onclick="window.currentScoreGradeFilter = '9'; window.renderScoreTable(1);"><i class="fas fa-graduation-cap"></i> Kelas 9</button>
                <button class="text-button gray" id="scorePrintBtn" style="display: none;" onclick="openCopyPrintModal('scoreTable', 'Cetak Daftar Nilai')"><i class="fas fa-print"></i> Cetak</button>
            </div>
            <div class="filters-group">
                <input type="text" id="scoreSearchName" placeholder="Cari Nama Siswa" />
                <input type="text" id="scoreSearchClass" placeholder="Cari Kelas (misal: 7A)" />
            </div>
        </div>
        <p id="scoreTableMessage" style="text-align: center; color: #555; font-style: italic; margin: 20px 0;">Pilih tingkatan kelas untuk menampilkan daftar nilai.</p>
        <div class="table-responsive">
          <table id="scoreTable">
            <thead id="scoreTableHeader">
            </thead>
            <tbody id="scoreTableBody">
            </tbody>
          </table>
        </div>
        <div id="scorePagination" class="pagination-controls"></div>
      </div>
      <div id="backupRestoreSection" class="dashboard-section container">
        <h1 style="text-align: left; color: #34495e;">Backup & Restore Data</h1>
        <p style="text-align: left; font-size: 0.9em; color: #555; margin-top: 5px; margin-bottom: 15px;">
          Di sini Anda dapat melakukan backup seluruh data (token, peserta, nilai dan aturan ujian) kemudian dapat memulihkan data jika terjadi masalah.
        </p>
        <p style="text-align: left; font-size: 0.9em; color: red; font-weight: bold; margin-top: 5px; margin-bottom: 15px;">
          Peringatan: Memulihkan data akan MENIMPA (MENGGANTI) SEMUA DATA yang sudah ada. Lakukan dengan hati hati!
        </p>
        <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
            <button class="text-button blue-gray" onclick="performBackup()"><i class="fas fa-download"></i> Unduh Data Backup</button>
            <button class="text-button orange" onclick="openRestorePasswordModal()"><i class="fas fa-upload"></i> Unggah & Pulihkan Data</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Container Floating Action Bar -->
  <div id="floatingBulkActions" class="floating-bulk-actions">
      <span id="selectedCountDisplay">0 Terpilih</span>
      <button class="text-button purple" onclick="initiateBulkReset()" style="background-color: #9b59b6;"><i class="fas fa-redo"></i> Reset Login</button>
      <button class="text-button green" onclick="initiateBulkSubmit()" style="background-color: #27ae60;"><i class="fas fa-paper-plane"></i> Kirim Jawaban</button>
      <button class="text-button red" onclick="initiateBulkDelete()" style="background-color: #e74c3c;"><i class="fas fa-eraser"></i> Hapus Jawaban</button>
      <button class="icon-button" onclick="clearSelection()" style="background: rgba(255,255,255,0.2); width: 30px; height: 30px;" title="Batalkan Pilihan"><i class="fas fa-times" style="color: white;"></i></button>
  </div>

  <!-- Modals -->
  <div id="addTokenModal" class="modal">
    <div class="modal-content">
        <h4>Tambah Token Baru</h4>
        <form id="addTokenForm">
            <label for="addKelas">Kelas</label>
            <select id="addKelas" required>
                <option value="" disabled selected>-- Pilih Kelas --</option>
                <option value="7">Kelas 7</option>
                <option value="8">Kelas 8</option>
                <option value="9">Kelas 9</option>
            </select>

            <label for="addTahunAjaran">Tahun Ajaran</label>
            <select id="addTahunAjaran" required disabled></select>

            <label for="addUjianName">Nama Ujian</label>
            <select id="addUjianName" required disabled></select>

            <label for="addMapel">Mata Pelajaran</label>
            <select id="addMapel" required disabled></select>

            <div id="addBankSoalInfo" class="bank-soal-info">Pilih mata pelajaran untuk melihat detail bank soal.</div>
            
            <label for="addToken">Token Ujian (Base Token)</label>
            <input type="text" id="addToken" placeholder="Huruf/Angka Kapital" required />
            
            <label>Waktu Token Dibuka</label>
            <input type="datetime-local" id="addStartTime" required />
            <label>Waktu Token Ditutup</label>
            <input type="datetime-local" id="addEndTime" required />
            
            <p id="addErrorMsg" class="error"></p>
            <div class="modal-buttons">
              <button type="button" onclick="closeAddTokenModal()" class="cancel-button">Batal</button>
              <button type="submit">Tambah Token</button>
            </div>
        </form>
    </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
        <h4>Edit Token</h4>
        <form id="modalForm">
            <label for="editKelas">Kelas</label>
            <input type="text" id="editKelas" placeholder="Berupa angka saja" required />
            
            <label for="editTahunAjaran">Tahun Ajaran</label>
            <select id="editTahunAjaran" required></select>

            <label for="editUjianName">Nama Ujian</label>
            <select id="editUjianName" required></select>

            <label for="editMapel">Mata Pelajaran</label>
            <select id="editMapel" required></select>
            
            <div id="editBankSoalInfo" class="bank-soal-info"></div>

            <label>Token Ujian</label>
            <input type="text" id="editToken" required />
            
            <label>Waktu Token Dibuka</label>
            <input type="datetime-local" id="editStartTime" required />
            <label>Waktu Token Ditutup</label>
            <input type="datetime-local" id="editEndTime" required />
            
            <p id="editErrorMsg" class="error"></p>
            <div class="modal-buttons">
                <button type="button" onclick="closeEditModal()" class="cancel-button">Batal</button>
                <button type="submit">Simpan</button>
            </div>
        </form>
    </div>
  </div>

  <div id="addStudentModal" class="modal">
      <div class="modal-content">
          <h4>Tambah Peserta Baru</h4>
          <form id="addStudentForm">
              <p id="addStudentErrorMsg" class="error"></p>
              <label for="newStudentId">ID Siswa</label>
              <input type="text" id="newStudentId" placeholder="Contoh: 001" required />
              <label for="newStudentName">Nama Siswa</label>
              <input type="text" id="newStudentName" placeholder="Nama Lengkap Siswa" required />
              <label for="newStudentClass">Kelas</label>
              <input type="text" id="newStudentClass" placeholder="Contoh: 7A, 8B, 9C" required />
              <label for="newStudentRoom">Ruang</label>
              <input type="text" id="newStudentRoom" placeholder="Contoh: 01, 02, dsb" required />
              <div class="modal-buttons">
                  <button type="button" onclick="closeAddStudentModal()" class="cancel-button">Batal</button>
                  <button type="submit">Tambah</button>
              </div>
          </form>
      </div>
  </div>

  <div id="deleteModal" class="modal"><div class="modal-content"><h4 style="text-align:center;">Hapus Token</h4><p>Yakin ingin menghapus token ini?</p><div class="modal-buttons"><button onclick="closeDeleteModal()" class="cancel-button">Batal</button><button onclick="confirmDelete()" class="confirm-button">Hapus</button></div></div></div>
  <div id="forceActiveModal" class="modal"><div class="modal-content"><h4>Aktifkan Token Secara Paksa?</h4><p>Token ini akan dapat diakses kapanpun, mengabaikan jadwal yang ada.</p><div><label for="forceActivePassword">Password Login Admin:</label><div class="password-input-container"><input type="password" id="forceActivePassword"><i class="fas fa-eye toggle-password"></i></div><p id="forceActivePasswordError" class="error"></p></div><div class="modal-buttons"><button onclick="closeForceActiveModal()" class="cancel-button">Batal</button><button onclick="confirmForceActive()" class="confirm-button">Ya, Aktifkan</button></div></div></div>
  <div id="forceInactiveModal" class="modal"><div class="modal-content"><h4>Nonaktifkan Mode Paksa?</h4><p>Token akan kembali ke pengaturan jadwal semula.</p><div class="modal-buttons"><button onclick="closeForceInactiveModal()" class="cancel-button">Batal</button><button onclick="confirmForceInactive()" class="confirm-button">Ya, Nonaktifkan</button></div></div></div>
  <div id="notification" class="notification"><span id="notificationMessage"></span></div>
  <div id="copyPrintModal" class="modal"><div class="modal-content"><h4 id="copyPrintModalTitle"></h4><button onclick="copyTableToClipboard()" class="confirm-button">Salin Tabel</button><p style="font-size: 0.9em; color: #555; margin-top: 15px;">Salin tabel kemudian paste ke word atau excel.</p><button onclick="closeCopyPrintModal()" class="cancel-button">Batal</button></div></div>
  <div id="setlokasiModal" class="modal"><div class="modal-content" style="text-align: center;"><h4>Pengaturan Lokasi</h4><button onclick="aktifkanLokasi()" class="confirm-button">Aktifkan</button><button onclick="openGantiRadiusModal()" class="warning-button">Ganti Radius</button><button onclick="nonaktifkanLokasi()" class="cancel-button">Nonaktifkan</button><button onclick="closeSetlokasiModal()" class="gray text-button" style="margin-top: 10px;">Batal</button></div></div>
  <div id="gantiRadiusModal" class="modal"><div class="modal-content"><h4>Ganti Radius Lokasi (meter)</h4><label for="radiusMeter">Radius (meter):</label><input type="number" id="radiusMeter" placeholder="Contoh: 75" required /><div style="text-align: center; margin-top: 10px;"><button onclick="closeGantiRadiusModal()" class="cancel-button">Batal</button><button onclick="gantiRadiusDanAktifkan()" class="confirm-button">Ganti & Aktifkan</button></div></div></div>
  <div id="setBlockKeyModal" class="modal"><div class="modal-content"><h4>Atur Kunci Blokir</h4><label for="blockKeyInput">Kunci (Otomatis Kapital):</label><input type="text" id="blockKeyInput" placeholder="Contoh: BUKA" required oninput="this.value = this.value.toUpperCase()" /><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;"><label for="blockKeyStatusToggle">Status Kunci:</label><label class="switch"><input type="checkbox" id="blockKeyStatusToggle"><span class="slider"></span></label></div><p id="blockKeySettingsError" class="error"></p><div class="modal-buttons"><button onclick="closeSetBlockKeyModal()" class="cancel-button">Batal</button><button onclick="saveBlockKeySettings()" class="confirm-button">Simpan</button></div></div></div>
  <div id="accessDetailModal" class="modal"><div class="modal-content" style="max-width: 700px;"><h4 id="accessDetailTokenTitle">Detail Akses Token: [Token]</h4><div class="table-responsive"><table id="accessDetailTable"><thead><tr><th>NO</th><th>ID SISWA</th><th>NAMA SISWA</th><th>KELAS</th><th>STATUS AKSES</th><th>WAKTU AKSES PERTAMA</th></tr></thead><tbody id="accessDetailTableBody"></tbody></table></div><button onclick="closeAccessDetailModal()" style="margin-top: 20px;">Tutup</button></div></div>
  <div id="editStudentModal" class="modal"><div class="modal-content"><h4>Edit Data Siswa</h4><p id="editStudentErrorMsg" class="error"></p><label for="modalStudentId">ID Siswa</label><input type="text" id="modalStudentId" required /><label for="modalStudentName">Nama Siswa</label><input type="text" id="modalStudentName" required /><label for="modalStudentClass">Kelas</label><input type="text" id="modalStudentClass" placeholder="Contoh: 7A, 7B, 7C" required /><label for="modalStudentRoom">Ruang</label><input type="text" id="modalStudentRoom" placeholder="Contoh: 01, 02, dsb" required /><div class="modal-buttons"><button type="button" onclick="closeEditStudentModal()" class="cancel-button">Batal</button><button onclick="confirmEditStudent()">Simpan</button></div></div></div>
  <div id="deleteStudentConfirmModal" class="modal"><div class="modal-content"><h4 style="text-align:center;">Hapus Siswa</h4><p>Yakin ingin menghapus siswa ini?</p><div class="modal-buttons"><button onclick="closeDeleteStudentConfirmModal()" class="cancel-button">Batal</button><button onclick="confirmDeleteStudent()" class="confirm-button">Hapus</button></div></div></div>
  <div id="importStudentModal" class="modal"><div class="modal-content"><h4>Import Data Peserta dari CSV</h4><p style="font-size: 0.9em; color: #555; text-align: left;">Perhatikan hal-hal berikut!<br>1. Siapkan data peserta dengan 4 kolom: ID Peserta (angka), Nama Lengkap, Kelas, dan Ruang<br>2. Simpan file dengan format *.csv (comma delimited)<br>3. Pastikan tidak ada kolom tambahan</p><a href="https://drive.google.com/uc?export=download&id=16rzsLjQ3AVm0wIPqWnzsauzbrwGfO7An" target="_blank" style="display: block; text-align: center; margin: 15px 0; padding: 10px 20px; background-color: #28a745; color: white; text-decoration: none; border-radius: 5px;">Unduh Template CSV</a> <input type="file" id="csvFileInput" accept=".csv" style="margin-top: 15px; margin-bottom: 10px;" /><p id="importFileError" class="error"></p><div class="modal-buttons"><button onclick="closeImportStudentModal()" class="cancel-button">Batal</button><button onclick="processCsvFile()">Mulai Impor</button></div></div></div>
  <div id="importResultModal" class="modal"><div class="modal-content"><h4>Hasil Impor Data Siswa</h4><p id="importResultSummary"></p><ul id="importResultDetails" style="text-align: left; max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 5px;"></ul><button onclick="closeImportResultModal()">Tutup</button></div></div>
  <div id="emptyStudentsModal" class="modal"><div class="modal-content"><h4>Kosongkan Daftar Peserta</h4><p>Anda yakin ingin menghapus <b>SEMUA</b> data peserta? Tindakan ini tidak dapat dibatalkan.</p><div><label for="emptyStudentsPassword">Password Login Admin:</label><div class="password-input-container"><input type="password" id="emptyStudentsPassword"><i class="fas fa-eye toggle-password"></i></div><p id="emptyStudentsPasswordError" class="error"></p></div><div class="modal-buttons"><button onclick="closeEmptyStudentsModal()" class="cancel-button">Batal</button><button onclick="confirmEmptyStudents()" class="confirm-button">Konfirmasi Hapus</button></div></div></div>
  <div id="logoutConfirmModal" class="modal"><div class="modal-content"><h4>Konfirmasi Logout</h4><p>Anda yakin ingin keluar dari panel admin?</p><div class="modal-buttons"><button onclick="closeLogoutModal()" class="cancel-button">Batal</button><button onclick="confirmLogout()" class="confirm-button">Ya, Keluar</button></div></div></div>
  <div id="resetStudentModal" class="modal"><div class="modal-content"><h4>Reset Status Login Siswa</h4><p>Anda yakin ingin mereset status login siswa <b id="resetStudentNameDisplay"></b> (ID: <b id="resetStudentIdDisplay"></b>) untuk ujian yang dipilih?</p><p style="font-size: 0.9em; color: #555;">Ini akan memaksa siswa untuk login ulang jika mereka sedang dalam sesi.</p><div class="modal-buttons"><button onclick="closeResetStudentModal()" class="cancel-button">Batal</button><button onclick="confirmResetStudent()" class="confirm-button">Reset</button></div></div></div>
  <div id="submitAnswerModal" class="modal"><div class="modal-content"><h4>Kirim Jawaban Siswa (Manual)</h4><p>Anda yakin ingin menandai ujian yang dipilih untuk siswa <b id="submitStudentNameDisplay"></b> (ID: <b id="submitStudentIdDisplay"></b>) sebagai 'Sudah submit'?</p><p style="font-size: 0.9em; color: #555;">Tindakan ini akan mengunci jawaban siswa untuk ujian yang relevan.</p><div class="modal-buttons"><button onclick="closeSubmitAnswerModal()" class="cancel-button">Batal</button><button onclick="confirmSubmitAnswer()" class="confirm-button">Kirim</button></div></div></div>
  <div id="deleteAnswerModal" class="modal"><div class="modal-content"><h4>Hapus Jawaban Siswa</h4><p>Anda yakin ingin menghapus jawaban dan status submit untuk siswa <b id="deleteAnswerStudentNameDisplay"></b> (ID: <b id="deleteAnswerStudentIdDisplay"></b>) pada ujian yang dipilih?</p><p style="font-size: 0.9em; color: #e74c3c; font-weight: bold;">Tindakan ini tidak dapat dibatalkan!</p><div><label for="deleteAnswerPassword">Password Login Admin:</label><div class="password-input-container"><input type="password" id="deleteAnswerPassword"><i class="fas fa-eye toggle-password"></i></div><p id="deleteAnswerPasswordError" class="error"></p></div><div class="modal-buttons"><button onclick="closeDeleteAnswerModal()" class="cancel-button">Batal</button><button onclick="confirmDeleteAnswer()" class="confirm-button">Hapus Jawaban</button></div></div></div>
  
  <!-- Modal untuk Konfirmasi Aksi Massal -->
  <div id="bulkActionModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <h4 id="bulkActionTitle">Konfirmasi Tindakan Massal</h4>
        <p id="bulkActionMessage"></p>
        <p style="font-size: 0.9em; color: #e74c3c; font-style: italic;">Hanya siswa yang memenuhi syarat status yang ditampilkan di bawah ini.</p>
        
        <div class="table-responsive" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;">
            <table id="bulkActionTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>NAMA</th>
                        <th>KELAS</th>
                        <th>STATUS SAAT INI</th>
                    </tr>
                </thead>
                <tbody id="bulkActionTableBody"></tbody>
            </table>
        </div>

        <!-- Input Password untuk Hapus Massal -->
        <div id="bulkActionPasswordContainer" style="display: none; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
             <label for="bulkActionPassword" style="color: #e74c3c; font-weight: bold;">Password Admin (Wajib untuk Hapus):</label>
             <div class="password-input-container">
                 <input type="password" id="bulkActionPassword" placeholder="Masukkan Password Admin">
                 <i class="fas fa-eye toggle-password"></i>
             </div>
             <p id="bulkActionPasswordError" class="error"></p>
        </div>

        <div class="modal-buttons">
            <button onclick="closeBulkActionModal()" class="cancel-button">Batal</button>
            <button id="confirmBulkActionButton" class="confirm-button" onclick="confirmBulkAction()">Konfirmasi</button>
        </div>
    </div>
  </div>

  <!-- Loading Overlay ditampilkan default (display: flex) untuk menutup proses cek login awal -->
  <div id="loadingOverlay" class="loading-overlay" style="display: flex;"><div class="spinner"></div></div>
  
  <div id="emptyTokensModal" class="modal">
      <div class="modal-content">
          <h4>Kosongkan Semua Token?</h4>
          <p>Anda yakin ingin menghapus <b>SEMUA</b> token dan data terkait (akses, submit, jawaban siswa)? Tindakan ini tidak dapat dibatalkan.</p>
          <div>
              <label for="adminPasswordConfirmation">Password Login Admin:</label>
               <div class="password-input-container"><input type="password" id="adminPasswordConfirmation"><i class="fas fa-eye toggle-password"></i></div>
              <p id="adminPasswordConfirmationError" class="error"></p>
          </div>
          <div class="modal-buttons"><button onclick="closeEmptyTokensModal()" class="cancel-button">Batal</button><button onclick="confirmEmptyTokens()" class="confirm-button">Konfirmasi Hapus</button></div>
      </div>
  </div>
  <div id="restoreModal" class="modal">
    <div class="modal-content">
      <h4>Pulihkan Data dari Backup</h4>
      <p style="text-align: center; color: red; font-weight: bold;">
        PERINGATAN: Tindakan ini akan MENIMPA SEMUA DATA yang ada di database Anda dengan data dari file backup.
        Pastikan Anda mengunggah file backup yang benar.
      </p>
      <input type="file" id="backupFileInput" accept=".json" style="margin-top: 15px; margin-bottom: 10px;" />
      <p id="restoreFileError" class="error"></p>
      <div class="modal-buttons"><button onclick="closeRestoreModal()" class="cancel-button">Batal</button><button onclick="confirmRestoreInternal()" class="confirm-button">Pulihkan</button></div>
    </div>
  </div>
  <div id="restorePasswordModal" class="modal">
      <div class="modal-content">
          <h4>Verifikasi Admin untuk Pulihkan Data</h4>
          <p>Masukkan password login admin untuk melanjutkan proses pemulihan data.</p>
          <div>
              <label for="restoreAdminPassword">Password Login Admin:</label>
              <div class="password-input-container"><input type="password" id="restoreAdminPassword"><i class="fas fa-eye toggle-password"></i></div>
              <p id="restoreAdminPasswordError" class="error"></p>
          </div>
          <div class="modal-buttons"><button onclick="closeRestorePasswordModal()" class="cancel-button">Batal</button><button onclick="checkRestoreAdminPassword()" class="confirm-button">Lanjutkan</button></div>
      </div>
  </div>

  <div id="setMinDurationModal" class="modal">
      <div class="modal-content">
          <h4>Atur Durasi Minimal Kirim Jawaban</h4>
          <label for="minDurationMinutesInput">Durasi Sisa Minimal (menit):</label>
          <input type="number" id="minDurationMinutesInput" placeholder="Contoh: 30" required />
          <p id="minDurationError" class="error"></p>
          <div style="text-align: center; margin-top: 10px;">
              <button onclick="setMinDurationAndActivate()" class="confirm-button">Ganti & Aktifkan</button>
              <button onclick="aktifkanMinDuration()" class="text-button green">Aktifkan Saja</button>
              <button onclick="nonaktifkanMinDuration()" class="cancel-button">Nonaktifkan</button>
              <button onclick="closeSetMinDurationModal()" class="gray text-button" style="margin-top: 10px;">Batal</button>
          </div>
      </div>
  </div>

  <div id="genericConfirmModal" class="modal">
      <div class="modal-content">
          <h4 id="genericConfirmTitle"></h4>
          <p id="genericConfirmMessage"></p>
          <div class="modal-buttons"><button onclick="closeGenericConfirmModal()" class="cancel-button">Batal</button><button id="genericConfirmButton" class="confirm-button" onclick="handleGenericConfirm()">Konfirmasi</button></div>
      </div>
  </div>

  <!-- Struktur Modal Cetak Kartu dengan Header yang lebih rapi -->
  <div id="printCardModal" class="modal">
    <div class="modal-content" style="max-width: 95%; width: 1200px; height: 90vh; display: flex; flex-direction: column; padding: 0; overflow: hidden;">
      <div style="padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; background-color: #f8f9fa;">
          <h4 style="margin: 0; color: #2c3e50; font-size: 1.2em; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-print" style="color: #3498db;"></i> Cetak Kartu Peserta
          </h4>
          <button onclick="closePrintCardModal()" class="modal-close-btn" title="Tutup">
              <i class="fas fa-times"></i>
          </button>
      </div>
      <div style="flex-grow: 1; width: 100%; position: relative; background-color: #fff;">
          <iframe id="printCardFrame" style="width: 100%; height: 100%; border: none;" title="Preview Cetak Kartu"></iframe>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, get, set } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, EmailAuthProvider, reauthenticateWithCredential, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    const allFirebaseConfigs = {
        '7ABC': { apiKey: "AIzaSyBAKwT7JY_HGnvK6h3u30-dfgRPXfef8l8", authDomain: "abc-a13ea.firebaseapp.com", projectId: "abc-a13ea", databaseURL: "https://abc-a13ea-default-rtdb.firebaseio.com", storageBucket: "abc-a13ea.firebasestorage.app", messagingSenderId: "1052966795599", appId: "1:1052966795599:web:d4d331199ca9081321ed3a" },
        '7DEF': { apiKey: "AIzaSyBkhBZw3oADXUAJ9FXY9-g7XBsSmQhzZVk", authDomain: "def-ab5ee.firebaseapp.com", projectId: "def-ab5ee", databaseURL: "https://def-ab5ee-default-rtdb.firebaseio.com", storageBucket: "def-ab5ee.firebasestorage.app", messagingSenderId: "129712840107", appId: "1:129712840107:web:ab10576fed95f735dd46ee" },
        '8ABC': { apiKey: "AIzaSyAwilwwwEJ2MAdSf09BotxNH-z6RiXaHXY", authDomain: "abc-43e73.firebaseapp.com", projectId: "abc-43e73", databaseURL: "https://abc-43e73-default-rtdb.firebaseio.com", storageBucket: "abc-43e73.firebasestorage.app", messagingSenderId: "1043754727577", appId: "1:1043754727577:web:56c3732bf2a6ac900c2008" },
        '8DEF': { apiKey: "AIzaSyBeCI57lmZ4-8DAKYJ7nvYjnXOfvy0vqrk", authDomain: "def-efcb2.firebaseapp.com", projectId: "def-efcb2", databaseURL: "https://def-efcb2-default-rtdb.firebaseio.com", storageBucket: "def-efcb2.firebasestorage.app", messagingSenderId: "12569956361", appId: "1:12569956361:web:fea36c4e034e65f33ba8d8" },
        '9ABC': { apiKey: "AIzaSyBZ6JR3ggnUiZFQ-wdrewbfhzMUwFaGGzQ", authDomain: "abc-d272a.firebaseapp.com", projectId: "abc-d272a", databaseURL: "https://abc-d272a-default-rtdb.firebaseio.com", storageBucket: "abc-d272a.firebasestorage.app", messagingSenderId: "1036605132828", appId: "1:1036605132828:web:2b59f91290d50afe304fd9" },
        '9DEF': { apiKey: "AIzaSyC2iwuDMWTaJIG8g464Wt0En3CXI2DZiz4", authDomain: "def-85f32.firebaseapp.com", projectId: "def-85f32", databaseURL: "https://def-85f32-default-rtdb.firebaseio.com", storageBucket: "def-85f32.firebasestorage.app", messagingSenderId: "82670626048", appId: "1:82670626048:web:f5fdfda8fe078245b6bfe5" },
        'SETUP': { apiKey: "AIzaSyBbXJ4VuACXyHJhl2eVSB2vHiT6hrx-XnE", authDomain: "setup-73809.firebaseapp.com", projectId: "setup-73809", databaseURL: "https://setup-73809-default-rtdb.firebaseio.com", storageBucket: "setup-73809.firebasestorage.app", messagingSenderId: "843995999446", appId: "1:843995999446:web:7fd92546f2d0bea73fed77" }
    };
    
    const appInstances = {};
    const authInstances = {}; 
    const dbInstances = {};
    
    for (const groupKey in allFirebaseConfigs) {
        if (allFirebaseConfigs.hasOwnProperty(groupKey)) {
            const config = allFirebaseConfigs[groupKey];
            const appInstance = initializeApp(config, groupKey);
            authInstances[groupKey] = getAuth(appInstance);
            dbInstances[groupKey] = getDatabase(appInstance);
        }
    }

    const gradeToDbGroupMap = {
        '7': ['7ABC', '7DEF'],
        '8': ['8ABC', '8DEF'],
        '9': ['9ABC', '9DEF']
    };

    const rombelToDbMap = {
        '7A': '7ABC', '7B': '7ABC', '7C': '7ABC', '7D': '7DEF', '7E': '7DEF', '7F': '7DEF',
        '8A': '8ABC', '8B': '8ABC', '8C': '8ABC', '8D': '8DEF', '8E': '8DEF', '8F': '8DEF',
        '9A': '9ABC', '9B': '9ABC', '9C': '9ABC', '9D': '9DEF', '9E': '9DEF', '9F': '9DEF'
    };

    const THIRTY_DAYS_IN_MS = 30 * 24 * 60 * 60 * 1000;
    const FIFTEEN_MINUTES_IN_MS = 15 * 60 * 1000;
    const ONE_WEEK_IN_MS = 7 * 24 * 60 * 60 * 1000;
    const VALID_ROMBELS = Object.keys(rombelToDbMap);
    const defaultLocationCoordinate = "-7.8589546,110.2655596";

    let isImporting = false;
    
    let bankSoalCache = {};
    let tokenCache = [];
    let studentCache = [];
    let tokenAccessStatus = {};
    let submittedExamsCache = {};
    let studentAnswersCache = {};
    let consolidatedTokensMap = new Map();
    let countdownIntervals = {};

    let currentConsolidatedTokenInfo = null;
    let currentStudentKey = null;
    let deleteStudentKey = null;
    let studentKeyForAction = null;
    let studentIdForAction = null;
    let studentNameForAction = null;
    let studentClassForAction = null;
    let currentTableIdToCopy = '';

    let selectedStatusKeys = new Set();
    let pendingBulkActionType = null; 
    let pendingBulkActionStudents = [];

    const SAVED_ACCOUNTS_KEY = 'examAdmin_saved_accounts_v1';

    let selectedItemsPerPage = parseInt(localStorage.getItem('selectedItemsPerPage') || '200', 10);
    let currentPageManagement = parseInt(localStorage.getItem('currentPageManagement') || '1', 10);
    let currentPageStatus = parseInt(localStorage.getItem('currentPageStatus') || '1', 10);
    let currentPageScore = parseInt(localStorage.getItem('currentPageScore') || '1', 10);

    let filteredStudentsManagement = [];
    let filteredStudentsStatus = [];
    let filteredScores = [];
    window.currentScoreGradeFilter = 'ALL';
    
    let isLocationEnabledAdmin = false;
    let allowedRadiusMeterAdmin = 75;
    let currentLocationKeyAdmin = ''; 
    let keyLastGeneratedAdmin = 0; 
    let isBlockKeyEnabledAdmin = false;
    let currentBlockKeyAdmin = "BUKA";
    let minSubmitDurationSecondsAdmin = 30 * 60; 
    let isMinDurationEnabledAdmin = false;
    let shuffleSettingsCache = { soal: true, pilgan: true };

    let publicSettingsCache = {
        kelas7: { enabled: false, url: '' },
        kelas8: { enabled: false, url: '' },
        kelas9: { enabled: false, url: '' },
        susulan: { enabled: false, list: {} }
    };

    const setupDbInstance = dbInstances['SETUP'];
    
    let lastSelectedTokens = { '7': 'DEFAULT', '8': 'DEFAULT', '9': 'DEFAULT' };
    
    const sidebar = document.getElementById('sidebar');
    const loginSection = document.getElementById('loginSection');
    const dashboardContent = document.getElementById('dashboardContent');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const highlightCardsContainer = document.getElementById('highlightCards');
    const progressCardsContainer = document.getElementById('progressCardsContainer');
    const tokenTableBody = document.getElementById('tokenTableBody');
    const studentTableBody = document.getElementById('studentTableBody');
    const studentStatusTableBody = document.getElementById('studentStatusTableBody');
    const studentTableContainer = document.getElementById('studentTableContainer');
    const studentStatusTableContainer = document.getElementById('studentStatusTableContainer');
    const studentStatusInitialMessage = document.getElementById('studentStatusInitialMessage');
    const scoreTableHeader = document.getElementById('scoreTableHeader');
    const scoreTableBody = document.getElementById('scoreTableBody');
    const scoreTableMessage = document.getElementById('scoreTableMessage');
    const locationSettingsTableBody = document.getElementById('locationSettingsTableBody');
    const blockKeySettingsTableBody = document.getElementById('blockKeySettingsTableBody');
    const minDurationSettingsTableBody = document.getElementById('minDurationSettingsTableBody'); 
    const shuffleSettingsTableBody = document.getElementById('shuffleSettingsTableBody');

    const studentPaginationDiv = document.getElementById('studentPagination');
    const studentStatusPaginationDiv = document.getElementById('studentStatusPagination');
    const scorePaginationDiv = document.getElementById('scorePagination');

    const grade7TokenSelect = document.getElementById('grade7TokenSelect');
    const grade8TokenSelect = document.getElementById('grade8TokenSelect');
    const grade9TokenSelect = document.getElementById('grade9TokenSelect');
    const activeButtonsInfoList = document.getElementById('activeButtonsInfoList');
    
    const floatingBulkActions = document.getElementById('floatingBulkActions');
    const selectedCountDisplay = document.getElementById('selectedCountDisplay');

    let currentConfirmAction = null; 

    const padStudentId = (id) => String(id).padStart(3, '0');
    const padRoomNumber = (room) => { if (!room) return '-'; const numRoom = parseInt(room, 10); return !isNaN(numRoom) ? String(numRoom).padStart(2, '0') : String(room).toUpperCase(); };
    const formatLocalDateTime = (date) => { const year = date.getFullYear(); const month = (date.getMonth() + 1).toString().padStart(2, '0'); const day = date.getDate().toString().padStart(2, '0'); const hours = date.getHours().toString().padStart(2, '0'); const minutes = date.getMinutes().toString().padStart(2, '0'); return `${year}-${month}-${day}T${hours}:${minutes}`; };
    const formatDisplayTime = (dateTimeString) => { if (!dateTimeString) return '-'; const date = new Date(dateTimeString); return date.toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' }); };
    const getNumericClass = (classString) => String(classString || '').match(/^(\d+)/)?.[1] || null;
    const getDbForClass = (classIdentifier) => { const numericClass = getNumericClass(classIdentifier); if (rombelToDbMap[classIdentifier]) { return dbInstances[rombelToDbMap[classIdentifier]]; } if (gradeToDbGroupMap[numericClass]) { return gradeToDbGroupMap[numericClass].map(dbName => dbInstances[dbName]); } console.error(`Instance database tidak ditemukan untuk identifier: ${classIdentifier}`); return null; };
    const escapeHtmlAttributeForJsString = (s) => String(s).replace(/&/g, '&amp;').replace(/'/g, '&#39;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&#x3E;');
    const showNotification = (message, isError = false) => { 
        const n = document.getElementById('notification');
        n.innerText = message; 
        n.className = isError ? 'notification error' : 'notification'; 
        n.style.display = 'block'; 
        setTimeout(() => { n.style.display = 'none'; }, 3000); 
    };

    function formatSecondsToHMS(totalSeconds) {
        if (totalSeconds < 0) totalSeconds = 0;
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function generateRandomKey(length) {
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        return result;
    }
    
    function initializeAppUI() {
        loginSection.style.display = 'none';
        sidebar.style.display = 'flex';
        dashboardContent.style.display = 'flex'; 
        document.body.style.flexDirection = 'row'; 
        document.body.style.alignItems = 'stretch';
        document.body.style.justifyContent = 'flex-start';
        showSection('dashboardSection');
    }
    
    onAuthStateChanged(authInstances['SETUP'], async (user) => {
        if (user) {
            loadingOverlay.style.display = 'flex';
            await loadAndSetBankSoalUrl();
            await loadAndSetPrintCardUrl();
            await loadOneTimeData();
            setupRealtimeListeners();
        } else {
            loginSection.style.display = 'block';
            dashboardContent.style.display = 'none';
            sidebar.style.display = 'none';
            loadingOverlay.style.display = 'none';
        }
    });

    async function loadAndSetBankSoalUrl() {
        try {
            const snapshot = await get(ref(setupDbInstance, 'adminbanksoal/url'));
            if (snapshot.exists()) {
                const url = snapshot.val();
                const iframe = document.getElementById('bankSoalFrame');
                if (iframe && url) {
                    iframe.src = url;
                }
            } else {
                console.log("URL Bank Soal tidak ditemukan di Firebase.");
            }
        } catch (error) {
            console.error("Gagal memuat URL Bank Soal:", error);
        }
    }
    
    async function loadAndSetPrintCardUrl() {
        const frame = document.getElementById('printCardFrame');
        const url = 'https://speropa.github.io/cetakkartu';
        if (frame) {
            frame.src = url;
        }
    }
    
    async function loadOneTimeData() {
        itemsPerPageSelect.value = selectedItemsPerPage;
        const oneTimePromises = [
            loadBankSoal(),
            loadSetlokasiSettings(),
            loadBlockKeySettings(),
            loadMinDurationSettings(),
            loadShuffleSettings(),
            loadLastSelectedTokens(),
            loadPublicSettings()
        ];
        await Promise.all(oneTimePromises);
    }
    
    function setupRealtimeListeners() {
        const dbNames = Object.keys(gradeToDbGroupMap).flatMap(grade => gradeToDbGroupMap[grade]);
        const totalInitialListeners = dbNames.length * 5; 
        let loadedListeners = 0;
        let initialLoadDone = false;

        let liveData = {
            tokens: {}, students: {}, access: {}, submitted: {}, answers: {}
        };
        
        const onDataReceived = () => {
            if (!initialLoadDone) {
                loadedListeners++;
                if (loadedListeners >= totalInitialListeners) {
                    initialLoadDone = true;
                    buildConsolidatedTokensMap();
                    initializeAppUI();
                    loadingOverlay.style.display = 'none';
                }
            } else {
                buildConsolidatedTokensMap();
                updateAllDependentUI();
            }
        };
        
        dbNames.forEach(dbName => {
            onValue(ref(dbInstances[dbName], 'tokens'), (snapshot) => {
                liveData.tokens[dbName] = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    data.key = child.key;
                    data.firebaseGroup = dbName;
                    if (data.createdAt && (Date.now() - data.createdAt) > THIRTY_DAYS_IN_MS) {
                        remove(ref(dbInstances[dbName], 'tokens/' + data.key));
                        return;
                    }
                    liveData.tokens[dbName].push(data);
                });
                tokenCache = Object.values(liveData.tokens).flat();
                onDataReceived();
            });

            onValue(ref(dbInstances[dbName], 'students'), (snapshot) => {
                liveData.students[dbName] = [];
                snapshot.forEach(child => {
                    liveData.students[dbName].push({ ...child.val(), key: child.key, firebaseGroup: dbName });
                });
                studentCache = Object.values(liveData.students).flat();
                onDataReceived();
            });

            onValue(ref(dbInstances[dbName], 'exam_access_status'), (snapshot) => {
                liveData.access[dbName] = snapshot.val() || {};
                tokenAccessStatus = Object.values(liveData.access).reduce((acc, val) => ({ ...acc, ...val }), {});
                onDataReceived();
            });

            onValue(ref(dbInstances[dbName], 'submitted_exams'), (snapshot) => {
                liveData.submitted[dbName] = snapshot.val() || {};
                submittedExamsCache = Object.values(liveData.submitted).reduce((acc, val) => ({ ...acc, ...val }), {});
                onDataReceived();
            });

            onValue(ref(dbInstances[dbName], 'student_answers'), (snapshot) => {
                liveData.answers[dbName] = snapshot.val() || {};
                studentAnswersCache = Object.values(liveData.answers).reduce((acc, val) => ({ ...acc, ...val }), {});
                onDataReceived();
            });
        });
    }

    function updateAllDependentUI() {
        const visibleSection = document.querySelector('#dashboardContent > .container[style*="display: block"], #dashboardContent > div > .container[style*="display: block"]');
        if (!visibleSection) return;
        
        updateDashboard();
        populateExamSelectionDropdowns();

        const actionMap = {
            'tokenSection': renderTokenTable,
            'studentStatusSection': () => renderStudentStatusTable(currentPageStatus),
            'studentSection': () => renderStudentManagementTable(currentPageManagement),
            'scoreSection': () => renderScoreTable(currentPageScore),
        };
        actionMap[visibleSection.id]?.();
    }
    
    function buildConsolidatedTokensMap() {
        consolidatedTokensMap.clear();
        tokenCache.forEach(tokenData => {
            const consolidatedKey = `${tokenData.token}_${tokenData.kelas}`;
            if (!consolidatedTokensMap.has(consolidatedKey)) {
                consolidatedTokensMap.set(consolidatedKey, { ...tokenData, firebaseKeys: new Set([tokenData.key]), firebaseGroups: new Set([tokenData.firebaseGroup]) });
            } else {
                const existing = consolidatedTokensMap.get(consolidatedKey);
                existing.firebaseKeys.add(tokenData.key);
                existing.firebaseGroups.add(tokenData.firebaseGroup);
                existing.isForceActive = existing.isForceActive || tokenData.isForceActive;
                existing.isActive = existing.isActive || tokenData.isActive;
            }
        });
    }

    window.login = async () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        const rememberAccount = document.getElementById("rememberAccount").checked;
        const loginError = document.getElementById("loginError");
        loginError.innerText = "";
        loadingOverlay.style.display = 'flex'; 

        try {
            await setPersistence(authInstances['SETUP'], inMemoryPersistence);
            await Promise.all(Object.values(authInstances).map(auth => signInWithEmailAndPassword(auth, email, password)));
            
            if (rememberAccount) {
                saveAccountToStorage(email, password);
            }

        } catch (error) {
            loginError.innerText = "Email atau password salah.";
            loadingOverlay.style.display = 'none'; 
        }
    };

    function saveAccountToStorage(email, password) {
        let accounts = JSON.parse(localStorage.getItem(SAVED_ACCOUNTS_KEY) || '[]');
        const existingIndex = accounts.findIndex(acc => acc.email === email);
        
        const encodedPass = btoa(password);

        if (existingIndex >= 0) {
            accounts[existingIndex].password = encodedPass;
            accounts[existingIndex].lastUsed = Date.now();
        } else {
            accounts.push({ email: email, password: encodedPass, lastUsed: Date.now() });
        }
        
        localStorage.setItem(SAVED_ACCOUNTS_KEY, JSON.stringify(accounts));
    }

    window.loadSavedAccounts = () => {
        const wrapper = document.getElementById('savedAccountsWrapper');
        const select = document.getElementById('savedAccountsSelect');
        const accounts = JSON.parse(localStorage.getItem(SAVED_ACCOUNTS_KEY) || '[]');

        if (accounts.length === 0) {
            if(wrapper) wrapper.style.display = 'none';
            return;
        }

        if(wrapper) wrapper.style.display = 'block';
        if(select) {
            select.innerHTML = '<option value="">-- Pilih Akun Tersimpan --</option>';
            
            accounts.sort((a, b) => b.lastUsed - a.lastUsed);

            accounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.email;
                option.innerText = acc.email;
                option.dataset.pass = acc.password;
                select.appendChild(option);
            });
        }
    };

    window.fillCredentialsFromSaved = () => {
        const select = document.getElementById('savedAccountsSelect');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        
        const selectedOption = select.options[select.selectedIndex];
        
        if (selectedOption && selectedOption.value) {
            emailInput.value = selectedOption.value;
            try {
                passwordInput.value = atob(selectedOption.dataset.pass);
            } catch (e) {
                console.error("Gagal decode password", e);
                passwordInput.value = "";
            }
        } else {
            emailInput.value = "";
            passwordInput.value = "";
        }
    };

    window.deleteSelectedAccount = () => {
        const select = document.getElementById('savedAccountsSelect');
        const emailToDelete = select.value;
        
        if (!emailToDelete) return;
        
        if (confirm(`Hapus akun tersimpan ${emailToDelete} dari perangkat ini?`)) {
            let accounts = JSON.parse(localStorage.getItem(SAVED_ACCOUNTS_KEY) || '[]');
            accounts = accounts.filter(acc => acc.email !== emailToDelete);
            localStorage.setItem(SAVED_ACCOUNTS_KEY, JSON.stringify(accounts));
            
            document.getElementById('email').value = "";
            document.getElementById('password').value = "";
            
            window.loadSavedAccounts();
        }
    };

    window.attachEventListeners = function() {
        document.getElementById('tokenSearchSubject').addEventListener('keyup', renderTokenTable);
        document.getElementById('scoreSearchName').addEventListener('keyup', () => renderScoreTable(1));
        document.getElementById('scoreSearchClass').addEventListener('keyup', () => renderScoreTable(1));
        document.getElementById('studentSearchId').addEventListener('keyup', () => renderStudentManagementTable(1));
        document.getElementById('studentSearchName').addEventListener('keyup', () => renderStudentManagementTable(1));
        document.getElementById('studentSearchClass').addEventListener('keyup', () => renderStudentManagementTable(1));
        document.getElementById('studentStatusSearchId').addEventListener('keyup', () => renderStudentStatusTable(1));
        document.getElementById('studentStatusSearchName').addEventListener('keyup', () => renderStudentStatusTable(1));
        document.getElementById('studentStatusSearchClass').addEventListener('keyup', () => renderStudentStatusTable(1));
        
        document.getElementById('addTokenForm').addEventListener('submit', handleAddToken);
        document.getElementById('modalForm').addEventListener('submit', handleEditToken);
        document.getElementById('addStudentForm').addEventListener('submit', handleAddStudent);
        
        document.getElementById('addKelas').addEventListener('change', (e) => populateTokenModalDropdowns('add', e.target.value));
        document.getElementById('addTahunAjaran').addEventListener('change', (e) => populateTokenModalDropdowns('add', document.getElementById('addKelas').value, e.target.value));
        document.getElementById('addUjianName').addEventListener('change', (e) => populateTokenModalDropdowns('add', document.getElementById('addKelas').value, document.getElementById('addTahunAjaran').value, e.target.value));
        document.getElementById('addMapel').addEventListener('change', () => displayBankSoalInfo('add'));

        document.getElementById('editKelas').addEventListener('change', (e) => populateTokenModalDropdowns('edit', e.target.value));
        document.getElementById('editTahunAjaran').addEventListener('change', (e) => populateTokenModalDropdowns('edit', document.getElementById('editKelas').value, e.target.value));
        document.getElementById('editUjianName').addEventListener('change', (e) => populateTokenModalDropdowns('edit', document.getElementById('editKelas').value, document.getElementById('editTahunAjaran').value, e.target.value));
        document.getElementById('editMapel').addEventListener('change', () => displayBankSoalInfo('edit'));

        window.loadSavedAccounts();

        const confirmationPasswordInputs = [
            { id: 'bulkActionPassword', action: window.confirmBulkAction },
            { id: 'deleteAnswerPassword', action: window.confirmDeleteAnswer },
            { id: 'emptyStudentsPassword', action: window.confirmEmptyStudents },
            { id: 'adminPasswordConfirmation', action: window.confirmEmptyTokens },
            { id: 'forceActivePassword', action: window.confirmForceActive },
            { id: 'restoreAdminPassword', action: window.checkRestoreAdminPassword }
        ];

        confirmationPasswordInputs.forEach(item => {
            const input = document.getElementById(item.id);
            if (input) {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); 
                        item.action(); 
                    }
                });
            }
        });

        document.body.addEventListener('click', function(e) {
            if (e.target.classList.contains('toggle-password')) {
                const input = e.target.previousElementSibling;
                if(input && (input.type === 'password' || input.type === 'text')) {
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    e.target.classList.toggle('fa-eye');
                    e.target.classList.toggle('fa-eye-slash');
                }
            }
        });

        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginButton = document.querySelector('#loginSection button');
        if (emailInput && passwordInput && loginButton) {
            emailInput.addEventListener('keydown', e => e.key === 'Enter' && (e.preventDefault(), passwordInput.focus()));
            passwordInput.addEventListener('keydown', e => e.key === 'Enter' && (e.preventDefault(), loginButton.click()));
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        itemsPerPageSelect.value = localStorage.getItem('selectedItemsPerPage') || '50';
        window.attachEventListeners(); 
    });
    
    window.showSection = (sectionId) => {
        document.querySelectorAll('#dashboardContent > .container, #dashboardContent > div > .container').forEach(s => s.style.display = 'none');
        document.getElementById(sectionId).style.display = 'block';

        if (sectionId === 'bankSoalSection') {
            document.getElementById(sectionId).style.display = 'flex';
        }

        document.querySelectorAll('.sidebar-nav button').forEach(b => b.classList.remove('active'));
        const activeBtn = document.querySelector(`.sidebar-nav button[data-section-id="${sectionId}"]`);
        if (activeBtn) activeBtn.classList.add('active');
        
        const actionMap = {
            'dashboardSection': updateDashboard,
            'bankSoalSection': () => {},
            'tokenSection': renderTokenTable,
            'rulesSection': () => { updateSetlokasiStatusDisplay(); renderBlockKeySettingsTable(); renderMinDurationSettingsTable(); renderShuffleSettingsTable(); },
            'setSelectClassSection': () => { renderPublicSettingsControls(); renderActiveButtonsInfo(); },
            'examStatusSelectionSection': populateExamSelectionDropdowns,
            'studentStatusSection': () => renderStudentStatusTable(currentPageStatus),
            'studentSection': () => renderStudentManagementTable(currentPageManagement),
            'scoreSection': () => { window.currentScoreGradeFilter = 'ALL'; renderScoreTable(currentPageScore); }
        };
        actionMap[sectionId]?.();
    };

    window.handleMenuClick = (buttonElement) => {
        const sectionId = buttonElement.dataset.sectionId;
        const action = buttonElement.dataset.action;
        if (action === 'promptLogout') {
            window.promptLogout();
        } else if (sectionId) {
            window.showSection(sectionId);
        }
    };
    
    function renderTokenTable() {
        tokenTableBody.innerHTML = '';
        let consolidatedTokens = Array.from(consolidatedTokensMap.values());
        const searchSubject = document.getElementById('tokenSearchSubject').value.trim().toUpperCase();
        if (searchSubject) {
            consolidatedTokens = consolidatedTokens.filter(token => token.subject.toUpperCase().includes(searchSubject));
        }
        consolidatedTokens.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
        
        consolidatedTokens.forEach((data, index) => {
            const row = document.createElement('tr');
            const studentsInClass = studentCache.filter(s => getNumericClass(s.class) === getNumericClass(data.kelas));
            let sudahSubmitCount = 0;
            let sudahAksesCount = 0;
            studentsInClass.forEach(student => {
                let hasAccessed = false;
                for (const fbKey of data.firebaseKeys) {
                    if (tokenAccessStatus[fbKey]?.[padStudentId(student.id)]) hasAccessed = true;
                    if (submittedExamsCache[fbKey]?.[padStudentId(student.id)]?.isSubmitted) {
                        sudahSubmitCount++;
                        break; 
                    }
                }
                if (hasAccessed) sudahAksesCount++;
            });
            const progresHtml = `Status Submit: <b>${sudahSubmitCount}/${sudahAksesCount}</b><br>Belum Login: <b>${studentsInClass.length - sudahAksesCount}</b>`;
            const isCurrentlyActive = data.isForceActive || data.isActive;
            const statusClass = isCurrentlyActive ? 'on' : 'off';
            const statusText = isCurrentlyActive ? 'ON' : 'OFF';
            const tokenDisplayHtml = `${data.token} <span class="token-status ${statusClass}" onclick="promptToggleForceActive('${escape(data.token)}', '${data.kelas}', ${isCurrentlyActive})">(${statusText})</span>`;
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td class="mapel-cell"><div class="subject-display">${escapeHtmlAttributeForJsString(data.subject)}</div></td>
                <td>${data.kelas}</td>
                <td>${tokenDisplayHtml}</td>
                <td class="time-cell">${formatDisplayTime(data.startTime)}</td>
                <td class="time-cell">${formatDisplayTime(data.endTime)}</td>
                <td class="duration-cell">${data.durationMinutes ? `${data.durationMinutes} menit` : '-'}</td>
                <td><div style="text-align: left; line-height: 1.5; font-size: 13px;">${progresHtml}</div></td>
                <td>
                    <div class="action-buttons-group">
                        <button class="icon-button edit" onclick="editTokenConsolidated('${escape(data.token)}', '${data.kelas}')" title="Edit Token"><i class="fas fa-edit"></i></button>
                        <button class="icon-button delete" onclick="promptDeleteConsolidated('${escape(data.token)}', '${data.kelas}')" title="Hapus Token"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </td>`;
            tokenTableBody.appendChild(row);
        });
    }

    async function reauthenticateAndExecute(password, errorElementId, actionFunction) {
        const user = authInstances['SETUP'].currentUser; 
        const errorElement = document.getElementById(errorElementId);
        errorElement.innerText = '';
        if (!user || !user.email) return errorElement.innerText = 'Sesi tidak valid. Silakan login ulang.';
        if (!password) return errorElement.innerText = 'Password diperlukan.';

        loadingOverlay.style.display = 'flex';
        try {
            await reauthenticateWithCredential(user, EmailAuthProvider.credential(user.email, password));
            await actionFunction();
        } catch (error) {
            errorElement.innerText = 'Password salah. Verifikasi gagal.';
        } finally {
            loadingOverlay.style.display = 'none';
        }
    }
    
    window.promptToggleForceActive = (token, kelas, isCurrentlyActive) => {
        const consolidatedToken = Array.from(consolidatedTokensMap.values()).find(t => t.token === unescape(token) && t.kelas === kelas);
        if (!consolidatedToken) return;
        currentConsolidatedTokenInfo = consolidatedToken;
        if (isCurrentlyActive) {
            document.getElementById('forceInactiveModal').style.display = 'flex';
        } else {
            document.getElementById('forceActivePassword').value = '';
            document.getElementById('forceActivePasswordError').innerText = '';
            document.getElementById('forceActiveModal').style.display = 'flex';
        }
    };
    
    window.confirmForceActive = async () => {
        const password = document.getElementById('forceActivePassword').value;
        await reauthenticateAndExecute(password, 'forceActivePasswordError', async () => {
            if (!currentConsolidatedTokenInfo) return;
            const updatePromises = [];
            for (const key of currentConsolidatedTokenInfo.firebaseKeys) {
                const token = tokenCache.find(t => t.key === key);
                if (token && dbInstances[token.firebaseGroup]) {
                    updatePromises.push(update(ref(dbInstances[token.firebaseGroup], `tokens/${key}`), { isForceActive: true, isActive: true }));
                }
            }
            await Promise.all(updatePromises);
            showNotification('Token diaktifkan secara paksa.');
            closeForceActiveModal();
        });
    };

    window.confirmForceInactive = async () => {
        if (!currentConsolidatedTokenInfo) return;
        loadingOverlay.style.display = 'flex';
        try {
            const updatePromises = [];
            for (const key of currentConsolidatedTokenInfo.firebaseKeys) {
                const token = tokenCache.find(t => t.key === key);
                if (token && dbInstances[token.firebaseGroup]) {
                    updatePromises.push(update(ref(dbInstances[token.firebaseGroup], `tokens/${key}`), { isForceActive: false }));
                }
            }
            await Promise.all(updatePromises);
            showNotification('Mode paksa dinonaktifkan.');
            periksaAndUpdateStatusToken();
        } catch(e) {
            showNotification('Gagal: ' + e.message, true);
        } finally {
            loadingOverlay.style.display = 'none';
            closeForceInactiveModal();
        }
    };
    
    async function handleAddToken(e) {
        e.preventDefault();
        const kelas = document.getElementById('addKelas').value;
        const tahunAjaran = document.getElementById('addTahunAjaran').value;
        const ujianName = document.getElementById('addUjianName').value;
        const subject = document.getElementById('addMapel').value;
        const token = document.getElementById('addToken').value.trim().toUpperCase();
        const startTime = document.getElementById('addStartTime').value;
        const endTime = document.getElementById('addEndTime').value;
        const errorMsg = document.getElementById('addErrorMsg');
        errorMsg.innerText = "";
        
        if (!kelas || !tahunAjaran || !ujianName || !subject || !token || !startTime || !endTime) {
            return errorMsg.innerText = "Semua field harus diisi!";
        }
        
        const startTimeObj = new Date(startTime);
        const endTimeObj = new Date(endTime);
        if (startTimeObj >= endTimeObj) return errorMsg.innerText = "Waktu buka harus sebelum waktu tutup!";
        
        if (tokenCache.some(item => item.token === token && getNumericClass(item.kelas) === getNumericClass(kelas))) {
            return errorMsg.innerText = "Token sudah ada untuk kelas ini!";
        }
        
        const targetDbs = getDbForClass(kelas);
        if (!targetDbs || targetDbs.length === 0) return errorMsg.innerText = "Konfigurasi DB tidak ditemukan untuk kelas ini.";

        loadingOverlay.style.display = 'flex';
        const durationMinutes = Math.round((endTimeObj.getTime() - startTimeObj.getTime()) / 60000);
        const data = { subject, kelas, token, tahunAjaran, ujianName, startTime, endTime, durationMinutes, createdAt: Date.now(), isActive: false, isForceActive: false };
        
        try {
            await Promise.all(targetDbs.map(db => push(ref(db, 'tokens'), data)));
            showNotification('Token berhasil ditambahkan!');
            closeAddTokenModal();
        } catch (err) {
            errorMsg.innerText = "Gagal menyimpan token: " + err.message;
        } finally {
            loadingOverlay.style.display = 'none';
        }
    }
    
    window.editTokenConsolidated = (baseToken, kelas) => {
        const token = Array.from(consolidatedTokensMap.values()).find(t => t.token === unescape(baseToken) && t.kelas === kelas);
        if (!token) return;
        currentConsolidatedTokenInfo = token;
        
        const modalPrefix = 'edit';
        document.getElementById(`${modalPrefix}Kelas`).value = token.kelas;
        document.getElementById(`${modalPrefix}Token`).value = token.token;
        document.getElementById(`${modalPrefix}StartTime`).value = token.startTime;
        document.getElementById(`${modalPrefix}EndTime`).value = token.endTime;
        document.getElementById(`${modalPrefix}ErrorMsg`).innerText = "";

        populateTokenModalDropdowns(modalPrefix, token.kelas, token.tahunAjaran, token.ujianName, token.subject);
        document.getElementById('editModal').style.display = 'flex';
    };

    async function handleEditToken(e) {
      e.preventDefault();
      const newKelas = document.getElementById('editKelas').value.trim();
      const tahunAjaran = document.getElementById('editTahunAjaran').value;
      const ujianName = document.getElementById('editUjianName').value;
      const subject = document.getElementById('editMapel').value;
      const token = document.getElementById('editToken').value.trim().toUpperCase();
      const startTime = document.getElementById('editStartTime').value;
      const endTime = document.getElementById('editEndTime').value;
      const errorMsg = document.getElementById('editErrorMsg');
      errorMsg.innerText = "";
      
      if (!newKelas || !tahunAjaran || !ujianName || !subject || !token || !startTime || !endTime) return errorMsg.innerText = "Semua field harus diisi!";
      
      const startTimeObj = new Date(startTime);
      const endTimeObj = new Date(endTime);
      if (startTimeObj >= endTimeObj) return errorMsg.innerText = "Waktu buka harus sebelum waktu tutup!";

      if (!currentConsolidatedTokenInfo) return errorMsg.innerText = "Error: Informasi token tidak ditemukan.";
      
      const oldKelas = currentConsolidatedTokenInfo.kelas;
      const oldToken = currentConsolidatedTokenInfo.token;
      
      if (tokenCache.some(item => item.token === token && item.kelas === newKelas && !(item.token === oldToken && item.kelas === oldKelas))) {
          return errorMsg.innerText = "Token sudah ada untuk kelas ini!";
      }

      loadingOverlay.style.display = 'flex';
      const durationMinutes = Math.round((endTimeObj.getTime() - startTimeObj.getTime()) / 60000);
      const updatedData = { ...currentConsolidatedTokenInfo, kelas: newKelas, tahunAjaran, ujianName, subject, token, startTime, endTime, durationMinutes };
      delete updatedData.firebaseKeys;
      delete updatedData.firebaseGroups;
      
      try {
          if (oldKelas !== newKelas || oldToken !== token) {
              const deletePromises = Array.from(currentConsolidatedTokenInfo.firebaseKeys).flatMap(fbKey => {
                  const t = tokenCache.find(tok => tok.key === fbKey);
                  return t ? [remove(ref(dbInstances[t.firebaseGroup], `tokens/${fbKey}`))] : [];
              });
              await Promise.all(deletePromises);
              const newTargetDbs = getDbForClass(newKelas);
              await Promise.all(newTargetDbs.map(db => push(ref(db, 'tokens'), updatedData)));
              showNotification(`Token berhasil dipindahkan ke kelas ${newKelas}!`);
          } else {
              const updatePromises = Array.from(currentConsolidatedTokenInfo.firebaseKeys).map(fbKey => {
                  const t = tokenCache.find(item => item.key === fbKey);
                  return t ? update(ref(dbInstances[t.firebaseGroup], `tokens/${fbKey}`), updatedData) : Promise.resolve();
              });
              await Promise.all(updatePromises);
              showNotification('Token berhasil diedit!');
          }
          closeEditModal();
      } catch (err) {
          errorMsg.innerText = "Gagal menyimpan: " + err.message;
      } finally {
          loadingOverlay.style.display = 'none';
      }
    }

    window.promptDeleteConsolidated = (baseToken, kelas) => {
        const token = Array.from(consolidatedTokensMap.values()).find(t => t.token === unescape(baseToken) && t.kelas === kelas);
        if (!token) return;
        currentConsolidatedTokenInfo = token;
        document.getElementById('deleteModal').style.display = 'flex';
    };

    window.confirmDelete = async () => {
        if (!currentConsolidatedTokenInfo) return;
        loadingOverlay.style.display = 'flex';
        try {
            const deletePromises = Array.from(currentConsolidatedTokenInfo.firebaseKeys).flatMap(fbKey => {
                const t = tokenCache.find(tok => tok.key === fbKey);
                return t ? [
                    remove(ref(dbInstances[t.firebaseGroup], `tokens/${fbKey}`)),
                    remove(ref(dbInstances[t.firebaseGroup], `exam_access_status/${fbKey}`)),
                    remove(ref(dbInstances[t.firebaseGroup], `submitted_exams/${fbKey}`)),
                    remove(ref(dbInstances[t.firebaseGroup], `student_answers/${fbKey}`))
                ] : [];
            });
            await Promise.all(deletePromises);
            showNotification('Token dan semua data terkait berhasil dihapus!');
        } catch (err) {
            showNotification("Gagal menghapus: " + err.message, true);
        } finally {
            loadingOverlay.style.display = 'none';
            closeDeleteModal();
        }
    };
    
    window.renderStudentManagementTable = function(page = 1) {
        currentPageManagement = page;
        localStorage.setItem('currentPageManagement', currentPageManagement);
        
        // UPDATE: Sorting Logic
        let studentsToDisplay = [...studentCache].sort((a,b) => {
            const classComparison = a.class.toString().localeCompare(b.class.toString(), undefined, {numeric: true, sensitivity: 'base'});
            if (classComparison !== 0) return classComparison;
            return a.name.toString().localeCompare(b.name.toString(), undefined, {sensitivity: 'base'});
        });
        
        const searchId = document.getElementById('studentSearchId').value.trim();
        if (searchId) studentsToDisplay = studentsToDisplay.filter(s => s.id.includes(searchId));
        const searchName = document.getElementById('studentSearchName').value.trim().toUpperCase();
        if (searchName) studentsToDisplay = studentsToDisplay.filter(s => s.name.toUpperCase().includes(searchName));
        const searchClass = document.getElementById('studentSearchClass').value.trim().toUpperCase();
        if (searchClass) studentsToDisplay = studentsToDisplay.filter(s => s.class.toUpperCase().includes(searchClass));
        
        filteredStudentsManagement = studentsToDisplay;
        
        const totalPages = Math.ceil(filteredStudentsManagement.length / selectedItemsPerPage);
        const studentsForPage = filteredStudentsManagement.slice((page - 1) * selectedItemsPerPage, page * selectedItemsPerPage);
        
        studentTableBody.innerHTML = '';
        studentsForPage.forEach((student, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${(page - 1) * selectedItemsPerPage + index + 1}</td>
                <td>${student.id}</td>
                <td>${student.name}</td>
                <td>${student.class}</td>
                <td>${padRoomNumber(student.room)}</td>
                <td>
                    <div class="action-buttons-group">
                        <button class="icon-button edit" onclick="openEditStudentModal('${student.key}')" title="Edit Data Siswa"><i class="fas fa-edit"></i></button>
                        <button class="icon-button delete" onclick="openDeleteStudentConfirmModal('${student.key}')" title="Hapus Siswa"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </td>`;
            studentTableBody.appendChild(row);
        });
        
        renderPaginationControls(studentPaginationDiv, page, totalPages, 'renderStudentManagementTable');
    }

    window.renderStudentStatusTable = function(page = 1) {
        currentPageStatus = page;
        localStorage.setItem('currentPageStatus', currentPageStatus);
    
        const tokenKeysForDisplay = [];
        let anySelected = false;
        Object.values(lastSelectedTokens).forEach(id => {
            if (id !== 'DEFAULT') {
                anySelected = true;
                const [token, kelas] = id.split('_');
                const consolidated = Array.from(consolidatedTokensMap.values()).find(t => t.token === token && t.kelas === kelas);
                if (consolidated) tokenKeysForDisplay.push(...Array.from(consolidated.firebaseKeys));
            }
        });

        if (!anySelected) {
            studentStatusInitialMessage.style.display = 'block';
            studentStatusTableContainer.style.display = 'none';
            studentStatusPaginationDiv.innerHTML = '';
            if(floatingBulkActions) floatingBulkActions.classList.remove('visible');
            return;
        }

        studentStatusInitialMessage.style.display = 'none';
        studentStatusTableContainer.style.display = 'block';
    
        let studentsToDisplay = studentCache.filter(student => {
            const studentGrade = getNumericClass(student.class);
            return tokenCache.some(tc => tokenKeysForDisplay.includes(tc.key) && getNumericClass(tc.kelas) === studentGrade);
        });
    
        const searchId = document.getElementById('studentStatusSearchId').value.trim();
        if (searchId) studentsToDisplay = studentsToDisplay.filter(s => s.id.includes(searchId));
        const searchName = document.getElementById('studentStatusSearchName').value.trim().toUpperCase();
        if (searchName) studentsToDisplay = studentsToDisplay.filter(s => s.name.toUpperCase().includes(searchName));
        const searchClass = document.getElementById('studentStatusSearchClass').value.trim().toUpperCase();
        if (searchClass) studentsToDisplay = studentsToDisplay.filter(s => s.class.toUpperCase().includes(searchClass));
        
        // UPDATE: Sorting Logic
        studentsToDisplay.sort((a,b) => {
            const classComparison = a.class.toString().localeCompare(b.class.toString(), undefined, {numeric: true, sensitivity: 'base'});
            if (classComparison !== 0) return classComparison;
            return a.name.toString().localeCompare(b.name.toString(), undefined, {sensitivity: 'base'});
        });
        
        filteredStudentsStatus = studentsToDisplay; 
    
        const totalPages = Math.ceil(filteredStudentsStatus.length / selectedItemsPerPage);
        const studentsForPage = filteredStudentsStatus.slice((page - 1) * selectedItemsPerPage, page * selectedItemsPerPage);
    
        studentStatusTableBody.innerHTML = '';
        
        const allSelected = studentsForPage.length > 0 && studentsForPage.every(s => selectedStatusKeys.has(s.key));
        const selectAllCheckbox = document.getElementById('selectAllStatus');
        if(selectAllCheckbox) selectAllCheckbox.checked = allSelected;
        updateBulkControlVisibility();

        studentsForPage.forEach((student, index) => {
            const row = document.createElement('tr');
            let status = 'Belum Login';
            const studentIdPadded = padStudentId(student.id);
            let isLoggedInAny = false, isSubmittedAny = false, hasAccessedAny = false;

            tokenKeysForDisplay.forEach(fbKey => {
                const accessData = tokenAccessStatus[fbKey]?.[studentIdPadded];
                if (submittedExamsCache[fbKey]?.[studentIdPadded]?.isSubmitted) isSubmittedAny = true;
                if (accessData?.isLoggedIn) isLoggedInAny = true;
                if (accessData?.accessCount > 0) hasAccessedAny = true;
            });
            
            if (isSubmittedAny) status = 'Sudah submit';
            else if (isLoggedInAny) status = 'Sedang mengerjakan';
            else if (hasAccessedAny) status = 'Belum Login (reset)';
            
            const statusColor = {'Sudah submit': '#27ae60', 'Sedang mengerjakan': '#f39c12', 'Belum Login (reset)': '#8e44ad', 'Belum Login': '#e74c3c'}[status] || 'black';
            const statusCellHtml = `<td style="color: ${statusColor}; font-weight: bold;">${status}</td>`;
            
            const isWorking = status === 'Sedang mengerjakan';
            const isSubmitted = status === 'Sudah submit';
            const isResetStatus = status === 'Belum Login (reset)';

            const resetDisabled = !isWorking;
            const submitDisabled = !(isWorking || isResetStatus);
            const deleteDisabled = !isSubmitted;

            const actionButtonsHtml = `
                <button class="icon-button reset" onclick="promptResetStudent('${student.key}', '${student.id}', '${escape(student.name)}', '${student.class}')" title="Reset Status Login" ${resetDisabled ? 'disabled' : ''}><i class="fas fa-redo"></i></button>
                <button class="icon-button submit" onclick="promptSubmitAnswer('${student.key}', '${student.id}', '${escape(student.name)}', '${student.class}')" title="Kirim Jawaban Manual" ${submitDisabled ? 'disabled' : ''}><i class="fas fa-paper-plane"></i></button>
                <button class="icon-button erase" onclick="promptDeleteAnswer('${student.key}', '${student.id}', '${escape(student.name)}', '${student.class}')" title="Hapus Jawaban" ${deleteDisabled ? 'disabled' : ''}><i class="fas fa-eraser"></i></button>`;

            const isChecked = selectedStatusKeys.has(student.key);

            row.innerHTML = `
                <td style="text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                        <input type="checkbox" class="status-checkbox" value="${student.key}" style="margin: 0; width: 16px; height: 16px;" ${isChecked ? 'checked' : ''} onchange="toggleStudentStatusSelection('${student.key}')">
                        <span>${(page - 1) * selectedItemsPerPage + index + 1}</span>
                    </div>
                </td>
                <td>${student.id}</td>
                <td>${student.name}</td>
                <td>${student.class}</td>
                <td>${padRoomNumber(student.room)}</td>
                ${statusCellHtml}
                <td><div class="action-buttons-group">${actionButtonsHtml}</div></td>`;
            studentStatusTableBody.appendChild(row);
        });
        
        renderPaginationControls(studentStatusPaginationDiv, page, totalPages, 'renderStudentStatusTable');
    }

    window.toggleStudentStatusSelection = (key) => {
        if (selectedStatusKeys.has(key)) {
            selectedStatusKeys.delete(key);
        } else {
            selectedStatusKeys.add(key);
        }
        updateBulkControlVisibility();
        
        const selectAllCheckbox = document.getElementById('selectAllStatus');
        if (selectAllCheckbox) {
             const studentsForPage = filteredStudentsStatus.slice((currentPageStatus - 1) * selectedItemsPerPage, currentPageStatus * selectedItemsPerPage);
             const allSelected = studentsForPage.length > 0 && studentsForPage.every(s => selectedStatusKeys.has(s.key));
             selectAllCheckbox.checked = allSelected;
        }
    };

    window.toggleSelectAllStatus = (checkbox) => {
        const isChecked = checkbox.checked;
        const studentsForPage = filteredStudentsStatus.slice((currentPageStatus - 1) * selectedItemsPerPage, currentPageStatus * selectedItemsPerPage);
        
        studentsForPage.forEach(student => {
            if (isChecked) {
                selectedStatusKeys.add(student.key);
            } else {
                selectedStatusKeys.delete(student.key);
            }
        });
        updateBulkControlVisibility();
        renderStudentStatusTable(currentPageStatus);
    };

    window.clearSelection = () => {
        selectedStatusKeys.clear();
        updateBulkControlVisibility();
        renderStudentStatusTable(currentPageStatus);
    };

    function updateBulkControlVisibility() {
        if (selectedStatusKeys.size > 0) {
            floatingBulkActions.classList.add('visible');
            selectedCountDisplay.innerText = `${selectedStatusKeys.size} Terpilih`;
        } else {
            floatingBulkActions.classList.remove('visible');
        }
    }

    window.initiateBulkReset = () => {
        prepareBulkAction('RESET'); 
    };

    window.initiateBulkSubmit = () => {
        prepareBulkAction('SUBMIT'); 
    };

    window.initiateBulkDelete = () => {
        prepareBulkAction('DELETE'); 
    };

    function prepareBulkAction(actionType) {
        pendingBulkActionType = actionType;
        pendingBulkActionStudents = [];

        const tokenKeysForDisplay = [];
        Object.values(lastSelectedTokens).forEach(id => {
            if (id !== 'DEFAULT') {
                const [token, kelas] = id.split('_');
                const consolidated = Array.from(consolidatedTokensMap.values()).find(t => t.token === token && t.kelas === kelas);
                if (consolidated) tokenKeysForDisplay.push(...Array.from(consolidated.firebaseKeys));
            }
        });

        selectedStatusKeys.forEach(studentKey => {
            const student = studentCache.find(s => s.key === studentKey);
            if (!student) return;

            let status = 'Belum Login';
            const studentIdPadded = padStudentId(student.id);
            let isLoggedInAny = false, isSubmittedAny = false, hasAccessedAny = false;

            tokenKeysForDisplay.forEach(fbKey => {
                const token = tokenCache.find(t => t.key === fbKey);
                if(token && getNumericClass(token.kelas) === getNumericClass(student.class)) {
                    const accessData = tokenAccessStatus[fbKey]?.[studentIdPadded];
                    if (submittedExamsCache[fbKey]?.[studentIdPadded]?.isSubmitted) isSubmittedAny = true;
                    if (accessData?.isLoggedIn) isLoggedInAny = true;
                    if (accessData?.accessCount > 0) hasAccessedAny = true;
                }
            });

            if (isSubmittedAny) status = 'Sudah submit';
            else if (isLoggedInAny) status = 'Sedang mengerjakan';
            else if (hasAccessedAny) status = 'Belum Login (reset)';

            let isValid = false;
            
            if (actionType === 'RESET') {
                if (status === 'Sedang mengerjakan') isValid = true;
            } 
            else if (actionType === 'SUBMIT') {
                if (status === 'Sedang mengerjakan' || status === 'Belum Login (reset)') isValid = true;
            } 
            else if (actionType === 'DELETE') {
                if (status === 'Sudah submit') isValid = true;
            }

            if (isValid) {
                pendingBulkActionStudents.push({
                    student: student,
                    status: status
                });
            }
        });

        if (pendingBulkActionStudents.length === 0) {
            let requiredStatusMsg = '';
            if (actionType === 'RESET') requiredStatusMsg = "'Sedang mengerjakan'";
            if (actionType === 'SUBMIT') requiredStatusMsg = "'Sedang mengerjakan' atau 'Belum Login (reset)'";
            if (actionType === 'DELETE') requiredStatusMsg = "'Sudah submit'";

            showNotification(`Tidak ada siswa terpilih yang memenuhi syarat (Status harus: ${requiredStatusMsg}).`, true);
            return;
        }

        let title = '';
        let statusColor = '';
        
        if (actionType === 'RESET') {
            title = 'Reset Login Massal';
            statusColor = '#f39c12'; 
        } else if (actionType === 'SUBMIT') {
            title = 'Kirim Jawaban Massal';
            statusColor = '#27ae60'; 
        } else {
            title = 'Hapus Jawaban Massal';
            statusColor = '#e74c3c'; 
        }

        const message = `Anda akan melakukan <b>${title}</b>. <br>Dari <b>${selectedStatusKeys.size}</b> siswa yang dipilih, hanya <b>${pendingBulkActionStudents.length}</b> siswa yang memenuhi syarat.`;
        
        document.getElementById('bulkActionTitle').innerText = title;
        document.getElementById('bulkActionMessage').innerHTML = message;
        
        const tbody = document.getElementById('bulkActionTableBody');
        tbody.innerHTML = '';
        pendingBulkActionStudents.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.student.id}</td>
                <td>${item.student.name}</td>
                <td>${item.student.class}</td>
                <td style="color: ${statusColor}; font-weight: bold;">${item.status}</td>
            `;
            tbody.appendChild(row);
        });

        const passwordContainer = document.getElementById('bulkActionPasswordContainer');
        const passwordInput = document.getElementById('bulkActionPassword');
        const passwordError = document.getElementById('bulkActionPasswordError');
        
        passwordInput.value = '';
        passwordError.innerText = '';

        if (actionType === 'DELETE') {
            passwordContainer.style.display = 'block';
        } else {
            passwordContainer.style.display = 'none';
        }

        document.getElementById('bulkActionModal').style.display = 'flex';
    }

    window.closeBulkActionModal = () => {
        document.getElementById('bulkActionModal').style.display = 'none';
        pendingBulkActionType = null;
        pendingBulkActionStudents = [];
        document.getElementById('bulkActionPasswordContainer').style.display = 'none';
    };

    window.confirmBulkAction = async () => {
        if (!pendingBulkActionType || pendingBulkActionStudents.length === 0) return;
        
        if (pendingBulkActionType === 'DELETE') {
            const password = document.getElementById('bulkActionPassword').value;
            const errorElement = document.getElementById('bulkActionPasswordError');
            errorElement.innerText = '';
            
            if (!password) {
                errorElement.innerText = 'Password diperlukan untuk menghapus data.';
                return;
            }

            loadingOverlay.style.display = 'flex';
            try {
                const user = authInstances['SETUP'].currentUser;
                await reauthenticateWithCredential(user, EmailAuthProvider.credential(user.email, password));
            } catch (error) {
                loadingOverlay.style.display = 'none';
                errorElement.innerText = 'Password salah. Verifikasi gagal.';
                return;
            }
        } else {
            loadingOverlay.style.display = 'flex';
        }

        try {
            const updates = {};

            const tokenKeysForDisplay = [];
             Object.values(lastSelectedTokens).forEach(id => {
                if (id !== 'DEFAULT') {
                    const [token, kelas] = id.split('_');
                    const consolidated = Array.from(consolidatedTokensMap.values()).find(t => t.token === token && t.kelas === kelas);
                    if (consolidated) tokenKeysForDisplay.push(...Array.from(consolidated.firebaseKeys));
                }
            });

            pendingBulkActionStudents.forEach(item => {
                const studentIdPadded = padStudentId(item.student.id);
                
                const relevantFbKeys = tokenKeysForDisplay.filter(fbKey => {
                     const token = tokenCache.find(t => t.key === fbKey);
                     return token && getNumericClass(token.kelas) === getNumericClass(item.student.class);
                });

                relevantFbKeys.forEach(fbKey => {
                    const group = tokenCache.find(t => t.key === fbKey)?.firebaseGroup;
                    if(group) {
                        if (pendingBulkActionType === 'RESET') {
                            updates[`${group}/exam_access_status/${fbKey}/${studentIdPadded}/isLoggedIn`] = false;
                        
                        } else if (pendingBulkActionType === 'SUBMIT') {
                            updates[`${group}/submitted_exams/${fbKey}/${studentIdPadded}`] = { isSubmitted: true, timestamp: Date.now() };
                            updates[`${group}/exam_access_status/${fbKey}/${studentIdPadded}/isLoggedIn`] = false;
                        
                        } else if (pendingBulkActionType === 'DELETE') {
                            updates[`${group}/submitted_exams/${fbKey}/${studentIdPadded}`] = null;
                            updates[`${group}/student_answers/${fbKey}/${studentIdPadded}`] = null;
                            updates[`${group}/exam_access_status/${fbKey}/${studentIdPadded}`] = null;
                        }
                    }
                });
            });

             const promises = Object.keys(updates).map(path => {
                const [group, ...rest] = path.split('/');
                const db = dbInstances[group];
                if(db) return update(ref(db), { [rest.join('/')]: updates[path] });
                return Promise.resolve();
            });

            await Promise.all(promises);
            showNotification(`Aksi massal berhasil dilakukan pada ${pendingBulkActionStudents.length} siswa.`);
            
            selectedStatusKeys.clear();
            updateBulkControlVisibility();
            renderStudentStatusTable(currentPageStatus);

        } catch (error) {
            showNotification("Gagal melakukan aksi massal: " + error.message, true);
        } finally {
            loadingOverlay.style.display = 'none';
            closeBulkActionModal();
        }
    };

    function renderPaginationControls(container, currentPage, totalPages, renderFunction) {
        container.innerHTML = '';
        if (totalPages <= 1) return;
        const prevButton = document.createElement('button');
        prevButton.innerText = 'Sebelumnya';
        prevButton.disabled = currentPage === 1;
        prevButton.onclick = () => window[renderFunction](currentPage - 1);
        container.appendChild(prevButton);
        container.appendChild(document.createElement('span')).innerText = `Halaman ${currentPage} dari ${totalPages}`;
        const nextButton = document.createElement('button');
        nextButton.innerText = 'Berikutnya';
        nextButton.disabled = currentPage === totalPages;
        nextButton.onclick = () => window[renderFunction](currentPage + 1);
        container.appendChild(nextButton);
    }

    window.updateItemsPerPage = (value) => {
        selectedItemsPerPage = parseInt(value, 10);
        localStorage.setItem('selectedItemsPerPage', selectedItemsPerPage);
        renderStudentManagementTable(1);
        renderStudentStatusTable(1);
        renderScoreTable(1);
    };

    async function handleAddStudent(e) {
        e.preventDefault();
        const id = document.getElementById('newStudentId').value.trim();
        const name = document.getElementById('newStudentName').value.trim().toUpperCase().replace(/'/g, '');
        const studentClass = document.getElementById('newStudentClass').value.trim().toUpperCase();
        const room = document.getElementById('newStudentRoom').value.trim();
        const errorMsg = document.getElementById('addStudentErrorMsg');
        errorMsg.innerText = "";
        
        if (!VALID_ROMBELS.includes(studentClass)) return errorMsg.innerText = "Kelas tidak valid.";
        const targetDb = getDbForClass(studentClass);
        if (!targetDb || Array.isArray(targetDb)) return errorMsg.innerText = "Konfigurasi DB tidak lengkap.";
        if (!/^\d+$/.test(id)) return errorMsg.innerText = "ID Siswa harus angka!";
        
        const paddedId = padStudentId(id);
        if (studentCache.some(s => s.id === paddedId && s.firebaseGroup === rombelToDbMap[studentClass])) return errorMsg.innerText = "ID Siswa sudah ada.";
        
        const data = { id: paddedId, name, class: studentClass, room: padRoomNumber(room) };
        try {
            await push(ref(targetDb, 'students'), data);
            showNotification('Siswa berhasil ditambahkan.');
            closeAddStudentModal();
        } catch (error) {
            errorMsg.innerText = "Gagal: " + error.message;
        }
    }

    window.openEditStudentModal = (key) => {
        const student = studentCache.find(s => s.key === key);
        if (!student) return;
        currentStudentKey = key;
        document.getElementById('modalStudentId').value = student.id;
        document.getElementById('modalStudentName').value = student.name;
        document.getElementById('modalStudentClass').value = student.class;
        document.getElementById('modalStudentRoom').value = student.room || '';
        document.getElementById('editStudentErrorMsg').innerText = "";
        document.getElementById('editStudentModal').style.display = 'flex';
    };

    window.confirmEditStudent = async () => {
        const id = document.getElementById('modalStudentId').value.trim();
        const name = document.getElementById('modalStudentName').value.trim().toUpperCase().replace(/'/g, '');
        const newClass = document.getElementById('modalStudentClass').value.trim().toUpperCase();
        const room = document.getElementById('modalStudentRoom').value.trim();
        const errorMsg = document.getElementById('editStudentErrorMsg');
        errorMsg.innerText = "";

        if (!VALID_ROMBELS.includes(newClass)) return errorMsg.innerText = "Kelas tidak valid.";
        const originalStudent = studentCache.find(s => s.key === currentStudentKey);
        if (!originalStudent) return errorMsg.innerText = "Data siswa asli tidak ditemukan.";
        
        const oldDb = getDbForClass(originalStudent.class);
        const newDb = getDbForClass(newClass);
        if (!oldDb || Array.isArray(oldDb) || !newDb || Array.isArray(newDb)) return errorMsg.innerText = "Konfigurasi DB tidak lengkap.";
        
        const paddedId = padStudentId(id);
        if (studentCache.some(s => s.id === paddedId && s.key !== currentStudentKey && s.firebaseGroup === rombelToDbMap[newClass])) return errorMsg.innerText = "ID Siswa sudah ada.";
        
        loadingOverlay.style.display = 'flex';
        const updatedData = { id: paddedId, name, class: newClass, room: padRoomNumber(room) };
        try {
            if (oldDb.app.name !== newDb.app.name) {
                await remove(ref(oldDb, 'students/' + currentStudentKey));
                await push(ref(newDb, 'students'), updatedData);
                showNotification(`Siswa dipindahkan ke kelas ${newClass}!`);
            } else {
                await update(ref(newDb, 'students/' + currentStudentKey), updatedData);
                showNotification('Data siswa diperbarui.');
            }
            closeEditStudentModal();
        } catch (error) {
            errorMsg.innerText = "Gagal: " + error.message;
        } finally {
            loadingOverlay.style.display = 'none';
        }
    };
    
    window.onclick = (event) => { if (event.target.classList.contains('modal')) event.target.style.display = 'none'; };
    window.openAddTokenModal = () => { document.getElementById('addTokenForm').reset(); populateTokenModalDropdowns('add'); document.getElementById('addTokenModal').style.display = 'flex'; };
    window.closeAddTokenModal = () => document.getElementById('addTokenModal').style.display = 'none';
    window.openAddStudentModal = () => { document.getElementById('addStudentForm').reset(); document.getElementById('addStudentModal').style.display = 'flex'; };
    window.closeAddStudentModal = () => document.getElementById('addStudentModal').style.display = 'none';
    window.closeEditModal = () => document.getElementById('editModal').style.display = 'none';
    window.closeDeleteModal = () => document.getElementById('deleteModal').style.display = 'none';
    window.closeForceActiveModal = () => document.getElementById('forceActiveModal').style.display = 'none';
    window.closeForceInactiveModal = () => document.getElementById('forceInactiveModal').style.display = 'none';
    window.closeAccessDetailModal = () => document.getElementById('accessDetailModal').style.display = 'none';
    window.closeEditStudentModal = () => { document.getElementById('editStudentModal').style.display = 'none'; currentStudentKey = null; };
    window.closeDeleteStudentConfirmModal = () => { document.getElementById('deleteStudentConfirmModal').style.display = 'none'; deleteStudentKey = null; };
    window.openImportStudentModal = () => { document.getElementById('importStudentModal').style.display = 'flex'; document.getElementById('csvFileInput').value = ''; document.getElementById('importFileError').innerText = 'Pilih file CSV.'; };
    window.closeImportStudentModal = () => document.getElementById('importStudentModal').style.display = 'none';
    window.closeImportResultModal = () => document.getElementById('importResultModal').style.display = 'none';
    window.openEmptyStudentsModal = () => { document.getElementById('emptyStudentsPassword').value = ''; document.getElementById('emptyStudentsPasswordError').innerText = ''; document.getElementById('emptyStudentsModal').style.display = 'flex'; };
    window.closeEmptyStudentsModal = () => document.getElementById('emptyStudentsModal').style.display = 'none';
    window.promptLogout = () => document.getElementById('logoutConfirmModal').style.display = 'flex';
    window.closeLogoutModal = () => document.getElementById('logoutConfirmModal').style.display = 'none';
    window.confirmLogout = () => { 
        sidebar.style.display = 'none';
        Promise.all(Object.values(authInstances).map(auth => signOut(auth)))
            .finally(() => { localStorage.clear(); location.reload(); });
    };
    window.closeResetStudentModal = () => { document.getElementById('resetStudentModal').style.display = 'none'; studentKeyForAction = null; };
    window.closeSubmitAnswerModal = () => { document.getElementById('submitAnswerModal').style.display = 'none'; studentKeyForAction = null; };
    window.closeDeleteAnswerModal = () => { document.getElementById('deleteAnswerModal').style.display = 'none'; studentKeyForAction = null; };
    
    window.closePrintCardModal = () => {
        document.getElementById('printCardModal').style.display = 'none';
    };

    window.openPrintCardModal = () => {
        document.getElementById('printCardModal').style.display = 'flex';
    };
    
    window.showPrintInfoModal = () => window.open('https://speropa.github.io/cetakkartu', '_blank');

    window.openCopyPrintModal = (tableId, modalTitle) => { currentTableIdToCopy = tableId; document.getElementById('copyPrintModalTitle').innerText = modalTitle; document.getElementById('copyPrintModal').style.display = 'flex'; };
    window.closeCopyPrintModal = () => { document.getElementById('copyPrintModal').style.display = 'none'; };
    
    window.copyTableToClipboard = () => {
        let textToCopy = '';
        if (currentTableIdToCopy === 'tokenTable') {
            const header = `NO\tMAPEL\tKELAS\tTOKEN\tDIBUKA\tDITUTUP\tDURASI\n`;
            let body = '';
            let consolidatedTokens = Array.from(consolidatedTokensMap.values()).sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
            consolidatedTokens.forEach((data, index) => {
                body += `${index + 1}\t${data.subject}\t${data.kelas}\t${data.token}\t${formatDisplayTime(data.startTime)}\t${formatDisplayTime(data.endTime)}\t${data.durationMinutes} menit\n`;
            });
            textToCopy = header + body;
        } else if (currentTableIdToCopy === 'scoreTable') {
            let studentsForCopy = filteredScores;
            const relevantTokens = tokenCache.filter(t => getNumericClass(t.kelas) === window.currentScoreGradeFilter);
            const subjects = [...new Set(relevantTokens.map(t => t.subject))].sort();
            let header = `NO\tNAMA SISWA\tKELAS${subjects.map(s => `\t${generateAbbreviation(s)}`).join('')}\n`;
            let body = '';
            studentsForCopy.forEach((student, index) => {
                let rowData = `${index + 1}\t${student.name}\t${student.class}`;
                subjects.forEach(subject => {
                    let score = '-';
                    const tokenInfo = Array.from(consolidatedTokensMap.values()).find(t => t.subject === subject && getNumericClass(t.kelas) === getNumericClass(student.class));
                    if(tokenInfo){
                        for(const fbKey of Array.from(tokenInfo.firebaseKeys)){
                             if(submittedExamsCache[fbKey]?.[padStudentId(student.id)]?.isSubmitted) {
                                 const answerData = studentAnswersCache[fbKey]?.[padStudentId(student.id)];
                                 const bankSoal = bankSoalCache[`kelas${getNumericClass(tokenInfo.kelas)}`]?.[tokenInfo.tahunAjaran.replace(/\//g, '-')]?.[tokenInfo.ujianName.replace(/\s+/g, '-')]?.[`Kelas-${tokenInfo.kelas}`]?.[tokenInfo.subject.replace(/\s+/g, '-')];
                                 if (answerData && bankSoal?.kunjab) {
                                     score = calculateScore(answerData.answers, bankSoal.kunjab);
                                     break;
                                 }
                             }
                        }
                    }
                    rowData += `\t${score}`;
                });
                body += rowData + '\n';
            });
            textToCopy = header + body;
        } else {
            const table = document.getElementById(currentTableIdToCopy);
            if (!table) return showNotification('Tabel tidak ditemukan.', true);
            textToCopy = Array.from(table.querySelectorAll('tr')).map(row => 
                Array.from(row.querySelectorAll('th, td')).map(cell => cell.innerText.trim()).join('\t')
            ).join('\n');
        }
        navigator.clipboard.writeText(textToCopy).then(() => showNotification('Tabel berhasil disalin.'), () => showNotification('Gagal menyalin tabel.', true));
        closeCopyPrintModal();
    };

    function updateTime() {
      const display = new Date().toLocaleString('id-ID', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(/\./g, ':');
      document.getElementById("currentTime").innerText = display;
      const adminTimeEl = document.getElementById("adminDateTime");
      if(adminTimeEl) adminTimeEl.innerText = display;
    }

    
    setInterval(updateTime, 1000);
    updateTime();

    setInterval(() => {
        if (authInstances['SETUP'].currentUser && isLocationEnabledAdmin) loadSetlokasiSettings(); 
        periksaAndUpdateStatusToken(); 
    }, 10 * 1000); 

    window.openDeleteStudentConfirmModal = (key) => { deleteStudentKey = key; document.getElementById('deleteStudentConfirmModal').style.display = 'flex'; };

    window.confirmDeleteStudent = async () => {
        if (!deleteStudentKey) return;
        const student = studentCache.find(s => s.key === deleteStudentKey);
        if (!student) return showNotification("Siswa tidak ditemukan.", true);
        const targetDb = getDbForClass(student.class);
        if (!targetDb || Array.isArray(targetDb)) return showNotification("Gagal: DB tidak ditemukan.", true);
        loadingOverlay.style.display = 'flex';
        try {
            await remove(ref(targetDb, 'students/' + deleteStudentKey));
            showNotification('Siswa berhasil dihapus.');
        } catch (error) {
            showNotification("Gagal: " + error.message, true);
        } finally {
            loadingOverlay.style.display = 'none';
            closeDeleteStudentConfirmModal();
        }
    };

    function showImportResult(importedCount, skippedCount, details) {
        document.getElementById('importResultSummary').innerHTML = `Berhasil: <b style="color:green;">${importedCount}</b>, Gagal: <b style="color:red;">${skippedCount}</b>`;
        const detailsList = document.getElementById('importResultDetails');
        detailsList.innerHTML = details.length > 0 ? details.map(d => `<li style="color:red;">${d}</li>`).join('') : "<li>Tidak ada detail kesalahan.</li>";
        document.getElementById('importResultModal').style.display = 'flex';
    }

    window.processCsvFile = async () => {
        if (isImporting) return;
        const file = document.getElementById('csvFileInput').files[0];
        const errorEl = document.getElementById('importFileError');
        errorEl.innerText = '';
        if (!file) return errorEl.innerText = 'Pilih file CSV.';
        if (!file.name.endsWith('.csv')) return errorEl.innerText = 'File harus berformat CSV.';
        
        isImporting = true;
        loadingOverlay.style.display = 'flex';
        const reader = new FileReader();
        reader.onload = async (e) => {
            const lines = e.target.result.split('\n').filter(line => line.trim());
            let imported = 0, skipped = 0, errors = [];
            const batchMap = {};
            Object.keys(dbInstances).filter(n => n !== 'SETUP').forEach(name => batchMap[name] = {});

            if (lines.length <= 1) errors.push("File CSV kosong atau hanya header.");
            
            // UPDATE: Deteksi Delimiter (Koma atau Titik Koma)
            // Memeriksa baris pertama (header) untuk menentukan delimiter yang dipakai
            let delimiter = ',';
            if (lines.length > 0 && lines[0].includes(';')) {
                delimiter = ';';
            }

            for (let i = 1; i < lines.length; i++) {
                // UPDATE: Menggunakan delimiter dinamis
                const parts = lines[i].split(delimiter).map(p => p.trim());
                
                if (parts.length !== 4) { skipped++; errors.push(`Baris ${i+1}: Format kolom salah.`); continue; }
                const [id, name, sClass, room] = parts;
                if (!/^\d+$/.test(id) || !name || !VALID_ROMBELS.includes(sClass.toUpperCase())) { skipped++; errors.push(`Baris ${i+1}: Data tidak valid.`); continue; }
                const dbName = rombelToDbMap[sClass.toUpperCase()];
                const paddedId = padStudentId(id);
                if (studentCache.some(s => s.id === paddedId && s.firebaseGroup === dbName)) { skipped++; errors.push(`Baris ${i+1}: ID ${id} sudah ada.`); continue; }
                
                batchMap[dbName][push(ref(dbInstances[dbName], 'students')).key] = { id: paddedId, name: name.toUpperCase().replace(/'/g, ''), class: sClass.toUpperCase(), room: padRoomNumber(room) };
                imported++;
            }
            try {
                await Promise.all(Object.keys(batchMap).filter(n => Object.keys(batchMap[n]).length > 0).map(n => update(ref(dbInstances[n], 'students'), batchMap[n])));
                showNotification(`${imported} siswa berhasil diimpor!`);
            } catch (err) { errors.push(`Firebase Error: ${err.message}`); }
            
            isImporting = false;
            loadingOverlay.style.display = 'none';
            closeImportStudentModal();
            showImportResult(imported, skipped, errors);
        };
        reader.readAsText(file);
    };

    window.openEmptyStudentsModal = () => { document.getElementById('emptyStudentsPassword').value = ''; document.getElementById('emptyStudentsPasswordError').innerText = ''; document.getElementById('emptyStudentsModal').style.display = 'flex'; };

    window.confirmEmptyStudents = async () => {
        const password = document.getElementById('emptyStudentsPassword').value;
        await reauthenticateAndExecute(password, 'emptyStudentsPasswordError', async () => {
            const promises = [];
            Object.keys(dbInstances).filter(n => n !== 'SETUP').forEach(dbName => {
                ['students', 'exam_access_status', 'submitted_exams', 'student_answers'].forEach(node => {
                    promises.push(remove(ref(dbInstances[dbName], node)));
                });
            });
            await Promise.all(promises);
            showNotification('Semua data peserta berhasil dikosongkan!');
            closeEmptyStudentsModal();
        });
    };

    window.promptEmptyTokens = () => { document.getElementById('adminPasswordConfirmation').value = ''; document.getElementById('adminPasswordConfirmationError').innerText = ''; document.getElementById('emptyTokensModal').style.display = 'flex'; };
    
    window.confirmEmptyTokens = async () => {
        const password = document.getElementById('adminPasswordConfirmation').value;
        await reauthenticateAndExecute(password, 'adminPasswordConfirmationError', async () => {
            const promises = [];
            Object.keys(dbInstances).filter(n => n !== 'SETUP').forEach(dbName => {
                ['tokens', 'exam_access_status', 'submitted_exams', 'student_answers'].forEach(node => {
                    promises.push(remove(ref(dbInstances[dbName], node)));
                });
            });
            await Promise.all(promises);
            showNotification('Semua token dan data terkait berhasil dikosongkan!');
            closeEmptyTokensModal();
        });
    };
    window.closeEmptyTokensModal = () => document.getElementById('emptyTokensModal').style.display = 'none';

    function generateAbbreviation(subjectName) {
        if (!subjectName) return 'N/A';
        const words = subjectName.toUpperCase().split(' ').filter(w => !['DAN', 'DAN,'].includes(w));
        if (words.length >= 3) return words.map(w => w[0]).join('');
        return words.join(' ').substring(0, 4);
    }

    function resetScoreTable() {
        scoreTableHeader.innerHTML = '';
        scoreTableBody.innerHTML = '';
        scorePaginationDiv.innerHTML = '';
        scoreTableMessage.style.display = 'block';
        document.getElementById('scoreTable').style.display = 'none';
        document.getElementById('scorePrintBtn').style.display = 'none';
    }

    window.renderScoreTable = (page = 1) => {
        currentPageScore = page; 
        localStorage.setItem('currentPageScore', currentPageScore);

        if (window.currentScoreGradeFilter === 'ALL') return resetScoreTable();
        
        document.getElementById('scorePrintBtn').style.display = 'inline-block';

        scoreTableMessage.style.display = 'none';
        document.getElementById('scoreTable').style.display = 'table';
        
        let studentsForGrade = studentCache.filter(s => getNumericClass(s.class) === window.currentScoreGradeFilter);
        const searchName = document.getElementById('scoreSearchName').value.trim().toUpperCase();
        if (searchName) studentsForGrade = studentsForGrade.filter(s => s.name.toUpperCase().includes(searchName));
        const searchClass = document.getElementById('scoreSearchClass').value.trim().toUpperCase();
        if (searchClass) studentsForGrade = studentsForGrade.filter(s => s.class.toUpperCase().includes(searchClass));

        filteredScores = studentsForGrade.sort((a,b) => a.class.localeCompare(b.class) || a.name.localeCompare(b.name));
        
        const subjects = [...new Set(tokenCache.filter(t => getNumericClass(t.kelas) === window.currentScoreGradeFilter).map(t => t.subject))].sort();
        scoreTableHeader.innerHTML = `<tr><th>NO</th><th>NAMA SISWA</th><th>KELAS</th>${subjects.map(s => `<th>${generateAbbreviation(s)}</th>`).join('')}</tr>`;
        
        const scoresForPage = filteredScores.slice((page - 1) * selectedItemsPerPage, page * selectedItemsPerPage);
        scoreTableBody.innerHTML = '';
        scoresForPage.forEach((student, index) => {
            const row = document.createElement('tr');
            let rowContent = `<td>${(page - 1) * selectedItemsPerPage + index + 1}</td><td>${student.name}</td><td>${student.class}</td>`;
            subjects.forEach(subject => {
                let score = '-';
                let isExpired = false;
                
                const tokenInfo = Array.from(consolidatedTokensMap.values()).find(t => t.subject === subject && getNumericClass(t.kelas) === getNumericClass(student.class));
                
                if (tokenInfo) {
                    if (new Date() > new Date(tokenInfo.endTime)) {
                        isExpired = true;
                    }

                    for(const fbKey of Array.from(tokenInfo.firebaseKeys)) {
                        const studentIdPadded = padStudentId(student.id);
                        if(submittedExamsCache[fbKey]?.[padStudentId(student.id)]?.isSubmitted) {
                            const answerData = studentAnswersCache[fbKey]?.[padStudentId(student.id)];
                            const bankSoal = bankSoalCache[`kelas${getNumericClass(tokenInfo.kelas)}`]?.[tokenInfo.tahunAjaran.replace(/\//g, '-')]?.[tokenInfo.ujianName.replace(/\s+/g, '-')]?.[`Kelas-${tokenInfo.kelas}`]?.[tokenInfo.subject.replace(/\s+/g, '-')];
                            if (answerData && bankSoal?.kunjab) {
                                score = calculateScore(answerData.answers, bankSoal.kunjab);
                                break;
                            }
                        }
                    }
                }

                let cellStyle = '';
                if (score === '-' && isExpired) {
                    cellStyle = 'style="background-color: #fadbd8; color: #c0392b; font-weight: bold;" title="Ujian telah berakhir namun nilai kosong"';
                }

                rowContent += `<td ${cellStyle}>${score}</td>`;
            });
            row.innerHTML = rowContent;
            scoreTableBody.appendChild(row);
        });
        renderPaginationControls(scorePaginationDiv, page, Math.ceil(filteredScores.length / selectedItemsPerPage), 'renderScoreTable');
    }; 

    function calculateScore(studentAnswersString, answerKeyString) {
        if (!answerKeyString || !studentAnswersString) return 0;
        try {
            const correctAnswers = answerKeyString.split(',').filter(Boolean);
            const studentAnswers = JSON.parse(studentAnswersString);
            if (!Array.isArray(studentAnswers)) return 0;

            let correctCount = 0;
            for (let i = 0; i < correctAnswers.length; i++) {
                if (studentAnswers[i] && studentAnswers[i].trim().toUpperCase() === correctAnswers[i].trim().toUpperCase()) {
                    correctCount++;
                }
            }
            return parseFloat(((correctCount / correctAnswers.length) * 100).toFixed(2)) || 0;
        } catch (e) {
            return 0;
        }
    }

    window.promptResetStudent = (key, id, name, sClass) => { studentKeyForAction = key; studentIdForAction = id; studentNameForAction = unescape(name); studentClassForAction = sClass; document.getElementById('resetStudentNameDisplay').innerText = unescape(name); document.getElementById('resetStudentIdDisplay').innerText = id; document.getElementById('resetStudentModal').style.display = 'flex'; };
    
    window.confirmResetStudent = async () => {
        if (!studentIdForAction || !studentClassForAction) return;

        const studentGrade = getNumericClass(studentClassForAction);
        const selectedTokenId = lastSelectedTokens[studentGrade];
        if (!selectedTokenId || selectedTokenId === 'DEFAULT') {
            showNotification(`Silakan pilih ujian di menu 'Status Ujian' untuk kelas ${studentGrade} terlebih dahulu.`, true);
            closeResetStudentModal();
            return;
        }

        const [token, kelas] = selectedTokenId.split('_');
        const consolidatedToken = Array.from(consolidatedTokensMap.values()).find(t => t.token === token && t.kelas === kelas);
        if (!consolidatedToken) {
            showNotification("Token yang dipilih tidak valid atau tidak ditemukan.", true);
            closeResetStudentModal();
            return;
        }
        
        loadingOverlay.style.display = 'flex';
        try {
            const updates = {};
            const studentIdPadded = padStudentId(studentIdForAction);
            
            for (const fbKey of consolidatedToken.firebaseKeys) {
                const group = tokenCache.find(t=> t.key === fbKey)?.firebaseGroup;
                if(group) {
                    updates[`${group}/exam_access_status/${fbKey}/${studentIdPadded}/isLoggedIn`] = false;
                }
            }
            
            const promises = Object.keys(updates).map(path => {
                const [group, ...rest] = path.split('/');
                const db = dbInstances[group];
                if(db) return update(ref(db), { [rest.join('/')]: updates[path] });
                return Promise.resolve();
            });

            await Promise.all(promises);
            showNotification(`Status login siswa ${studentIdForAction} berhasil direset untuk ujian yang dipilih.`);

        } catch (error) { 
            showNotification("Gagal mereset: " + error.message, true); 
        } finally { 
            loadingOverlay.style.display = 'none'; 
            closeResetStudentModal(); 
        }
    };

    window.promptSubmitAnswer = (key, id, name, sClass) => { studentKeyForAction = key; studentIdForAction = id; studentNameForAction = unescape(name); studentClassForAction = sClass; document.getElementById('submitStudentNameDisplay').innerText = unescape(name); document.getElementById('submitStudentIdDisplay').innerText = id; document.getElementById('submitAnswerModal').style.display = 'flex'; };
    window.confirmSubmitAnswer = async () => {
        if (!studentIdForAction || !studentClassForAction) return;

        const studentGrade = getNumericClass(studentClassForAction);
        const selectedTokenId = lastSelectedTokens[studentGrade];
        if (!selectedTokenId || selectedTokenId === 'DEFAULT') {
            showNotification(`Silakan pilih ujian di menu 'Status Ujian' untuk kelas ${studentGrade} terlebih dahulu.`, true);
            closeSubmitAnswerModal();
            return;
        }

        const [token, kelas] = selectedTokenId.split('_');
        const consolidatedToken = Array.from(consolidatedTokensMap.values()).find(t => t.token === token && t.kelas === kelas);
        if (!consolidatedToken) {
            showNotification("Token yang dipilih tidak valid atau tidak ditemukan.", true);
            closeSubmitAnswerModal();
            return;
        }

        loadingOverlay.style.display = 'flex';
        try {
            const updates = {};
            const studentIdPadded = padStudentId(studentIdForAction);

            for (const fbKey of consolidatedToken.firebaseKeys) {
                const group = tokenCache.find(t=> t.key === fbKey)?.firebaseGroup;
                 if(group) {
                    updates[`${group}/submitted_exams/${fbKey}/${studentIdPadded}`] = { isSubmitted: true, timestamp: Date.now() };
                    updates[`${group}/exam_access_status/${fbKey}/${studentIdPadded}/isLoggedIn`] = false;
                }
            }
            
            const promises = Object.keys(updates).map(path => {
                const [group, ...rest] = path.split('/');
                const db = dbInstances[group];
                if(db) return update(ref(db), { [rest.join('/')]: updates[path] });
                return Promise.resolve();
            });

            await Promise.all(promises);
            showNotification(`Jawaban siswa ${studentIdForAction} untuk ujian yang dipilih berhasil disubmit.`);
        } catch (error) { 
            showNotification("Gagal: " + error.message, true); 
        } finally { 
            loadingOverlay.style.display = 'none'; 
            closeSubmitAnswerModal(); 
        }
    };
    
    window.promptDeleteAnswer = (key, id, name, sClass) => { studentKeyForAction = key; studentIdForAction = id; studentNameForAction = unescape(name); studentClassForAction = sClass; document.getElementById('deleteAnswerStudentNameDisplay').innerText = unescape(name); document.getElementById('deleteAnswerStudentIdDisplay').innerText = id; document.getElementById('deleteAnswerPassword').value = ''; document.getElementById('deleteAnswerPasswordError').innerText = ''; document.getElementById('deleteAnswerModal').style.display = 'flex'; };
    window.confirmDeleteAnswer = async () => {
        const password = document.getElementById('deleteAnswerPassword').value;
        await reauthenticateAndExecute(password, 'deleteAnswerPasswordError', async () => {
            if (!studentIdForAction || !studentClassForAction) return;

            const studentGrade = getNumericClass(studentClassForAction);
            const selectedTokenId = lastSelectedTokens[studentGrade];
            if (!selectedTokenId || selectedTokenId === 'DEFAULT') {
                showNotification(`Silakan pilih ujian di menu 'Status Ujian' untuk kelas ${studentGrade} terlebih dahulu.`, true);
                closeDeleteAnswerModal();
                return;
            }

            const [token, kelas] = selectedTokenId.split('_');
            const consolidatedToken = Array.from(consolidatedTokensMap.values()).find(t => t.token === token && t.kelas === kelas);
            if (!consolidatedToken) {
                showNotification("Token yang dipilih tidak valid atau tidak ditemukan.", true);
                closeDeleteAnswerModal();
                return;
            }

            const updates = {};
            const studentIdPadded = padStudentId(studentIdForAction);

            for (const fbKey of consolidatedToken.firebaseKeys) {
                const group = tokenCache.find(t => t.key === fbKey)?.firebaseGroup;
                 if(group) {
                    updates[`${group}/submitted_exams/${fbKey}/${studentIdPadded}`] = null;
                    updates[`${group}/student_answers/${fbKey}/${studentIdPadded}`] = null;
                    updates[`${group}/exam_access_status/${fbKey}/${studentIdPadded}`] = null;
                 }
            }

            const promises = Object.keys(updates).map(path => {
                const [group, ...rest] = path.split('/');
                const db = dbInstances[group];
                if(db) return update(ref(db), { [rest.join('/')]: updates[path] });
                return Promise.resolve();
            });

            await Promise.all(promises);
            showNotification(`Semua jawaban siswa ${studentIdForAction} untuk ujian yang dipilih telah dihapus.`);
            closeDeleteAnswerModal();
        });
    };
    
    function loadSetlokasiSettings() { return new Promise(r => onValue(ref(setupDbInstance, 'setlokasi'), s => { const val=s.val()||{}; isLocationEnabledAdmin=val.isLocationEnabled||!1; allowedRadiusMeterAdmin=(val.allowedRadiusKm||0.075)*1000; currentLocationKeyAdmin=val.currentKey||''; keyLastGeneratedAdmin=val.keyLastGenerated||0; if(isLocationEnabledAdmin && Date.now()-keyLastGeneratedAdmin > FIFTEEN_MINUTES_IN_MS) update(ref(setupDbInstance,'setlokasi'),{currentKey:generateRandomKey(5),keyLastGenerated:Date.now()}); r(); }, {onlyOnce:!0})); }
    
    function loadBlockKeySettings() { return new Promise(r => onValue(ref(setupDbInstance, 'block_key_settings'), s => { const val = s.val() || {}; isBlockKeyEnabledAdmin = val.isEnabled || false; currentBlockKeyAdmin = val.key || "BUKA"; r(); }, { onlyOnce: true })); }
    function loadMinDurationSettings() { return new Promise(r => onValue(ref(setupDbInstance, 'min_duration_settings'), s => { const val=s.val()||{}; isMinDurationEnabledAdmin=val.isMinDurationEnabled||!1; minSubmitDurationSecondsAdmin=val.minDurationSeconds||1800; r(); }, {onlyOnce:!0})); }
    
    function loadShuffleSettings() { return new Promise(r => onValue(ref(setupDbInstance, 'acaksoalpilgan'), s => { shuffleSettingsCache=s.val()||{soal:!0,pilgan:!0}; r(); }, {onlyOnce:!0})); }

    function renderShuffleSettingsTable() { shuffleSettingsTableBody.innerHTML = `<tr><td>Acak Urutan Soal</td><td style="color:${shuffleSettingsCache.soal?'green':'red'};font-weight:bold;">${shuffleSettingsCache.soal?'ON':'OFF'}</td><td><label class="switch"><input type="checkbox" onchange="toggleShuffleSetting('soal')" ${shuffleSettingsCache.soal?'checked':''}><span class="slider"></span></label></td></tr><tr><td>Acak Urutan Pilihan Ganda</td><td style="color:${shuffleSettingsCache.pilgan?'green':'red'};font-weight:bold;">${shuffleSettingsCache.pilgan?'ON':'OFF'}</td><td><label class="switch"><input type="checkbox" onchange="toggleShuffleSetting('pilgan')" ${shuffleSettingsCache.pilgan?'checked':''}><span class="slider"></span></label></td></tr>`; }

    window.toggleShuffleSetting = async (setting) => { const path = `acaksoalpilgan/${setting}`; const newValue = !shuffleSettingsCache[setting]; loadingOverlay.style.display = 'flex'; try { await update(ref(setupDbInstance), { [path]: newValue }); showNotification(`Pengaturan '${setting}' berhasil diperbarui.`); await loadShuffleSettings(); renderShuffleSettingsTable(); } catch (error) { showNotification(`Gagal memperbarui pengaturan: ${error.message}`, true); } finally { loadingOverlay.style.display = 'none'; } };

    function loadPublicSettings() { return new Promise(r => onValue(ref(setupDbInstance, 'publicSettings'), s => { publicSettingsCache=s.val()||{kelas7:{e:0,u:''},kelas8:{e:0,u:''},kelas9:{e:0,u:''},susulan:{e:0,l:{}}}; cleanUpOldSusulanExams(); r(); }, {onlyOnce:!0})); }

    function renderPublicSettingsControls() { document.getElementById('kelas7Toggle').checked = publicSettingsCache.kelas7.enabled; document.getElementById('kelas7Url').value = publicSettingsCache.kelas7.url; document.getElementById('kelas8Toggle').checked = publicSettingsCache.kelas8.enabled; document.getElementById('kelas8Url').value = publicSettingsCache.kelas8.url; document.getElementById('kelas9Toggle').checked = publicSettingsCache.kelas9.enabled; document.getElementById('kelas9Url').value = publicSettingsCache.kelas9.url; document.getElementById('susulanToggle').checked = publicSettingsCache.susulan.enabled; }
    
    window.savePublicSettings = async () => { loadingOverlay.style.display = 'flex'; try { await update(ref(setupDbInstance, 'publicSettings'), { kelas7: { enabled: document.getElementById('kelas7Toggle').checked, url: document.getElementById('kelas7Url').value.trim() }, kelas8: { enabled: document.getElementById('kelas8Toggle').checked, url: document.getElementById('kelas8Url').value.trim() }, kelas9: { enabled: document.getElementById('kelas9Toggle').checked, url: document.getElementById('kelas9Url').value.trim() }, 'susulan/enabled': document.getElementById('susulanToggle').checked }); showNotification('Pengaturan berhasil disimpan!'); await loadPublicSettings(); renderActiveButtonsInfo(); } catch (error) { showNotification('Gagal: ' + error.message, true); } finally { loadingOverlay.style.display = 'none'; } };
    
    window.addSusulanUjian = async () => { const name = document.getElementById('addSusulanName').value.trim(); const url = document.getElementById('addSusulanUrl').value.trim(); if (!name || !url) return showNotification('Nama dan URL tidak boleh kosong!', true); loadingOverlay.style.display = 'flex'; try { await push(ref(setupDbInstance, 'publicSettings/susulan/list'), { name, url, createdAt: Date.now() }); showNotification('Ujian susulan ditambahkan!'); document.getElementById('addSusulanName').value = ''; document.getElementById('addSusulanUrl').value = ''; await loadPublicSettings(); renderActiveButtonsInfo(); } catch (error) { showNotification('Gagal: ' + error.message, true); } finally { loadingOverlay.style.display = 'none'; } };

    window.deleteSusulanUjian = async (id) => { openGenericConfirmModal('Hapus Ujian Susulan', 'Yakin ingin menghapus ujian ini?', async () => { loadingOverlay.style.display = 'flex'; try { await remove(ref(setupDbInstance, `publicSettings/susulan/list/${id}`)); showNotification('Ujian susulan dihapus!'); await loadPublicSettings(); renderActiveButtonsInfo(); } catch (error) { showNotification('Gagal: ' + error.message, true); } finally { loadingOverlay.style.display = 'none'; } }); };
    
    function cleanUpOldSusulanExams() { if (!publicSettingsCache.susulan?.list) return; const updates = {}; Object.entries(publicSettingsCache.susulan.list).forEach(([id, exam]) => { if (Date.now() - exam.createdAt > ONE_WEEK_IN_MS) updates[id] = null; }); if(Object.keys(updates).length > 0) update(ref(setupDbInstance, 'publicSettings/susulan/list'), updates); }

    function renderActiveButtonsInfo() { activeButtonsInfoList.innerHTML = ''; ['kelas7', 'kelas8', 'kelas9'].forEach(k => { const info = publicSettingsCache[k]; const li = document.createElement('li'); li.className = 'info-list-item'; li.innerHTML = `<div><span class="status-indicator ${info.enabled ? 'on' : 'off'}"></span><strong>${k.charAt(0).toUpperCase() + k.slice(1)}:</strong> ${info.enabled ? 'Aktif' : 'Nonaktif'}</div>${info.url ? `<div class="link-info">Link: <a href="${info.url}" target="_blank">${info.url}</a></div>` : ''}`; activeButtonsInfoList.appendChild(li); }); const susulanInfo = publicSettingsCache.susulan; const headerLi = document.createElement('li'); headerLi.className = 'info-list-item'; headerLi.innerHTML = `<div><span class="status-indicator ${susulanInfo.enabled ? 'on' : 'off'}"></span><strong>Ujian Susulan:</strong> ${susulanInfo.enabled ? 'Aktif' : 'Nonaktif'}</div>`; activeButtonsInfoList.appendChild(headerLi); if (susulanInfo.enabled && susulanInfo.list) { Object.entries(susulanInfo.list).forEach(([id, item]) => { const itemLi = document.createElement('li'); itemLi.className = 'info-list-item'; itemLi.style.paddingLeft = '20px'; itemLi.innerHTML = `<div><span>${item.name}</span><button class="icon-button delete-button" onclick="deleteSusulanUjian('${id}')" title="Hapus"><i class="fas fa-trash-alt"></i></button></div><div class="link-info">Link: <a href="${item.url}" target="_blank">${item.url}</a></div>`; activeButtonsInfoList.appendChild(itemLi); }); } }

    function periksaAndUpdateStatusToken() { const now = new Date(); tokenCache.forEach(token => { const newIsActive = token.isForceActive || (now >= new Date(token.startTime) && now < new Date(token.endTime)); if (token.isActive !== newIsActive) update(ref(dbInstances[token.firebaseGroup], `tokens/${token.key}`), { isActive: newIsActive }); }); }
    
    function updateSetlokasiStatusDisplay() { const statusText = isLocationEnabledAdmin ? 'ON' : 'OFF'; const statusColor = isLocationEnabledAdmin ? 'green' : 'red'; locationSettingsTableBody.innerHTML = `<tr><td>${currentLocationKeyAdmin}</td><td>${defaultLocationCoordinate}</td><td>${allowedRadiusMeterAdmin}m</td><td style="color:${statusColor};font-weight:bold;">${statusText}</td><td><button class="icon-button" onclick="openSetlokasiModal()"><i class="fas fa-map-marker-alt"></i></button></td></tr>`; }
    function renderBlockKeySettingsTable() { const statusText = isBlockKeyEnabledAdmin ? 'ON' : 'OFF'; const statusColor = isBlockKeyEnabledAdmin ? 'green' : 'red'; blockKeySettingsTableBody.innerHTML = `<tr><td>${currentBlockKeyAdmin}</td><td style="color:${statusColor};font-weight:bold;">${statusText}</td><td><button class="icon-button edit" onclick="openSetBlockKeyModal()"><i class="fas fa-edit"></i></button></td></tr>`; }
    function renderMinDurationSettingsTable() { const statusText = isMinDurationEnabledAdmin ? 'ON' : 'OFF'; const statusColor = isMinDurationEnabledAdmin ? 'green' : 'red'; const displayString = `${formatSecondsToHMS(minSubmitDurationSecondsAdmin)} (${minSubmitDurationSecondsAdmin/60} menit)`; minDurationSettingsTableBody.innerHTML = `<tr><td>${displayString}</td><td style="color:${statusColor};font-weight:bold;">${statusText}</td><td><button class="icon-button edit" onclick="openSetMinDurationModal()"><i class="fas fa-edit"></i></button></td></tr>`; }
    
    window.openSetlokasiModal = () => document.getElementById('setlokasiModal').style.display = 'flex';
    window.closeSetlokasiModal = () => document.getElementById('setlokasiModal').style.display = 'none';
    window.openGantiRadiusModal = () => { document.getElementById('gantiRadiusModal').style.display = 'flex'; document.getElementById('radiusMeter').value = allowedRadiusMeterAdmin; closeSetlokasiModal(); };
    window.closeGantiRadiusModal = () => document.getElementById('gantiRadiusModal').style.display = 'none';
    window.aktifkanLokasi = async () => { await update(ref(setupDbInstance, 'setlokasi'), { isLocationEnabled: true }); showNotification('Lokasi diaktifkan.'); closeSetlokasiModal(); await loadSetlokasiSettings(); updateSetlokasiStatusDisplay(); };
    window.nonaktifkanLokasi = async () => { await update(ref(setupDbInstance, 'setlokasi'), { isLocationEnabled: false }); showNotification('Lokasi dinonaktifkan.'); closeSetlokasiModal(); await loadSetlokasiSettings(); updateSetlokasiStatusDisplay(); };
    window.gantiRadiusDanAktifkan = async () => { const r = parseInt(document.getElementById('radiusMeter').value); if(isNaN(r) || r<=0) return; await update(ref(setupDbInstance, 'setlokasi'), { allowedRadiusKm: r / 1000, isLocationEnabled: true }); showNotification(`Radius diubah jadi ${r}m & diaktifkan.`); closeGantiRadiusModal(); await loadSetlokasiSettings(); updateSetlokasiStatusDisplay(); };

    window.openSetBlockKeyModal = () => { document.getElementById('blockKeyInput').value = currentBlockKeyAdmin; document.getElementById('blockKeyStatusToggle').checked = isBlockKeyEnabledAdmin; document.getElementById('blockKeySettingsError').innerText = ""; document.getElementById('setBlockKeyModal').style.display = 'flex'; };
    window.closeSetBlockKeyModal = () => document.getElementById('setBlockKeyModal').style.display = 'none';
    window.saveBlockKeySettings = async () => { const keyInput = document.getElementById('blockKeyInput').value.trim().toUpperCase(); const isEnabled = document.getElementById('blockKeyStatusToggle').checked; const errorMsg = document.getElementById('blockKeySettingsError'); errorMsg.innerText = ""; if (!keyInput) { errorMsg.innerText = "Kunci tidak boleh kosong."; return; } loadingOverlay.style.display = 'flex'; try { await update(ref(setupDbInstance, 'block_key_settings'), { key: keyInput, isEnabled: isEnabled }); showNotification('Pengaturan kunci blokir berhasil disimpan.'); closeSetBlockKeyModal(); await loadBlockKeySettings(); renderBlockKeySettingsTable(); } catch (error) { showNotification("Gagal menyimpan: " + error.message, true); } finally { loadingOverlay.style.display = 'none'; } };

    window.openSetMinDurationModal = () => { document.getElementById('setMinDurationModal').style.display = 'flex'; document.getElementById('minDurationMinutesInput').value = minSubmitDurationSecondsAdmin / 60; };
    window.closeSetMinDurationModal = () => document.getElementById('setMinDurationModal').style.display = 'none';
    window.aktifkanMinDuration = async () => { await update(ref(setupDbInstance, 'min_duration_settings'), { isMinDurationEnabled: true }); showNotification('Durasi minimal diaktifkan.'); closeSetMinDurationModal(); await loadMinDurationSettings(); renderMinDurationSettingsTable(); };
    window.nonaktifkanMinDuration = async () => { await update(ref(setupDbInstance, 'min_duration_settings'), { isMinDurationEnabled: false }); showNotification('Durasi minimal dinonaktifkan.'); closeSetMinDurationModal(); await loadMinDurationSettings(); renderMinDurationSettingsTable(); };
    window.setMinDurationAndActivate = async () => { const m = parseInt(document.getElementById('minDurationMinutesInput').value); if(isNaN(m)) return; await update(ref(setupDbInstance, 'min_duration_settings'), { minDurationSeconds: m * 60, isMinDurationEnabled: true }); showNotification(`Durasi minimal diubah & diaktifkan.`); closeSetMinDurationModal(); await loadMinDurationSettings(); renderMinDurationSettingsTable(); };
    
    function updateDashboard() { if(document.getElementById('dashboardSection').style.display === 'block') { updateHighlightCards(); renderProgressCards(); } }

    function updateHighlightCards() {
        const activeTokens = Array.from(consolidatedTokensMap.values()).filter(t => t.isActive || t.isForceActive);
        const activeTokenKeys = new Set(activeTokens.flatMap(t => Array.from(t.firebaseKeys)));
        let onlineCount = 0;
        for (const tokenKey in tokenAccessStatus) { Object.values(tokenAccessStatus[tokenKey]).forEach(s => { if(s?.isLoggedIn) onlineCount++; }); }
        let submittedCount = 0;
        for (const tokenKey in submittedExamsCache) { if (activeTokenKeys.has(tokenKey)) submittedCount += Object.keys(submittedExamsCache[tokenKey]).length; }
        highlightCardsContainer.innerHTML = `
            <div class="highlight-card"><span class="icon active-exams"><i class="fas fa-play-circle"></i></span><div class="info"><h3>${activeTokens.length}</h3><p>Ujian Aktif</p></div></div>
            <div class="highlight-card"><span class="icon online-users"><i class="fas fa-user-clock"></i></span><div class="info"><h3>${onlineCount}</h3><p>Online</p></div></div>
            <div class="highlight-card"><span class="icon submitted-users"><i class="fas fa-check-double"></i></span><div class="info"><h3>${submittedCount}</h3><p>Submit</p></div></div>
            <div class="highlight-card"><span class="icon total-users"><i class="fas fa-users"></i></span><div class="info"><h3>${studentCache.length}</h3><p>Total Peserta</p></div></div>`;
    }

    function renderProgressCards() {
        progressCardsContainer.innerHTML = '';
        Object.values(countdownIntervals).forEach(clearInterval);
        const activeTokens = Array.from(consolidatedTokensMap.values()).filter(t => t.isActive || t.isForceActive);
        if(activeTokens.length === 0) return progressCardsContainer.innerHTML = '<p>Tidak ada ujian yang sedang aktif.</p>';
        activeTokens.forEach(token => {
            const studentsInClass = studentCache.filter(s => getNumericClass(s.class) === getNumericClass(token.kelas));
            let submitted = 0, working = 0;
            studentsInClass.forEach(student => {
                 let isSubmitted = false, isLoggedIn = false;
                 for (const fbKey of token.firebaseKeys) {
                     if (submittedExamsCache[fbKey]?.[padStudentId(student.id)]?.isSubmitted) { isSubmitted = true; break; }
                     if(tokenAccessStatus[fbKey]?.[padStudentId(student.id)]?.isLoggedIn) { isLoggedIn = true; }
                 }
                 if(isSubmitted) submitted++;
                 else if (isLoggedIn) working++;
            });
            const card = document.createElement('div');
            card.className = 'progress-card';
            card.innerHTML = `
                <div class="progress-card-header"><h4>${token.subject} - KLS ${token.kelas}</h4><span class="token-code">${token.token}</span></div>
                <div class="progress-card-body">
                    ${createProgressBar('Submit', submitted, studentsInClass.length, '#27ae60')}
                    ${createProgressBar('Mengerjakan', working, studentsInClass.length, '#f39c12')}
                    ${createProgressBar('Belum Login', studentsInClass.length - submitted - working, studentsInClass.length, '#bdc3c7')}
                </div>
                <div class="progress-card-footer"><div class="status-text" id="status-${token.key}"></div><button class="text-button light-blue" style="padding:5px 10px;font-size:0.8em;" onclick="navigateToStudentManagement('${getNumericClass(token.kelas)}')">Kelola</button></div>`;
            progressCardsContainer.appendChild(card);
            const statusEl = document.getElementById(`status-${token.key}`);
            if (token.isForceActive) { statusEl.innerHTML = "<span class='forced'>PAKSA AKTIF</span>"; } else { countdownIntervals[token.key] = setInterval(() => { const dist = new Date(token.endTime) - new Date(); if (dist < 0) { clearInterval(countdownIntervals[token.key]); statusEl.innerHTML = "<span class='expired'>WAKTU HABIS</span>"; return; } statusEl.innerHTML = `<span class="countdown">${formatSecondsToHMS(Math.floor(dist/1000))}</span>`; }, 1000); }
        });
    }

    function createProgressBar(label, value, total, color) { const p = total > 0 ? (value / total) * 100 : 0; return `<div class="progress-item"><div class="progress-text-info"><span>${label}</span><span>${value}/${total} (${Math.round(p)}%)</span></div><div class="progress-bar-container"><div class="progress-bar-fill" style="width:${p}%;background-color:${color};">${p > 15 ? `${Math.round(p)}%` : ''}</div></div></div>`; }
    window.navigateToStudentManagement = (kelas) => {
        const token = Array.from(consolidatedTokensMap.values()).find(t => getNumericClass(t.kelas) === kelas && (t.isActive || t.isForceActive));
        lastSelectedTokens[kelas] = token ? `${token.token}_${token.kelas}` : 'DEFAULT';
        localStorage.setItem('lastSelectedTokens', JSON.stringify(lastSelectedTokens));
        showSection('studentStatusSection');
    }

    window.performBackup = async () => {
        showNotification('Mempersiapkan data backup...');
        loadingOverlay.style.display = 'flex';
        try {
            const allData = {};
            const dbNames = Object.keys(dbInstances);

            const promises = dbNames.map(async (dbName) => {
                const snapshot = await get(ref(dbInstances[dbName]));
                if (snapshot.exists()) {
                    allData[dbName] = snapshot.val();
                }
            });

            await Promise.all(promises);

            const date = new Date();
            const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            
            const fullBackup = {
                backupInfo: {
                    createdAt: date.toISOString(),
                    version: '1.1'
                },
                data: allData
            };
            
            const blob = new Blob([JSON.stringify(fullBackup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-smpn2pajangan-${dateString}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Unduhan backup telah dimulai.');
        } catch (error) {
            console.error("Backup failed:", error);
            showNotification('Gagal membuat backup: ' + error.message, true);
        } finally {
            loadingOverlay.style.display = 'none';
        }
    };
    
    window.openRestorePasswordModal = () => document.getElementById('restorePasswordModal').style.display = 'flex';
    window.closeRestorePasswordModal = () => document.getElementById('restorePasswordModal').style.display = 'none';
    window.checkRestoreAdminPassword = async () => {
        const password = document.getElementById('restoreAdminPassword').value;
        await reauthenticateAndExecute(password, 'restoreAdminPasswordError', () => {
             closeRestorePasswordModal(); 
             document.getElementById('restoreModal').style.display = 'flex';
        });
    };
    window.closeRestoreModal = () => document.getElementById('restoreModal').style.display = 'none';
    window.confirmRestoreInternal = () => { openGenericConfirmModal('Konfirmasi Pemulihan', 'Yakin ingin memulihkan data? Ini akan MENIMPA SEMUA DATA.', async () => { 
        const file = document.getElementById('backupFileInput').files[0];
        if (!file) {
            document.getElementById('restoreFileError').innerText = "Silakan pilih file backup.";
            return;
        }
        loadingOverlay.style.display = 'flex';
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const backupData = JSON.parse(e.target.result);
                const dataToRestore = backupData.data;
                if (!dataToRestore) throw new Error("Format file backup tidak valid.");

                const restorePromises = Object.keys(dataToRestore).map(dbName => {
                    if (dbInstances[dbName]) {
                        return set(ref(dbInstances[dbName]), dataToRestore[dbName]);
                    }
                    return Promise.resolve();
                });

                await Promise.all(restorePromises);
                showNotification('Data berhasil dipulihkan! Halaman akan dimuat ulang.');
                setTimeout(() => location.reload(), 2000);
            } catch (error) {
                document.getElementById('restoreFileError').innerText = "Gagal memulihkan: " + error.message;
            } finally {
                loadingOverlay.style.display = 'none';
            }
        };
        reader.readAsText(file);
     }); 
    };

    function loadLastSelectedTokens() { lastSelectedTokens = JSON.parse(localStorage.getItem('lastSelectedTokens')) || { '7': 'DEFAULT', '8': 'DEFAULT', '9': 'DEFAULT' }; return Promise.resolve(); }

    function populateExamSelectionDropdowns() {
        const gradeDropdowns = { '7': grade7TokenSelect, '8': grade8TokenSelect, '9': grade9TokenSelect };
        Object.values(gradeDropdowns).forEach(d => d.innerHTML = '<option value="DEFAULT">[Kosong]</option>');
        Array.from(consolidatedTokensMap.values()).sort((a,b) => a.subject.localeCompare(b.subject)).forEach(t => {
            const dropdown = gradeDropdowns[getNumericClass(t.kelas)];
            if(dropdown) dropdown.innerHTML += `<option value="${t.token}_${t.kelas}">${t.subject} (Kls ${t.kelas}) - ${t.isActive || t.isForceActive ? '(Aktif)' : ''}</option>`;
        });
        Object.entries(gradeDropdowns).forEach(([grade, dropdown]) => dropdown.value = lastSelectedTokens[grade] || 'DEFAULT');
    }

    window.saveSelectedExamTokens = () => { lastSelectedTokens = { '7': grade7TokenSelect.value, '8': grade8TokenSelect.value, '9': grade9TokenSelect.value }; localStorage.setItem('lastSelectedTokens', JSON.stringify(lastSelectedTokens)); showNotification('Pilihan token disimpan.'); window.showSection('studentStatusSection'); };

    async function loadBankSoal() {
        bankSoalCache = {};
        const fetchPromises = [];

        Object.keys(gradeToDbGroupMap).forEach(gradeNum => {
            bankSoalCache[`kelas${gradeNum}`] = {};
            gradeToDbGroupMap[gradeNum].forEach(dbName => {
                const dbInstance = dbInstances[dbName];
                if (dbInstance) {
                    fetchPromises.push(
                        get(ref(dbInstance, 'ujian')).then(snapshot => {
                            if (snapshot.exists()) {
                                Object.assign(bankSoalCache[`kelas${gradeNum}`], snapshot.val());
                            }
                        })
                    );
                }
            });
        });
        await Promise.all(fetchPromises);
    }

    function populateTokenModalDropdowns(prefix, kelas, tahunAjaran, ujianName, selectedMapel) {
        const tahunAjaranSelect = document.getElementById(`${prefix}TahunAjaran`);
        const ujianNameSelect = document.getElementById(`${prefix}UjianName`);
        const mapelSelect = document.getElementById(`${prefix}Mapel`);
        
        const resetSelect = (select, placeholder) => {
            select.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
            select.disabled = true;
        };

        if (!kelas) {
            resetSelect(tahunAjaranSelect, '-- Pilih Tahun Ajaran --');
            resetSelect(ujianNameSelect, '-- Pilih Nama Ujian --');
            resetSelect(mapelSelect, '-- Pilih Mata Pelajaran --');
            return;
        }

        const bankSoalKelas = bankSoalCache[`kelas${kelas}`] || {};
        
        resetSelect(tahunAjaranSelect, '-- Pilih Tahun Ajaran --');
        Object.keys(bankSoalKelas).sort().reverse().forEach(thn => {
            tahunAjaranSelect.innerHTML += `<option value="${thn.replace(/-/g, '/')}">${thn.replace(/-/g, '/')}</option>`;
        });
        tahunAjaranSelect.disabled = Object.keys(bankSoalKelas).length === 0;
        if (tahunAjaran) tahunAjaranSelect.value = tahunAjaran;

        resetSelect(ujianNameSelect, '-- Pilih Nama Ujian --');
        if (tahunAjaran && bankSoalKelas[tahunAjaran.replace(/\//g, '-')]) {
            Object.keys(bankSoalKelas[tahunAjaran.replace(/\//g, '-')]).sort().forEach(ujian => {
                ujianNameSelect.innerHTML += `<option value="${ujian.replace(/-/g, ' ')}">${ujian.replace(/-/g, ' ')}</option>`;
            });
            ujianNameSelect.disabled = false;
        }
        if (ujianName) ujianNameSelect.value = ujianName;

        resetSelect(mapelSelect, '-- Pilih Mata Pelajaran --');
        if (tahunAjaran && ujianName && bankSoalKelas[tahunAjaran.replace(/\//g, '-')]?.[ujianName.replace(/\s+/g, '-')]?.[`Kelas-${kelas}`]) {
            Object.keys(bankSoalKelas[tahunAjaran.replace(/\//g, '-')][ujianName.replace(/\s+/g, '-')][`Kelas-${kelas}`]).sort().forEach(mapel => {
                mapelSelect.innerHTML += `<option value="${mapel.replace(/-/g, ' ')}">${mapel.replace(/-/g, ' ')}</option>`;
            });
            mapelSelect.disabled = false;
        }
        if (selectedMapel) mapelSelect.value = selectedMapel;

        displayBankSoalInfo(prefix);
    }
    
    function displayBankSoalInfo(prefix) {
        const kelas = document.getElementById(`${prefix}Kelas`).value;
        const tahunAjaran = document.getElementById(`${prefix}TahunAjaran`).value;
        const ujianName = document.getElementById(`${prefix}UjianName`).value;
        const mapel = document.getElementById(`${prefix}Mapel`).value;
        const infoDiv = document.getElementById(`${prefix}BankSoalInfo`);

        if (!kelas || !tahunAjaran || !ujianName || !mapel) {
            infoDiv.textContent = 'Lengkapi pilihan untuk melihat detail bank soal.';
            infoDiv.className = 'bank-soal-info';
            return;
        }

        const bankSoalData = bankSoalCache[`kelas${kelas}`]?.[tahunAjaran.replace(/\//g, '-')]?.[ujianName.replace(/\s+/g, '-')]?.[`Kelas-${kelas}`]?.[mapel.replace(/\s+/g, '-')];
        
        if (bankSoalData) {
            const soalCount = bankSoalData.soal ? bankSoalData.soal.length - 1 : 0;
            const kunjab = bankSoalData.kunjab || 'Tidak tersedia';
            infoDiv.innerHTML = `Bank soal ditemukan: <b>${soalCount} soal</b>.<br>Kunci: ${kunjab}`;
            infoDiv.className = 'bank-soal-info found';
        } else {
            infoDiv.textContent = 'Bank soal tidak ditemukan untuk pilihan ini.';
            infoDiv.className = 'bank-soal-info not-found';
        }
    }

    window.openGenericConfirmModal = (title, message, onConfirm) => { document.getElementById('genericConfirmTitle').innerText = title; document.getElementById('genericConfirmMessage').innerText = message; currentConfirmAction = onConfirm; document.getElementById('genericConfirmModal').style.display = 'flex'; };
    window.closeGenericConfirmModal = () => { document.getElementById('genericConfirmModal').style.display = 'none'; currentConfirmAction = null; };
    window.handleGenericConfirm = () => { if (currentConfirmAction) currentConfirmAction(); closeGenericConfirmModal(); };
  </script>
</body>
</html>