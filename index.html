<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=2.0" />
    <title>Login Ujian Siswa</title>
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', Arial, sans-serif;
            transition: background-color 0.5s ease;
        }
        body {
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1),
                        inset 0 -2px 4px rgba(255,255,255,0.7);
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow: hidden;
        }
        #selectionContainer {
            max-width: 450px;
            width: 90%;
            padding: 40px 20px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        #selectionContainer h1 {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        #selectionContainer p {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 30px;
        }
        .grade-selection-btn {
            display: block;
            width: 100%;
            padding: 18px;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 50px; /* Disesuaikan agar lebih oval */
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .grade-selection-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        #selectGrade7 { background-color: #3498db; border-bottom: 4px solid #2980b9; }
        #selectGrade8 { background-color: #f39c12; border-bottom: 4px solid #d35400; }
        #selectGrade9 { background-color: #c0392b; border-bottom: 4px solid #a93226; }

        .container {
            max-width: 450px; /* Disesuaikan agar sama dengan selectionContainer */
            width: 90%;
            margin: 20px auto;
            border: 1px solid #ddd;
            background: white;
            border-radius: 15px; /* Disesuaikan agar sama */
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); /* Disesuaikan agar sama */
            overflow: hidden;
            flex-shrink: 0;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }
        .header-box {
            background-color: #0066cc;
            padding: 20px 15px;
            color: white;
            position: relative;
            transition: background-color 0.5s ease;
        }
        #backToSelectionBtn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 1.5em;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header-box .logo {
            width: 80px;
        }
        .title {
            font-size: 22px;
            font-weight: bold;
            margin-top: 10px;
            color: white;
        }
        .card-body {
            padding: 20px;
        }
        .judul-ujian {
            color: #333;
            font-size: 22px;
            font-weight: bold;
            margin: 10px 0;
            transition: color 0.5s ease;
        }

        body.theme-blue .header-box, body.theme-blue #countdownDisplay { background-color: #0066cc; }
        body.theme-blue .judul-ujian { color: #0066cc; }
        body.theme-blue #loginBtn { background-color: #007bff; }
        body.theme-blue #loginBtn:hover { background-color: #0056b3; }
        
        body.theme-orange .header-box, body.theme-orange #countdownDisplay { background-color: #e67e22; }
        body.theme-orange .judul-ujian { color: #e67e22; }
        body.theme-orange #loginBtn { background-color: #f39c12; }
        body.theme-orange #loginBtn:hover { background-color: #d35400; }

        body.theme-maroon .header-box, body.theme-maroon #countdownDisplay { background-color: #a93226; }
        body.theme-maroon .judul-ujian { color: #a93226; }
        body.theme-maroon #loginBtn { background-color: #c0392b; }
        body.theme-maroon #loginBtn:hover { background-color: #922b21; }

        .token-input-group {
            display: flex;
            align-items: center;
            width: calc(100% - 20px);
            margin: 10px auto;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .token-input-group input {
            padding: 10px;
            font-size: 16px;
            border: none;
            margin: 0;
            box-sizing: border-box;
            text-align: center;
            height: 40px;
        }
        #inputTokenPrefix {
            flex-grow: 1;
            min-width: 0;
            border-right: 1px solid #ccc;
        }
        .token-separator {
            background-color: #f0f0f0;
            padding: 10px 5px;
            font-size: 16px;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            box-sizing: border-box;
        }
        #displayStudentId {
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            background-color: #f0f0f0;
            cursor: not-allowed;
        }
        input {
            padding: 10px;
            width: calc(100% - 20px);
            font-size: 16px;
            margin: 10px auto;
            display: block;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: center;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .custom-dropdown-container {
            position: relative;
            width: calc(100% - 20px);
            margin: 10px auto;
            display: block;
        }
        .custom-dropdown-display {
            padding: 10px;
            width: 100%;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: center;
            background-color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 40px;
            color: #555;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .custom-dropdown-display.selected {
            color: #000;
        }
        .custom-dropdown-display.disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }
        .custom-dropdown-display::after {
            content: 'â–¼';
            position: absolute;
            right: 15px;
            font-size: 0.8em;
            color: #888;
        }
        .token-input-group.is-valid {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        .token-input-group.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            width: 100%;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 10px auto;
            display: block;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:active {
            transform: scale(0.98);
        }
        #btnBatal {
            background-color: #dc3545;
        }
        #btnBatal:hover {
            background-color: #c82333;
        }
        .message {
            margin-bottom: 10px;
            font-size: 14px;
            min-height: 30px;
            text-align: center;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid black;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .footer {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            padding-bottom: 10px;
        }
        .custom-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .custom-modal.show {
            display: flex;
            opacity: 1;
        }
        .custom-modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .custom-modal-content h4 {
            font-size: 1.5em;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0;
        }
        .custom-modal-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }
        .custom-modal-list li {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            text-align: left;
            font-size: 1.1em;
            transition: background-color 0.2s ease;
        }
        .custom-modal-list li:nth-child(odd) {
            background-color: white;
        }
        .custom-modal-list li:nth-child(even) {
            background-color: #f9f9f9;
        }
        .custom-modal-list li:last-child {
            border-bottom: none;
        }
        .custom-modal-list li:hover {
            background-color: #e0e0e0;
        }
        #confirmModal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #confirmModal.show {
            display: flex;
            opacity: 1;
        }
        #confirmModal .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            max-width: 380px;
            text-align: left;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #confirmModal .modal-content h4 {
            font-size: 1.8em;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 15px;
            text-align: center;
        }
        #confirmModal .modal-content .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        #confirmModal .modal-content .info-table tr {
            border-bottom: 1px solid #eee;
        }
        #confirmModal .modal-content .info-table tr:last-child {
            border-bottom: none;
        }
        #confirmModal .modal-content .info-table td {
            padding: 8px 0;
            font-size: 1.1em;
        }
        #confirmModal .modal-content td:first-child {
            font-weight: bold;
            color: #333;
            width: 120px;
            padding-right: 10px;
        }
        #confirmModal .modal-content td:last-child {
            text-align: left;
            color: #000;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-top: 15px;
            margin-bottom: 15px;
            font-size: 1em;
            color: #333;
            padding-left: 10px;
        }
        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0 8px 0 0;
            cursor: pointer;
            vertical-align: middle;
            box-shadow: none;
            display: inline-block;
        }
        .checkbox-container label {
            cursor: pointer;
            vertical-align: middle;
        }
        #modalMessage {
            color: red;
            font-size: 0.9em;
            text-align: center;
            margin-top: -10px;
            margin-bottom: 10px;
            min-height: 1.2em;
        }
        #examContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            flex-direction: column;
            background-color: #f0f0f0;
            z-index: 500;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #countdownDisplay {
            color: white;
            padding: 10px;
            font-size: 1.5em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-shrink: 0;
            gap: 10px;
            overflow: hidden;
            transition: background-color 0.5s ease;
        }
        #countdownDisplay #timerText {
            flex-shrink: 0;
        }
        #countdownDisplay #studentNameDisplay,
        #countdownDisplay #classDisplay {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            min-width: 0;
        }
        #examContentWrapper {
            display: flex;
            flex-grow: 1;
            width: 100%;
            position: relative;
            overflow: hidden;
            background-color: transparent;
        }
        #examIframe {
            flex-grow: 1;
            width: 100%;
            border: none;
            margin: 0;
            padding: 0;
            display: block;
            transition: filter 0.3s ease, width 0.3s ease, transform 0.3s ease;
            transform-origin: top left;
            cursor: grab;
            overflow: auto;
        }
        #examIframe.blurred {
            filter: grayscale(100%) blur(5px);
            pointer-events: none;
        }
        #examIframe.dragging {
            cursor: grabbing;
            pointer-events: none;
        }
        #topIframeBlocker {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 25%;
            background: transparent;
            z-index: 550;
            pointer-events: auto;
        }
        #answerSidebar {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 250px;
            background-color: transparent;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            transform: translateX(calc(100% - 56px));
            transition: transform 0.3s ease-in-out;
            z-index: 600;
        }
        #answerSidebar.open {
            transform: translateX(0);
        }
        #sidebarToggle {
            background-color: #28a745;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            position: absolute;
            right: 0;
            top: 0;
            height: 56px;
            width: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            box-shadow: none;
            transition: background-color 0.2s ease, transform 0.3s ease-in-out, opacity 0.2s ease;
            padding: 0;
            box-sizing: border-box;
            z-index: 601;
            transform: translateX(0);
            opacity: 0.5;
        }
        #sidebarToggle:hover {
            background-color: #218838;
            opacity: 1;
        }
        #sidebarToggle #sidebarText {
            writing-mode: horizontal-tb;
            text-orientation: unset;
            transform: none;
            white-space: nowrap;
            padding: 10px 5px;
            font-size: 0.8em;
        }
        #closeSidebarButton {
            background-color: #dc3545;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            box-shadow: none;
            display: none;
            position: absolute;
            left: 0;
            top: 0;
            height: 56px;
            width: 56px;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, opacity 0.2s ease;
            z-index: 602;
            padding: 0;
            box-sizing: border-box;
            opacity: 0.5;
        }
        #closeSidebarButton:hover {
            background-color: #c82333;
            opacity: 1;
        }
        #closeSidebarButton #closeSidebarText {
            writing-mode: horizontal-tb;
            text-orientation: unset;
            transform: none;
            white-space: nowrap;
            padding: 10px 5px;
            font-size: 0.8em;
        }
        #examContentWrapper.sidebar-open #examIframe {
            width: calc(100% - 250px);
        }
        #examContentWrapper.sidebar-open #sidebarToggle {
            display: none;
        }
        #examContentWrapper.sidebar-open #answerSidebar {
            transform: translateX(0);
        }
        #examContentWrapper.sidebar-open #closeSidebarButton {
            display: flex;
        }
        #answerListContainer {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
            gap: 8px;
            flex-shrink: 1;
            margin-left: 56px;
        }
        .answer-box {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 5px 3px;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 30px;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .answer-box:hover {
            background-color: #e0e0e0;
        }
        .answer-box .question-number {
            font-weight: bold;
            margin-bottom: 2px;
            color: #333;
            font-size: 0.7em;
            line-height: 1;
        }
        .answer-box .selected-answer {
            font-weight: bold;
            color: #555;
            font-size: 0.7em;
            line-height: 1;
        }
        .answer-box.answered {
            background-color: #d4edda;
            border-color: #28a745;
        }
        .answer-box.unanswered {
            background-color: #f8d7da;
            border-color: #dc3545;
        }
        .submission-warning-message {
            color: red;
            font-weight: bold;
            text-align: center;
            margin: 5px 0 10px 56px;
            font-size: 0.9em;
            min-height: 1.2em;
        }
        #submitAnswersButton {
            background-color: #007bff;
            color: white;
            padding: 12px;
            margin-top: 0px;
            margin-bottom: 10px;
            margin-left: 56px;
            margin-right: 10px;
            width: calc(100% - 66px);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            flex-shrink: 0;
            transition: background-color 0.2s ease;
        }
        #submitAnswersButton:hover {
            background-color: #0056b3;
        }
        .custom-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .custom-modal.show {
            display: flex;
            opacity: 1;
        }
        .custom-modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        #answerSelectionModal .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            max-width: 300px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            text-align: center;
        }
        #answerSelectionModal h4 {
            font-size: 1.5em;
            color: #0066cc;
            margin-bottom: 20px;
        }
        #answerOptions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        #answerOptions button {
            width: 60px;
            height: 60px;
            font-size: 1.5em;
            border-radius: 50%;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        #answerOptions button:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
        }
        #answerOptions button:active {
            transform: translateY(0);
        }
        #answerOptions button.selected {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }
        #clearAnswerButton {
            background-color: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }
        #clearAnswerButton:hover {
            background-color: #c82333;
        }
        #warningOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0);
            z-index: 10;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #warningOverlay.show {
            display: flex;
            opacity: 1;
        }
        .warning-content-box {
            background: rgba(255, 255, 255, 0.03);
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: none;
            text-align: center;
            box-sizing: border-box;
            pointer-events: none;
        }
        #warningCountdown {
            font-size: 4em;
            font-weight: bold;
            color: red;
            text-shadow: 0 0 10px rgba(255,0,0,0.5);
            margin-bottom: 10px;
            pointer-events: none;
            animation: blink-smooth 1.5s infinite alternate;
        }
        @keyframes blink-smooth {
            0% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        #warningMessage {
            font-size: 1.5em;
            color: black;
            font-weight: bold;
            pointer-events: none;
        }
        #submissionConfirmationOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10001;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            pointer-events: auto;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #submissionConfirmationOverlay.show {
            display: flex;
            opacity: 1;
        }
        .submission-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            text-align: center;
            box-sizing: border-box;
        }
        #submissionConfirmationOverlay h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            font-weight: bold;
            color: #4CAF50;
        }
        #submissionConfirmationOverlay p {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 20px;
        }
        #submissionConfirmationOverlay button {
            padding: 12px 25px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #submissionConfirmationOverlay button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
        #submissionConfirmationOverlay button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,128,0,0.4);
        }
        #fullscreenExitWarningOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            pointer-events: auto;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            flex-direction: column;
        }
        #fullscreenExitWarningOverlay.show {
            display: flex;
            opacity: 1;
        }
        .exit-warning-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            text-align: center;
            box-sizing: border-box;
        }
        .exit-warning-content h2 {
            font-size: 2.2em;
            color: #dc3545;
            margin-bottom: 15px;
        }
        .exit-warning-content p {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 20px;
        }
        .exit-warning-button {
            padding: 12px 25px;
            font-size: 1.2em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .exit-warning-button:hover {
            background-color: #0056b3;
        }
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        #fullscreenOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #fullscreenOverlay.show {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }
        #fullscreenOverlay .overlay-content {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            box-sizing: border-box;
            animation: fadeInScale 0.5s ease-out forwards;
        }
        #fullscreenOverlay .overlay-title {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        #fullscreenOverlay .overlay-instructions {
            list-style: none;
            padding: 0;
            margin-bottom: 30px;
            font-size: 1.2em;
            line-height: 1.6;
        }
        #fullscreenOverlay .overlay-instructions li {
            margin-bottom: 10px;
            position: relative;
            padding-left: 30px;
            text-align: left;
        }
        #fullscreenOverlay .overlay-instructions li::before {
            content: 'âœ…';
            position: absolute;
            left: 0;
            color: #d4edda;
            font-size: 1.2em;
        }
        #fullscreenOverlay .overlay-button {
            background-color: #28a745;
            color: white;
            padding: 15px 30px;
            font-size: 1.3em;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #fullscreenOverlay .overlay-button:hover {
            background-color: #218838;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        #fullscreenOverlay .overlay-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #zoomControls {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 700;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.3s ease-in-out;
        }
        #mainToggleBtnContainer {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }
        #zoomControls button {
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, opacity 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            opacity: 0.5;
        }
        #zoomControls button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
            opacity: 1;
        }
        #zoomControls button:active {
            transform: scale(0.95);
        }
        #zoomControls button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.5;
        }
        #controlsGrid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            height: 0;
            opacity: 0;
            pointer-events: none;
        }
        #zoomControls.show-controls #controlsGrid {
            height: auto;
            opacity: 1;
            pointer-events: auto;
        }
        #refreshIframeBtn .icon {
            font-size: 1.2em;
        }
        #panLeftBtn .icon, #panRightBtn .icon {
            font-size: 1.5em;
        }
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        @media (max-width: 600px) {
            .container, #selectionContainer {
                margin-top: 40px;
                margin-bottom: 40px;
                border-radius: 0;
                border: none;
                box-shadow: none;
                width: 100%;
            }
            .header-box {
                border-radius: 0;
            }
            #confirmModal .modal-content {
                padding: 20px;
                max-width: 90%;
            }
            #confirmModal .modal-content h4 {
                font-size: 1.5em;
            }
            #confirmModal .modal-content .info-table td {
                font-size: 1em;
            }
            #confirmModal .modal-content td:first-child {
                width: 90px;
            }
            .checkbox-container {
                padding-left: 5px;
            }
            #fullscreenOverlay .overlay-content {
                padding: 25px;
                max-width: 95%;
            }
            #fullscreenOverlay .overlay-title {
                font-size: 2em;
            }
            #fullscreenOverlay .overlay-instructions {
                font-size: 0.9em;
            }
            #fullscreenOverlay .overlay-instructions li {
                padding-left: 25px;
            }
            #fullscreenOverlay .overlay-instructions li::before {
                font-size: 1em;
            }
            #fullscreenOverlay .overlay-button {
                font-size: 1.1em;
                padding: 12px 25px;
            }
            #countdownDisplay {
                font-size: 1.1em;
                padding: 8px;
            }
            #countdownDisplay #studentNameDisplay,
            #countdownDisplay #classDisplay {
                font-size: 0.9em;
            }
            #warningCountdown {
                font-size: 3em;
            }
            #warningMessage {
                font-size: 1.2em;
            }
            .warning-content-box {
                padding: 20px;
                max-width: 90%;
            }
            #submissionConfirmationOverlay h1 {
                font-size: 2em;
            }
            #submissionConfirmationOverlay p {
                font-size: 1.2em;
            }
            #submissionConfirmationOverlay button {
                font-size: 1em;
                padding: 12px 25px;
            }
            .submission-content {
                padding: 20px;
                max-width: 90%;
            }
            .exit-warning-content {
                padding: 20px;
                max-width: 90%;
            }
            .exit-warning-content h2 {
                font-size: 1.8em;
            }
            .exit-warning-content p {
                font-size: 1em;
            }
            .exit-warning-button {
                font-size: 1em;
                padding: 10px 20px;
            }
            .custom-modal-content {
                padding: 15px;
                width: 95%;
                max-height: 90vh;
            }
            .custom-modal-content h4 {
                font-size: 1.2em;
            }
            .custom-modal-list li {
                padding: 10px 12px;
                font-size: 1em;
            }
            #answerSidebar {
                width: 180px;
                transform: translateX(calc(100% - 56px));
            }
            #answerSidebar.open {
                transform: translateX(0);
            }
            #sidebarToggle {
                width: 56px;
                height: 56px;
            }
            #sidebarToggle #sidebarText {
                font-size: 0.7em;
            }
            #closeSidebarButton {
                width: 56px;
                height: 56px;
            }
            #closeSidebarButton #closeSidebarText {
                font-size: 0.7em;
            }
            #answerListContainer {
                grid-template-columns: repeat(auto-fill, minmax(25px, 1fr));
                gap: 5px;
                margin-left: 56px;
            }
            .answer-box {
                height: 30px;
                font-size: 0.8em;
            }
            .answer-box .question-number,
            .answer-box .selected-answer {
                font-size: 0.7em;
            }
            #submitAnswersButton {
                font-size: 0.9em;
                padding: 10px;
                width: calc(100% - 66px);
            }
            #answerSelectionModal .modal-content {
                max-width: 280px;
            }
            #answerOptions button {
                width: 50px;
                height: 50px;
                font-size: 1.2em;
            }
            #zoomControls button {
                width: 35px;
                height: 35px;
                font-size: 1.2em;
            }
        }
        @media (max-width: 400px) {
            .header-box .logo {
                width: 60px;
            }
            .title {
                font-size: 18px;
            }
            .card-body {
                padding: 15px;
            }
            input {
                font-size: 14px;
                padding: 8px;
            }
            button {
                font-size: 14px;
                padding: 8px 15px;
            }
            .footer {
                font-size: 10px;
            }
            .checkbox-container {
                font-size: 0.9em;
            }
            .custom-dropdown-display {
                font-size: 14px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="selectionContainer">
        <h1>SELAMAT DATANG</h1>
        <p>Silakan pilih jenjang kelas Anda untuk melanjutkan ke halaman ujian.</p>
        <button id="selectGrade7" class="grade-selection-btn">KELAS 7</button>
        <button id="selectGrade8" class="grade-selection-btn">KELAS 8</button>
        <button id="selectGrade9" class="grade-selection-btn">KELAS 9</button>
    </div>

    <div id="appContainer" style="display: none;">
        <div class="container">
            <div class="header-box">
                <button id="backToSelectionBtn" title="Kembali ke Pemilihan Kelas">&#8617;</button>
                <img src="https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/logosmpn2pjg.png" alt="Logo" class="logo" />
                <div class="title">SMPN 2 PAJANGAN</div>
            </div>
            <div class="card-body">
                <div class="judul-ujian">UJIAN KELAS</div>
                <div id="locationBlocked" style="display: none; color: red; margin-bottom: 10px; font-weight: bold; text-align: center;">
                    AKSES UJIAN DIBLOKIR, silahkan aktifkan lokasi perangkat Anda di SMPN 2 Pajangan! Setelah diaktifkan, silahkan refresh halaman login!
                </div>
                <p class="message" id="message"></p>
                <p id="locationStatus" style="color: gray; font-size: 12px; text-align: center;">Memuat status lokasi...</p>

                <div class="custom-dropdown-container">
                    <div id="customSelectKelasDisplay" class="custom-dropdown-display" data-placeholder="-- Pilih Kelas --">
                        -- Pilih Kelas --
                    </div>
                    <input type="hidden" id="selectKelas" value="" />
                </div>

                <div class="custom-dropdown-container">
                    <div id="customSelectNamaSiswaDisplay" class="custom-dropdown-display" data-placeholder="-- Pilih Nama Siswa --">
                        -- Pilih Nama Siswa --
                    </div>
                    <input type="hidden" id="selectNamaSiswa" value="" />
                </div>

                <div class="token-input-group">
                    <input type="text" id="inputTokenPrefix" placeholder="TOKEN (contoh: ABCDE)" />
                    <span class="token-separator">-</span>
                    <input type="text" id="displayStudentId" placeholder="ID Siswa" readonly />
                </div>

                <button id="loginBtn">Login</button>
            </div>
            <div class="footer">
                Â© Admin SMPN 2 Pajangan<br>
                <span id="datetime"></span>
            </div>
        </div>
    </div>

    <div id="examContainer" style="display: none;">
        <div id="countdownDisplay">
            <span id="timerText"></span> | <span id="studentNameDisplay"></span> | <span id="classDisplay"></span>
        </div>
        <div id="examContentWrapper">
            <iframe id="examIframe" src="" frameborder="0"></iframe>
            <div id="topIframeBlocker"></div>

            <div id="zoomControls">
                <div id="mainToggleBtnContainer">
                    <button id="toggleControlsBtn" title="Alihkan Kontrol">
                        <span class="icon">&#9776;</span> </button>
                    <button id="refreshIframeBtn" title="Muat Ulang Iframe">
                        <span class="icon">&#x21BB;</span>
                    </button>
                </div>
                <div id="controlsGrid">
                    <button id="zoomInBtn">+</button>
                    <button id="zoomOutBtn">-</button>
                    <button id="panLeftBtn"><span class="icon">&larr;</span></button>
                    <button id="panRightBtn"><span class="icon">&rarr;</span></button>
                </div>
            </div>

            <button id="sidebarToggle">
                <span id="sidebarText">JAWAB</span>
            </button>

            <div id="answerSidebar">
                <button id="closeSidebarButton">
                    <span id="closeSidebarText">TUTUP</span>
                </button>

                <div id="answerListContainer">
                </div>
                <p id="submissionWarningMessage" class="submission-warning-message"></p>
                <button id="submitAnswersButton" disabled style="background-color: #cccccc; cursor: not-allowed;">KIRIM JAWABAN</button>
            </div>
        </div>

        <div id="warningOverlay" style="display: none;">
            <div class="warning-content-box">
                <div id="warningCountdown"></div>
                <div id="warningMessage">SEGERA KIRIMKAN JAWABAN, JANGAN SAMPAI KEHABISAN WAKTU!</div>
            </div>
        </div>

        <div id="fullscreenExitWarningOverlay" style="display: none;">
            <div class="exit-warning-content">
                <h2 id="exitWarningTitle">PERINGATAN!</h2>
                <p id="exitWarningMessage">Anda telah keluar dari mode layar penuh. Mohon kembali ke mode layar penuh untuk melanjutkan ujian.</p>
                <p id="attemptsLeftInfo" style="font-size: 1.1em; color: #0066cc; font-weight: bold; margin-top: 10px; display: none;"></p>

                <div id="lockKeySection" style="margin-top: 20px; display: none;">
                    <p style="font-size: 1.1em; color: #333; margin-bottom: 10px;">Masukkan kunci untuk melanjutkan:</p>
                    <input type="password" id="lockKeyInput" placeholder="Kunci..." style="width: calc(100% - 20px); padding: 10px; border: 1px solid #ccc; border-radius: 5px; text-align: center; margin-bottom: 10px;">
                    <p id="lockKeyMessage" style="color: red; font-size: 0.9em; min-height: 1.2em;"></p>
                    <button id="lockKeySubmitBtn" class="exit-warning-button" style="background-color: #28a745;">Masuk dengan Kunci</button>
                </div>

                <button id="reEnterFullscreenBtn" class="exit-warning-button">Kembali ke Layar Penuh</button>
            </div>
        </div>

        <div id="answerSelectionModal" class="custom-modal">
            <div class="modal-content">
                <h4 id="answerModalTitle">Pilih Jawaban Soal No. <span id="currentQuestionNumber"></span></h4>
                <div id="answerOptions">
                    <button data-answer="A">A</button>
                    <button data-answer="B">B</button>
                    <button data-answer="C">C</button>
                    <button data-answer="D">D</button>
                </div>
                <button id="clearAnswerButton">Hapus Jawaban</button>
            </div>
        </div>

        <div id="customMessageModal" class="custom-modal">
            <div class="custom-modal-content">
                <h4 id="customMessageModalTitle"></h4>
                <p id="customMessageModalText"></p>
                <button id="customMessageModalButton" onclick="window.hideCustomMessageModal()">OK</button>
            </div>
        </div>

        <div id="customConfirmModal" class="custom-modal">
            <div class="custom-modal-content">
                <h4 id="customConfirmModalTitle"></h4>
                <p id="customConfirmModalText"></p>
                <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                    <button id="customConfirmModalConfirmBtn" style="background-color: #28a745; width: 45%;">Ya</button>
                    <button id="customConfirmModalCancelBtn" style="background-color: #dc3545; width: 45%;">Tidak</button>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmModal">
        <div class="modal-content">
            <h4>DATA UJIAN ONLINE</h4>
            <table class="info-table">
                <tr>
                    <td>ID Siswa</td>
                    <td>: <span id="modalIdSiswa"></span></td>
                </tr>
                <tr>
                    <td>Nama Lengkap</td>
                    <td>: <span id="modalNamaLengkap"></span></td>
                </tr>
                <tr>
                    <td>Kelas</td>
                    <td>: <span id="modalKelas"></span></td>
                </tr>
                <tr>
                    <td>Mapel</td>
                    <td>: <span id="modalMapel"></span></td>
                </tr>
                <tr>
                    <td>Waktu Ujian</td>
                    <td>: <span id="modalExamDuration"></span></td>
                </tr>
            </table>

            <div class="checkbox-container">
                <input type="checkbox" id="confirmCheckbox">
                <label for="confirmCheckbox">Data di atas sudah benar</label>
            </div>
            <p id="modalMessage" style="display: none;"></p>
            <div class="button-container">
                <button id="btnLanjut">Lanjutkan</button>
                <button id="btnBatal" onclick="window.tutupModal()">Batal</button>
            </div>
        </div>
    </div>

    <div id="fullscreenOverlay" style="display: none;">
        <div class="overlay-content">
            <h2 class="overlay-title">PERHATIKAN HAL-HAL BERIKUT:</h2>
            <ul class="overlay-instructions">
                <li>Berdoa & kerjakan sungguh-sungguh</li>
                <li>Dilarang curang</li>
                <li>Pastikan jaringan stabil</li>
                <li>Klik "JAWAB" di kanan untuk mengisi</li>
                <li>"Kirim Jawaban" aktif sisa 30 menit</li>
                <li>Ujian otomatis terkirim jika waktu habis</li>
            </ul>
            <button id="overlayUnderstandBtn" class="overlay-button">SAYA MENGERTI</button>
        </div>
    </div>

    <div id="submissionConfirmationOverlay">
        <div class="submission-content">
            <h1 id="submissionOverlayTitle"></h1>
            <p id="submissionOverlayMessage"></p>
            <button id="backToLoginFromSubmissionBtn">KEMBALI</button>
        </div>
    </div>

    <div id="classModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4>Pilih Kelas</h4>
            <ul id="classModalList" class="custom-modal-list">
            </ul>
        </div>
    </div>

    <div id="studentModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4>Pilih Nama Siswa</h4>
            <ul id="studentModalList" class="custom-modal-list">
            </ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { getDatabase, ref, get, child, runTransaction, set, onValue, off, update, remove } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

        const allFirebaseConfigs = {
            'ujianpdf-7abc': {
                apiKey: "AIzaSyBJBl_HWsOsnBBI1EPs1yQlJd0Hso8HcSo",
                authDomain: "ujianpdf-7abc.firebaseapp.com",
                databaseURL: "https://ujianpdf-7abc-default-rtdb.firebaseio.com",
                projectId: "ujianpdf-7abc",
                storageBucket: "ujianpdf-7abc.appspot.com",
                messagingSenderId: "1035978389542",
                appId: "1:1035978389542:web:413eb32b04c0d09bc48ee7"
            },
            'ujianpdf-7def': {
                apiKey: "AIzaSyDQKdbwaG0Tg7_tfHs0hCbNR3xlqT3vWLA",
                authDomain: "ujianpdf-7def.firebaseapp.com",
                databaseURL: "https://ujianpdf-7def-default-rtdb.firebaseio.com",
                projectId: "ujianpdf-7def",
                storageBucket: "ujianpdf-7def.appspot.com",
                messagingSenderId: "210211262444",
                appId: "1:210211262444:web:a06a988913ede65369bac9"
            },
            'ujianpdf-8abc': {
                apiKey: "AIzaSyAsbVn2qVIgH278ZjPfkMihlGYmyL8zJFA",
                authDomain: "ujianpdf8abc-3bedf.firebaseapp.com",
                databaseURL: "https://ujianpdf8abc-3bedf-default-rtdb.firebaseio.com",
                projectId: "ujianpdf8abc-3bedf",
                storageBucket: "ujianpdf8abc-3bedf.appspot.com",
                messagingSenderId: "408487358048",
                appId: "1:408487358048:web:10cc8796510f4b8ab99d05"
            },
            'ujianpdf-8def': {
                apiKey: "AIzaSyBvkIMTkJkDqe2nKspIMXOCeT9vc6h8xjA",
                authDomain: "ujianpdf8def-9bdcd.firebaseapp.com",
                databaseURL: "https://ujianpdf8def-9bdcd-default-rtdb.firebaseio.com",
                projectId: "ujianpdf8def-9bdcd",
                storageBucket: "ujianpdf8def-9bdcd.appspot.com",
                messagingSenderId: "69381651529",
                appId: "1:69381651529:web:af517e87735d2ad51a9398"
            },
            'ujianpdf-9abc': {
                apiKey: "AIzaSyCjf42a3CCB3IuNto2K8MGpTX_SM1FXyrw",
                authDomain: "ujianpdf-9abc.firebaseapp.com",
                databaseURL: "https://ujianpdf-9abc-default-rtdb.firebaseio.com",
                projectId: "ujianpdf-9abc",
                storageBucket: "ujianpdf-9abc.appspot.com",
                messagingSenderId: "939178637981",
                appId: "1:939178637981:web:b9a15dfa72180d15d77274"
            },
            'ujianpdf-9def': {
                apiKey: "AIzaSyDK50Amn6N8gl_q6CVhDjV_DRPpdCpCTrw",
                authDomain: "ujianpdf-9def.firebaseapp.com",
                databaseURL: "https://ujianpdf-9def-default-rtdb.firebaseio.com",
                projectId: "ujianpdf-9def",
                storageBucket: "ujianpdf-9def.appspot.com",
                messagingSenderId: "450883192159",
                appId: "1:450883192159:web:6ad39c42db5756ff0f62ea"
            }
        };

        function getClassGroupKey(className) {
            if (!className) return null;
            const grade = parseInt(className.charAt(0), 10);
            const classLetter = className.charAt(1).toUpperCase();

            if (grade === 7) {
                if (['A', 'B', 'C'].includes(classLetter)) return 'ujianpdf-7abc';
                if (['D', 'E', 'F'].includes(classLetter)) return 'ujianpdf-7def';
            } else if (grade === 8) {
                if (['A', 'B', 'C'].includes(classLetter)) return 'ujianpdf-8abc';
                if (['D', 'E', 'F'].includes(classLetter)) return 'ujianpdf-8def';
            } else if (grade === 9) {
                 if (['A', 'B', 'C'].includes(classLetter)) return 'ujianpdf-9abc';
                if (['D', 'E', 'F'].includes(classLetter)) return 'ujianpdf-9def';
            }
            return null;
        }

        const firebaseApps = {};
        const firebaseDBs = {};
        const firebaseAuths = {};
        let currentDb = null;
        let currentAuth = null;
        let selectedGrade = null;

        async function getFirebaseInstanceForClass(className) {
            const classGroupKey = getClassGroupKey(className);
            if (!classGroupKey || !allFirebaseConfigs[classGroupKey]) {
                console.error(`Error: Tidak ada konfigurasi Firebase yang ditemukan untuk grup kelas: ${className}`);
                return null;
            }

            if (!firebaseApps[classGroupKey]) {
                const config = allFirebaseConfigs[classGroupKey];
                const appInstance = initializeApp(config, classGroupKey);
                firebaseApps[classGroupKey] = appInstance;
                firebaseDBs[classGroupKey] = getDatabase(appInstance);
                const authInstance = getAuth(appInstance);
                firebaseAuths[classGroupKey] = authInstance;

                try {
                    await signInAnonymously(authInstance);
                    console.log(`Login anonim berhasil untuk grup: ${classGroupKey}`);
                } catch (error) {
                    console.error(`Gagal login anonim untuk grup ${classGroupKey}:`, error);
                    message.style.color = "red";
                    message.textContent = "Gagal melakukan autentikasi ke server.";
                    return null;
                }
            }
            return { db: firebaseDBs[classGroupKey], auth: firebaseAuths[classGroupKey] };
        }
        
        function getDbRefs() {
            if (!currentDb) {
                console.error("Instance database (currentDb) tidak diinisialisasi.");
                return null;
            }
            return {
                settingsRef: ref(currentDb, 'setlokasi'),
                lockSettingsRef: ref(currentDb, 'lock_settings'),
                studentsRef: ref(currentDb, 'students'),
                tokensRef: ref(currentDb, 'tokens'),
                examAccessStatusRef: ref(currentDb, 'exam_access_status'),
                adminSettingsRef: ref(currentDb, 'admin_settings'),
                submittedExamsRef: ref(currentDb, 'submitted_exams'),
                studentAnswersRef: ref(currentDb, 'student_answers')
            };
        }

        let isLocationEnabled = true;
        let firebaseAllowedRadiusKm = 0.075;
        let isLockEnabledGlobal = false;
        let lockKeyGlobal = "";
        let toleranceLimitGlobal = 0;
        let currentAttemptsLeft = 0;
        const allowedLatitude = -7.8589546;
        const allowedLongitude = 110.2655596;
        const appContainer = document.getElementById('appContainer');
        const selectionContainer = document.getElementById('selectionContainer');
        const examContainer = document.getElementById('examContainer');
        const countdownDisplay = document.getElementById('countdownDisplay');
        const timerText = document.getElementById('timerText');
        const studentNameDisplay = document.getElementById('studentNameDisplay');
        const classDisplay = document.getElementById('classDisplay');
        const examIframe = document.getElementById('examIframe');
        const fullscreenOverlay = document.getElementById('fullscreenOverlay');
        const overlayUnderstandBtn = document.getElementById('overlayUnderstandBtn');
        const warningOverlay = document.getElementById('warningOverlay');
        const warningCountdown = document.getElementById('warningCountdown');
        const locationBlockedDiv = document.getElementById('locationBlocked');
        const message = document.getElementById('message');
        const loginBtn = document.getElementById('loginBtn');
        const confirmModal = document.getElementById('confirmModal');
        const locationStatus = document.getElementById('locationStatus');
        const inputTokenPrefix = document.getElementById('inputTokenPrefix');
        const displayStudentId = document.getElementById('displayStudentId');
        const customSelectKelasDisplay = document.getElementById('customSelectKelasDisplay');
        const hiddenSelectKelas = document.getElementById('selectKelas');
        const customSelectNamaSiswaDisplay = document.getElementById('customSelectNamaSiswaDisplay');
        const hiddenSelectNamaSiswa = document.getElementById('selectNamaSiswa');
        const confirmCheckbox = document.getElementById('confirmCheckbox');
        const modalMessage = document.getElementById('modalMessage');
        const modalExamDuration = document.getElementById('modalExamDuration');
        const submissionConfirmationOverlay = document.getElementById('submissionConfirmationOverlay');
        const submissionOverlayTitle = document.getElementById('submissionOverlayTitle'); 
        const submissionOverlayMessage = document.getElementById('submissionOverlayMessage'); 
        const backToLoginFromSubmissionBtn = document.getElementById('backToLoginFromSubmissionBtn');
        const fullscreenExitWarningOverlay = document.getElementById('fullscreenExitWarningOverlay');
        const exitWarningTitle = document.getElementById('exitWarningTitle');
        const exitWarningMessage = document.getElementById('exitWarningMessage');
        const attemptsLeftInfo = document.getElementById('attemptsLeftInfo');
        const lockKeySection = document.getElementById('lockKeySection');
        const lockKeyInput = document.getElementById('lockKeyInput');
        const lockKeyMessage = document.getElementById('lockKeyMessage');
        const lockKeySubmitBtn = document.getElementById('lockKeySubmitBtn');
        const reEnterFullscreenBtn = document.getElementById('reEnterFullscreenBtn');
        const classModal = document.getElementById('classModal');
        const classModalList = document.getElementById('classModalList');
        const studentModal = document.getElementById('studentModal');
        const studentModalList = document.getElementById('studentModalList');
        const answerSidebar = document.getElementById('answerSidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const answerListContainer = document.getElementById('answerListContainer');
        const submitAnswersButton = document.getElementById('submitAnswersButton');
        const submissionWarningMessage = document.getElementById('submissionWarningMessage');
        const sidebarText = document.getElementById('sidebarText');
        const closeSidebarButton = document.getElementById('closeSidebarButton');
        const closeSidebarText = document.getElementById('closeSidebarText');
        const examContentWrapper = document.getElementById('examContentWrapper');
        const zoomControls = document.getElementById('zoomControls');
        const toggleControlsBtn = document.getElementById('toggleControlsBtn');
        const controlsGrid = document.getElementById('controlsGrid');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const panLeftBtn = document.getElementById('panLeftBtn');
        const panRightBtn = document.getElementById('panRightBtn');
        const refreshIframeBtn = document.getElementById('refreshIframeBtn');

        let allStudentsData = [];
        let selectedStudentData = null;
        let isLocationValid = false;
        let foundTokenGlobal = null;
        let timerInterval; 
        let remainingTime; 
        let submissionListenerRef = null;
        let isInExamMode = false;
        let isAnyModalOpen = false;
        let totalQuestions = 0; 
        let studentAnswers = []; 
        let currentQuestionIndexForModal = -1; 

        const answerSelectionModal = document.getElementById('answerSelectionModal');
        const currentQuestionNumberSpan = document.getElementById('currentQuestionNumber');
        const answerOptionsContainer = document.getElementById('answerOptions');
        const clearAnswerButton = document.getElementById('clearAnswerButton');
        const customMessageModal = document.getElementById('customMessageModal');
        const customMessageModalTitle = document.getElementById('customMessageModalTitle');
        const customMessageModalText = document.getElementById('customMessageModalText');
        const customMessageModalButton = document.getElementById('customMessageModalButton');
        const customConfirmModal = document.getElementById('customConfirmModal');
        const customConfirmModalTitle = document.getElementById('customConfirmModalTitle');
        const customConfirmModalText = document.getElementById('customConfirmModalText');
        const customConfirmModalConfirmBtn = document.getElementById('customConfirmModalConfirmBtn');
        const customConfirmModalCancelBtn = document.getElementById('customConfirmModalCancelBtn');

        let globalExamUrl = '';
        let globalExamDurationMinutes = 0;
        let globalNumQuestions = 0;
        let globalExamStartTime = 0;
        let globalInitialAnswers = null;

        let currentZoom = 1.0;
        const MIN_ZOOM = 1.0;
        const MAX_ZOOM = 2.0;
        const ZOOM_STEP = 0.1;
        const PAN_STEP = 10;
        let isDragging = false;
        let startX, startY;
        let currentTranslateX = 0;
        let currentTranslateY = 0;
        let autoHideTimer;
        let panIntervalId = null;
        let panDirection = 0;
        const PAN_START_DELAY = 1500;
        const PAN_INTERVAL = 150;
        let panPressTimer = null;

        function padStudentId(id) {
            return String(id).padStart(3, '0');
        }

        function isTouchDevice() {
            return window.matchMedia('(pointer: coarse)').matches;
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('datetime').textContent = now.toLocaleDateString('id-ID', options);
        }

        window.formatTokenPrefix = function (inputElement) {
            const tokenInputGroup = inputElement.closest('.token-input-group');
            if (tokenInputGroup) {
                tokenInputGroup.classList.remove('is-valid', 'is-invalid');
            }
            let value = inputElement.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            inputElement.value = value;
            if (value.length > 0) {
                if (tokenInputGroup) tokenInputGroup.classList.add('is-valid');
            }
            updateLoginButtonStatus();
        };

        function updateLoginButtonStatus() {
            const isLocationCheckPassed = (isLocationEnabled && isTouchDevice()) ? isLocationValid : true;
            const isClassAndStudentSelected = hiddenSelectKelas.value !== "" && hiddenSelectNamaSiswa.value !== "";
            const isTokenPrefixFilled = inputTokenPrefix.value.trim() !== "";

            inputTokenPrefix.disabled = !isClassAndStudentSelected;
            if (!isClassAndStudentSelected) {
                inputTokenPrefix.value = "";
                const tokenInputGroup = inputTokenPrefix.closest('.token-input-group');
                if (tokenInputGroup) tokenInputGroup.classList.remove('is-valid', 'is-invalid');
            }

            customSelectNamaSiswaDisplay.classList.toggle('disabled', hiddenSelectKelas.value === "");
            loginBtn.disabled = !(isLocationCheckPassed && isClassAndStudentSelected && isTokenPrefixFilled);
            loginBtn.style.opacity = loginBtn.disabled ? 0.6 : 1;
        }

        window.tutupModal = async function () {
            confirmModal.classList.remove('show');
            isAnyModalOpen = false;
            message.textContent = "";
            modalMessage.textContent = "";
            confirmCheckbox.checked = false;
            updateLoginButtonStatus();
            sessionStorage.clear();
        };

        function checkLocation(latitude, longitude) {
            const distance = getDistanceFromLatLonInKm(allowedLatitude, allowedLongitude, latitude, longitude);
            isLocationValid = distance <= firebaseAllowedRadiusKm;
            locationBlockedDiv.style.display = isLocationValid ? 'none' : 'block';
            locationStatus.textContent = isLocationValid ? "Lokasi valid." : `Anda berada ${distance.toFixed(2)} km dari lokasi.`;
            locationStatus.style.color = isLocationValid ? "green" : "red";
            updateLoginButtonStatus();
        }

        function handleLocation(position) {
            checkLocation(position.coords.latitude, position.coords.longitude);
        }

        function handleLocationError(error) {
            locationBlockedDiv.style.display = 'block';
            let errorMessage = "Gagal mendapatkan lokasi. Pastikan GPS dan izin lokasi aktif.";
            message.textContent = errorMessage;
            isLocationValid = false;
            updateLoginButtonStatus();
        }

        function getLocation() {
            if (isLocationEnabled && isTouchDevice()) {
                locationStatus.style.display = 'block';
                locationStatus.textContent = 'Mencari lokasi Anda...';
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(handleLocation, handleLocationError, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                } else {
                    locationBlockedDiv.textContent = 'Geolocation tidak didukung.';
                    isLocationValid = false;
                    updateLoginButtonStatus();
                }
            } else {
                locationBlockedDiv.style.display = 'none';
                isLocationValid = true;
                locationStatus.style.display = 'none';
                updateLoginButtonStatus();
            }
        }

        function loadInitialClassDropdown() {
            customSelectKelasDisplay.classList.add('disabled');
            customSelectNamaSiswaDisplay.classList.add('disabled');
            inputTokenPrefix.disabled = true;
            displayStudentId.value = "";
            message.innerHTML = `Memuat daftar kelas... <span class="spinner"></span>`;
            
            let classNames = [];
            if (selectedGrade === 7) classNames = ['7A', '7B', '7C', '7D', '7E', '7F'];
            else if (selectedGrade === 8) classNames = ['8A', '8B', '8C', '8D', '8E', '8F'];
            else if (selectedGrade === 9) classNames = ['9A', '9B', '9C', '9D', '9E', '9F'];

            classModalList.innerHTML = '';
            classNames.forEach(cls => {
                const listItem = document.createElement('li');
                listItem.textContent = cls;
                listItem.dataset.value = cls;
                listItem.addEventListener('click', () => selectClass(cls));
                classModalList.appendChild(listItem);
            });
            customSelectKelasDisplay.classList.remove('disabled');
            message.textContent = "";
        }

        async function loadStudentsAndFilterByClass() {
            if (!currentDb) {
                message.style.color = "red";
                message.textContent = "Database belum diinisialisasi.";
                return;
            }
            const dbRefs = getDbRefs();
            if (!dbRefs) return;

            message.innerHTML = `Memuat data siswa... <span class="spinner"></span>`;
            try {
                const snapshot = await get(dbRefs.studentsRef);
                if (snapshot.exists()) {
                    allStudentsData = [];
                    snapshot.forEach(childSnapshot => {
                        allStudentsData.push({ ...childSnapshot.val(), key: childSnapshot.key });
                    });
                    filterStudentsByClass();
                    message.textContent = "";
                } else {
                    message.style.color = "orange";
                    message.textContent = "Tidak ada data siswa ditemukan.";
                }
            } catch (error) {
                message.style.color = "red";
                message.textContent = "Gagal memuat data siswa.";
            }
        }

        function filterStudentsByClass() {
            const selectedClass = hiddenSelectKelas.value;
            studentModalList.innerHTML = '';
            hiddenSelectNamaSiswa.value = '';
            customSelectNamaSiswaDisplay.textContent = '-- Pilih Nama Siswa --';
            customSelectNamaSiswaDisplay.classList.remove('selected');
            selectedStudentData = null;
            displayStudentId.value = "";
            inputTokenPrefix.value = "";
            
            if (selectedClass) {
                const filteredStudents = allStudentsData.filter(student => student.class === selectedClass);
                filteredStudents.sort((a, b) => a.name.localeCompare(b.name)).forEach(student => {
                    const listItem = document.createElement('li');
                    listItem.textContent = student.name;
                    listItem.dataset.value = student.id;
                    listItem.addEventListener('click', () => selectStudent(student.id, student.name));
                    studentModalList.appendChild(listItem);
                });
                customSelectNamaSiswaDisplay.classList.remove('disabled');
            } else {
                customSelectNamaSiswaDisplay.classList.add('disabled');
            }
            updateLoginButtonStatus();
        }

        function openClassModal() {
            if (customSelectKelasDisplay.classList.contains('disabled')) return;
            classModal.classList.add('show');
            isAnyModalOpen = true;
        }

        function closeClassModal() {
            classModal.classList.remove('show');
            isAnyModalOpen = false;
        }

        async function selectClass(className) {
            hiddenSelectKelas.value = className;
            customSelectKelasDisplay.textContent = className;
            customSelectKelasDisplay.classList.add('selected');
            closeClassModal();

            const instances = await getFirebaseInstanceForClass(className);
            if (!instances) {
                message.style.color = "red";
                message.textContent = "Gagal memuat konfigurasi.";
                return;
            }
            currentDb = instances.db;
            currentAuth = instances.auth;

            await loadStudentsAndFilterByClass();
        }

        function openStudentModal() {
            if (customSelectNamaSiswaDisplay.classList.contains('disabled')) return;
            studentModal.classList.add('show');
            isAnyModalOpen = true;
        }

        function closeStudentModal() {
            studentModal.classList.remove('show');
            isAnyModalOpen = false;
        }

        function selectStudent(studentId, studentName) {
            hiddenSelectNamaSiswa.value = studentId;
            customSelectNamaSiswaDisplay.textContent = studentName;
            customSelectNamaSiswaDisplay.classList.add('selected');
            selectedStudentData = allStudentsData.find(s => s.id == studentId);
            displayStudentId.value = padStudentId(studentId);
            closeStudentModal();
            updateLoginButtonStatus();
        }

        function updateTimerDisplay() {
            if (!timerText || !studentNameDisplay || !classDisplay) return;

            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            timerText.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            studentNameDisplay.textContent = selectedStudentData?.name || '';
            classDisplay.textContent = selectedStudentData?.class || '';

            const thirtyMinutesInSeconds = 30 * 60;
            submitAnswersButton.disabled = !(remainingTime <= thirtyMinutesInSeconds && remainingTime > 0);
            submitAnswersButton.style.backgroundColor = submitAnswersButton.disabled ? '#cccccc' : '';
            submitAnswersButton.style.cursor = submitAnswersButton.disabled ? 'not-allowed' : 'pointer';

            if (remainingTime <= 300 && remainingTime > 0) {
                countdownDisplay.style.display = 'none';
                warningCountdown.textContent = timerText.textContent;
                warningOverlay.style.display = 'flex';
                warningOverlay.style.opacity = 1;
            } else {
                warningOverlay.style.opacity = 0;
                setTimeout(() => { warningOverlay.style.display = 'none'; }, 300);
            }

            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                timerText.textContent = "00:00";
                countdownDisplay.style.display = 'block';
                submitAnswers(true);
                return;
            }
            remainingTime--;
        }

        function showOverlay(initialAnswers = null) {
            globalInitialAnswers = initialAnswers;
            appContainer.style.display = 'none';
            setTimeout(() => {
                fullscreenOverlay.style.display = 'flex';
                fullscreenOverlay.classList.add('show');
            }, 500);
        }

        function hideOverlay() {
            fullscreenOverlay.classList.remove('show');
            setTimeout(() => {
                fullscreenOverlay.style.display = 'none';
                startExamProcess(globalExamUrl, globalExamDurationMinutes, globalNumQuestions, globalExamStartTime, globalInitialAnswers); 
            }, 300);
        }

        async function showSubmissionConfirmationOverlay(isAutoSubmit) {
            sessionStorage.clear();
            examContainer.style.opacity = 0;
            setTimeout(async () => {
                examContainer.style.display = 'none';
                submissionConfirmationOverlay.style.display = 'flex';
                submissionConfirmationOverlay.style.opacity = 1;

                if (timerInterval) clearInterval(timerInterval);
                if (submissionListenerRef) {
                    off(submissionListenerRef);
                    submissionListenerRef = null;
                }
                isInExamMode = false;
                toggleExamSecurityFeatures(false);
                if (document.fullscreenElement) await document.exitFullscreen();

                if (isAutoSubmit) {
                    submissionOverlayTitle.innerHTML = '<span style="color: red;">WAKTU HABIS</span>';
                    submissionOverlayMessage.innerText = 'Jawaban Anda otomatis terkirim.';
                } else {
                    submissionOverlayTitle.innerText = 'SELAMAT!';
                    submissionOverlayMessage.innerText = 'Jawaban Anda berhasil terkirim.';
                }
            }, 500);
        }

        function toggleExamSecurityFeatures(enable) {
            const events = ['copy', 'cut', 'paste', 'selectstart', 'contextmenu'];
            events.forEach(event => {
                if (enable) document.addEventListener(event, preventDefaultBehavior);
                else document.removeEventListener(event, preventDefaultBehavior);
            });
            document.body.classList.toggle('no-select', enable);
        }

        function preventDefaultBehavior(e) { e.preventDefault(); }

        function attemptFullscreen() {
            if (document.fullscreenElement) return;
            const fsRequest = examContainer.requestFullscreen || examContainer.mozRequestFullScreen || examContainer.webkitRequestFullscreen || examContainer.msRequestFullscreen;
            fsRequest.call(examContainer).catch(err => console.warn(`Gagal masuk layar penuh: ${err.message}`));
        }

        async function handleFullscreenChange() {
            const isFullscreen = !!(document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
            
            if (!isFullscreen && isInExamMode) {
                examIframe.classList.add('blurred');
                fullscreenExitWarningOverlay.style.display = 'flex';
                setTimeout(() => fullscreenExitWarningOverlay.style.opacity = 1, 10);

                if (isLockEnabledGlobal) {
                    let attempts = parseInt(sessionStorage.getItem('attemptsLeft') ?? toleranceLimitGlobal);
                    if (attempts > 0) {
                        attempts--;
                        sessionStorage.setItem('attemptsLeft', attempts);
                        const dbRefs = getDbRefs();
                        const studentId = padStudentId(selectedStudentData.id);
                        const accessStatusRef = child(dbRefs.examAccessStatusRef, `${foundTokenGlobal.key}/${studentId}`);
                        try {
                            await update(accessStatusRef, { attemptsLeft: attempts });
                        } catch (error) {
                            console.error("Gagal update attemptsLeft:", error);
                        }
                    }
                    currentAttemptsLeft = attempts;

                    if (currentAttemptsLeft > 0) {
                        exitWarningMessage.textContent = "Kembali ke mode layar penuh untuk melanjutkan.";
                        attemptsLeftInfo.textContent = `Kesempatan tersisa: ${currentAttemptsLeft}`;
                        reEnterFullscreenBtn.style.display = 'block';
                        lockKeySection.style.display = 'none';
                    } else {
                        exitWarningMessage.textContent = "Kesempatan habis. Masukkan kunci untuk melanjutkan.";
                        attemptsLeftInfo.textContent = "";
                        reEnterFullscreenBtn.style.display = 'none';
                        lockKeySection.style.display = 'block';
                    }
                }
            } else if (isFullscreen) {
                fullscreenExitWarningOverlay.style.opacity = 0;
                setTimeout(() => { fullscreenExitWarningOverlay.style.display = 'none'; }, 300);
                examIframe.classList.remove('blurred');
            }
        }

        function startSubmissionStatusListener() {
            if (!foundTokenGlobal || !selectedStudentData || !currentDb) return;
            const dbRefs = getDbRefs();
            if (!dbRefs) return;
            const studentSubmissionRef = child(dbRefs.submittedExamsRef, `${foundTokenGlobal.key}/${padStudentId(selectedStudentData.id)}`);

            if (submissionListenerRef) off(submissionListenerRef);
            submissionListenerRef = studentSubmissionRef; 
            onValue(studentSubmissionRef, (snapshot) => {
                if (snapshot.exists() && snapshot.val().isSubmitted && examContainer.style.display === 'flex') {
                    showSubmissionConfirmationOverlay(true);
                }
            }, (error) => console.error("Listener Gagal:", error));
        }

        function startExamProcess(examUrl, examDurationMinutes, numQuestions, examStartTime, initialAnswers = null) {
            sessionStorage.setItem('isInExamMode', 'true');
            sessionStorage.setItem('selectedStudentData', JSON.stringify(selectedStudentData));
            sessionStorage.setItem('foundTokenGlobal', JSON.stringify(foundTokenGlobal));
            sessionStorage.setItem('examIframeSrc', examUrl);
            sessionStorage.setItem('examStartTime', examStartTime);
            sessionStorage.setItem('examDurationMinutes', examDurationMinutes);
            sessionStorage.setItem('totalQuestions', numQuestions);
            sessionStorage.setItem('selectedGrade', selectedGrade);

            studentAnswers = initialAnswers || Array(numQuestions).fill('');
            sessionStorage.setItem('studentAnswers', studentAnswers.join(','));
            
            appContainer.style.display = 'none';
            examContainer.style.display = 'flex';
            setTimeout(() => {
                examContainer.style.opacity = 1;
                isInExamMode = true;
                toggleExamSecurityFeatures(true);
                renderAnswerBoxes();
            }, 10);

            examIframe.src = examUrl;
            const elapsedSeconds = Math.floor((Date.now() - examStartTime) / 1000);
            remainingTime = (examDurationMinutes * 60) - elapsedSeconds;
            
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimerDisplay, 1000);
            updateTimerDisplay();
            attemptFullscreen();
            history.pushState(null, '', location.href);
            startSubmissionStatusListener();
        }

        async function restoreExamState() {
            if (sessionStorage.getItem('isInExamMode') !== 'true') return;

            const storedData = {
                student: JSON.parse(sessionStorage.getItem('selectedStudentData')),
                token: JSON.parse(sessionStorage.getItem('foundTokenGlobal')),
                iframeSrc: sessionStorage.getItem('examIframeSrc'),
                duration: parseInt(sessionStorage.getItem('examDurationMinutes'), 10),
                totalQuestions: parseInt(sessionStorage.getItem('totalQuestions'), 10),
                grade: parseInt(sessionStorage.getItem('selectedGrade'), 10),
                startTime: Number(sessionStorage.getItem('examStartTime'))
            };

            if (Object.values(storedData).some(val => !val)) {
                sessionStorage.clear();
                return;
            }

            await selectGrade(storedData.grade, true);
            selectedStudentData = storedData.student;
            foundTokenGlobal = storedData.token;
            totalQuestions = storedData.totalQuestions;

            const instances = await getFirebaseInstanceForClass(`${storedData.grade}A`);
            if (!instances) { sessionStorage.clear(); return; }
            currentDb = instances.db;
            currentAuth = instances.auth;
            
            const dbRefs = getDbRefs();
            if (!dbRefs) { sessionStorage.clear(); return; }

            const studentId = padStudentId(selectedStudentData.id);
            const accessStatusRef = child(dbRefs.examAccessStatusRef, `${foundTokenGlobal.key}/${studentId}`);
            const studentAnswersPath = child(dbRefs.studentAnswersRef, `${foundTokenGlobal.key}/${studentId}`);
            
            let loadedAnswers = Array(totalQuestions).fill('');
            let storedAttemptsLeft = toleranceLimitGlobal;

            try {
                const answersSnapshot = await get(studentAnswersPath);
                if (answersSnapshot.exists()) loadedAnswers = answersSnapshot.val().answers?.split(',') || loadedAnswers;
                
                const accessStatusSnapshot = await get(accessStatusRef);
                if (accessStatusSnapshot.exists()) {
                    const accessData = accessStatusSnapshot.val();
                    storedAttemptsLeft = accessData.attemptsLeft ?? storedAttemptsLeft;
                    if (accessData.isLoggedIn) {
                        message.textContent = "Anda sudah login di perangkat lain. Hubungi admin.";
                        sessionStorage.clear();
                        showSelectionScreen();
                        return;
                    }
                }
            } catch (error) { console.error("Gagal memuat status:", error); }
            
            sessionStorage.setItem('attemptsLeft', storedAttemptsLeft);
            currentAttemptsLeft = storedAttemptsLeft;
            remainingTime = (storedData.duration * 60) - Math.floor((Date.now() - storedData.startTime) / 1000);

            if (remainingTime > 0) {
                selectionContainer.style.display = 'none';
                appContainer.style.display = 'none';
                startExamProcess(storedData.iframeSrc, storedData.duration, storedData.totalQuestions, storedData.startTime, loadedAnswers);
            } else {
                sessionStorage.clear();
                examContainer.style.display = 'flex';
                examContainer.style.opacity = 1;
                submitAnswers(true);
            }
        }

        async function handleLanjutClick(examDurationMinutes, numQuestions, initialAnswers = null) {
            if (!confirmCheckbox.checked) {
                modalMessage.textContent = "Anda harus mencentang cekbox untuk melanjutkan!";
                modalMessage.style.display = 'block';
                return;
            }
            modalMessage.style.display = 'none';
            confirmModal.classList.remove('show');
            message.innerHTML = `Mencatat akses ujian... <span class="spinner"></span>`;
            
            const dbRefs = getDbRefs();
            const studentId = padStudentId(selectedStudentData.id);
            const accessStatusRef = child(dbRefs.examAccessStatusRef, `${foundTokenGlobal.key}/${studentId}`);
            
            try {
                const txResult = await runTransaction(accessStatusRef, (currentData) => {
                    if (currentData?.isLoggedIn) return; // Abort
                    const now = Date.now();
                    return {
                        accessCount: (currentData?.accessCount || 0) + 1,
                        firstLoginTimestamp: currentData?.firstLoginTimestamp || now,
                        lastAccessTimestamp: now,
                        isLoggedIn: true,
                        examStartTime: currentData?.examStartTime || now,
                        studentId: studentId,
                        attemptsLeft: toleranceLimitGlobal
                    };
                });

                if (txResult.committed) {
                    const studentIsLoggedInRef = child(dbRefs.studentsRef, `${selectedStudentData.key}/isLoggedIn`);
                    await set(studentIsLoggedInRef, true);
                    
                    let url = foundTokenGlobal.googleDriveUrl;
                    if (url.includes('drive.google.com/file/d/')) {
                        url = url.replace('/view', '/preview');
                        if (!url.includes('chrome=false')) {
                            url += (url.includes('?') ? '&' : '?') + 'chrome=false';
                        }
                    }
                    globalExamUrl = url;
                    globalExamDurationMinutes = examDurationMinutes;
                    globalNumQuestions = numQuestions;
                    globalExamStartTime = Number(txResult.snapshot.val().examStartTime);
                    showOverlay(initialAnswers);
                } else {
                    message.textContent = "Gagal merekam akses. Sesi mungkin sudah aktif.";
                }
            } catch (err) {
                message.textContent = "Terjadi kesalahan saat memulai sesi ujian.";
            }
        }
        
        function toggleSidebar() {
            examContentWrapper.classList.toggle('sidebar-open');
            resetIframePan();
        }

        function closeSidebarOnClickOutside(event) {
            if (examContentWrapper.classList.contains('sidebar-open') && !answerSidebar.contains(event.target) && !sidebarToggle.contains(event.target)) {
                toggleSidebar();
            }
        }

        function renderAnswerBoxes() {
            answerListContainer.innerHTML = '';
            for (let i = 0; i < totalQuestions; i++) {
                const answer = studentAnswers[i] || '...';
                const box = document.createElement('div');
                box.className = `answer-box ${studentAnswers[i] ? 'answered' : 'unanswered'}`;
                box.dataset.questionIndex = i;
                box.innerHTML = `<span class="question-number">${i + 1}</span><span class="selected-answer">${answer}</span>`;
                box.addEventListener('click', () => openAnswerSelectionModal(i));
                answerListContainer.appendChild(box);
            }
        }

        function openAnswerSelectionModal(index) {
            currentQuestionIndexForModal = index;
            currentQuestionNumberSpan.textContent = index + 1;
            answerOptionsContainer.querySelectorAll('button').forEach(button => {
                button.classList.toggle('selected', button.dataset.answer === studentAnswers[index]);
            });
            answerSelectionModal.classList.add('show');
        }

        function closeAnswerSelectionModal() {
            answerSelectionModal.classList.remove('show');
        }

        function selectAnswer(answer) {
            if (currentQuestionIndexForModal !== -1) {
                studentAnswers[currentQuestionIndexForModal] = answer;
                renderAnswerBoxes();
                saveStudentAnswersToFirebase();
                closeAnswerSelectionModal();
            }
        }

        function clearAnswer() {
            selectAnswer('');
        }

        async function saveStudentAnswersToFirebase() {
            if (!foundTokenGlobal || !selectedStudentData) return;
            const dbRefs = getDbRefs();
            const studentId = padStudentId(selectedStudentData.id);
            const path = child(dbRefs.studentAnswersRef, `${foundTokenGlobal.key}/${studentId}`);
            try {
                await set(path, {
                    answers: studentAnswers.join(','),
                    timestamp: Date.now(),
                    studentId: studentId
                });
            } catch (error) { console.error("Gagal simpan jawaban:", error); }
        }

        async function submitAnswers(isAutoSubmit = false) {
            if (!isAutoSubmit) {
                const unansweredCount = studentAnswers.filter(a => !a).length;
                if (unansweredCount > 0) {
                    submissionWarningMessage.textContent = `Ada ${unansweredCount} jawaban kosong!`;
                    return;
                }
                if (!await window.showCustomConfirmModal("Konfirmasi", "Yakin ingin mengirimkan jawaban?")) return;
            }
            submitAnswersButton.disabled = true;
            submitAnswersButton.textContent = 'Mengirim...';
            try {
                await saveStudentAnswersToFirebase();
                const dbRefs = getDbRefs();
                const studentId = padStudentId(selectedStudentData.id);
                const submittedPath = child(dbRefs.submittedExamsRef, `${foundTokenGlobal.key}/${studentId}`);
                await set(submittedPath, { isSubmitted: true, timestamp: Date.now(), studentId });
                const accessStatusRef = child(dbRefs.examAccessStatusRef, `${foundTokenGlobal.key}/${studentId}`);
                await update(accessStatusRef, { isLoggedIn: false });
                const studentIsLoggedInRef = child(dbRefs.studentsRef, `${selectedStudentData.key}/isLoggedIn`);
                await set(studentIsLoggedInRef, false);
                showSubmissionConfirmationOverlay(isAutoSubmit);
            } catch (error) {
                submissionWarningMessage.textContent = 'Gagal mengirim. Hubungi admin.';
                submitAnswersButton.disabled = false;
            }
        }

        window.showCustomMessageModal = function (title, text) {
            customMessageModalTitle.textContent = title;
            customMessageModalText.textContent = text;
            customMessageModal.classList.add('show');
        }
        window.hideCustomMessageModal = function () {
            customMessageModal.classList.remove('show');
        }
        window.showCustomConfirmModal = function (title, text) {
            return new Promise(resolve => {
                customConfirmModalTitle.textContent = title;
                customConfirmModalText.textContent = text;
                customConfirmModal.classList.add('show');
                const onConfirm = () => cleanup(true);
                const onCancel = () => cleanup(false);
                const cleanup = (result) => {
                    customConfirmModalConfirmBtn.removeEventListener('click', onConfirm);
                    customConfirmModalCancelBtn.removeEventListener('click', onCancel);
                    customConfirmModal.classList.remove('show');
                    resolve(result);
                };
                customConfirmModalConfirmBtn.addEventListener('click', onConfirm);
                customConfirmModalCancelBtn.addEventListener('click', onCancel);
            });
        }
        
        function resetIframePan() {
            currentTranslateX = 0;
            currentTranslateY = 0;
            applyIframeTransform();
        }

        function updateZoomButtonStates() {
            zoomInBtn.disabled = currentZoom >= MAX_ZOOM;
            zoomOutBtn.disabled = currentZoom <= MIN_ZOOM;
            panLeftBtn.disabled = panRightBtn.disabled = currentZoom <= MIN_ZOOM;
        }
        
        function showSelectionScreen() {
            appContainer.style.display = 'none';
            selectionContainer.style.display = 'block';
            document.body.className = '';
            
            selectedGrade = null;
            currentDb = null;
            currentAuth = null;
            allStudentsData = [];
            selectedStudentData = null;
            hiddenSelectKelas.value = '';
            customSelectKelasDisplay.textContent = '-- Pilih Kelas --';
            customSelectKelasDisplay.classList.remove('selected');
            hiddenSelectNamaSiswa.value = '';
            customSelectNamaSiswaDisplay.textContent = '-- Pilih Nama Siswa --';
            customSelectNamaSiswaDisplay.classList.remove('selected');
            inputTokenPrefix.value = '';
            displayStudentId.value = '';
            updateLoginButtonStatus();
        }

        async function selectGrade(grade, isRestoring = false) {
            selectedGrade = grade;
            document.body.className = `theme-${{7:'blue', 8:'orange', 9:'maroon'}[grade]}`;
            document.querySelector('#appContainer .judul-ujian').textContent = `UJIAN KELAS ${grade}`;

            if (!isRestoring) {
                selectionContainer.style.display = 'none';
                appContainer.style.display = 'block';

                if (grade === 7) {
                    await getFirebaseInstanceForClass('7A');
                    await getFirebaseInstanceForClass('7D');
                } else if (grade === 8) {
                    await getFirebaseInstanceForClass('8A');
                    await getFirebaseInstanceForClass('8D');
                } else if (grade === 9) {
                    await getFirebaseInstanceForClass('9A');
                    await getFirebaseInstanceForClass('9D');
                }

                const instances = await getFirebaseInstanceForClass(`${grade}A`);
                if (!instances) {
                    message.textContent = "Gagal memuat pengaturan untuk jenjang ini.";
                    message.style.color = 'red';
                    return;
                }
                const db = instances.db;
                try {
                    const settings = (await get(ref(db, 'setlokasi'))).val() || {};
                    isLocationEnabled = settings.isLocationEnabled ?? true;
                    firebaseAllowedRadiusKm = settings.allowedRadiusKm ?? 0.075;
                    const lockSettings = (await get(ref(db, 'lock_settings'))).val() || {};
                    isLockEnabledGlobal = lockSettings.isLockEnabled ?? false;
                    lockKeyGlobal = lockSettings.lockKey ?? "";
                    toleranceLimitGlobal = lockSettings.toleranceLimit ?? 3;
                } catch (error) { console.error("Gagal ambil pengaturan:", error); }
                loadInitialClassDropdown();
                getLocation();
                updateLoginButtonStatus();
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('selectGrade7').addEventListener('click', () => selectGrade(7));
            document.getElementById('selectGrade8').addEventListener('click', () => selectGrade(8));
            document.getElementById('selectGrade9').addEventListener('click', () => selectGrade(9));
            document.getElementById('backToSelectionBtn').addEventListener('click', showSelectionScreen);

            await restoreExamState();
            if (!sessionStorage.getItem('isInExamMode')) {
                 showSelectionScreen();
            }

            window.cekToken = async function() {
                const tokenPrefix = inputTokenPrefix.value.trim().toUpperCase();
                const studentId = displayStudentId.value.trim();
                const selectedClass = hiddenSelectKelas.value;
                if (!selectedClass || !studentId || !tokenPrefix) {
                    message.style.color = "red";
                    message.textContent = "Harap lengkapi semua isian.";
                    return;
                }
                loginBtn.disabled = true;
                message.innerHTML = `Memproses... <span class="spinner"></span>`;
                const dbRefs = getDbRefs();
                if (!dbRefs) return;
                try {
                    const tokensSnapshot = await get(dbRefs.tokensRef);
                    let foundToken = null;
                    tokensSnapshot.forEach(child => {
                        const data = child.val();
                        if (data.token.toUpperCase() === tokenPrefix) {
                            foundToken = { ...data, key: child.key };
                        }
                    });
                    if (!foundToken) { throw new Error("Token ujian tidak ditemukan."); }
                    foundTokenGlobal = foundToken;
                    
                    const submittedSnapshot = await get(child(dbRefs.submittedExamsRef, `${foundToken.key}/${studentId}`));
                    if (submittedSnapshot.exists() && submittedSnapshot.val().isSubmitted) {
                        throw new Error("Anda sudah menyelesaikan ujian ini.");
                    }
                    
                    const now = new Date(), startTime = new Date(foundToken.startTime), endTime = new Date(foundToken.endTime);
                    if (!foundToken.isForceActive && (!foundToken.isActive || now < startTime || now > endTime)) {
                        throw new Error("Token tidak aktif atau sudah kadaluarsa.");
                    }
                    
                    const studentGrade = selectedStudentData.class.match(/^\d+/)?.[0];
                    if (String(studentGrade) !== String(foundToken.kelas)) {
                        throw new Error(`Token ini bukan untuk kelas ${selectedStudentData.class}.`);
                    }

                    const accessStatusSnapshot = await get(child(dbRefs.examAccessStatusRef, `${foundToken.key}/${studentId}`));
                    if (accessStatusSnapshot.val()?.isLoggedIn) {
                        throw new Error("Anda sudah Login di perangkat lain. Hubungi admin.");
                    }

                    const numQuestions = (foundToken.answerKey?.split(',').length) || 0;
                    let loadedAnswers = Array(numQuestions).fill('');
                    const answersSnapshot = await get(child(dbRefs.studentAnswersRef, `${foundToken.key}/${studentId}`));
                    if (answersSnapshot.exists()) loadedAnswers = answersSnapshot.val().answers?.split(',') || loadedAnswers;

                    document.getElementById("modalIdSiswa").textContent = selectedStudentData.id;
                    document.getElementById("modalNamaLengkap").textContent = selectedStudentData.name;
                    document.getElementById("modalKelas").textContent = selectedClass;
                    document.getElementById("modalMapel").textContent = foundToken.subject;
                    modalExamDuration.textContent = `${foundToken.durationMinutes} Menit`;
                    confirmModal.classList.add('show');
                    message.textContent = "";
                    document.getElementById("btnLanjut").onclick = () => handleLanjutClick(foundToken.durationMinutes, numQuestions, loadedAnswers);

                } catch (err) {
                    message.style.color = "red";
                    message.textContent = err.message;
                    loginBtn.disabled = false;
                }
            };
            
            customSelectKelasDisplay.addEventListener('click', openClassModal);
            customSelectNamaSiswaDisplay.addEventListener('click', openStudentModal);
            classModal.addEventListener('click', e => { if (e.target === classModal) closeClassModal(); });
            studentModal.addEventListener('click', e => { if (e.target === studentModal) closeStudentModal(); });
            inputTokenPrefix.addEventListener('input', () => window.formatTokenPrefix(inputTokenPrefix));
            loginBtn.addEventListener('click', window.cekToken);
            overlayUnderstandBtn.addEventListener('click', hideOverlay);
            backToLoginFromSubmissionBtn.addEventListener('click', showSelectionScreen);
            window.onpopstate = e => { if (isInExamMode) history.pushState(null, '', location.href); };
            ['fullscreenchange', 'mozfullscreenchange', 'webkitfullscreenchange', 'msfullscreenchange'].forEach(evt => 
                document.addEventListener(evt, handleFullscreenChange, false)
            );
            reEnterFullscreenBtn.addEventListener('click', attemptFullscreen);
            lockKeySubmitBtn.addEventListener('click', async () => {
                if (lockKeyInput.value === lockKeyGlobal) {
                    currentAttemptsLeft = toleranceLimitGlobal;
                    sessionStorage.setItem('attemptsLeft', currentAttemptsLeft);
                    const dbRefs = getDbRefs();
                    if (dbRefs) {
                        const studentId = padStudentId(selectedStudentData.id);
                        const accessStatusRef = child(dbRefs.examAccessStatusRef, `${foundTokenGlobal.key}/${studentId}`);
                        await update(accessStatusRef, { attemptsLeft: currentAttemptsLeft, studentId: studentId });
                    }
                    lockKeySection.style.display = 'none';
                    reEnterFullscreenBtn.style.display = 'block';
                    attemptFullscreen();
                } else {
                    lockKeyMessage.textContent = 'Kunci salah.';
                }
            });
            sidebarToggle.addEventListener('click', toggleSidebar);
            closeSidebarButton.addEventListener('click', toggleSidebar);
            document.addEventListener('click', closeSidebarOnClickOutside);
            answerSelectionModal.addEventListener('click', e => { if(e.target === answerSelectionModal) closeAnswerSelectionModal(); });
            answerOptionsContainer.querySelectorAll('button').forEach(b => b.addEventListener('click', () => selectAnswer(b.dataset.answer)));
            clearAnswerButton.addEventListener('click', clearAnswer);
            submitAnswersButton.addEventListener('click', () => submitAnswers(false));
            updateDateTime();
            setInterval(updateDateTime, 1000);
        });
    </script>
</body>
</html>
